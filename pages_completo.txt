--- CONTEXTO ESPECIFICO: CARPETA PAGES ---
Aqu√≠ est√°n solo las vistas/p√°ginas de la aplicaci√≥n.


==================================================
RUTA: src\pages\Bitacora.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { StickyNote, Plus, Trash2, CheckCircle, AlertCircle, Lightbulb, Clock } from 'lucide-react'
import Modal from '../components/Modal'

function Bitacora() {
  const [notas, setNotas] = useState([])
  const [filtro, setFiltro] = useState('Pendiente') // Pendiente | Realizado
  const [modalOpen, setModalOpen] = useState(false)
  
  // Estado formulario
  const [nuevaNota, setNuevaNota] = useState({ titulo: '', contenido: '', tipo: 'Nota', importante: false })

  useEffect(() => { cargarNotas() }, [filtro])

  async function cargarNotas() {
    let query = supabase.from('bitacora').select('*').order('created_at', { ascending: false })
    
    // Si filtro es Pendiente, traemos todo lo que NO est√© archivado ni realizado (o ajusta seg√∫n gusto)
    if (filtro === 'Pendiente') query = query.neq('estado', 'Realizado')
    else query = query.eq('estado', 'Realizado')

    const { data } = await query
    setNotas(data || [])
  }

  const guardarNota = async (e) => {
      e.preventDefault()
      if (!nuevaNota.contenido) return alert("Escribe algo...")
      
      const { error } = await supabase.from('bitacora').insert([nuevaNota])
      if (error) alert(error.message)
      else {
          setModalOpen(false)
          setNuevaNota({ titulo: '', contenido: '', tipo: 'Nota', importante: false })
          cargarNotas()
      }
  }

  const cambiarEstado = async (id, nuevoEstado) => {
      await supabase.from('bitacora').update({ estado: nuevoEstado }).eq('id', id)
      cargarNotas()
  }

  const eliminarNota = async (id) => {
      if(!confirm("¬øBorrar nota?")) return
      await supabase.from('bitacora').delete().eq('id', id)
      cargarNotas()
  }

  // Iconos seg√∫n tipo
  const getIcon = (tipo) => {
      if (tipo === 'Idea') return <Lightbulb size={20} color="#eab308"/>
      if (tipo === 'Alerta') return <AlertCircle size={20} color="#ef4444"/>
      if (tipo === 'Tarea') return <CheckCircle size={20} color="#3b82f6"/>
      return <StickyNote size={20} color="#6b7280"/>
  }

  const styles = {
      container: { padding: '20px', width: '100%' },
      header: { display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'20px' },
      title: { fontSize: '1.8rem', fontWeight: 'bold', color: '#1f2937', display:'flex', gap:'10px' },
      
      tabs: { display:'flex', gap:'10px', marginBottom:'20px' },
      tab: (active) => ({ padding:'8px 16px', borderRadius:'20px', border:'none', cursor:'pointer', fontWeight:'bold', backgroundColor: active ? '#1f2937' : '#e5e7eb', color: active ? 'white' : '#4b5563' }),
      
      grid: { display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(280px, 1fr))', gap:'20px' },
      card: (importante) => ({ backgroundColor: importante ? '#fef3c7' : 'white', borderRadius:'12px', padding:'20px', boxShadow:'0 4px 6px rgba(0,0,0,0.05)', border: importante ? '1px solid #fcd34d' : '1px solid #e5e7eb', display:'flex', flexDirection:'column', gap:'10px', position:'relative' }),
      
      cardHeader: { display:'flex', justifyContent:'space-between', alignItems:'flex-start' },
      cardTitle: { fontWeight:'bold', fontSize:'1.1rem', color:'#1f2937', margin:0 },
      cardDate: { fontSize:'0.75rem', color:'#6b7280', display:'flex', alignItems:'center', gap:'4px' },
      
      actions: { display:'flex', justifyContent:'flex-end', gap:'10px', marginTop:'10px', paddingTop:'10px', borderTop:'1px dashed #d1d5db' },
      btnAction: { background:'none', border:'none', cursor:'pointer', color:'#6b7280', padding:'5px' },

      // Form Styles
      form: { display:'flex', flexDirection:'column', gap:'15px' },
      input: { padding:'10px', borderRadius:'8px', border:'1px solid #d1d5db', width:'100%', boxSizing:'border-box' },
      textarea: { padding:'10px', borderRadius:'8px', border:'1px solid #d1d5db', width:'100%', minHeight:'100px', fontFamily:'inherit', boxSizing:'border-box' },
      select: { padding:'10px', borderRadius:'8px', border:'1px solid #d1d5db', width:'100%' },
      btnSave: { padding:'12px', backgroundColor:'#1f2937', color:'white', border:'none', borderRadius:'8px', fontWeight:'bold', cursor:'pointer' }
  }

  return (
    <div style={styles.container}>
        <div style={styles.header}>
            <h1 style={styles.title}><StickyNote color="#d97706"/> Bit√°cora de Campo</h1>
            <button onClick={() => setModalOpen(true)} style={{backgroundColor:'#d97706', color:'white', border:'none', padding:'10px 20px', borderRadius:'8px', fontWeight:'bold', cursor:'pointer', display:'flex', alignItems:'center', gap:'8px'}}>
                <Plus size={18}/> Nueva Nota
            </button>
        </div>

        <div style={styles.tabs}>
            <button style={styles.tab(filtro === 'Pendiente')} onClick={() => setFiltro('Pendiente')}>Activas / Pendientes</button>
            <button style={styles.tab(filtro === 'Realizado')} onClick={() => setFiltro('Realizado')}>Historial / Realizadas</button>
        </div>

        <div style={styles.grid}>
            {notas.length === 0 && <div style={{color:'#9ca3af', gridColumn:'1/-1', textAlign:'center', padding:'40px'}}>No hay notas en esta vista.</div>}
            
            {notas.map(n => (
                <div key={n.id} style={styles.card(n.importante)}>
                    <div style={styles.cardHeader}>
                        <div style={{display:'flex', gap:'8px', alignItems:'center'}}>
                            {getIcon(n.tipo)}
                            <h3 style={styles.cardTitle}>{n.titulo || 'Nota sin t√≠tulo'}</h3>
                        </div>
                        {n.importante && <AlertCircle size={16} color="#d97706" title="Importante"/>}
                    </div>
                    
                    <p style={{margin:0, color:'#374151', whiteSpace:'pre-wrap', fontSize:'0.95rem'}}>{n.contenido}</p>
                    
                    <div style={styles.cardDate}>
                        <Clock size={12}/> {n.fecha}
                    </div>

                    <div style={styles.actions}>
                        <button onClick={() => eliminarNota(n.id)} style={{...styles.btnAction, color:'#ef4444'}} title="Borrar"><Trash2 size={18}/></button>
                        
                        {filtro === 'Pendiente' ? (
                             <button onClick={() => cambiarEstado(n.id, 'Realizado')} style={{...styles.btnAction, color:'#16a34a'}} title="Marcar Realizado"><CheckCircle size={18}/></button>
                        ) : (
                             <button onClick={() => cambiarEstado(n.id, 'Pendiente')} style={{...styles.btnAction, color:'#d97706'}} title="Volver a Pendiente"><Clock size={18}/></button>
                        )}
                    </div>
                </div>
            ))}
        </div>

        <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title="Agregar a Bit√°cora">
            <form onSubmit={guardarNota} style={styles.form}>
                <input 
                    placeholder="T√≠tulo (Opcional)" 
                    value={nuevaNota.titulo} 
                    onChange={e => setNuevaNota({...nuevaNota, titulo: e.target.value})} 
                    style={styles.input}
                />
                <textarea 
                    placeholder="Escribe tu idea, tarea u observaci√≥n..." 
                    value={nuevaNota.contenido} 
                    onChange={e => setNuevaNota({...nuevaNota, contenido: e.target.value})} 
                    style={styles.textarea}
                    required
                />
                <div style={{display:'flex', gap:'10px'}}>
                    <select 
                        value={nuevaNota.tipo} 
                        onChange={e => setNuevaNota({...nuevaNota, tipo: e.target.value})} 
                        style={styles.select}
                    >
                        <option value="Nota">Nota General</option>
                        <option value="Idea">Idea / Proyecto</option>
                        <option value="Tarea">Tarea Pendiente</option>
                        <option value="Alerta">Alerta / Problema</option>
                    </select>
                    <label style={{display:'flex', alignItems:'center', gap:'5px', padding:'0 10px', border:'1px solid #d1d5db', borderRadius:'8px', cursor:'pointer', backgroundColor:'white'}}>
                        <input 
                            type="checkbox" 
                            checked={nuevaNota.importante} 
                            onChange={e => setNuevaNota({...nuevaNota, importante: e.target.checked})} 
                        />
                        <span style={{fontSize:'0.9rem'}}>¬°Importante!</span>
                    </label>
                </div>
                <button type="submit" style={styles.btnSave}>Guardar Nota</button>
            </form>
        </Modal>
    </div>
  )
}
export default Bitacora


==================================================
RUTA: src\pages\Bodega.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Package, Plus, ArrowUpCircle, ArrowDownCircle, Search, AlertTriangle, History } from 'lucide-react'
import Modal from '../components/Modal'
import NuevoProducto from './NuevoProducto'
import NuevoMovimientoBodega from './NuevoMovimientoBodega'

function Bodega() {
  const [productos, setProductos] = useState([])
  const [filtro, setFiltro] = useState('')
  
  // Modales
  const [modalProductoOpen, setModalProductoOpen] = useState(false)
  const [modalMovimientoOpen, setModalMovimientoOpen] = useState(false)
  
  const [productoEditar, setProductoEditar] = useState(null) // Para editar ficha
  const [movimientoConfig, setMovimientoConfig] = useState(null) // { tipo: 'Entrada', productoId: 1 }

  useEffect(() => {
    cargarBodega()
  }, [])

  async function cargarBodega() {
    const { data } = await supabase.from('bodega_insumos').select('*').order('nombre')
    if (data) setProductos(data)
  }

  // --- ACCIONES ---
  const abrirNuevoProducto = () => {
    setProductoEditar(null)
    setModalProductoOpen(true)
  }

  const abrirEditarProducto = (prod) => {
    setProductoEditar(prod)
    setModalProductoOpen(true)
  }

  const abrirMovimiento = (tipo, prod) => {
    setMovimientoConfig({ tipo, producto: prod })
    setModalMovimientoOpen(true)
  }

  const productosFiltrados = productos.filter(p => 
    p.nombre.toLowerCase().includes(filtro.toLowerCase()) || 
    p.categoria?.toLowerCase().includes(filtro.toLowerCase())
  )

  const styles = {
    container: { padding: '20px', width: '100%' },
    header: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap:'wrap', gap:'15px' },
    title: { fontSize: '1.8rem', fontWeight: 'bold', color: '#1f2937', display:'flex', alignItems:'center', gap:'10px' },
    
    searchBar: { display:'flex', alignItems:'center', backgroundColor:'white', padding:'8px 15px', borderRadius:'8px', border:'1px solid #d1d5db', width:'300px' },
    searchInput: { border:'none', outline:'none', marginLeft:'10px', width:'100%', fontSize:'0.95rem' },

    btnNew: { backgroundColor: '#1f2937', color: 'white', padding: '10px 20px', borderRadius: '8px', border: 'none', cursor: 'pointer', fontWeight: 'bold', display:'flex', alignItems:'center', gap:'8px' },

    grid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: '20px' },
    
    card: { backgroundColor: 'white', borderRadius: '12px', padding: '20px', border: '1px solid #e5e7eb', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', display:'flex', flexDirection:'column', justifyContent:'space-between' },
    cardHeader: { display:'flex', justifyContent:'space-between', alignItems:'flex-start', marginBottom:'10px' },
    prodName: { fontSize: '1.1rem', fontWeight: 'bold', color: '#1f2937' },
    prodCat: { fontSize: '0.8rem', color: '#6b7280', backgroundColor:'#f3f4f6', padding:'2px 8px', borderRadius:'4px', marginTop:'4px', display:'inline-block' },
    
    stockBig: { fontSize: '2rem', fontWeight: 'bold', color: '#2563eb', margin: '10px 0' },
    stockUnit: { fontSize: '1rem', color: '#6b7280', fontWeight:'normal', marginLeft:'5px' },

    actionsRow: { display:'flex', gap:'10px', marginTop:'15px', borderTop:'1px solid #f3f4f6', paddingTop:'15px' },
    btnAction: (color, bg) => ({ flex:1, padding:'8px', borderRadius:'6px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.85rem', display:'flex', alignItems:'center', justifyContent:'center', gap:'5px', backgroundColor: bg, color: color }),
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><Package color="#2563eb"/> Bodega</h1>
        
        <div style={styles.searchBar}>
            <Search size={18} color="#9ca3af"/>
            <input 
                type="text" 
                placeholder="Buscar insumo..." 
                style={styles.searchInput}
                value={filtro}
                onChange={e => setFiltro(e.target.value)}
            />
        </div>

        <button onClick={abrirNuevoProducto} style={styles.btnNew}><Plus size={18}/> Nuevo Producto</button>
      </div>

      <div style={styles.grid}>
        {productosFiltrados.map(p => (
            <div key={p.id} style={styles.card}>
                <div>
                    <div style={styles.cardHeader}>
                        <div>
                            <div style={styles.prodName}>{p.nombre}</div>
                            <span style={styles.prodCat}>{p.categoria}</span>
                        </div>
                        <button onClick={() => abrirEditarProducto(p)} style={{border:'none', background:'none', color:'#9ca3af', cursor:'pointer'}} title="Editar Ficha">
                            <History size={18}/>
                        </button>
                    </div>

                    <div style={styles.stockBig}>
                        {parseFloat(p.stock_actual).toLocaleString('es-CL')} 
                        <span style={styles.stockUnit}>{p.unidad_medida}</span>
                    </div>

                    {p.stock_actual <= p.stock_minimo && (
                        <div style={{display:'flex', alignItems:'center', gap:'5px', color:'#ef4444', fontSize:'0.85rem', fontWeight:'bold'}}>
                            <AlertTriangle size={14}/> Stock Bajo (Min: {p.stock_minimo})
                        </div>
                    )}
                </div>

                <div style={styles.actionsRow}>
                    <button 
                        onClick={() => abrirMovimiento('Entrada', p)} 
                        style={styles.btnAction('#166534', '#dcfce7')}
                    >
                        <ArrowUpCircle size={16}/> Entrada
                    </button>
                    <button 
                        onClick={() => abrirMovimiento('Salida', p)} 
                        style={styles.btnAction('#991b1b', '#fee2e2')}
                    >
                        <ArrowDownCircle size={16}/> Salida
                    </button>
                </div>
            </div>
        ))}
      </div>
      
      {/* MODALES */}
      <Modal isOpen={modalProductoOpen} onClose={() => setModalProductoOpen(false)} title={productoEditar ? "Editar Producto" : "Nuevo Producto"}>
          {modalProductoOpen && (
            <NuevoProducto 
                producto={productoEditar} 
                cerrar={() => setModalProductoOpen(false)} 
                alGuardar={() => { setModalProductoOpen(false); cargarBodega() }}
            />
          )}
      </Modal>

      <Modal isOpen={modalMovimientoOpen} onClose={() => setModalMovimientoOpen(false)} title={`Registrar ${movimientoConfig?.tipo || 'Movimiento'}`}>
          {modalMovimientoOpen && (
            <NuevoMovimientoBodega 
                config={movimientoConfig}
                cerrar={() => setModalMovimientoOpen(false)}
                alGuardar={() => { setModalMovimientoOpen(false); cargarBodega() }}
            />
          )}
      </Modal>

    </div>
  )
}

export default Bodega


==================================================
RUTA: src\pages\Categorias.jsx
==================================================
import { useState, useEffect } from 'react'
import { supabase } from '../supabaseClient'
import { Plus, Trash2, Folder, CornerDownRight } from 'lucide-react'

function Categorias() {
  const [categorias, setCategorias] = useState([])
  const [subcategorias, setSubcategorias] = useState([])
  const [catSeleccionada, setCatSeleccionada] = useState(null)
  
  const [loading, setLoading] = useState(false)
  const [nuevaCat, setNuevaCat] = useState('')
  const [nuevaSub, setNuevaSub] = useState('')

  useEffect(() => {
    cargarCategorias()
  }, [])

  useEffect(() => {
    if (catSeleccionada) cargarSubcategorias(catSeleccionada.id)
    else setSubcategorias([])
  }, [catSeleccionada])

  async function cargarCategorias() {
    const { data } = await supabase.from('categorias_gastos').select('*').order('nombre')
    setCategorias(data || [])
  }

  async function cargarSubcategorias(catId) {
    const { data } = await supabase
        .from('subcategorias_gastos')
        .select('*')
        .eq('categoria_id', catId)
        .order('nombre')
    setSubcategorias(data || [])
  }

  // --- LOGICA CATEGORIAS ---
  async function agregarCategoria(e) {
    e.preventDefault()
    if (!nuevaCat.trim()) return
    setLoading(true)
    const { error } = await supabase.from('categorias_gastos').insert([{ nombre: nuevaCat }])
    if (!error) {
        setNuevaCat('')
        cargarCategorias()
    }
    setLoading(false)
  }

  async function borrarCategoria(id) {
    if (!confirm('Al borrar una categor√≠a se pueden perder las subcategor√≠as asociadas. ¬øContinuar?')) return
    await supabase.from('categorias_gastos').delete().eq('id', id)
    cargarCategorias()
    if (catSeleccionada?.id === id) setCatSeleccionada(null)
  }

  // --- LOGICA SUBCATEGORIAS ---
  async function agregarSubcategoria(e) {
    e.preventDefault()
    if (!nuevaSub.trim() || !catSeleccionada) return
    setLoading(true)
    const { error } = await supabase.from('subcategorias_gastos').insert([{ 
        nombre: nuevaSub, 
        categoria_id: catSeleccionada.id 
    }])
    if (!error) {
        setNuevaSub('')
        cargarSubcategorias(catSeleccionada.id)
    }
    setLoading(false)
  }

  async function borrarSubcategoria(id) {
    if (!confirm('¬øBorrar subcategor√≠a?')) return
    await supabase.from('subcategorias_gastos').delete().eq('id', id)
    if (catSeleccionada) cargarSubcategorias(catSeleccionada.id)
  }

  const styles = {
    container: { maxWidth: '1000px', margin: '0 auto', display: 'flex', gap: '30px', height: 'calc(100vh - 100px)' },
    column: { flex: 1, backgroundColor: 'white', padding: '20px', borderRadius: '12px', boxShadow: '0 2px 5px rgba(0,0,0,0.05)', display: 'flex', flexDirection: 'column' },
    header: { borderBottom: '1px solid #e5e7eb', paddingBottom: '15px', marginBottom: '15px' },
    title: { margin: 0, color: '#111827', fontSize: '1.2rem', display: 'flex', alignItems: 'center', gap: '10px' },
    list: { flex: 1, overflowY: 'auto', listStyle: 'none', padding: 0, margin: 0 },
    item: (isActive) => ({
        padding: '12px', margin: '5px 0', borderRadius: '8px', cursor: 'pointer',
        display: 'flex', justifyContent: 'space-between', alignItems: 'center',
        backgroundColor: isActive ? '#eff6ff' : 'transparent',
        border: isActive ? '1px solid #bfdbfe' : '1px solid transparent',
        color: isActive ? '#1d4ed8' : '#374151'
    }),
    form: { display: 'flex', gap: '10px', marginTop: '15px' },
    input: { flex: 1, padding: '8px', borderRadius: '6px', border: '1px solid #d1d5db' },
    btn: { backgroundColor: '#2563eb', color: 'white', border: 'none', borderRadius: '6px', padding: '0 15px', cursor: 'pointer' },
    emptyState: { textAlign: 'center', color: '#9ca3af', marginTop: '50px' }
  }

  return (
    <div style={styles.container}>
      {/* COLUMNA IZQUIERDA: CATEGORIAS */}
      <div style={styles.column}>
        <div style={styles.header}>
            <h2 style={styles.title}><Folder size={20}/> Categor√≠as</h2>
        </div>
        <ul style={styles.list}>
            {categorias.map(cat => (
                <li 
                    key={cat.id} 
                    style={styles.item(catSeleccionada?.id === cat.id)}
                    onClick={() => setCatSeleccionada(cat)}
                >
                    <span>{cat.nombre}</span>
                    <button 
                        onClick={(e) => { e.stopPropagation(); borrarCategoria(cat.id); }}
                        style={{ border: 'none', background: 'transparent', cursor: 'pointer', color: '#ef4444' }}
                    >
                        <Trash2 size={16} />
                    </button>
                </li>
            ))}
        </ul>
        <form style={styles.form} onSubmit={agregarCategoria}>
            <input 
                placeholder="Nueva Categor√≠a..." 
                value={nuevaCat} 
                onChange={e => setNuevaCat(e.target.value)}
                style={styles.input}
            />
            <button type="submit" style={styles.btn} disabled={loading}><Plus size={20}/></button>
        </form>
      </div>

      {/* COLUMNA DERECHA: SUBCATEGORIAS */}
      <div style={styles.column}>
        <div style={styles.header}>
            <h2 style={styles.title}>
                <CornerDownRight size={20}/> 
                {catSeleccionada ? `Subcategor√≠as de "${catSeleccionada.nombre}"` : 'Selecciona una categor√≠a'}
            </h2>
        </div>
        
        {catSeleccionada ? (
            <>
                <ul style={styles.list}>
                    {subcategorias.length === 0 && <p style={styles.emptyState}>No hay subcategor√≠as definidas.</p>}
                    {subcategorias.map(sub => (
                        <li key={sub.id} style={styles.item(false)}>
                            <span>{sub.nombre}</span>
                            <button 
                                onClick={() => borrarSubcategoria(sub.id)}
                                style={{ border: 'none', background: 'transparent', cursor: 'pointer', color: '#ef4444' }}
                            >
                                <Trash2 size={16} />
                            </button>
                        </li>
                    ))}
                </ul>
                <form style={styles.form} onSubmit={agregarSubcategoria}>
                    <input 
                        placeholder="Nueva Subcategor√≠a..." 
                        value={nuevaSub} 
                        onChange={e => setNuevaSub(e.target.value)}
                        style={styles.input}
                    />
                    <button type="submit" style={styles.btn} disabled={loading}><Plus size={20}/></button>
                </form>
            </>
        ) : (
            <div style={{flex:1, display:'flex', alignItems:'center', justifyContent:'center', color:'#9ca3af', textAlign:'center'}}>
                <p>Haz clic en una categor√≠a de la izquierda<br/>para gestionar sus opciones.</p>
            </div>
        )}
      </div>
    </div>
  )
}

export default Categorias

==================================================
RUTA: src\pages\Clientes.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Briefcase, Plus, Pencil, Trash2, Phone, Mail } from 'lucide-react'
// Importamos Modal y el Formulario (que antes era una p√°gina)
import Modal from '../components/Modal' 
import NuevoCliente from './NuevoCliente' 

function Clientes() {
  const [clientes, setClientes] = useState([])
  // Estados para el modal
  const [modalOpen, setModalOpen] = useState(false)
  const [editId, setEditId] = useState(null)

  useEffect(() => { leerClientes() }, [])

  async function leerClientes() {
    const { data } = await supabase.from('clientes').select('*').order('nombre')
    setClientes(data || [])
  }

  // Funciones para abrir modal
  const abrirCrear = () => { setEditId(null); setModalOpen(true); }
  const abrirEditar = (id) => { setEditId(id); setModalOpen(true); }
  
  // Funci√≥n segura para cerrar
  const cerrarModal = () => {
      if (window.intentarCerrarModal) window.intentarCerrarModal()
      else setModalOpen(false)
  }

  const eliminarCliente = async (id) => {
    if (!confirm("¬øEliminar cliente?")) return;
    const { error } = await supabase.from('clientes').delete().eq('id', id)
    if (error) alert("Error: " + error.message)
    else leerClientes()
  }

  const styles = {
     /* ... tus estilos existentes ... */
     container: { padding: '20px', width: '100%' },
     header: { display: 'flex', gap: '20px', alignItems: 'center', marginBottom: '30px' },
     title: { fontSize: '1.5rem', fontWeight: 'bold', color: '#1f2937', display:'flex', gap:'10px' },
     // Cambiamos estilo de Link a Button
     btnNew: { border:'none', cursor:'pointer', backgroundColor: '#059669', color: 'white', padding: '10px 20px', borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '0.9rem' },
     grid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '20px' }
     /* ... resto de estilos ... */
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><Briefcase color="#059669" /> Cartera de Clientes</h1>
        {/* Ahora es un bot√≥n que abre modal */}
        <button onClick={abrirCrear} style={styles.btnNew}><Plus size={18} /> Nuevo Cliente</button>
      </div>

      <div style={styles.grid}>
        {clientes.map((cliente) => (
          <div key={cliente.id} style={{backgroundColor:'white', padding:'20px', borderRadius:'12px', boxShadow:'0 2px 4px rgba(0,0,0,0.05)', position:'relative'}}>
            {/* ... renderizado de tarjeta igual que antes ... */}
            <h3 style={{margin:0}}>{cliente.nombre}</h3>
            <div style={{fontSize:'0.9rem', color:'#6b7280'}}>{cliente.tipo}</div>
            
            <div style={{position:'absolute', top:'20px', right:'20px', display:'flex', gap:'10px'}}>
              {/* Bot√≥n Editar ahora abre modal */}
              <button onClick={() => abrirEditar(cliente.id)} style={{border:'none', background:'none', color:'#2563eb', cursor:'pointer'}}><Pencil size={20}/></button>
              <button onClick={() => eliminarCliente(cliente.id)} style={{border:'none', background:'none', color:'#ef4444', cursor:'pointer'}}><Trash2 size={20}/></button>
            </div>
          </div>
        ))}
      </div>

      {/* COMPONENTE MODAL GEN√âRICO */}
      <Modal 
        isOpen={modalOpen} 
        onClose={cerrarModal} 
        title={editId ? "Editar Cliente" : "Nuevo Cliente"}
      >
          {/* Renderizamos el formulario SOLO si el modal est√° abierto */}
          {modalOpen && (
            <NuevoCliente 
                // Necesitas adaptar NuevoCliente.jsx para recibir props en vez de usar useParams
                idCliente={editId} 
                cerrarModal={() => setModalOpen(false)}
                alGuardar={() => { setModalOpen(false); leerClientes(); }}
            />
          )}
      </Modal>
    </div>
  )
}

export default Clientes


==================================================
RUTA: src\pages\ConfiguracionCampo.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Link } from 'react-router-dom'
import { MapPin, Map, Plus, Pencil, Trash2, Maximize } from 'lucide-react'
import Modal from '../components/Modal'
import NuevaParcela from './NuevaParcela'
import NuevoSector from './NuevoSector'

function ConfiguracionCampo() {
  const [arbol, setArbol] = useState([])
  const [loading, setLoading] = useState(true)

  // ESTADOS MODALES
  const [modalParcelaOpen, setModalParcelaOpen] = useState(false)
  const [modalSectorOpen, setModalSectorOpen] = useState(false)
  
  const [editParcelaId, setEditParcelaId] = useState(null)
  const [editSectorId, setEditSectorId] = useState(null)

  useEffect(() => {
    cargarDatos()
  }, [])

  async function cargarDatos() {
    try {
      const { data: parcelas } = await supabase.from('parcelas').select('*').order('nombre')
      const { data: sectores } = await supabase.from('sectores').select('*').order('nombre')

      if (parcelas && sectores) {
        // Armamos la estructura y CALCULAMOS la superficie productiva sumando sectores
        const estructura = parcelas.map(p => {
            const misSectores = sectores.filter(s => s.parcela_id === p.id)
            const superficieProductiva = misSectores.reduce((acc, s) => acc + (parseFloat(s.superficie_ha) || 0), 0)
            
            return {
                ...p,
                misSectores,
                superficieProductiva: superficieProductiva.toFixed(2) // Redondeo a 2 decimales
            }
        })
        setArbol(estructura)
      }
    } catch (error) {
      console.error(error)
    } finally {
      setLoading(false)
    }
  }

  // --- ACCIONES ---
  const abrirNuevaParcela = () => { setEditParcelaId(null); setModalParcelaOpen(true); }
  const abrirEditarParcela = (id) => { setEditParcelaId(id); setModalParcelaOpen(true); }
  
  const eliminarParcela = async (id, cantidadSectores) => {
    if (cantidadSectores > 0) return alert("‚ùå No puedes borrar una parcela con sectores. Borra los sectores primero.")
    if (!confirm("¬øEliminar esta parcela?")) return
    await supabase.from('parcelas').delete().eq('id', id)
    cargarDatos()
  }

  const abrirNuevoSector = () => { setEditSectorId(null); setModalSectorOpen(true); }
  const abrirEditarSector = (id) => { setEditSectorId(id); setModalSectorOpen(true); }

  const eliminarSector = async (id) => {
    if (!confirm("¬øEliminar sector? Se perder√° su historial.")) return
    const { error } = await supabase.from('sectores').delete().eq('id', id)
    if (error) alert("No se puede eliminar: Tiene datos asociados.")
    else cargarDatos()
  }

  const handleClose = (setOpenFunc) => {
      if (window.intentarCerrarModal) window.intentarCerrarModal()
      else setOpenFunc(false)
  }

  const styles = {
    container: { padding: '20px', width: '90%' },
    header: { display: 'flex', justifyContent: 'flex-start', gap: '20px', alignItems: 'center', marginBottom: '30px' },
    title: { display: 'flex', alignItems: 'center', gap: '10px', fontSize: '1.5rem', fontWeight: 'bold', color: '#1f2937' },
    btnNewParcela: { border:'none', cursor:'pointer', backgroundColor: '#1f2937', color: 'white', padding: '10px 20px', borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '0.9rem' },
    
    parcelaCard: { backgroundColor: 'white', borderRadius: '12px', border: '1px solid #e5e7eb', marginBottom: '25px', overflow: 'hidden', boxShadow: '0 2px 4px rgba(0,0,0,0.05)' },
    parcelaHeader: { backgroundColor: '#f8fafc', padding: '15px 20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', borderBottom: '1px solid #e5e7eb' },
    
    parcelaInfo: { display:'flex', flexDirection:'column' },
    parcelaTitle: { fontSize: '1.1rem', fontWeight: 'bold', color: '#334155', display: 'flex', alignItems: 'center', gap: '8px' },
    parcelaStats: { fontSize: '0.85rem', color: '#64748b', marginTop:'4px', marginLeft:'28px' },

    sectorList: { padding: '0' },
    sectorItem: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '15px 20px', borderBottom: '1px solid #f1f5f9' },
    sectorInfo: { display: 'flex', alignItems: 'center', gap: '10px' },
    badge: { fontSize: '0.75rem', backgroundColor: '#f0fdf4', color: '#15803d', padding: '2px 8px', borderRadius: '10px', fontWeight: '600' },
    
    actions: { display: 'flex', gap: '10px' },
    btnIcon: { background: 'none', border: 'none', cursor: 'pointer', color: '#64748b', padding: '5px' },
    btnAddSector: { border:'none', cursor:'pointer', fontSize: '0.85rem', color: '#2563eb', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '4px', backgroundColor: '#eff6ff', padding: '6px 12px', borderRadius: '6px' }
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><MapPin color="#4b5563" /> Configuraci√≥n del Campo</h1>
        <button onClick={abrirNuevaParcela} style={styles.btnNewParcela}><Plus size={18} /> Nueva Parcela</button>
      </div>

      {arbol.map(p => (
        <div key={p.id} style={styles.parcelaCard}>
            <div style={styles.parcelaHeader}>
                <div style={styles.parcelaInfo}>
                    <div style={styles.parcelaTitle}>
                        <MapPin size={20} color="#059669" /> 
                        {p.nombre} 
                    </div>
                    {/* MOSTRAMOS EL TOTAL PRODUCTIVO VS EL LEGAL */}
                    <div style={styles.parcelaStats}>
                        Superficie Productiva: <b>{p.superficieProductiva} ha</b> (Suma Sectores)
                        {p.superficie_ha > 0 && <span> / Legal: {p.superficie_ha} ha</span>}
                    </div>
                </div>

                <div style={styles.actions}>
                    <button onClick={abrirNuevoSector} style={styles.btnAddSector}><Plus size={14}/> Agregar Sector</button>
                    <button onClick={() => abrirEditarParcela(p.id)} style={styles.btnIcon}><Pencil size={18}/></button>
                    <button onClick={() => eliminarParcela(p.id, p.misSectores.length)} style={{...styles.btnIcon, color:'#ef4444'}}><Trash2 size={18}/></button>
                </div>
            </div>

            <div style={styles.sectorList}>
                {p.misSectores.length === 0 ? (
                    <div style={{padding:'20px', color:'#9ca3af', fontStyle:'italic', fontSize:'0.9rem'}}>No hay sectores registrados en esta parcela.</div>
                ) : (
                    p.misSectores.map(s => (
                        <div key={s.id} style={styles.sectorItem}>
                            <div style={styles.sectorInfo}>
                                <Map size={18} color="#64748b" />
                                <span style={{fontWeight:'600', color:'#1f2937'}}>{s.nombre}</span>
                                
                                <span style={styles.badge}>{s.variedad}</span>
                                <span style={{fontSize:'0.85rem', color:'#64748b', display:'flex', alignItems:'center', gap:'4px'}}>
                                    <Maximize size={12}/> {s.superficie_ha || 0} ha
                                </span>
                                <span style={{fontSize:'0.85rem', color:'#64748b'}}>| {s.cantidad_arboles} plantas</span>
                            </div>
                            <div style={styles.actions}>
                                <button onClick={() => abrirEditarSector(s.id)} style={styles.btnIcon}><Pencil size={16}/></button>
                                <button onClick={() => eliminarSector(s.id)} style={{...styles.btnIcon, color:'#ef4444'}}><Trash2 size={16}/></button>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>
      ))}
      
      {arbol.length === 0 && !loading && <div style={{textAlign:'center', padding:'40px', color:'#6b7280'}}>No hay parcelas creadas. Comienza creando una.</div>}

      <Modal isOpen={modalParcelaOpen} onClose={() => handleClose(setModalParcelaOpen)} title={editParcelaId ? "Editar Parcela" : "Nueva Parcela"}>
          {modalParcelaOpen && <NuevaParcela idParcela={editParcelaId} cerrarModal={() => setModalParcelaOpen(false)} alGuardar={() => { setModalParcelaOpen(false); cargarDatos(); }} />}
      </Modal>

      <Modal isOpen={modalSectorOpen} onClose={() => handleClose(setModalSectorOpen)} title={editSectorId ? "Editar Sector" : "Nuevo Sector"}>
          {modalSectorOpen && <NuevoSector idSector={editSectorId} cerrarModal={() => setModalSectorOpen(false)} alGuardar={() => { setModalSectorOpen(false); cargarDatos(); }} />}
      </Modal>

    </div>
  )
}

export default ConfiguracionCampo


==================================================
RUTA: src\pages\Cosechas.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Sprout, Calendar, User, FileText, Plus, Trash2, Pencil, MapPin, Scale, ChevronDown, ChevronUp } from 'lucide-react'
import Modal from '../components/Modal'
import NuevaCosecha from './NuevaCosecha'

function Cosechas() {
  const [gruposCosechas, setGruposCosechas] = useState({}) // { 'Parcela A': [cosecha1, cosecha2] }
  const [loading, setLoading] = useState(true)
  
  // ESTADOS DEL MODAL
  const [modalOpen, setModalOpen] = useState(false)
  const [editarId, setEditarId] = useState(null)

  // Estado para expandir/colapsar detalles (opcional, por defecto mostramos todo)
  const [expandidos, setExpandidos] = useState({})

  const formatearDinero = (monto) => '$ ' + Math.round(monto).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")
  const formatearFecha = (f) => f ? f.split('-').reverse().join('/') : '-'

  useEffect(() => {
    leerCosechas()
  }, [])

  const abrirCrear = () => { setEditarId(null); setModalOpen(true) }
  const abrirEditar = (id) => { setEditarId(id); setModalOpen(true) }
  
  const cerrarModal = () => {
      if (window.intentarCerrarModal) window.intentarCerrarModal()
      else setModalOpen(false)
  }

  const handleGuardado = () => { setModalOpen(false); leerCosechas() }

  async function leerCosechas() {
    setLoading(true)
    // TRAEMOS TODO: Cosecha, Cliente, Sector, Parcela y DETALLES
    const { data } = await supabase
      .from('cosechas')
      .select(`
        *,
        clientes ( nombre ),
        sectores ( nombre, parcelas ( nombre ) ),
        detalle_cosechas ( calibre, kilos, precio_kilo )
      `)
      .order('fecha', { ascending: false })
    
    if (data) {
        // AGRUPAR POR PARCELA
        const agrupado = data.reduce((acc, item) => {
            const nombreParcela = item.sectores?.parcelas?.nombre || 'Sin Parcela Asignada'
            if (!acc[nombreParcela]) acc[nombreParcela] = []
            acc[nombreParcela].push(item)
            return acc
        }, {})
        setGruposCosechas(agrupado)
    }
    setLoading(false)
  }

  const eliminar = async (id) => {
    if (confirm("¬øEliminar este registro de cosecha y sus detalles?")) {
      await supabase.from('cosechas').delete().eq('id', id)
      leerCosechas()
    }
  }

  const renderBadge = (destino) => {
    const stylesBadge = {
        'Venta': { bg: '#dcfce7', color: '#166534', icon: 'üí∞' },
        'Consumo Interno': { bg: '#ffedd5', color: '#9a3412', icon: 'üè†' },
        'Mermas': { bg: '#fee2e2', color: '#991b1b', icon: 'üóëÔ∏è' }
    }
    const config = stylesBadge[destino] || stylesBadge['Venta']
    
    return (
        <span style={{ backgroundColor: config.bg, color: config.color, padding: '4px 8px', borderRadius: '4px', fontSize: '0.75rem', fontWeight: 'bold', display: 'inline-block', marginBottom: '10px' }}>
            {config.icon} {destino}
        </span>
    )
  }

  const styles = {
    container: { padding: '20px', width: '100%' },
    header: { display: 'flex', justifyContent: 'flex-start', gap: '20px', alignItems: 'center', marginBottom: '30px' },
    title: { display: 'flex', alignItems: 'center', gap: '10px', fontSize: '1.5rem', fontWeight: 'bold', color: '#1f2937' },
    btnNew: { border: 'none', cursor: 'pointer', textDecoration: 'none', backgroundColor: '#16a34a', color: 'white', padding: '10px 20px', borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '0.9rem' },
    
    // Agrupaci√≥n
    parcelaSection: { marginBottom: '40px' },
    parcelaTitle: { fontSize: '1.2rem', fontWeight: 'bold', color: '#374151', borderBottom: '1px solid #e5e7eb', paddingBottom: '10px', marginBottom: '15px', display:'flex', alignItems:'center', gap:'8px' },
    
    // Grid
    grid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: '20px' },
    
    // Tarjeta
    card: { backgroundColor: 'white', borderRadius: '12px', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', border: '1px solid #e5e7eb', overflow:'hidden', display:'flex', flexDirection:'column' },
    cardHeader: { padding: '15px', backgroundColor: '#fff', display:'flex', justifyContent:'space-between', alignItems:'flex-start' },
    
    sectorName: { fontSize: '1rem', fontWeight: 'bold', color: '#16a34a' },
    kilosBig: { fontSize: '1.4rem', fontWeight: 'bold', color: '#1f2937' },
    
    metaRow: { display: 'flex', alignItems: 'center', gap: '6px', fontSize: '0.85rem', color: '#6b7280', marginTop:'4px' },
    
    // Mini Tabla Calibres
    tableContainer: { padding: '0 15px 15px 15px' },
    miniTable: { width: '100%', fontSize: '0.8rem', borderCollapse: 'collapse', backgroundColor: '#f9fafb', borderRadius: '6px', overflow:'hidden' },
    td: { padding: '6px 10px', borderBottom: '1px solid #e5e7eb', color: '#374151' },
    th: { padding: '6px 10px', textAlign: 'left', fontWeight: 'bold', color: '#6b7280', backgroundColor: '#f3f4f6' },
    
    moneyBlock: { marginTop: '10px', paddingTop: '10px', borderTop: '1px dashed #e5e7eb', display:'flex', justifyContent:'space-between', alignItems:'center' },
    
    actions: { display:'flex', gap:'5px' },
    btnIcon: { background:'none', border:'none', cursor:'pointer', color:'#9ca3af', padding:'4px' }
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><Sprout color="#16a34a" /> Registro de Cosechas</h1>
        <button onClick={abrirCrear} style={styles.btnNew}><Plus size={18} /> Nueva Cosecha</button>
      </div>

      {loading && <div style={{padding:'20px', color:'#9ca3af'}}>Cargando registros...</div>}

      {!loading && Object.keys(gruposCosechas).length === 0 && (
          <div style={{textAlign:'center', padding:'40px', color:'#9ca3af', border:'2px dashed #e5e7eb', borderRadius:'12px'}}>
              No hay cosechas registradas.
          </div>
      )}

      {/* ITERAMOS POR PARCELA */}
      {Object.keys(gruposCosechas).sort().map(parcela => (
          <div key={parcela} style={styles.parcelaSection}>
              <h3 style={styles.parcelaTitle}><MapPin size={20} color="#16a34a"/> {parcela}</h3>
              
              <div style={styles.grid}>
                  {gruposCosechas[parcela].map(c => {
                      const totalDinero = (c.kilos || 0) * (c.precio_kilo || 0)
                      return (
                          <div key={c.id} style={styles.card}>
                              <div style={styles.cardHeader}>
                                  <div>
                                      {renderBadge(c.destino)}
                                      <div style={styles.kilosBig}>{c.kilos} Kg</div>
                                      <div style={styles.sectorName}>{c.sectores?.nombre}</div>
                                      <div style={styles.metaRow}><Calendar size={14}/> {formatearFecha(c.fecha)}</div>
                                      
                                      {c.destino === 'Venta' && (
                                          <div style={styles.metaRow}>
                                              <User size={14}/> {c.clientes?.nombre || 'Sin Cliente'}
                                              {c.tipo_documento && <span style={{fontSize:'0.75rem', backgroundColor:'#f3f4f6', padding:'2px 5px', borderRadius:'4px'}}>{c.tipo_documento} {c.nro_documento}</span>}
                                          </div>
                                      )}
                                  </div>
                                  
                                  <div style={styles.actions}>
                                      <button onClick={() => abrirEditar(c.id)} style={styles.btnIcon}><Pencil size={16}/></button>
                                      <button onClick={() => eliminar(c.id)} style={{...styles.btnIcon, color:'#ef4444'}}><Trash2 size={16}/></button>
                                  </div>
                              </div>

                              {/* TABLA DE DETALLES (CALIBRES) */}
                              <div style={styles.tableContainer}>
                                  {c.detalle_cosechas && c.detalle_cosechas.length > 0 ? (
                                      <table style={styles.miniTable}>
                                          <thead>
                                              <tr>
                                                  <th style={styles.th}>Calibre</th>
                                                  <th style={{...styles.th, textAlign:'right'}}>Kg</th>
                                                  {c.destino === 'Venta' && <th style={{...styles.th, textAlign:'right'}}>$</th>}
                                              </tr>
                                          </thead>
                                          <tbody>
                                              {c.detalle_cosechas.map((d, idx) => (
                                                  <tr key={idx}>
                                                      <td style={styles.td}>{d.calibre}</td>
                                                      <td style={{...styles.td, textAlign:'right'}}>{d.kilos}</td>
                                                      {c.destino === 'Venta' && <td style={{...styles.td, textAlign:'right', color:'#16a34a'}}>{formatearDinero(d.precio_kilo)}</td>}
                                                  </tr>
                                              ))}
                                          </tbody>
                                      </table>
                                  ) : (
                                      <div style={{fontSize:'0.8rem', fontStyle:'italic', color:'#9ca3af', padding:'10px 0'}}>Sin detalle de calibres</div>
                                  )}

                                  {/* TOTAL MONETARIO */}
                                  {c.destino === 'Venta' && (
                                      <div style={styles.moneyBlock}>
                                          <span style={{fontSize:'0.85rem', color:'#6b7280'}}>Total Venta</span>
                                          <span style={{fontWeight:'bold', color:'#15803d', fontSize:'1.1rem'}}>{formatearDinero(totalDinero)}</span>
                                      </div>
                                  )}
                                  
                                  {c.comentarios && (
                                      <div style={{fontSize:'0.8rem', color:'#6b7280', marginTop:'10px', fontStyle:'italic'}}>
                                          "{c.comentarios}"
                                      </div>
                                  )}
                              </div>
                          </div>
                      )
                  })}
              </div>
          </div>
      ))}

      <Modal 
        isOpen={modalOpen} 
        onClose={cerrarModal} 
        title={editarId ? "Editar Cosecha" : "Registrar Nueva Cosecha"}
      >
        {modalOpen && (
            <NuevaCosecha 
                idCosecha={editarId} 
                cerrarModal={() => setModalOpen(false)} 
                alGuardar={handleGuardado} 
            />
        )}
      </Modal>

    </div>
  )
}
export default Cosechas


==================================================
RUTA: src\pages\CuentasSocios.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Link } from 'react-router-dom'
import { ArrowRightLeft, Calendar, Plus, Trash2, Pencil } from 'lucide-react' // <--- Import Trash2

function CuentasSocios() {
  const [movimientos, setMovimientos] = useState([])

  const formatearDinero = (monto) => {
    return '$ ' + Math.round(monto).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  const formatearFecha = (fechaString) => {
    if (!fechaString) return '-';
    const [anio, mes, dia] = fechaString.split('-');
    return `${dia}/${mes}/${anio}`;
  }

  useEffect(() => {
    leerMovimientos()
  }, [])

  async function leerMovimientos() {
    const { data, error } = await supabase
      .from('movimientos_billetera')
      .select('*, socios(nombre)')
      .order('fecha', { ascending: false })
    
    if (error) console.log(error)
    else setMovimientos(data)
  }

  // --- FUNCI√ìN ELIMINAR ---
  const eliminarMovimiento = async (id) => {
    if (!confirm("¬øBorrar este movimiento? Se recalcular√° el saldo del socio.")) return;

    const { error } = await supabase
      .from('movimientos_billetera')
      .delete()
      .eq('id', id)

    if (error) {
      alert('Error: ' + error.message)
    } else {
      setMovimientos(prev => prev.filter(m => m.id !== id))
    }
  }

  const styles = {
    container: { padding: '20px' },
    header: { display: 'flex', justifyContent: 'flex-start', gap: '20px', alignItems: 'center', marginBottom: '30px' },
    title: { display: 'flex', alignItems: 'center', gap: '10px', fontSize: '1.5rem', fontWeight: 'bold', color: '#1f2937' },
    btnNew: { textDecoration: 'none', backgroundColor: '#2563eb', color: 'white', padding: '10px 20px', borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '0.9rem' },
    tableContainer: { backgroundColor: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.05)', overflow: 'hidden' },
    table: { width: '100%', borderCollapse: 'collapse', textAlign: 'left' },
    th: { backgroundColor: '#f9fafb', padding: '16px', fontSize: '0.85rem', color: '#6b7280', fontWeight: '600', textTransform: 'uppercase' },
    td: { padding: '16px', borderBottom: '1px solid #f3f4f6', color: '#374151' },
    badgeIngreso: { backgroundColor: '#dcfce7', color: '#166534', padding: '4px 8px', borderRadius: '4px', fontSize: '0.8rem', fontWeight: 'bold' },
    badgeEgreso: { backgroundColor: '#fee2e2', color: '#991b1b', padding: '4px 8px', borderRadius: '4px', fontSize: '0.8rem', fontWeight: 'bold' },
    btnDelete: { background: 'none', border: 'none', cursor: 'pointer', color: '#ef4444', padding: '8px' }
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}>
          <ArrowRightLeft color="#2563eb" /> Cuentas Corrientes
        </h1>
        <Link to="/cuentas-socios/nuevo" style={styles.btnNew}>
          <Plus size={18} /> Registrar Movimiento
        </Link>
      </div>

      <div style={styles.tableContainer}>
        <table style={styles.table}>
          <thead>
            <tr>
              <th style={styles.th}>Fecha</th>
              <th style={styles.th}>Socio</th>
              <th style={styles.th}>Concepto</th>
              <th style={styles.th}>Monto</th>
              <th style={styles.th} width="50"></th>
            </tr>
          </thead>
          <tbody>
            {movimientos.map((mov) => (
              <tr key={mov.id}>
                <td style={styles.td}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                    <Calendar size={14} color="#9ca3af" />
                    {formatearFecha(mov.fecha)}
                  </div>
                </td>
                <td style={styles.td}>
                  <strong>{mov.socios?.nombre}</strong>
                </td>
                <td style={styles.td}>
                   <span style={mov.monto >= 0 ? styles.badgeIngreso : styles.badgeEgreso}>
                     {mov.tipo}
                   </span>
                   <div style={{fontSize: '0.85rem', color: '#6b7280', marginTop: '4px'}}>{mov.descripcion}</div>
                </td>
                <td style={{ ...styles.td, fontWeight: 'bold', color: mov.monto >= 0 ? '#16a34a' : '#dc2626' }}>
                  {formatearDinero(mov.monto)}
                </td>
                <td style={styles.td}>
                  <div style={{ display: 'flex', gap: '10px' }}>
                    {/* Bot√≥n Editar */}
                    <Link to={`/cuentas-socios/editar/${mov.id}`} style={{ color: '#2563eb' }} title="Editar">
                      <Pencil size={18} />
                    </Link>

                    {/* Bot√≥n Eliminar (Ya lo ten√≠as) */}
                    <button 
                      style={styles.btnDelete}
                      onClick={() => eliminarMovimiento(mov.id)}
                      title="Eliminar movimiento"
                    >
                      <Trash2 size={18} />
                    </button>
                  </div>
                </td>
              </tr>
            ))}
            
            {movimientos.length === 0 && (
              <tr>
                <td colSpan="5" style={{ padding: '40px', textAlign: 'center', color: '#9ca3af' }}>
                  No hay movimientos registrados.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  )
}

export default CuentasSocios


==================================================
RUTA: src\pages\Dashboard.jsx
==================================================
import { useState } from 'react'
import { LayoutDashboard, Wallet, Sprout, CalendarClock } from 'lucide-react'

// Importamos los sub-componentes (aseg√∫rate de haber renombrado los archivos como acordamos)
import DashboardSectores from './DashboardSectores' // Antes ComparativoSectores.jsx
import DashboardFinanzas from './DashboardFinanzas' // Antes Finanzas_______.jsx
import ResumenCosechas from './ResumenCosechas'     // Reutilizamos el resumen existente
import Labores from './Labores'                     // Reutilizamos la vista de labores

function Dashboard() {
  const [activeTab, setActiveTab] = useState('sectores')

  // Definici√≥n de las pesta√±as
  const tabs = [
    { id: 'sectores', label: 'Sectores', icon: <LayoutDashboard size={18} /> },
    { id: 'finanzas', label: 'Finanzas', icon: <Wallet size={18} /> },
    { id: 'cosecha', label: 'Cosecha', icon: <Sprout size={18} /> },
    { id: 'trabajos', label: 'Trabajos', icon: <CalendarClock size={18} /> },
  ]

  // Renderizado condicional seg√∫n la pesta√±a activa
  const renderContent = () => {
    switch (activeTab) {
      case 'sectores':
        return <DashboardSectores />
      case 'finanzas':
        return <DashboardFinanzas />
      case 'cosecha':
        // Pasamos una prop opcional si quieres que se comporte diferente dentro del dashboard
        return <ResumenCosechas isDashboardView={true} /> 
      case 'trabajos':
        // Mostramos labores pero quiz√°s en modo "solo lectura" o vista simplificada si prefieres
        return <Labores isDashboardView={true} />
      default:
        return <DashboardSectores />
    }
  }

  const styles = {
    container: {
      maxWidth: '1200px',
      margin: '0 auto',
      paddingBottom: '40px'
    },
    header: {
      marginBottom: '25px'
    },
    title: {
      fontSize: '1.8rem',
      fontWeight: 'bold',
      color: '#111827',
      marginBottom: '5px'
    },
    subtitle: {
      color: '#6b7280',
      fontSize: '0.95rem'
    },
    tabsContainer: {
      display: 'flex',
      gap: '10px',
      borderBottom: '1px solid #e5e7eb',
      marginBottom: '30px',
      overflowX: 'auto', // Para que sea responsivo en m√≥viles
      paddingBottom: '2px'
    },
    tab: (isActive) => ({
      display: 'flex',
      alignItems: 'center',
      gap: '8px',
      padding: '10px 20px',
      cursor: 'pointer',
      fontSize: '0.95rem',
      fontWeight: isActive ? '600' : '500',
      color: isActive ? '#2563eb' : '#4b5563',
      // CORRECCI√ìN AQU√ç: Usar propiedades expl√≠citas en lugar de 'border: none'
      borderTop: 'none',
      borderLeft: 'none',
      borderRight: 'none',
      borderBottom: isActive ? '2px solid #2563eb' : '2px solid transparent',
      transition: 'all 0.2s ease',
      backgroundColor: 'transparent',
      outline: 'none',
      whiteSpace: 'nowrap'
    }),
    contentArea: {
      animation: 'fadeIn 0.3s ease-in-out'
    }
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}>Panel de Control</h1>
        <p style={styles.subtitle}>Visi√≥n general del estado de tu campo</p>
      </div>

      {/* Navegaci√≥n por Pesta√±as */}
      <div style={styles.tabsContainer}>
        {tabs.map((tab) => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            style={styles.tab(activeTab === tab.id)}
          >
            {tab.icon}
            {tab.label}
          </button>
        ))}
      </div>

      {/* √Årea de Contenido Din√°mico */}
      <div style={styles.contentArea}>
        {renderContent()}
      </div>
      
      {/* Estilo global para la animaci√≥n simple */}
      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(5px); }
          to { opacity: 1; transform: translateY(0); }
        }
      `}</style>
    </div>
  )
}

export default Dashboard

==================================================
RUTA: src\pages\DashboardFinanzas.jsx
==================================================
import React, { useState, useEffect } from 'react';
import Sidebar from '../components/Sidebar'; // Si usas el layout en App.jsx, podr√≠as quitar esto, pero por seguridad d√©jalo o ad√°ptalo.
import { supabase } from '../supabaseClient';
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
  PieChart, Pie, Cell
} from 'recharts';
import { DollarSign, TrendingUp, TrendingDown, AlertCircle } from 'lucide-react';

export default function Finanzas() {
  const [loading, setLoading] = useState(true);
  const [kpis, setKpis] = useState({
    ingresosTotales: 0,
    gastosTotales: 0,
    utilidad: 0,
    margen: 0
  });
  const [datosGrafico, setDatosGrafico] = useState([]);
  const [gastosPorCat, setGastosPorCat] = useState([]);

  // Colores para gr√°ficos
  const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8'];

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    setLoading(true);
    try {
      // 1. Obtener Gastos (Egresos)
      const { data: gastos, error: errGastos } = await supabase
        .from('gastos')
        .select('*');
      
      if (errGastos) throw errGastos;

      // 2. Obtener Cosechas y sus detalles (Ingresos)
      // Nota: Asumimos que calculamos ingresos sumando (kilos * precio) de los detalles
      // Si tu l√≥gica es diferente, ajusta aqu√≠.
      const { data: detallesCosecha, error: errCosechas } = await supabase
        .from('detalle_cosechas')
        .select('*, cosechas(fecha)');

      if (errCosechas) throw errCosechas;

      // --- PROCESAMIENTO DE DATOS ---

      // A. Calcular Total Gastos
      const totalGastos = gastos.reduce((sum, g) => sum + Number(g.monto), 0);

      // B. Calcular Total Ingresos (Kilos * Precio Unitario)
      const totalIngresos = detallesCosecha.reduce((sum, d) => {
        return sum + (Number(d.kilos_reales || 0) * Number(d.precio_unitario || 0));
      }, 0);

      // C. Preparar datos para Gr√°fico Mensual
      // Agrupamos por mes para ver la evoluci√≥n
      const movimientosPorMes = {};

      // Sumar Gastos al mes correspondiente
      gastos.forEach(g => {
        const mes = g.fecha.substring(0, 7); // "2023-10"
        if (!movimientosPorMes[mes]) movimientosPorMes[mes] = { name: mes, ingresos: 0, gastos: 0 };
        movimientosPorMes[mes].gastos += Number(g.monto);
      });

      // Sumar Ingresos al mes correspondiente
      detallesCosecha.forEach(d => {
        if (d.cosechas?.fecha) {
          const mes = d.cosechas.fecha.substring(0, 7);
          if (!movimientosPorMes[mes]) movimientosPorMes[mes] = { name: mes, ingresos: 0, gastos: 0 };
          movimientosPorMes[mes].ingresos += (Number(d.kilos_reales || 0) * Number(d.precio_unitario || 0));
        }
      });

      // Convertir objeto a array y ordenar
      const dataGraficoArray = Object.values(movimientosPorMes).sort((a, b) => a.name.localeCompare(b.name));

      // D. Gastos por Categor√≠a (Para gr√°fico de torta)
      const catMap = {};
      gastos.forEach(g => {
        const cat = g.categoria || 'Sin Categor√≠a';
        if (!catMap[cat]) catMap[cat] = 0;
        catMap[cat] += Number(g.monto);
      });
      const dataPieArray = Object.keys(catMap).map(k => ({ name: k, value: catMap[k] }));

      // Guardar estados
      setKpis({
        ingresosTotales: totalIngresos,
        gastosTotales: totalGastos,
        utilidad: totalIngresos - totalGastos,
        margen: totalIngresos > 0 ? ((totalIngresos - totalGastos) / totalIngresos) * 100 : 0
      });
      setDatosGrafico(dataGraficoArray);
      setGastosPorCat(dataPieArray);

    } catch (error) {
      console.error("Error cargando finanzas:", error);
    } finally {
      setLoading(false);
    }
  };

  // Helper para formato moneda
  const fmt = (num) =>  new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(num);

  return (
    <div style={{ paddingBottom: '40px' }}>
        {/* Si usas Sidebar en App.jsx, aqu√≠ solo necesitas el contenido */}
        <div style={{ marginBottom: '30px' }}>
          <h1 style={{ fontSize: '1.8rem', fontWeight: 'bold', color: '#111827', margin: 0 }}>An√°lisis Financiero</h1>
          <p style={{ color: '#6b7280' }}>Rentabilidad, flujo de caja y distribuci√≥n de gastos.</p>
        </div>

        {/* TARJETAS DE RESUMEN (KPIs) */}
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))', gap: '20px', marginBottom: '30px' }}>
            
            <div style={{ background: 'white', padding: '20px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' }}>
                    <div style={{ background: '#dcfce7', p: '8px', borderRadius: '8px', color: '#16a34a' }}><TrendingUp size={24}/></div>
                    <span style={{ color: '#6b7280', fontWeight: '500' }}>Ingresos Totales</span>
                </div>
                <div style={{ fontSize: '1.8rem', fontWeight: 'bold', color: '#111827' }}>{fmt(kpis.ingresosTotales)}</div>
            </div>

            <div style={{ background: 'white', padding: '20px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' }}>
                    <div style={{ background: '#fee2e2', p: '8px', borderRadius: '8px', color: '#dc2626' }}><TrendingDown size={24}/></div>
                    <span style={{ color: '#6b7280', fontWeight: '500' }}>Gastos Totales</span>
                </div>
                <div style={{ fontSize: '1.8rem', fontWeight: 'bold', color: '#111827' }}>{fmt(kpis.gastosTotales)}</div>
            </div>

            <div style={{ background: 'white', padding: '20px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' }}>
                    <div style={{ background: '#e0e7ff', p: '8px', borderRadius: '8px', color: '#4f46e5' }}><DollarSign size={24}/></div>
                    <span style={{ color: '#6b7280', fontWeight: '500' }}>Utilidad Neta</span>
                </div>
                <div style={{ fontSize: '1.8rem', fontWeight: 'bold', color: kpis.utilidad >= 0 ? '#16a34a' : '#dc2626' }}>
                    {fmt(kpis.utilidad)}
                </div>
                <div style={{ fontSize: '0.9rem', color: kpis.margen >= 0 ? '#16a34a' : '#dc2626' }}>
                    {kpis.margen.toFixed(1)}% Margen
                </div>
            </div>

        </div>

        {/* GR√ÅFICOS */}
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '20px' }}>
            
            {/* Flujo de Caja Mensual */}
            <div style={{ background: 'white', padding: '20px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                <h3 style={{ fontSize: '1.1rem', fontWeight: 'bold', marginBottom: '20px', color: '#374151' }}>Flujo de Caja (Ingresos vs Gastos)</h3>
                <div style={{ width: '100%', height: '300px' }}> {/* <--- IMPORTANTE: height fijo */}
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={datosGrafico}>
                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                            <XAxis dataKey="name" />
                            <YAxis />
                            <Tooltip formatter={(value) => fmt(value)} />
                            <Legend />
                            <Bar dataKey="ingresos" name="Ingresos" fill="#10b981" radius={[4, 4, 0, 0]} />
                            <Bar dataKey="gastos" name="Gastos" fill="#ef4444" radius={[4, 4, 0, 0]} />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            </div>

            {/* Distribuci√≥n de Gastos */}
            <div style={{ background: 'white', padding: '20px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                <h3 style={{ fontSize: '1.1rem', fontWeight: 'bold', marginBottom: '20px', color: '#374151' }}>Distribuci√≥n de Gastos</h3>
                <div style={{ width: '100%', height: '300px' }}> {/* <--- IMPORTANTE: height fijo */}
                    <ResponsiveContainer width="100%" height="100%">
                        <PieChart>
                            <Pie
                                data={gastosPorCat}
                                cx="50%"
                                cy="50%"
                                labelLine={false}
                                label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                                outerRadius={100}
                                fill="#8884d8"
                                dataKey="value"
                            >
                                {gastosPorCat.map((entry, index) => (
                                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                ))}
                            </Pie>
                            <Tooltip formatter={(value) => fmt(value)} />
                        </PieChart>
                    </ResponsiveContainer>
                </div>
            </div>

        </div>
    </div>
  );
}

==================================================
RUTA: src\pages\DashboardSectores.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
// CORRECCI√ìN 1: Quitamos 'Map' de los imports para no romper el Map de JavaScript
import { Droplets, Shovel, TrendingUp, MapPin } from 'lucide-react'

function ComparativoSectores() {
  const [grupos, setGrupos] = useState({}) 
  const [loading, setLoading] = useState(true)

  const formatearFecha = (f) => f ? f.split('-').reverse().join('/') : '-'
  const formatearNumero = (n) => n ? parseInt(n).toLocaleString('es-CL') : '0'

  useEffect(() => {
    async function cargarTodo() {
      // 1. Cargar Sectores
      const { data: sectores } = await supabase.from('sectores').select('*, parcelas(nombre)').order('nombre')
      if (!sectores) return setLoading(false)

      // 2. Cargar Datos Relacionados
      const promesas = sectores.map(async (sector) => {
          // CORRECCI√ìN 2: Usamos .maybeSingle() en vez de .single() para evitar error 406 si no hay riego
          const { data: riego } = await supabase
            .from('programas_riego')
            .select('*')
            .eq('sector_id', sector.id)
            .is('fecha_fin', null)
            .maybeSingle() 

          const { data: labores } = await supabase.from('labores_campo').select('*').eq('sector_id', sector.id).order('fecha', { ascending: false }).limit(10)
          const { data: cosechas } = await supabase.from('cosechas').select('kilos').eq('sector_id', sector.id)
          const totalKilos = cosechas?.reduce((sum, c) => sum + (c.kilos || 0), 0) || 0

          return { ...sector, riego, labores: labores || [], produccionTotal: totalKilos }
      })

      const resultados = await Promise.all(promesas)

      // 3. Agrupar por Parcela y CALCULAR "EVENTOS MAESTROS"
      const agrupado = resultados.reduce((acc, sector) => {
          const nombreParcela = sector.parcelas?.nombre || 'Sin Parcela'
          if (!acc[nombreParcela]) {
              acc[nombreParcela] = {
                  sectores: [],
                  eventosMaestros: [] 
              }
          }
          acc[nombreParcela].sectores.push(sector)
          return acc
      }, {})

      // 4. GENERAR LA MATRIZ DE ALINEACI√ìN POR PARCELA
      Object.keys(agrupado).forEach(parcela => {
          const todosLosEventos = []
          agrupado[parcela].sectores.forEach(sec => {
              sec.labores.forEach(lab => {
                  todosLosEventos.push({ 
                      uniqueKey: `${lab.fecha}-${lab.tipo_labor}`, 
                      fecha: lab.fecha, 
                      tipo: lab.tipo_labor 
                  })
              })
          })

          // Eliminar duplicados (Misma fecha y tipo cuenta como 1 evento maestro)
          // AHORA ESTO FUNCIONAR√Å PORQUE 'Map' YA ES EL DE JAVASCRIPT, NO EL ICONO
          const eventosUnicos = Array.from(new Map(todosLosEventos.map(item => [item.uniqueKey, item])).values())
          
          // Ordenar por fecha descendente y tomar los √∫ltimos 3
          eventosUnicos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
          agrupado[parcela].eventosMaestros = eventosUnicos.slice(0, 3)
      })

      setGrupos(agrupado)
      setLoading(false)
    }
    cargarTodo()
  }, [])

  const styles = {
    container: { padding: '20px', width: '100%', boxSizing: 'border-box' },
    header: { marginBottom: '30px' },
    title: { fontSize: '1.8rem', fontWeight: 'bold', color: '#1f2937' },
    
    grupoContainer: { marginBottom: '40px' },
    grupoTitle: { fontSize: '1.3rem', fontWeight: 'bold', color: '#059669', marginBottom: '15px', borderBottom: '2px solid #e2e8f0', paddingBottom: '5px', display:'flex', alignItems:'center', gap:'10px' },
    
    cardGrid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: '20px' },

    card: { backgroundColor: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.05)', border: '1px solid #e5e7eb', overflow: 'hidden', display:'flex', flexDirection:'column' },
    cardHeader: { padding: '15px', backgroundColor: '#f8fafc', borderBottom: '1px solid #e2e8f0' },
    sectorName: { fontSize: '1.1rem', fontWeight: 'bold', color: '#1f2937', margin: 0 },
    cardBody: { padding: '15px', display: 'flex', flexDirection: 'column', gap: '15px', flex: 1 },
    
    section: { borderBottom: '1px solid #f1f5f9', paddingBottom: '10px' },
    sectionTitle: { fontSize: '0.8rem', fontWeight: 'bold', color: '#64748b', textTransform: 'uppercase', marginBottom: '5px', display:'flex', alignItems:'center', gap:'5px' },
    
    tagRiego: { backgroundColor: '#e0f2fe', color: '#0284c7', padding: '6px', borderRadius: '6px', fontSize: '0.9rem', fontWeight: 'bold', textAlign: 'center' },
    
    // Estilos para la labor
    laborRow: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: '0.8rem', padding: '6px', marginBottom: '4px', borderRadius: '6px', height: '20px' }, 
    laborActive: { backgroundColor: '#fffbeb', border: '1px solid #fef3c7', color: '#92400e' },
    laborEmpty: { visibility: 'hidden' } 
  }

  if (loading) return <div style={{padding:'20px'}}>Cargando...</div>

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}>Estado del Campo</h1>
      </div>

      {Object.keys(grupos).sort().map(parcela => {
          const { sectores, eventosMaestros } = grupos[parcela]
          
          return (
            <div key={parcela} style={styles.grupoContainer}>
                <h2 style={styles.grupoTitle}><MapPin size={24}/> {parcela}</h2>
                <div style={styles.cardGrid}>
                    {sectores.map(s => (
                        <div key={s.id} style={styles.card}>
                            <div style={styles.cardHeader}>
                                <div style={styles.sectorName}>{s.nombre}</div>
                                <div style={{fontSize:'0.85rem', color:'#64748b'}}>{s.cantidad_arboles} √Årb. | {s.variedad}</div>
                            </div>
                            <div style={styles.cardBody}>
                                {/* RIEGO */}
                                <div style={styles.section}>
                                    <div style={styles.sectionTitle}><Droplets size={14}/> Riego</div>
                                    {s.riego ? (
                                        <div style={styles.tagRiego}>{s.riego.frecuencia} ({s.riego.duracion_minutos} min)</div>
                                    ) : <div style={{...styles.tagRiego, backgroundColor:'#f1f5f9', color:'#94a3b8'}}>Inactivo</div>}
                                </div>
                                {/* PRODUCCI√ìN */}
                                <div style={styles.section}>
                                    <div style={styles.sectionTitle}><TrendingUp size={14}/> Producci√≥n</div>
                                    <div style={{textAlign:'center', fontWeight:'bold', color:'#16a34a', fontSize:'1.2rem'}}>{formatearNumero(s.produccionTotal)} Kg</div>
                                </div>
                                {/* LABORES ALINEADAS */}
                                <div style={{...styles.section, borderBottom:'none', flex: 1}}>
                                    <div style={styles.sectionTitle}><Shovel size={14}/> Actividad Reciente</div>
                                    
                                    {eventosMaestros.length === 0 ? (
                                        <div style={{fontStyle:'italic', fontSize:'0.8rem', color:'#cbd5e1'}}>Sin actividad</div>
                                    ) : (
                                        eventosMaestros.map((evt, idx) => {
                                            const miLabor = s.labores.find(l => l.fecha === evt.fecha && l.tipo_labor === evt.tipo)
                                            
                                            if (miLabor) {
                                                return (
                                                    <div key={idx} style={{...styles.laborRow, ...styles.laborActive}}>
                                                        <strong>{miLabor.tipo_labor}</strong> 
                                                        <span style={{opacity:0.8}}>{formatearFecha(miLabor.fecha)}</span>
                                                    </div>
                                                )
                                            } else {
                                                return (
                                                    <div key={idx} style={{...styles.laborRow, ...styles.laborEmpty}}>
                                                        <strong>Espacio</strong>
                                                    </div>
                                                )
                                            }
                                        })
                                    )}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
          )
      })}
    </div>
  )
}
export default ComparativoSectores


==================================================
RUTA: src\pages\DetalleSector.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { useParams, useNavigate } from 'react-router-dom'
import { Map, Droplets, Shovel, Sprout, ArrowLeft, Calendar, TrendingUp } from 'lucide-react'

function DetalleSector() {
  const { id } = useParams()
  const navigate = useNavigate()
  const [sector, setSector] = useState(null)
  const [programaRiego, setProgramaRiego] = useState(null)
  const [labores, setLabores] = useState([])
  const [cosechas, setCosechas] = useState([])
  const [loading, setLoading] = useState(true)

  const formatearFecha = (f) => f ? f.split('-').reverse().join('/') : '-'
  const formatearNumero = (n) => n ? parseInt(n).toLocaleString('es-CL') : '0'

  useEffect(() => {
    async function cargarDatos() {
      if (!id) return

      // 1. Datos del Sector
      const { data: sec } = await supabase.from('sectores').select('*, parcelas(nombre)').eq('id', id).single()
      setSector(sec)

      // 2. Programa de Riego ACTIVO
      const { data: prog } = await supabase
        .from('programas_riego')
        .select('*')
        .eq('sector_id', id)
        .is('fecha_fin', null) // Solo el vigente
        .single()
      setProgramaRiego(prog)

      // 3. √öltimas 5 Labores
      const { data: lab } = await supabase
        .from('labores_campo')
        .select('*')
        .eq('sector_id', id)
        .order('fecha', { ascending: false })
        .limit(5)
      setLabores(lab || [])

      // 4. Historial Cosechas
      const { data: cos } = await supabase
        .from('cosechas')
        .select('*')
        .eq('sector_id', id)
        .order('fecha', { ascending: false })
      setCosechas(cos || [])

      setLoading(false)
    }
    cargarDatos()
  }, [id])

  if (loading) return <div style={{padding:'40px', textAlign:'center'}}>Cargando ficha...</div>
  if (!sector) return <div style={{padding:'40px', textAlign:'center'}}>Sector no encontrado.</div>

  // C√°lculos r√°pidos
  const totalKilosHistorico = cosechas.reduce((sum, c) => sum + (Number(c.kilos) || 0), 0)
  const rendimientoPromedio = sector.cantidad_arboles > 0 ? (totalKilosHistorico / sector.cantidad_arboles).toFixed(1) : 0

  const styles = {
    container: { padding: '20px', width: '100%', boxSizing: 'border-box' },
    header: { marginBottom: '30px' },
    backBtn: { display: 'flex', alignItems: 'center', gap: '5px', background: 'none', border: 'none', color: '#6b7280', cursor: 'pointer', marginBottom: '10px', fontSize: '0.9rem' },
    title: { fontSize: '2rem', fontWeight: 'bold', color: '#1f2937', margin: 0 },
    subtitle: { color: '#6b7280', fontSize: '1.1rem', marginTop: '5px' },
    
    grid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '20px', marginBottom: '30px' },
    card: { backgroundColor: 'white', padding: '25px', borderRadius: '12px', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', border: '1px solid #e5e7eb' },
    cardTitle: { display: 'flex', alignItems: 'center', gap: '10px', fontSize: '1.1rem', fontWeight: 'bold', color: '#374151', marginBottom: '15px', borderBottom: '1px solid #f3f4f6', paddingBottom: '10px' },
    
    dataRow: { display: 'flex', justifyContent: 'space-between', marginBottom: '10px', fontSize: '0.95rem' },
    dataLabel: { color: '#6b7280' },
    dataValue: { fontWeight: '600', color: '#1f2937' },
    
    // Lista simple
    list: { listStyle: 'none', padding: 0, margin: 0 },
    listItem: { padding: '10px 0', borderBottom: '1px solid #f3f4f6', fontSize: '0.9rem' },
    empty: { fontStyle: 'italic', color: '#9ca3af', fontSize: '0.9rem' },

    badgeRiego: { backgroundColor: '#e0f2fe', color: '#0284c7', padding: '4px 8px', borderRadius: '6px', fontWeight: 'bold', fontSize: '0.9rem', display: 'inline-block', marginTop: '5px' }
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <button onClick={() => navigate('/sectores')} style={styles.backBtn}><ArrowLeft size={16} /> Volver a Sectores</button>
        <h1 style={styles.title}>{sector.nombre}</h1>
        <div style={styles.subtitle}>{sector.parcelas?.nombre} ‚Äî {sector.variedad}</div>
      </div>

      <div style={styles.grid}>
        
        {/* TARJETA 1: DATOS T√âCNICOS */}
        <div style={styles.card}>
            <div style={styles.cardTitle}><Map size={20} color="#059669"/> Ficha T√©cnica</div>
            <div style={styles.dataRow}>
                <span style={styles.dataLabel}>√Årboles</span>
                <span style={styles.dataValue}>{sector.cantidad_arboles} un.</span>
            </div>
            <div style={styles.dataRow}>
                <span style={styles.dataLabel}>A√±o Plantaci√≥n</span>
                <span style={styles.dataValue}>{sector.anio_plantacion}</span>
            </div>
            <div style={styles.dataRow}>
                <span style={styles.dataLabel}>Rendimiento Hist√≥rico</span>
                <span style={{...styles.dataValue, color: '#16a34a'}}>{rendimientoPromedio} Kg/√°rbol</span>
            </div>
        </div>

        {/* TARJETA 2: RIEGO ACTUAL */}
        <div style={styles.card}>
            <div style={styles.cardTitle}><Droplets size={20} color="#0ea5e9"/> Riego Vigente</div>
            {programaRiego ? (
                <div>
                    <div style={{fontSize:'1.2rem', fontWeight:'bold', color:'#0284c7'}}>{programaRiego.frecuencia}</div>
                    <div style={styles.dataRow}>
                        <span style={styles.dataLabel}>Duraci√≥n:</span>
                        <span style={styles.dataValue}>{programaRiego.duracion_minutos} min</span>
                    </div>
                    <div style={styles.dataRow}>
                        <span style={styles.dataLabel}>Desde:</span>
                        <span style={styles.dataValue}>{formatearFecha(programaRiego.fecha_inicio)}</span>
                    </div>
                    {programaRiego.comentarios && (
                        <div style={{fontStyle:'italic', color:'#6b7280', fontSize:'0.9rem', marginTop:'10px'}}>"{programaRiego.comentarios}"</div>
                    )}
                </div>
            ) : (
                <div style={styles.empty}>No hay programa activo.</div>
            )}
        </div>
      </div>

      <div style={styles.grid}>
          {/* LISTA: HISTORIAL LABORES */}
          <div style={styles.card}>
              <div style={styles.cardTitle}><Shovel size={20} color="#d97706"/> √öltimas Labores</div>
              <ul style={styles.list}>
                  {labores.map(l => (
                      <li key={l.id} style={styles.listItem}>
                          <div style={{fontWeight:'bold', color:'#d97706'}}>{l.tipo_labor}</div>
                          <div style={{display:'flex', justifyContent:'space-between', color:'#6b7280', fontSize:'0.85rem'}}>
                              <span>{formatearFecha(l.fecha)}</span>
                              {l.costo_mo > 0 && <span>${formatearNumero(l.costo_mo)}</span>}
                          </div>
                          {l.insumos_usados && <div style={{fontSize:'0.85rem', color:'#374151'}}>Insumos: {l.insumos_usados}</div>}
                      </li>
                  ))}
                  {labores.length === 0 && <div style={styles.empty}>Sin registros recientes.</div>}
              </ul>
              <button onClick={() => navigate('/labores/nuevo')} style={{marginTop:'15px', background:'none', border:'none', color:'#2563eb', cursor:'pointer', fontWeight:'bold'}}>+ Registrar Labor</button>
          </div>

          {/* LISTA: PRODUCCI√ìN */}
          <div style={styles.card}>
              <div style={styles.cardTitle}><TrendingUp size={20} color="#16a34a"/> Producci√≥n Reciente</div>
              <div style={{marginBottom:'15px'}}>
                  <span style={{fontSize:'0.9rem', color:'#6b7280'}}>Total Acumulado: </span>
                  <span style={{fontWeight:'bold', fontSize:'1.1rem', color:'#16a34a'}}>{formatearNumero(totalKilosHistorico)} Kg</span>
              </div>
              <ul style={styles.list}>
                  {cosechas.map(c => (
                      <li key={c.id} style={styles.listItem}>
                          <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                              <span style={{fontWeight:'bold', color:'#374151'}}>{formatearNumero(c.kilos)} Kg</span>
                              <span style={{fontSize:'0.8rem', backgroundColor: c.destino==='Venta'?'#dcfce7':'#fee2e2', color: c.destino==='Venta'?'#166534':'#991b1b', padding:'2px 6px', borderRadius:'4px'}}>{c.destino}</span>
                          </div>
                          <div style={{color:'#6b7280', fontSize:'0.85rem'}}>{formatearFecha(c.fecha)}</div>
                      </li>
                  ))}
                  {cosechas.length === 0 && <div style={styles.empty}>Sin cosechas registradas.</div>}
              </ul>
          </div>
      </div>

    </div>
  )
}

export default DetalleSector


==================================================
RUTA: src\pages\Gastos.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Link } from 'react-router-dom'
import { Wallet, Plus, Trash2, Pencil, Clock, CheckCircle, AlertCircle } from 'lucide-react'
import Modal from '../components/Modal'
import NuevoGasto from './NuevoGasto'

function Gastos() {
  const [gastos, setGastos] = useState([]) // Lista de documentos (Padres)
  const [cuotasPendientes, setCuotasPendientes] = useState([]) // Lista aplanada de cuotas POR PAGAR
  const [cuotasPagadas, setCuotasPagadas] = useState([]) // Lista aplanada de cuotas YA PAGADAS
  
  const [filtro, setFiltro] = useState('Todos') // 'Todos', 'Pendiente', 'Pagado'

  // --- ESTADO DEL MODAL ---
  const [modalOpen, setModalOpen] = useState(false)
  const [gastoEditarId, setGastoEditarId] = useState(null)

  const formatearDinero = (monto) => '$ ' + Math.round(monto).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")
  const formatearFecha = (f) => f ? f.split('-').reverse().join('/') : '-'

  useEffect(() => {
    leerGastos()
  }, [])

  // --- FUNCIONES DEL MODAL ---
  const abrirModalCrear = () => {
    setGastoEditarId(null)
    setModalOpen(true)
  }

  const abrirModalEditar = (id) => {
    setGastoEditarId(id)
    setModalOpen(true)
  }

  // Intenta cerrar el modal (si el formulario tiene cambios, el formulario hijo preguntar√°)
  const handleCloseRequest = () => {
    if (window.intentarCerrarModal) {
        window.intentarCerrarModal() 
    } else {
        setModalOpen(false)
    }
  }

  const handleGuardadoExitoso = () => {
    setModalOpen(false)
    leerGastos() // Recargamos la lista para ver los cambios
  }

  // --- CARGA DE DATOS ---
  async function leerGastos() {
    // CONSULTA EXPANDIDA: Traemos parcelas y subcategor√≠as tambi√©n
    const { data: dataDocs, error } = await supabase
      .from('gastos')
      .select(`
        *,
        proveedores ( nombre ),
        categorias_gastos ( nombre ),
        subcategorias_gastos ( nombre ),
        parcelas ( nombre ),
        pagos_gastos ( * ) 
      `) 
      .order('fecha', { ascending: false })
      
    if (!error) {
      setGastos(dataDocs)
      
      let pendientes = []
      let pagadas = []

      dataDocs.forEach(doc => {
         // Verificamos si tiene desglose de pagos (Hijos)
         if (doc.pagos_gastos && doc.pagos_gastos.length > 0) {
            
            // A) Procesar PENDIENTES
            const hijosPendientes = doc.pagos_gastos.filter(p => p.estado === 'Pendiente')
            hijosPendientes.forEach(hijo => {
               pendientes.push({
                  tipo: 'cuota',
                  id: hijo.id,
                  padreId: doc.id,
                  fecha: hijo.fecha_vencimiento,
                  proveedor: doc.proveedores?.nombre,
                  docInfo: `${doc.tipo_documento} ${doc.nro_documento}`,
                  categoria: doc.categorias_gastos?.nombre,
                  subcat: doc.subcategorias_gastos?.nombre,
                  parcela: doc.parcelas?.nombre,
                  detalle: `Cuota del ${formatearFecha(doc.fecha)} (${doc.descripcion})`,
                  monto: hijo.monto
               })
            })

            // B) Procesar PAGADAS
            const hijosPagados = doc.pagos_gastos.filter(p => p.estado === 'Pagado')
            hijosPagados.forEach(hijo => {
               pagadas.push({
                  tipo: 'cuota',
                  id: hijo.id,
                  padreId: doc.id,
                  fecha: hijo.fecha_vencimiento,
                  proveedor: doc.proveedores?.nombre,
                  docInfo: `${doc.tipo_documento} ${doc.nro_documento}`,
                  categoria: doc.categorias_gastos?.nombre,
                  subcat: doc.subcategorias_gastos?.nombre,
                  parcela: doc.parcelas?.nombre,
                  detalle: `Cuota Pagada (${doc.descripcion})`,
                  monto: hijo.monto
               })
            })

         } else {
            // Si NO tiene hijos (Gastos antiguos o simples)
            const itemSimple = {
               tipo: 'doc',
               id: doc.id,
               padreId: doc.id,
               fecha: doc.fecha_vencimiento || doc.fecha,
               proveedor: doc.proveedores?.nombre,
               docInfo: `${doc.tipo_documento} ${doc.nro_documento || ''}`,
               categoria: doc.categorias_gastos?.nombre,
               subcat: doc.subcategorias_gastos?.nombre,
               parcela: doc.parcelas?.nombre,
               detalle: doc.descripcion,
               monto: doc.monto
            }

            if (doc.estado_pago === 'Pendiente') {
                pendientes.push(itemSimple)
            } else if (doc.estado_pago === 'Pagado') {
                pagadas.push(itemSimple)
            }
         }
      })

      // Ordenar
      pendientes.sort((a, b) => new Date(a.fecha) - new Date(b.fecha))
      pagadas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))

      setCuotasPendientes(pendientes)
      setCuotasPagadas(pagadas)
    }
  }

  const eliminarGasto = async (id) => {
    if (confirm("¬øEliminar documento y sus pagos?")) {
      await supabase.from('gastos').delete().eq('id', id)
      leerGastos() 
    }
  }

  const totalDeudaReal = cuotasPendientes.reduce((acc, item) => acc + Number(item.monto), 0)

  // --- LOGICA DE RENDERIZADO (Filas de la tabla) ---
  const renderContenido = () => {
    
    // CASO 1: VISTA DE PENDIENTES (ROJO)
    if (filtro === 'Pendiente') {
        if (cuotasPendientes.length === 0) return <tr><td colSpan="8" style={styles.empty}>¬°Est√°s al d√≠a! No tienes cuentas por pagar.</td></tr>
        
        return cuotasPendientes.map((item) => (
            <tr key={`${item.tipo}-${item.id}`} style={{backgroundColor:'#fef2f2'}}>
                <td style={styles.td}>
                    <div style={{color:'#dc2626', fontWeight:'bold'}}>{formatearFecha(item.fecha)}</div>
                    <div style={{fontSize:'0.75rem', color:'#ef4444'}}>Vencimiento</div>
                </td>
                <td style={styles.td}>
                    <div style={{fontSize:'0.85rem', color:'#6b7280'}}>{item.docInfo}</div>
                </td>
                <td style={styles.td}><strong>{item.proveedor}</strong></td>
                <td style={styles.td}><span style={{fontSize:'0.85rem', color:'#4b5563'}}>{item.parcela || '-'}</span></td>
                <td style={styles.td}>
                    <span style={styles.badgeCat}>{item.categoria}</span>
                    <div style={{fontSize:'0.75rem', color:'#6b7280', marginTop:'2px'}}>{item.subcat}</div>
                </td>
                <td style={styles.td}>{item.detalle}</td>
                <td style={{...styles.td, color:'#dc2626', fontWeight:'bold'}}>{formatearDinero(item.monto)}</td>
                <td style={styles.td}>
                    <button onClick={() => abrirModalEditar(item.padreId)} style={{border:'none', background:'none', color:'#2563eb', cursor:'pointer'}}>
                        <Pencil size={18} />
                    </button>
                </td>
            </tr>
        ))
    }

    // CASO 2: VISTA DE PAGADOS (VERDE)
    if (filtro === 'Pagado') {
        if (cuotasPagadas.length === 0) return <tr><td colSpan="8" style={styles.empty}>No hay historial de pagos registrados.</td></tr>

        return cuotasPagadas.map((item) => (
            <tr key={`${item.tipo}-${item.id}`} style={{backgroundColor:'#f0fdf4'}}>
                <td style={styles.td}>
                    <div style={{color:'#166534', fontWeight:'bold'}}>{formatearFecha(item.fecha)}</div>
                    <div style={{fontSize:'0.75rem', color:'#15803d'}}>Fecha Pago</div>
                </td>
                <td style={styles.td}>
                    <div style={{fontSize:'0.85rem', color:'#6b7280'}}>{item.docInfo}</div>
                </td>
                <td style={styles.td}><strong>{item.proveedor}</strong></td>
                <td style={styles.td}><span style={{fontSize:'0.85rem', color:'#4b5563'}}>{item.parcela || '-'}</span></td>
                <td style={styles.td}>
                    <span style={styles.badgeCat}>{item.categoria}</span>
                    <div style={{fontSize:'0.75rem', color:'#6b7280', marginTop:'2px'}}>{item.subcat}</div>
                </td>
                <td style={styles.td}>{item.detalle}</td>
                <td style={{...styles.td, color:'#166534', fontWeight:'bold'}}>{formatearDinero(item.monto)}</td>
                <td style={styles.td}>
                    <button onClick={() => abrirModalEditar(item.padreId)} style={{border:'none', background:'none', color:'#2563eb', cursor:'pointer'}}>
                        <Pencil size={18} />
                    </button>
                </td>
            </tr>
        ))
    }

    // CASO 3: VISTA DOCUMENTOS (FACTURAS GENERALES - VISTA COMPLETA)
    if (gastos.length === 0) return <tr><td colSpan="8" style={styles.empty}>No hay documentos registrados.</td></tr>

    return gastos.map((g) => (
        <tr key={g.id}>
            <td style={styles.td}>
                <div>{formatearFecha(g.fecha)}</div>
                <span style={styles.badgePago(g.estado_pago)}>
                    {g.estado_pago === 'Pagado' ? <CheckCircle size={12}/> : <Clock size={12}/>}
                    {g.estado_pago}
                </span>
            </td>
            {/* Columna DOC separada */}
            <td style={styles.td}>
                <div style={{fontSize:'0.85rem', fontWeight:'bold'}}>{g.tipo_documento}</div>
                <div style={{fontSize:'0.85rem', color:'#374151'}}>{g.nro_documento}</div>
            </td>
            <td style={styles.td}><strong>{g.proveedores?.nombre}</strong></td>
            {/* Columna PARCELA */}
            <td style={styles.td}>{g.parcelas?.nombre || '-'}</td>
            {/* Columna CATEGORIA/SUBCATEGORIA */}
            <td style={styles.td}>
                <div>{g.categorias_gastos?.nombre}</div>
                <div style={{fontSize:'0.75rem', color:'#6b7280'}}>{g.subcategorias_gastos?.nombre}</div>
            </td>
            <td style={styles.td}>{g.descripcion}</td>
            <td style={{...styles.td, fontWeight:'bold'}}>{formatearDinero(g.monto)}</td>
            <td style={styles.td}>
                <div style={{display:'flex', gap:'10px'}}>
                  <button onClick={() => abrirModalEditar(g.id)} style={{border:'none', background:'none', color:'#2563eb', cursor:'pointer'}}>
                      <Pencil size={18} />
                  </button>
                  <button onClick={() => eliminarGasto(g.id)} style={styles.btnIcon}><Trash2 size={18} /></button>
                </div>
            </td>
        </tr>
    ))
  }

  const styles = {
    container: { padding: '20px', width: '90%' },
    header: { display: 'flex', justifyContent: 'flex-start', gap: '20px', alignItems: 'center', marginBottom: '20px' },
    title: { display: 'flex', alignItems: 'center', gap: '10px', fontSize: '1.5rem', fontWeight: 'bold', color: '#1f2937' },
    
    btnNew: { 
        textDecoration: 'none', backgroundColor: '#1f2937', color: 'white', padding: '10px 20px', 
        borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '8px', 
        fontWeight: 'bold', fontSize: '0.9rem', border: 'none', cursor: 'pointer' 
    },
    
    summaryCard: { backgroundColor: '#fee2e2', color: '#991b1b', padding: '15px 20px', borderRadius: '12px', marginBottom: '30px', display: 'flex', alignItems: 'center', justifyContent: 'space-between', border: '1px solid #fecaca' },
    
    tabs: { display: 'flex', gap: '10px', marginBottom: '20px' },
    tab: (active) => ({
      padding: '8px 16px', borderRadius: '20px', border: 'none', cursor: 'pointer', fontWeight: 'bold', fontSize: '0.9rem',
      backgroundColor: active ? '#1f2937' : '#e5e7eb', color: active ? 'white' : '#4b5563'
    }),

    tableContainer: { backgroundColor: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.05)', overflowX: 'auto' },
    table: { width: '100%', borderCollapse: 'collapse', textAlign: 'left', minWidth:'900px' },
    th: { backgroundColor: '#f9fafb', padding: '12px', fontSize: '0.8rem', color: '#6b7280', fontWeight: '600', textTransform: 'uppercase', whiteSpace:'nowrap' },
    td: { padding: '12px', borderBottom: '1px solid #f3f4f6', color: '#374151', fontSize: '0.9rem' },
    empty: { textAlign:'center', padding:'40px', color:'#9ca3af', fontStyle:'italic' },
    
    badgePago: (estado) => ({
      display: 'inline-flex', alignItems: 'center', gap: '4px', padding: '2px 8px', borderRadius: '20px', fontSize: '0.7rem', fontWeight: 'bold', textTransform: 'uppercase', marginTop:'4px',
      backgroundColor: estado === 'Pagado' ? '#dcfce7' : (estado === 'Parcial' ? '#fef9c3' : '#fee2e2'),
      color: estado === 'Pagado' ? '#166534' : (estado === 'Parcial' ? '#854d0e' : '#991b1b')
    }),
    badgeCat: { display: 'inline-block', padding: '2px 8px', borderRadius: '4px', fontSize: '0.8rem', backgroundColor: '#f3f4f6', color: '#4b5563' },
    btnIcon: { border:'none', background:'none', color:'#ef4444', cursor:'pointer' }
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><Wallet color="#4b5563" /> Gastos</h1>
        {/* BOT√ìN PRINCIPAL ABRE MODAL */}
        <button onClick={abrirModalCrear} style={styles.btnNew}><Plus size={18} /> Nuevo Gasto</button>
      </div>

      {totalDeudaReal > 0 && (
        <div style={styles.summaryCard}>
          <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
             <AlertCircle size={24} />
             <div>
               <div style={{fontWeight:'bold', fontSize:'1.1rem'}}>Total Por Pagar</div>
               <div style={{fontSize:'0.9rem'}}>Suma de cuotas pendientes</div>
             </div>
          </div>
          <div style={{fontSize:'1.5rem', fontWeight:'bold'}}>{formatearDinero(totalDeudaReal)}</div>
        </div>
      )}

      <div style={styles.tabs}>
        <button onClick={() => setFiltro('Todos')} style={styles.tab(filtro === 'Todos')}>Documentos</button>
        <button onClick={() => setFiltro('Pendiente')} style={styles.tab(filtro === 'Pendiente')}>Por Pagar ‚è≥</button>
        <button onClick={() => setFiltro('Pagado')} style={styles.tab(filtro === 'Pagado')}>Pagados ‚úÖ</button>
      </div>

      <div style={styles.tableContainer}>
        <table style={styles.table}>
          <thead>
            <tr>
              <th style={styles.th}>Fecha</th>
              <th style={styles.th}>Doc.</th>
              <th style={styles.th}>Proveedor</th>
              <th style={styles.th}>Parcela</th>
              <th style={styles.th}>Categor√≠a / Sub</th>
              <th style={styles.th}>Detalle</th>
              <th style={styles.th}>Monto</th>
              <th style={styles.th} width="50"></th>
            </tr>
          </thead>
          <tbody>
            {renderContenido()}
          </tbody>
        </table>
      </div>

      {/* --- AQU√ç VIVE EL MODAL --- */}
      <Modal 
        isOpen={modalOpen} 
        onClose={handleCloseRequest} 
        title={gastoEditarId ? "Editar Gasto" : "Registrar Nuevo Gasto"}
      >
        {modalOpen && (
            <NuevoGasto 
                idGasto={gastoEditarId} 
                cerrarModal={() => setModalOpen(false)} 
                alGuardar={handleGuardadoExitoso}
            />
        )}
      </Modal>

    </div>
  )
}
export default Gastos


==================================================
RUTA: src\pages\Labores.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Shovel, Plus, Calendar, Edit, Trash2, Search, X } from 'lucide-react'
import Modal from '../components/Modal'
import NuevaLabor from './NuevaLabor'

function Labores() {
  const [labores, setLabores] = useState([])
  const [loading, setLoading] = useState(true)
  
  // 1. CAMBIO: Iniciamos vac√≠o para ver todo el historial por defecto
  const [mesFiltro, setMesFiltro] = useState('') 
  const [textoBusqueda, setTextoBusqueda] = useState('')

  // Estados del Modal
  const [modalOpen, setModalOpen] = useState(false)
  const [editId, setEditId] = useState(null)

  useEffect(() => {
    cargarLabores()
  }, [mesFiltro]) // Se recarga cuando el usuario elige un mes o lo borra

  async function cargarLabores() {
    setLoading(true)
    
    // 2. CAMBIO: Construcci√≥n din√°mica de la consulta
    let query = supabase
      .from('labores_campo')
      .select(`
        *,
        sectores ( nombre )
      `)
      .order('fecha', { ascending: false }) // Siempre ordenamos por lo m√°s reciente

    // Solo aplicamos filtro de fecha si el usuario seleccion√≥ un mes
    if (mesFiltro) {
        const inicioMes = `${mesFiltro}-01`
        const finMes = `${mesFiltro}-31`
        query = query.gte('fecha', inicioMes).lte('fecha', finMes)
    }

    const { data, error } = await query

    if (error) {
        console.error("Error cargando labores:", error)
    } else {
        setLabores(data || [])
    }
    
    setLoading(false)
  }

  // --- L√ìGICA DE CIERRE ---
  const handleCloseRequest = () => {
      if (window.intentarCerrarModal) {
          window.intentarCerrarModal()
      } else {
          setModalOpen(false)
      }
  }

  const abrirNueva = () => { setEditId(null); setModalOpen(true); }
  const abrirEditar = (labor) => { setEditId(labor.id); setModalOpen(true); }

  const eliminarLabor = async (id) => {
      if(!confirm("¬øEst√°s seguro de eliminar esta labor?")) return;
      const { error } = await supabase.from('labores_campo').delete().eq('id', id)
      if(error) alert(error.message)
      else cargarLabores()
  }

  const laboresFiltradas = labores.filter(l => 
      l.tipo_labor.toLowerCase().includes(textoBusqueda.toLowerCase()) ||
      l.sectores?.nombre?.toLowerCase().includes(textoBusqueda.toLowerCase()) ||
      l.comentarios?.toLowerCase().includes(textoBusqueda.toLowerCase())
  )

  const fmtDinero = (m) => '$ ' + Math.round(m).toLocaleString('es-CL')

  // Helper para mostrar icono seg√∫n labor (Mismo mapa que NuevaLabor)
  const getIconoLabor = (tipo) => {
      const mapa = {
          'Riego': 'üíß', 'Fertilizaci√≥n': 'üß™', 'Poda': '‚úÇÔ∏è', 'Cosecha': 'ü•ë',
          'Fitosanitario': 'üò∑', 'Mantenimiento Riego': 'üîß', 'Limpieza': 'üçÇ',
          'Plantaci√≥n': 'üå±', 'Otros': 'üìù'
      }
      // Buscamos si el tipo contiene alguna de las claves (por si guardaste "Riego Sector 1")
      const key = Object.keys(mapa).find(k => tipo?.includes(k))
      return key ? mapa[key] : 'üìã'
  }

  const styles = {
    container: { padding: '20px', width: '90%' },
    header: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap:'wrap', gap:'15px' },
    title: { display: 'flex', alignItems: 'center', gap: '10px', fontSize: '1.8rem', fontWeight: 'bold', color: '#1f2937' },
    
    controls: { display:'flex', gap:'10px', alignItems:'center', flexWrap:'wrap' },
    inputSearch: { padding:'8px 12px', borderRadius:'6px', border:'1px solid #d1d5db', outline:'none', height:'40px', boxSizing:'border-box' },
    btnNew: { backgroundColor: '#1f2937', color: 'white', border: 'none', padding: '0 20px', borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '8px', height:'40px' },
    
    tableContainer: { overflowX: 'auto', backgroundColor:'white', borderRadius:'12px', boxShadow:'0 2px 5px rgba(0,0,0,0.05)', border:'1px solid #e5e7eb' },
    table: { width: '100%', borderCollapse: 'collapse', minWidth:'600px' },
    th: { textAlign: 'left', padding: '15px', borderBottom: '2px solid #f3f4f6', color: '#6b7280', fontSize: '0.85rem', textTransform: 'uppercase' },
    td: { padding: '15px', borderBottom: '1px solid #f3f4f6', color: '#374151', fontSize: '0.95rem' },
    
    badge: { padding:'4px 8px', borderRadius:'12px', fontSize:'0.85rem', fontWeight:'500', backgroundColor:'#f3f4f6', color:'#374151', display:'inline-flex', alignItems:'center', gap:'5px' },
    actions: { display:'flex', gap:'10px' }
  }

  return (
    <div style={styles.container}>
      
      <div style={styles.header}>
        <h1 style={styles.title}><Shovel color="#d97706"/> Labores de Campo</h1>
        
        <div style={styles.controls}>
            {/* Buscador */}
            <div style={{position:'relative', display:'flex', alignItems:'center'}}>
                <Search size={16} style={{position:'absolute', left:10, color:'#9ca3af'}}/>
                <input 
                    type="text" 
                    placeholder="Buscar labor..." 
                    value={textoBusqueda}
                    onChange={e => setTextoBusqueda(e.target.value)}
                    style={{...styles.inputSearch, paddingLeft:'30px'}}
                />
            </div>

            {/* Filtro Mes (Con bot√≥n limpiar si est√° activo) */}
            <div style={{display:'flex', alignItems:'center', gap:'5px'}}>
                <input 
                    type="month" 
                    value={mesFiltro} 
                    onChange={e => setMesFiltro(e.target.value)}
                    style={styles.inputSearch}
                    title="Filtrar por mes"
                />
                {mesFiltro && (
                    <button onClick={() => setMesFiltro('')} style={{border:'none', background:'#fee2e2', color:'#ef4444', borderRadius:'50%', width:'30px', height:'30px', cursor:'pointer', display:'flex', alignItems:'center', justifyContent:'center'}} title="Quitar filtro">
                        <X size={16}/>
                    </button>
                )}
            </div>

            <button onClick={abrirNueva} style={styles.btnNew}>
                <Plus size={18}/> Registrar Labor
            </button>
        </div>
      </div>

      <div style={styles.tableContainer}>
          <table style={styles.table}>
              <thead>
                  <tr>
                      <th style={styles.th}>Fecha</th>
                      <th style={styles.th}>Sector</th>
                      <th style={styles.th}>Tipo Labor</th>
                      <th style={styles.th}>Costo</th>
                      <th style={styles.th}>Acciones</th>
                  </tr>
              </thead>
              <tbody>
                  {loading ? (
                      <tr><td colSpan="5" style={{padding:'30px', textAlign:'center', color:'#9ca3af'}}>Cargando labores...</td></tr>
                  ) : laboresFiltradas.length === 0 ? (
                      <tr><td colSpan="5" style={{padding:'30px', textAlign:'center', color:'#9ca3af'}}>
                          {mesFiltro ? 'No hay labores en el mes seleccionado.' : 'No hay labores registradas.'}
                      </td></tr>
                  ) : (
                      laboresFiltradas.map(l => (
                          <tr key={l.id}>
                              <td style={styles.td}>
                                  <div style={{display:'flex', alignItems:'center', gap:'8px'}}>
                                      <Calendar size={14} color="#9ca3af"/>
                                      {l.fecha.split('-').reverse().join('/')}
                                  </div>
                              </td>
                              <td style={styles.td}>
                                  <span style={{fontWeight:'bold'}}>{l.sectores?.nombre || 'General'}</span>
                              </td>
                              <td style={styles.td}>
                                  <span style={styles.badge}>
                                      {getIconoLabor(l.tipo_labor)} {l.tipo_labor}
                                  </span>
                                  {l.comentarios && (
                                    <div style={{fontSize:'0.8rem', color:'#6b7280', marginTop:'4px', maxWidth:'300px', whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis'}}>
                                        {l.comentarios}
                                    </div>
                                  )}
                              </td>
                              <td style={styles.td}>{fmtDinero(l.costo_total)}</td>
                              <td style={styles.td}>
                                  <div style={styles.actions}>
                                      <button onClick={() => abrirEditar(l)} style={{border:'none', background:'none', cursor:'pointer', color:'#2563eb'}}>
                                          <Edit size={18}/>
                                      </button>
                                      <button onClick={() => eliminarLabor(l.id)} style={{border:'none', background:'none', cursor:'pointer', color:'#ef4444'}}>
                                          <Trash2 size={18}/>
                                      </button>
                                  </div>
                              </td>
                          </tr>
                      ))
                  )}
              </tbody>
          </table>
      </div>

      {/* MODAL */}
      <Modal 
        isOpen={modalOpen} 
        onClose={handleCloseRequest} 
        title={editId ? "Editar Labor" : "Nueva Labor"}
      >
          {modalOpen && (
            <NuevaLabor 
                idLabor={editId}
                cerrarModal={() => setModalOpen(false)} 
                alGuardar={() => { setModalOpen(false); cargarLabores(); }}
            />
          )}
      </Modal>

    </div>
  )
}

export default Labores


==================================================
RUTA: src\pages\NuevaCategoria.jsx
==================================================
import { useState, useEffect } from 'react'
import { supabase } from '../supabaseClient'
import { useNavigate, useParams } from 'react-router-dom'
import { Save, X, Tag, Plus, Trash2, AlertCircle } from 'lucide-react'

function NuevaCategoria() {
  const navigate = useNavigate()
  const { id } = useParams()
  const [loading, setLoading] = useState(false)
  const [nombre, setNombre] = useState('')
  const [tipo, setTipo] = useState('Gasto Operacional') // <--- NUEVO CAMPO
  const [subs, setSubs] = useState([])
  const [newSub, setNewSub] = useState('')

  useEffect(() => {
    if (id) {
      async function cargar() {
        const { data: cat } = await supabase.from('categorias_gastos').select('*').eq('id', id).single()
        if (cat) {
            setNombre(cat.nombre)
            setTipo(cat.tipo || 'Gasto Operacional')
        }
        
        const { data: subData } = await supabase.from('subcategorias_gastos').select('*').eq('categoria_id', id)
        if (subData) setSubs(subData)
      }
      cargar()
    }
  }, [id])

  const agregarSub = () => {
    if (!newSub.trim()) return
    setSubs([...subs, { id: -Date.now(), nombre: newSub }])
    setNewSub('')
  }

  const eliminarSub = (subId) => {
    setSubs(subs.filter(s => s.id !== subId))
  }

  const handleSubmit = async (e) => {
    e.preventDefault()
    setLoading(true)

    try {
      let catId = id
      const payload = { nombre, tipo } // Guardamos el tipo

      if (id) {
        await supabase.from('categorias_gastos').update(payload).eq('id', id)
        await supabase.from('subcategorias_gastos').delete().eq('categoria_id', id)
      } else {
        const { data } = await supabase.from('categorias_gastos').insert([payload]).select().single()
        catId = data.id
      }

      if (subs.length > 0) {
        const subsAGuardar = subs.map(s => ({ categoria_id: catId, nombre: s.nombre }))
        await supabase.from('subcategorias_gastos').insert(subsAGuardar)
      }

      navigate('/categorias')
    } catch (error) {
      alert('Error: ' + error.message)
    } finally {
      setLoading(false)
    }
  }

  const styles = {
    container: { maxWidth: '600px', margin: '40px auto', padding: '20px' },
    card: { backgroundColor: 'white', padding: '30px', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)' },
    title: { display: 'flex', alignItems: 'center', gap: '10px', fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '20px', color: '#1f2937' },
    formGroup: { marginBottom: '20px' },
    label: { display: 'block', marginBottom: '8px', color: '#4b5563', fontWeight: '500' },
    input: { width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '1rem' },
    actions: { display: 'flex', gap: '10px', marginTop: '30px' },
    btnSave: { flex: 1, padding: '12px', backgroundColor: '#8b5cf6', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold', fontSize: '1rem' },
    btnCancel: { flex: 1, padding: '12px', backgroundColor: '#f3f4f6', color: '#4b5563', border: '1px solid #d1d5db', borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold', fontSize: '1rem' },
    
    // Subcategor√≠as
    subRow: { display: 'flex', gap: '10px', marginBottom: '10px' },
    subList: { marginTop: '15px', border: '1px solid #e5e7eb', borderRadius: '8px', padding: '10px' },
    subItem: { display: 'flex', justifyContent: 'space-between', padding: '8px', borderBottom: '1px solid #f3f4f6' },
  }

  return (
    <div style={styles.container}>
      <div style={styles.card}>
        <h2 style={styles.title}><Tag color="#8b5cf6" /> {id ? 'Editar Categor√≠a' : 'Nueva Categor√≠a'}</h2>
        <form onSubmit={handleSubmit}>
          
          <div style={styles.formGroup}>
            <label style={styles.label}>Nombre Categor√≠a</label>
            <input type="text" value={nombre} onChange={e => setNombre(e.target.value)} style={styles.input} placeholder="Ej: Fertilizantes" required />
          </div>

          <div style={styles.formGroup}>
              <label style={styles.label}>Tipo de Egreso</label>
              <select value={tipo} onChange={e => setTipo(e.target.value)} style={{...styles.input, backgroundColor:'white'}}>
                  <option value="Gasto Operacional">üìâ Gasto Operacional (Insumos, Luz, Mano de Obra)</option>
                  <option value="Inversi√≥n">üèóÔ∏è Inversi√≥n (Activos, Maquinaria, Plantas)</option>
              </select>
              <div style={{fontSize:'0.85rem', color:'#6b7280', marginTop:'5px', display:'flex', alignItems:'center', gap:'5px'}}>
                  <AlertCircle size={14}/>
                  <span>Las inversiones se separan en el balance financiero.</span>
              </div>
          </div>

          <label style={styles.label}>Subcategor√≠as (Opcional)</label>
          <div style={styles.subRow}>
            <input type="text" value={newSub} onChange={e => setNewSub(e.target.value)} style={styles.input} placeholder="Ej: Urea" onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), agregarSub())}/>
            <button type="button" onClick={agregarSub} style={{...styles.btnSave, flex: '0 0 50px', backgroundColor: '#3b82f6'}}><Plus /></button>
          </div>

          <div style={styles.subList}>
             {subs.length === 0 && <span style={{color:'#9ca3af', fontStyle:'italic'}}>Sin subcategor√≠as</span>}
             {subs.map(s => (
               <div key={s.id} style={styles.subItem}>
                 <span>{s.nombre}</span>
                 <button type="button" onClick={() => eliminarSub(s.id)} style={{border:'none', background:'none', color:'#ef4444', cursor:'pointer'}}><Trash2 size={16}/></button>
               </div>
             ))}
          </div>

          <div style={styles.actions}>
            <button type="button" onClick={() => navigate('/categorias')} style={styles.btnCancel}><X size={20} /> Cancelar</button>
            <button type="submit" style={styles.btnSave} disabled={loading}><Save size={20} /> Guardar</button>
          </div>
        </form>
      </div>
    </div>
  )
}
export default NuevaCategoria


==================================================
RUTA: src\pages\NuevaCosecha.jsx
==================================================
import { useState, useEffect, useRef } from 'react'
import { supabase } from '../supabaseClient'
import { Save, Trash2, Plus } from 'lucide-react'

// Calibres por defecto si no hay oferta seleccionada
const CALIBRES_STD = ["Extra", "Primera", "Segunda", "Tercera", "Cuarta", "Quinta", "Descarte", "Barrido"]

function NuevaCosecha({ idCosecha, cerrarModal, alGuardar }) {
  const [loading, setLoading] = useState(false)
  const [isDirty, setIsDirty] = useState(false)
  
  // Datos Maestros
  const [sectores, setSectores] = useState([])
  const [clientes, setClientes] = useState([])
  const [parcelas, setParcelas] = useState([])
  const [ofertasCliente, setOfertasCliente] = useState([]) 

  const inputsRef = useRef({}) 

  const [formData, setFormData] = useState({
    fecha: new Date().toISOString().split('T')[0],
    parcela_id: '',
    sector_id: '',
    cliente_id: '',
    oferta_id: '', 
    nro_guia: '',
    tipo_cosecha: 'Venta',
    destino: 'Venta',
    comentarios: ''
  })

  // Estado de filas (din√°mico)
  const [detalles, setDetalles] = useState(
    CALIBRES_STD.map(c => ({ calibre: c, kilos: '', precio_kilo: '' }))
  )

  // 1. CARGA DE DATOS INICIALES
  useEffect(() => {
    async function load() {
      const { data: sec } = await supabase.from('sectores').select('id, nombre, parcela_id').order('nombre')
      setSectores(sec || [])
      const { data: cli } = await supabase.from('clientes').select('id, nombre').order('nombre')
      setClientes(cli || [])
      const { data: par } = await supabase.from('parcelas').select('id, nombre').order('nombre')
      setParcelas(par || [])

      if (idCosecha) {
        // MODO EDICI√ìN
        const { data: c } = await supabase.from('cosechas').select('*').eq('id', idCosecha).single()
        if (c) {
           setFormData({
               fecha: c.fecha,
               parcela_id: c.parcela_id,
               sector_id: c.sector_id,
               cliente_id: c.cliente_id,
               oferta_id: '', // No vinculamos a la oferta hist√≥rica, solo copiamos precios
               nro_guia: c.nro_guia || '',
               tipo_cosecha: c.tipo_cosecha,
               destino: c.destino,
               comentarios: c.comentarios || ''
           })
           
           const { data: dets } = await supabase.from('detalle_cosechas').select('*').eq('cosecha_id', idCosecha)
           if (dets && dets.length > 0) {
               const existentes = dets.map(d => ({ 
                   calibre: d.calibre, 
                   kilos: d.kilos, 
                   precio_kilo: d.precio_kilo 
               }))
               setDetalles(existentes)
           }
        }
      }
    }
    load()
  }, [idCosecha])

  // 2. BUSCAR OFERTAS AL CAMBIAR CLIENTE
  useEffect(() => {
    if (formData.cliente_id) {
        async function fetchOfertas() {
            const { data } = await supabase
                .from('ofertas_comerciales')
                .select('*')
                .eq('cliente_id', formData.cliente_id)
                .eq('activa', true)
                .order('created_at', { ascending: false })
            setOfertasCliente(data || [])
        }
        fetchOfertas()
    } else {
        setOfertasCliente([])
    }
  }, [formData.cliente_id])

  // 3. APLICAR OFERTA (PRECARGAR PRECIOS Y CALIBRES)
  const aplicarOferta = (ofertaId) => {
      setFormData(prev => ({ ...prev, oferta_id: ofertaId }))
      if (!ofertaId) return 

      const oferta = ofertasCliente.find(o => o.id == ofertaId)
      
      if (oferta && oferta.precios_json && Array.isArray(oferta.precios_json)) {
          // Si el usuario elige una oferta, reescribimos las filas para coincidir con la oferta
          // Esto facilita el ingreso si la oferta tiene calibres espec√≠ficos
          if(confirm("¬øReemplazar la tabla de calibres con los de esta cotizaci√≥n?")) {
              const nuevosDetalles = oferta.precios_json.map(p => ({
                  calibre: p.calibre,
                  precio_kilo: p.precio, // Precargamos el precio
                  kilos: '' // Limpiamos kilos para que ingrese
              }))
              setDetalles(nuevosDetalles)
          }
      }
  }

  // --- GESTI√ìN DE FILAS ---
  const eliminarFila = (index) => {
      const copia = detalles.filter((_, i) => i !== index)
      setDetalles(copia)
      setIsDirty(true)
  }

  const agregarFila = () => {
      setDetalles([...detalles, { calibre: '', kilos: '', precio_kilo: '' }])
  }

  // --- NAVEGACI√ìN CON TECLADO (FLECHAS) ---
  const handleKeyDown = (e, index, field) => {
      if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
          e.preventDefault()
          const direction = e.key === 'ArrowDown' ? 1 : -1
          const nextIndex = index + direction
          
          // Verificamos que el ref exista (puede no existir si borramos una fila)
          if (nextIndex >= 0 && nextIndex < detalles.length) {
              const refKey = `${nextIndex}-${field}`
              if (inputsRef.current[refKey]) {
                  inputsRef.current[refKey].focus()
              }
          }
      }
  }

  const handleDetalleChange = (index, field, value) => {
      setIsDirty(true)
      const copia = [...detalles]
      copia[index][field] = value
      setDetalles(copia)
  }

  const handleHeaderChange = (e) => {
      setIsDirty(true)
      const { name, value } = e.target
      setFormData({ ...formData, [name]: value })
      if (name === 'parcela_id') {
          setFormData(prev => ({ ...prev, parcela_id: value, sector_id: '' }))
      }
  }

  // --- C√ÅLCULOS ---
  const totalKilos = detalles.reduce((sum, d) => sum + (parseFloat(d.kilos) || 0), 0)
  const totalVenta = detalles.reduce((sum, d) => sum + ((parseFloat(d.kilos) || 0) * (parseFloat(d.precio_kilo) || 0)), 0)
  const precioPromedio = totalKilos > 0 ? (totalVenta / totalKilos) : 0

  const handleSubmit = async (e) => {
      e.preventDefault()
      if (!formData.fecha) return alert("Falta Fecha")
      setLoading(true)

      try {
          const cabecera = {
              ...formData,
              oferta_id: undefined, // No guardamos el ID de oferta en BD, solo los valores
              kilos: totalKilos,
              precio_kilo: precioPromedio
          }
          
          let finalId = idCosecha
          if (idCosecha) {
              await supabase.from('cosechas').update(cabecera).eq('id', idCosecha)
              await supabase.from('detalle_cosechas').delete().eq('cosecha_id', idCosecha)
          } else {
              const { data, error } = await supabase.from('cosechas').insert([cabecera]).select().single()
              if (error) throw error
              finalId = data.id
          }

          // Guardamos solo filas con kilos o precio
          const lineasGuardar = detalles
            .filter(d => d.kilos || d.precio_kilo) 
            .map(d => ({
              cosecha_id: finalId,
              calibre: d.calibre || 'Sin Calibre',
              kilos: parseFloat(d.kilos) || 0,
              precio_kilo: parseFloat(d.precio_kilo) || 0
          }))

          await supabase.from('detalle_cosechas').insert(lineasGuardar)
          
          setIsDirty(false)
          alGuardar()

      } catch (err) {
          alert("Error: " + err.message)
      } finally {
          setLoading(false)
      }
  }

  useEffect(() => {
    window.intentarCerrarModal = () => {
        if (isDirty && confirm("¬øSalir sin guardar cambios?")) cerrarModal()
        else if (!isDirty) cerrarModal()
    }
    return () => { window.intentarCerrarModal = null }
  }, [isDirty, cerrarModal])


  const styles = {
      form: { display: 'flex', flexDirection: 'column', gap: '15px', fontSize:'0.9rem' },
      row: { display:'flex', gap:'10px' },
      col: { flex:1 },
      label: { display:'block', fontWeight:'bold', marginBottom:'3px', fontSize:'0.85rem', color:'#374151' },
      input: { width:'100%', padding:'6px 8px', borderRadius:'6px', border:'1px solid #d1d5db', boxSizing:'border-box' },
      
      table: { width:'100%', borderCollapse:'collapse', marginTop:'10px' },
      th: { textAlign:'left', padding:'5px', borderBottom:'2px solid #e5e7eb', fontSize:'0.8rem', color:'#6b7280' },
      td: { padding:'4px 0' },
      inputTable: { width:'100%', padding:'4px', border:'1px solid #e5e7eb', borderRadius:'4px', textAlign:'right' },
      
      footer: { backgroundColor:'#f9fafb', padding:'10px', borderRadius:'8px', display:'flex', justifyContent:'space-between', alignItems:'center', fontWeight:'bold', color:'#1f2937' },
      btnSave: { flex:1, padding:'10px', backgroundColor:'#1f2937', color:'white', border:'none', borderRadius:'6px', fontWeight:'bold', cursor:'pointer' },
      btnTrash: { background:'none', border:'none', color:'#ef4444', cursor:'pointer', marginLeft:'5px' },
      btnAdd: { background:'none', border:'1px dashed #d1d5db', color:'#6b7280', width:'100%', padding:'5px', borderRadius:'4px', cursor:'pointer', fontSize:'0.8rem', marginTop:'5px'}
  }

  return (
    <form onSubmit={handleSubmit} style={styles.form}>
        
        <div style={styles.row}>
            <div style={styles.col}>
                <label style={styles.label}>Fecha</label>
                <input type="date" name="fecha" value={formData.fecha} onChange={handleHeaderChange} style={styles.input} required />
            </div>
            <div style={styles.col}>
                <label style={styles.label}>N¬∞ Gu√≠a / Ref</label>
                <input type="text" name="nro_guia" value={formData.nro_guia} onChange={handleHeaderChange} style={styles.input} />
            </div>
        </div>

        <div style={styles.row}>
            <div style={styles.col}>
                <label style={styles.label}>Cliente</label>
                <select name="cliente_id" value={formData.cliente_id} onChange={handleHeaderChange} style={styles.input}>
                    <option value="">-- Seleccionar --</option>
                    {clientes.map(c => <option key={c.id} value={c.id}>{c.nombre}</option>)}
                </select>
            </div>
            <div style={styles.col}>
                <label style={styles.label}>Usar Cotizaci√≥n</label>
                <select 
                    name="oferta_id" 
                    value={formData.oferta_id} 
                    onChange={(e) => aplicarOferta(e.target.value)} 
                    style={{...styles.input, backgroundColor: formData.oferta_id ? '#ecfdf5' : 'white', borderColor: formData.oferta_id ? '#10b981' : '#d1d5db'}}
                    disabled={!formData.cliente_id}
                >
                    <option value="">-- Ninguna (Manual) --</option>
                    {ofertasCliente.map(o => (
                        <option key={o.id} value={o.id}>{o.nombre}</option>
                    ))}
                </select>
            </div>
        </div>

        <div style={styles.row}>
             <div style={styles.col}>
                <label style={styles.label}>Parcela</label>
                <select name="parcela_id" value={formData.parcela_id} onChange={handleHeaderChange} style={styles.input}>
                    <option value="">-- Seleccionar --</option>
                    {parcelas.map(p => <option key={p.id} value={p.id}>{p.nombre}</option>)}
                </select>
            </div>
            <div style={styles.col}>
                <label style={styles.label}>Sector</label>
                <select name="sector_id" value={formData.sector_id} onChange={handleHeaderChange} style={styles.input}>
                    <option value="">-- Seleccionar --</option>
                    {sectores.filter(s => !formData.parcela_id || s.parcela_id == formData.parcela_id).map(s => (
                        <option key={s.id} value={s.id}>{s.nombre}</option>
                    ))}
                </select>
            </div>
        </div>

        <div style={{maxHeight:'300px', overflowY:'auto', border:'1px solid #f3f4f6', padding:'5px', borderRadius:'6px'}}>
            <table style={styles.table}>
                <thead>
                    <tr>
                        <th style={{...styles.th, width:'35%'}}>Calibre</th>
                        <th style={{...styles.th, width:'25%', textAlign:'right'}}>Kilos</th>
                        <th style={{...styles.th, width:'25%', textAlign:'right'}}>Precio ($)</th>
                        <th style={{width:'5%'}}></th>
                    </tr>
                </thead>
                <tbody>
                    {detalles.map((fila, i) => (
                        <tr key={i}>
                            <td style={styles.td}>
                                <input 
                                    value={fila.calibre} 
                                    onChange={(e) => handleDetalleChange(i, 'calibre', e.target.value)} 
                                    style={{...styles.inputTable, textAlign:'left', border:'none', background:'transparent', fontWeight:'500'}}
                                    placeholder="Nombre"
                                />
                            </td>
                            <td style={styles.td}>
                                <input 
                                    ref={el => inputsRef.current[`${i}-kilos`] = el}
                                    type="number" 
                                    placeholder="0"
                                    value={fila.kilos} 
                                    onChange={(e) => handleDetalleChange(i, 'kilos', e.target.value)}
                                    onKeyDown={(e) => handleKeyDown(e, i, 'kilos')}
                                    style={styles.inputTable}
                                />
                            </td>
                            <td style={styles.td}>
                                <input 
                                    ref={el => inputsRef.current[`${i}-precio`] = el}
                                    type="number" 
                                    placeholder="0"
                                    value={fila.precio_kilo} 
                                    onChange={(e) => handleDetalleChange(i, 'precio_kilo', e.target.value)}
                                    onKeyDown={(e) => handleKeyDown(e, i, 'precio_kilo')}
                                    style={styles.inputTable}
                                />
                            </td>
                            <td style={{textAlign:'center'}}>
                                <button type="button" onClick={() => eliminarFila(i)} style={styles.btnTrash} tabIndex={-1}>
                                    <Trash2 size={14}/>
                                </button>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
            <button type="button" onClick={agregarFila} style={styles.btnAdd}>
                <Plus size={14} style={{verticalAlign:'middle'}}/> Agregar fila
            </button>
        </div>
        
        <div style={styles.footer}>
            <div style={{display:'flex', gap:'15px'}}>
                <span>Total: {Math.round(totalKilos).toLocaleString()} Kg</span>
                <span style={{color:'#059669'}}>${Math.round(totalVenta).toLocaleString()}</span>
            </div>
            <div style={{fontSize:'0.85rem', color:'#6b7280'}}>
                Prom: ${Math.round(precioPromedio)}/kg
            </div>
        </div>

        <button type="submit" style={styles.btnSave} disabled={loading}>
            <Save size={16} style={{marginRight:5}}/>
            {loading ? 'Guardando...' : 'Guardar Cosecha'}
        </button>
    </form>
  )
}

export default NuevaCosecha

==================================================
RUTA: src\pages\NuevaLabor.jsx
==================================================
import { useState, useEffect } from 'react'
import { supabase } from '../supabaseClient'
import { Save, CheckSquare, Square, Calculator, Info, Package, Plus, Trash2, X } from 'lucide-react'

// DEFINICI√ìN DE LABORES CON ICONOS
const TIPOS_LABOR = [
  { id: 'Riego', label: 'Riego', icono: 'üíß' },
  { id: 'Fertilizaci√≥n', label: 'Fertilizaci√≥n', icono: 'üß™' },
  { id: 'Poda', label: 'Poda', icono: '‚úÇÔ∏è' },
  { id: 'Cosecha', label: 'Cosecha', icono: 'ü•ë' },
  { id: 'Fitosanitario', label: 'Aplicaci√≥n Fitosanitaria', icono: 'üò∑' },
  { id: 'Mantenimiento Riego', label: 'Mantenci√≥n Riego', icono: 'üîß' },
  { id: 'Limpieza', label: 'Limpieza / Desmalezado', icono: 'üçÇ' },
  { id: 'Plantaci√≥n', label: 'Plantaci√≥n', icono: 'üå±' },
  { id: 'Otros', label: 'Otros', icono: 'üìù' }
]

function NuevaLabor({ idLabor, cerrarModal, alGuardar }) {
  const [loading, setLoading] = useState(false)
  const [isDirty, setIsDirty] = useState(false)
  const [crearGastoAuto, setCrearGastoAuto] = useState(false)
  
  // Datos Maestros
  const [sectores, setSectores] = useState([])
  const [insumosBodega, setInsumosBodega] = useState([]) 
  const [proveedores, setProveedores] = useState([]) 

  // Estado Formulario
  const [sectoresSeleccionados, setSectoresSeleccionados] = useState([])
  const [currentLoteId, setCurrentLoteId] = useState(null) 

  const [formData, setFormData] = useState({
    fecha: new Date().toISOString().split('T')[0],
    tipo_labor: '', 
    comentarios: '', 
    proveedor_id: '', 
    metodo_costo: 'Global', 
    precio_unitario: '',    
    costo_manual: ''        
  })

  // Estado para Insumos Usados
  const [insumosUsados, setInsumosUsados] = useState([]) 

  // 1. CARGAR DATOS INICIALES
  useEffect(() => {
    async function init() {
      try {
        // A. Cargas Maestras
        const { data: sec } = await supabase.from('sectores').select('id, nombre, parcelas(nombre), cantidad_arboles, superficie_ha').order('nombre')
        setSectores(sec || [])

        const { data: ins } = await supabase.from('bodega_insumos').select('id, nombre, unidad_medida, stock_actual').order('nombre')
        setInsumosBodega(ins || [])

        const { data: provs } = await supabase.from('proveedores').select('id, nombre').order('nombre')
        setProveedores(provs || [])

        // B. Si es EDICI√ìN
        if (idLabor) {
            const { data: lab } = await supabase.from('labores_campo').select('*').eq('id', idLabor).single()
            
            if (lab) {
                // 2. DETECCI√ìN DE LOTE
                let sectoresDelGrupo = [lab.sector_id]
                let loteIdEncontrado = lab.lote_id

                if (loteIdEncontrado) {
                    const { data: hermanos } = await supabase
                        .from('labores_campo')
                        .select('sector_id')
                        .eq('lote_id', loteIdEncontrado)
                    
                    if (hermanos && hermanos.length > 0) {
                        sectoresDelGrupo = hermanos.map(h => h.sector_id)
                    }
                }

                setCurrentLoteId(loteIdEncontrado)
                setSectoresSeleccionados(sectoresDelGrupo)
                
                // 3. C√ÅLCULO DE COSTOS (CORREGIDO: Ya no usa RPC)
                let costoParaMostrar = lab.costo_total

                if (loteIdEncontrado && lab.metodo_costo === 'Global') {
                     // Consultamos todos los registros de este lote y sumamos sus costos en JS
                     const { data: todosLosCostos } = await supabase
                        .from('labores_campo')
                        .select('costo_total')
                        .eq('lote_id', loteIdEncontrado)
                     
                     if (todosLosCostos) {
                         costoParaMostrar = todosLosCostos.reduce((acc, curr) => acc + (Number(curr.costo_total)||0), 0)
                     }
                }

                setFormData({
                    fecha: lab.fecha,
                    tipo_labor: lab.tipo_labor,
                    comentarios: lab.comentarios || '',
                    proveedor_id: lab.proveedor_id || '',
                    metodo_costo: lab.metodo_costo,
                    precio_unitario: lab.precio_unitario || '',
                    costo_manual: lab.metodo_costo === 'Global' ? costoParaMostrar : ''
                })

                // 4. CARGAR INSUMOS
                let queryInsumos = supabase.from('bodega_movimientos').select('cantidad, insumo_id, labor_id, bodega_insumos(nombre, unidad_medida)').eq('tipo_movimiento', 'Salida')
                
                if (loteIdEncontrado) {
                    const { data: idsLote } = await supabase.from('labores_campo').select('id').eq('lote_id', loteIdEncontrado)
                    if (idsLote) {
                        const listaIds = idsLote.map(x => x.id)
                        queryInsumos = queryInsumos.in('labor_id', listaIds)
                    }
                } else {
                    queryInsumos = queryInsumos.eq('labor_id', idLabor)
                }

                const { data: movs } = await queryInsumos
                
                if (movs && movs.length > 0) {
                    // Consolidar insumos
                    const mapaInsumos = {}
                    movs.forEach(m => {
                        if (!mapaInsumos[m.insumo_id]) {
                            mapaInsumos[m.insumo_id] = {
                                productoId: m.insumo_id,
                                nombre: m.bodega_insumos?.nombre,
                                unidad: m.bodega_insumos?.unidad_medida,
                                cantidad: 0
                            }
                        }
                        mapaInsumos[m.insumo_id].cantidad += Number(m.cantidad)
                    })
                    setInsumosUsados(Object.values(mapaInsumos))
                }
            }
        }
      } catch (err) {
        console.error("Error cargando datos:", err)
      }
    }
    init()
  }, [idLabor])

  // --- CIERRE SEGURO ---
  useEffect(() => {
    window.intentarCerrarModal = () => {
        if (isDirty) {
            if (window.confirm("‚ö†Ô∏è Tienes cambios sin guardar. ¬øDeseas salir?")) cerrarModal()
        } else {
            cerrarModal()
        }
    }
    return () => { window.intentarCerrarModal = null }
  }, [isDirty, cerrarModal])

  // --- HANDLERS ---
  const toggleSector = (id) => {
    setIsDirty(true)
    setSectoresSeleccionados(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id])
  }

  const handleChange = (e) => {
    setIsDirty(true)
    setFormData({ ...formData, [e.target.name]: e.target.value })
  }

  // --- LOGICA INSUMOS ---
  const agregarInsumo = () => {
      setInsumosUsados([...insumosUsados, { productoId: '', nombre: '', unidad: '', cantidad: '' }])
      setIsDirty(true)
  }

  const actualizarInsumo = (index, campo, valor) => {
      const copia = [...insumosUsados]
      if (campo === 'productoId') {
          const prod = insumosBodega.find(p => p.id.toString() === valor)
          copia[index].productoId = valor
          copia[index].nombre = prod?.nombre
          copia[index].unidad = prod?.unidad_medida
      } else {
          copia[index][campo] = valor
      }
      setInsumosUsados(copia)
      setIsDirty(true)
  }

  const eliminarInsumo = (index) => {
      const copia = [...insumosUsados]
      copia.splice(index, 1)
      setInsumosUsados(copia)
      setIsDirty(true)
  }

  // --- CALCULADORA ---
  const calcularTotalEstimado = () => {
    if (sectoresSeleccionados.length === 0) return 0
    if (formData.metodo_costo === 'Global') return parseInt(formData.costo_manual) || 0

    const precio = parseInt(formData.precio_unitario) || 0
    let total = 0
    sectoresSeleccionados.forEach(id => {
        const sec = sectores.find(s => s.id === id)
        if (!sec) return
        const cantidad = formData.metodo_costo === 'Por Arbol' ? (sec.cantidad_arboles || 0) : (sec.superficie_ha || 0)
        total += (cantidad * precio)
    })
    return total
  }

  const formatMoney = (val) => '$ ' + Math.round(val).toLocaleString('es-CL')

  // --- SUBMIT ---
const handleSubmit = async (e) => {
    e.preventDefault()
    if (sectoresSeleccionados.length === 0) return alert("Selecciona al menos un sector.")
    if (!formData.tipo_labor) return alert("Selecciona el tipo de labor.")
    
    setLoading(true)
    try {
        const totalGlobalInput = parseInt(formData.costo_manual) || 0
        const precioUnitario = parseInt(formData.precio_unitario) || 0
        
        // 1. GENERAR ID DE LOTE
        const loteIdFinal = currentLoteId || crypto.randomUUID()

        // 2. PREPARAR REGISTROS DE LABOR
        const registrosLabor = sectoresSeleccionados.map(secId => {
            const sec = sectores.find(s => s.id === secId)
            let costoFinal = 0

            if (formData.metodo_costo === 'Global') {
                costoFinal = totalGlobalInput / sectoresSeleccionados.length
            } else {
                const cantidad = formData.metodo_costo === 'Por Arbol' ? (sec.cantidad_arboles || 0) : (sec.superficie_ha || 0)
                costoFinal = cantidad * precioUnitario
            }

            return {
                sector_id: secId,
                fecha: formData.fecha,
                tipo_labor: formData.tipo_labor,
                comentarios: formData.comentarios,
                proveedor_id: formData.proveedor_id || null,
                metodo_costo: formData.metodo_costo,
                precio_unitario: formData.metodo_costo === 'Global' ? 0 : precioUnitario,
                costo_total: costoFinal,
                lote_id: loteIdFinal
            }
        })

        // 3. ESTRATEGIA DE GUARDADO (Borrar y Re-insertar)
        if (idLabor) {
            if (currentLoteId) {
                const { data: laboresABorrar } = await supabase.from('labores_campo').select('id').eq('lote_id', currentLoteId)
                if (laboresABorrar) {
                    const idsBorrar = laboresABorrar.map(x => x.id)
                    if (idsBorrar.length > 0) {
                        // Borramos movimientos de bodega y GASTOS asociados previos (para evitar duplicados al editar)
                        await supabase.from('bodega_movimientos').delete().in('labor_id', idsBorrar)
                        // Opcional: Borrar gasto anterior si se desea regenerar, pero es arriesgado si ya se pag√≥. 
                        // Por seguridad, NO borramos el gasto autom√°ticamente al editar, solo creamos al crear nuevo.
                    }
                    await supabase.from('labores_campo').delete().eq('lote_id', currentLoteId)
                }
            } else {
                await supabase.from('bodega_movimientos').delete().eq('labor_id', idLabor)
                await supabase.from('labores_campo').delete().eq('id', idLabor)
            }
        } 
        
        // 4. INSERCI√ìN DE LABORES
        const { data: inserted, error: errIns } = await supabase.from('labores_campo').insert(registrosLabor).select()
        if (errIns) throw errIns
        
        const laborIdReference = inserted[0].id 

        // 5. REGISTRAR SALIDA DE BODEGA
        const movimientosBodega = insumosUsados
            .filter(i => i.productoId && i.cantidad > 0)
            .map(i => ({
                insumo_id: i.productoId,
                tipo_movimiento: 'Salida',
                cantidad: parseFloat(i.cantidad),
                fecha: formData.fecha,
                referencia: `Consumo en Labor: ${formData.tipo_labor}`,
                labor_id: laborIdReference 
            }))

        if (movimientosBodega.length > 0) {
            const { error: errBod } = await supabase.from('bodega_movimientos').insert(movimientosBodega)
            if (errBod) throw errBod
        }

        // 6. REGISTRAR GASTO AUTOM√ÅTICO (SOLO SI ES CREACI√ìN O SE MARCA EXPL√çCITAMENTE)
        // Nota: Solo lo hacemos si es nuevo (para no duplicar en edici√≥n) o si el usuario insiste.
        // Aqu√≠ asumimos que si el check est√° true, quiere crear el gasto.
        if (crearGastoAuto) {
             // Calculamos el monto total real de la operaci√≥n (sumando lo de todos los sectores o el global input)
             // Si fue por √°rbol, hay que recalcular el total global
             let montoGasto = totalGlobalInput;
             
             if (formData.metodo_costo !== 'Global') {
                 // Sumamos el costo total de los registros insertados
                 montoGasto = registrosLabor.reduce((acc, curr) => acc + curr.costo_total, 0);
             }

             if (montoGasto > 0) {
                 const { error: errGasto } = await supabase.from('gastos').insert([{
                     fecha: formData.fecha,
                     monto: montoGasto,
                     descripcion: `Labor: ${formData.tipo_labor} (Generado Autom√°ticamente)`,
                     categoria: 'Mano de Obra', // Puedes cambiar esto a una categor√≠a que prefieras por defecto
                     labor_origen_id: laborIdReference,
                     proveedor_id: formData.proveedor_id || null,
                     estado_pago: 'Pendiente' // Por defecto
                 }])
                 
                 if (errGasto) console.error("Error creando gasto auto:", errGasto)
             }
        }

        setIsDirty(false)
        alGuardar()

    } catch (error) {
        console.error(error)
        alert("Error al guardar: " + error.message)
    } finally {
        setLoading(false)
    }
  }

  const styles = {
    form: { display: 'flex', flexDirection: 'column', gap: '20px' },
    label: { fontSize: '0.9rem', fontWeight: 'bold', color: '#374151', marginBottom: '5px', display: 'block' },
    input: { padding: '10px', borderRadius: '6px', border: '1px solid #d1d5db', width: '100%', boxSizing: 'border-box' },
    select: { padding: '10px', borderRadius: '6px', border: '1px solid #d1d5db', width: '100%', boxSizing: 'border-box', backgroundColor: 'white', fontSize:'1rem' },
    
    scrollArea: { maxHeight: '150px', overflowY: 'auto', border: '1px solid #e5e7eb', borderRadius: '8px', padding: '10px', backgroundColor:'white' },
    sectorGrid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(180px, 1fr))', gap: '10px' },
    sectorItem: (selected) => ({
        display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', borderRadius: '6px', cursor: 'pointer', transition: '0.2s',
        backgroundColor: selected ? '#f0fdf4' : 'white', border: selected ? '1px solid #16a34a' : '1px solid #e5e7eb', color: selected ? '#15803d' : '#374151'
    }),
    
    bodegaBox: { backgroundColor: '#fff7ed', border: '1px solid #fed7aa', padding: '15px', borderRadius: '8px' },
    insumoRow: { display:'flex', gap:'10px', marginBottom:'10px', alignItems:'flex-end' },
    btnSmall: { padding:'8px', backgroundColor:'#fff', border:'1px solid #d1d5db', borderRadius:'6px', cursor:'pointer', color:'#ef4444', display:'flex', alignItems:'center' },

    costCard: { backgroundColor: '#f8fafc', padding: '15px', borderRadius: '8px', border: '1px solid #e2e8f0' },
    radioGroup: { display: 'flex', gap: '15px', marginBottom: '15px', flexWrap:'wrap' },
    totalRow: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '15px', borderTop: '1px solid #e2e8f0', paddingTop: '10px' },
    
    actions: { display:'flex', gap:'10px', marginTop:'10px' },
    btnSave: { flex:1, padding: '12px', backgroundColor: '#1f2937', color: 'white', border: 'none', borderRadius: '8px', fontWeight: 'bold', cursor: 'pointer', opacity: loading ? 0.7 : 1 },
    btnCancel: { padding: '12px', backgroundColor: 'white', color: '#ef4444', border: '1px solid #ef4444', borderRadius: '8px', fontWeight: 'bold', cursor: 'pointer' }
  }

  const totalCalculado = calcularTotalEstimado()

  return (
    <form onSubmit={handleSubmit} style={styles.form}>
      
      {/* SECCI√ìN 1: SECTORES */}
      <div>
        <label style={styles.label}>Sectores Afectados ({sectoresSeleccionados.length}) <span style={{color:'red'}}>*</span></label>
        {sectores.length === 0 ? (
            <div style={{color:'#6b7280', fontSize:'0.9rem', padding:'10px'}}>Cargando sectores...</div>
        ) : (
            <div style={styles.scrollArea}>
                <div style={styles.sectorGrid}>
                    {sectores.map(s => {
                        const isSelected = sectoresSeleccionados.includes(s.id)
                        return (
                            <div key={s.id} onClick={() => toggleSector(s.id)} style={styles.sectorItem(isSelected)}>
                                {isSelected ? <CheckSquare size={18} /> : <Square size={18} color="#d1d5db"/>}
                                <div>
                                    <div style={{fontWeight:'bold', fontSize:'0.85rem'}}>{s.nombre}</div>
                                    <div style={{fontSize:'0.7rem', color:'#6b7280'}}>{s.parcelas?.nombre}</div>
                                </div>
                            </div>
                        )
                    })}
                </div>
            </div>
        )}
      </div>

      {/* SECCI√ìN 2: DATOS GENERALES */}
      <div style={{display:'flex', gap:'20px'}}>
         <div style={{flex: 1}}>
            <label style={styles.label}>Fecha <span style={{color:'red'}}>*</span></label>
            <input type="date" name="fecha" value={formData.fecha} onChange={handleChange} style={styles.input} required />
         </div>
         
         <div style={{flex: 1}}>
            <label style={styles.label}>Tipo de Labor <span style={{color:'red'}}>*</span></label>
            <select 
                name="tipo_labor" 
                value={formData.tipo_labor} 
                onChange={handleChange} 
                style={styles.select} 
                required
            >
                <option value="">-- Seleccionar --</option>
                {TIPOS_LABOR.map(t => (
                    <option key={t.id} value={t.id}>
                        {t.icono} {t.label}
                    </option>
                ))}
            </select>
         </div>
      </div>
      
      {/* PROVEEDOR */}
      <div style={{display:'flex', gap:'20px'}}>
          <div style={{flex: 1}}>
              <label style={styles.label}>Realizado por (Contratista / Proveedor)</label>
              <select name="proveedor_id" value={formData.proveedor_id} onChange={handleChange} style={styles.select}>
                  <option value="">-- Interno / Sin especificar --</option>
                  {proveedores.map(p => <option key={p.id} value={p.id}>{p.nombre}</option>)}
              </select>
          </div>
          <div style={{flex: 1}}></div>
      </div>

      <div style={styles.formGroup}>
         <label style={styles.label}>Detalles / Notas</label>
         <input type="text" name="comentarios" value={formData.comentarios} onChange={handleChange} style={styles.input} placeholder="Ej: Se realiz√≥ repaso en bordes..." />
      </div>

      {/* SECCI√ìN 3: INSUMOS DE BODEGA */}
      <div style={styles.bodegaBox}>
          <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'10px'}}>
             <label style={{...styles.label, color:'#9a3412', marginBottom:0}}><Package size={16} style={{marginBottom:-3}}/> Salida de Insumos (Opcional)</label>
             <button type="button" onClick={agregarInsumo} style={{background:'none', border:'none', color:'#ea580c', fontWeight:'bold', cursor:'pointer', fontSize:'0.85rem', display:'flex', alignItems:'center', gap:4}}>
                 <Plus size={16}/> Agregar Insumo
             </button>
          </div>
          
          {insumosUsados.length === 0 && <div style={{fontSize:'0.85rem', color:'#9ca3af', fontStyle:'italic'}}>No se descontar√°n productos de bodega.</div>}

          {insumosUsados.map((item, idx) => (
              <div key={idx} style={styles.insumoRow}>
                  <div style={{flex: 2}}>
                      <select 
                        value={item.productoId} 
                        onChange={e => actualizarInsumo(idx, 'productoId', e.target.value)} 
                        style={{...styles.select, fontSize:'0.9rem'}}
                      >
                          <option value="">-- Seleccionar --</option>
                          {insumosBodega.map(ins => (
                              <option key={ins.id} value={ins.id}>
                                  {ins.nombre} (Stock: {ins.stock_actual} {ins.unidad_medida})
                              </option>
                          ))}
                      </select>
                  </div>
                  <div style={{flex: 1, display:'flex', alignItems:'center', gap:'5px'}}>
                      <input 
                        type="number" 
                        value={item.cantidad} 
                        onChange={e => actualizarInsumo(idx, 'cantidad', e.target.value)} 
                        style={styles.input} 
                        placeholder="Cant."
                      />
                      <span style={{fontSize:'0.8rem', color:'#6b7280'}}>{item.unidad}</span>
                  </div>
                  <button type="button" onClick={() => eliminarInsumo(idx)} style={styles.btnSmall}><Trash2 size={16}/></button>
              </div>
          ))}
      </div>

      {/* SECCI√ìN 4: COSTOS */}
      <div style={styles.costCard}>
          <label style={styles.label}><Calculator size={16} style={{marginBottom:-2}}/> Costo Financiero</label>
          
          <div style={styles.radioGroup}>
              <label style={{fontSize:'0.9rem', display:'flex', alignItems:'center', gap:5}}>
                  <input type="radio" name="metodo_costo" value="Global" checked={formData.metodo_costo === 'Global'} onChange={handleChange} />
                  Total Fijo
              </label>
              <label style={{fontSize:'0.9rem', display:'flex', alignItems:'center', gap:5}}>
                  <input type="radio" name="metodo_costo" value="Por Arbol" checked={formData.metodo_costo === 'Por Arbol'} onChange={handleChange} />
                  Por √Årbol
              </label>
              <label style={{fontSize:'0.9rem', display:'flex', alignItems:'center', gap:5}}>
                  <input type="radio" name="metodo_costo" value="Por Hectarea" checked={formData.metodo_costo === 'Por Hectarea'} onChange={handleChange} />
                  Por Ha
              </label>
          </div>

          {formData.metodo_costo === 'Global' ? (
              <div>
                  <label style={{fontSize:'0.8rem', color:'#4b5563'}}>Costo Total ($)</label>
                  <input type="number" name="costo_manual" value={formData.costo_manual} onChange={handleChange} style={styles.input} placeholder="0" />
              </div>
          ) : (
               <div>
                  <label style={{fontSize:'0.8rem', color:'#4b5563'}}>Precio Unitario ({formData.metodo_costo})</label>
                  <input type="number" name="precio_unitario" value={formData.precio_unitario} onChange={handleChange} style={styles.input} placeholder="0" />
              </div>
          )}

          <div style={styles.totalRow}>
              <div style={{display:'flex', alignItems:'center', gap:'5px', color:'#4b5563'}}>
                  <Info size={16}/> Costo Financiero Estimado
              </div>
              <div style={{fontSize: '1.4rem', fontWeight: 'bold', color: '#059669'}}>{formatMoney(totalCalculado)}</div>
          </div>

          {/* --- PEGAR EL CHECKBOX AQU√ç --- */}
          <div style={{marginTop:'15px', paddingTop:'15px', borderTop:'1px dashed #cbd5e1'}}>
              <label style={{display:'flex', alignItems:'center', gap:'8px', cursor:'pointer', fontSize:'0.9rem', color:'#374151', userSelect:'none'}}>
                  <input 
                      type="checkbox" 
                      checked={crearGastoAuto} 
                      onChange={e => setCrearGastoAuto(e.target.checked)} 
                      style={{width:'16px', height:'16px', accentColor:'#1f2937'}}
                  />
                  <span style={{fontWeight:'500'}}>Registrar tambi√©n en Gastos (Contabilidad)</span>
              </label>
              {crearGastoAuto && (
                  <div style={{fontSize:'0.8rem', color:'#64748b', marginLeft:'26px', marginTop:'4px'}}>
                      Se crear√° autom√°ticamente un registro en la categor√≠a "Mano de Obra / Labores".
                  </div>
              )}
          </div>

      </div>

      <div style={styles.actions}>
        <button type="button" onClick={() => window.intentarCerrarModal ? window.intentarCerrarModal() : cerrarModal()} style={styles.btnCancel}>
            <X size={18} style={{marginRight:5}}/> Cancelar
        </button>
        <button type="submit" style={styles.btnSave} disabled={loading}>
            <Save size={18} style={{marginRight:5}}/> 
            {loading ? 'Guardando...' : (idLabor ? 'Actualizar Labor' : 'Registrar Labor')}
        </button>
      </div>

    </form>
  )
}
export default NuevaLabor


==================================================
RUTA: src\pages\NuevaOferta.jsx
==================================================
import { useState, useEffect, useRef } from 'react'
import { supabase } from '../supabaseClient'
import { Save, Plus, Trash2 } from 'lucide-react'

const CALIBRES_STD = ["Extra", "Primera", "Segunda", "Tercera", "Cuarta", "Quinta", "Descarte", "Barrido"]

function NuevaOferta({ idOferta, cerrarModal, alGuardar }) {
  const [loading, setLoading] = useState(false)
  const [isDirty, setIsDirty] = useState(false)
  const [clientes, setClientes] = useState([])
  const inputsRef = useRef({})

  const [formData, setFormData] = useState({
    cliente_id: '',
    nombre: '',
    fecha: new Date().toISOString().split('T')[0],
    activa: true
  })

  // Inicializamos con los est√°ndar, pero ahora es una lista din√°mica
  const [precios, setPrecios] = useState(
      CALIBRES_STD.map(c => ({ calibre: c, precio: '' }))
  )

  useEffect(() => {
    async function load() {
        const { data } = await supabase.from('clientes').select('id, nombre').order('nombre')
        setClientes(data || [])

        if (idOferta) {
            const { data: of } = await supabase.from('ofertas_comerciales').select('*').eq('id', idOferta).single()
            if (of) {
                setFormData({
                    cliente_id: of.cliente_id,
                    nombre: of.nombre,
                    fecha: of.fecha,
                    activa: of.activa
                })
                // Si ya tiene precios guardados (JSON), los usamos.
                if (of.precios_json && Array.isArray(of.precios_json)) {
                    setPrecios(of.precios_json)
                }
            }
        }
    }
    load()
  }, [idOferta])

  // Navegaci√≥n teclado
  const handleKeyDown = (e, index) => {
    if (e.key === 'Enter' || e.key === 'ArrowDown') {
        e.preventDefault()
        // Buscar el siguiente input disponible
        let nextIndex = index + 1
        while (nextIndex < precios.length && !inputsRef.current[nextIndex]) {
            nextIndex++
        }
        if (inputsRef.current[nextIndex]) inputsRef.current[nextIndex].focus()
    }
    if (e.key === 'ArrowUp') {
        e.preventDefault()
        let prevIndex = index - 1
        while (prevIndex >= 0 && !inputsRef.current[prevIndex]) {
            prevIndex--
        }
        if (inputsRef.current[prevIndex]) inputsRef.current[prevIndex].focus()
    }
  }

  const handleChangeRow = (index, field, val) => {
      setIsDirty(true)
      const copia = [...precios]
      copia[index][field] = val
      setPrecios(copia)
  }

  const eliminarFila = (index) => {
      const copia = precios.filter((_, i) => i !== index)
      setPrecios(copia)
      setIsDirty(true)
  }

  const agregarFila = () => {
      setPrecios([...precios, { calibre: '', precio: '' }])
  }

  const handleSubmit = async (e) => {
      e.preventDefault()
      if (!formData.cliente_id) return alert("Selecciona un cliente")
      if (!formData.nombre) return alert("Ponle nombre a la oferta (ej: Cotizaci√≥n 1)")

      setLoading(true)
      try {
          // Guardamos todos los que tengan alg√∫n dato
          const preciosGuardar = precios.filter(p => p.calibre)

          const payload = {
              ...formData,
              precios_json: preciosGuardar
          }

          if (idOferta) {
              await supabase.from('ofertas_comerciales').update(payload).eq('id', idOferta)
          } else {
              await supabase.from('ofertas_comerciales').insert([payload])
          }

          setIsDirty(false)
          alGuardar()
      } catch (err) {
          alert("Error: " + err.message)
      } finally {
          setLoading(false)
      }
  }

  // Protecci√≥n cierre
  useEffect(() => {
    window.intentarCerrarModal = () => {
        if (isDirty && confirm("¬øSalir sin guardar cambios?")) cerrarModal()
        else if (!isDirty) cerrarModal()
    }
    return () => { window.intentarCerrarModal = null }
  }, [isDirty, cerrarModal])

  const styles = {
      form: { display: 'flex', flexDirection: 'column', gap: '15px' },
      row: { display:'flex', gap:'10px' },
      col: { flex:1 },
      label: { display:'block', fontWeight:'bold', marginBottom:'3px', fontSize:'0.85rem', color:'#374151' },
      input: { width:'100%', padding:'8px', borderRadius:'6px', border:'1px solid #d1d5db', boxSizing:'border-box' },
      table: { width:'100%', borderCollapse:'collapse', marginTop:'10px', border:'1px solid #e5e7eb' },
      th: { textAlign:'left', padding:'8px', backgroundColor:'#f9fafb', borderBottom:'1px solid #e5e7eb', fontSize:'0.85rem' },
      td: { padding:'5px', borderBottom:'1px solid #f3f4f6' },
      inputPrice: { width:'100%', padding:'6px', border:'1px solid #d1d5db', borderRadius:'4px', textAlign:'right' },
      inputCalibre: { width:'100%', padding:'6px', border:'none', background:'transparent', fontWeight:'500' },
      btnSave: { padding:'12px', backgroundColor:'#1f2937', color:'white', border:'none', borderRadius:'6px', fontWeight:'bold', cursor:'pointer', display:'flex', justifyContent:'center', alignItems:'center', gap:'8px' },
      btnIcon: { background:'none', border:'none', cursor:'pointer', color:'#ef4444', display:'flex', alignItems:'center' },
      btnAdd: { marginTop:'10px', background:'none', border:'1px dashed #9ca3af', color:'#4b5563', width:'100%', padding:'8px', borderRadius:'6px', cursor:'pointer', display:'flex', justifyContent:'center', alignItems:'center', gap:'5px', fontSize:'0.85rem' }
  }

  return (
    <form onSubmit={handleSubmit} style={styles.form}>
        <div style={styles.row}>
            <div style={styles.col}>
                <label style={styles.label}>Cliente</label>
                <select 
                    value={formData.cliente_id} 
                    onChange={e => { setIsDirty(true); setFormData({...formData, cliente_id: e.target.value})}} 
                    style={styles.input}
                    disabled={!!idOferta}
                >
                    <option value="">-- Seleccionar --</option>
                    {clientes.map(c => <option key={c.id} value={c.id}>{c.nombre}</option>)}
                </select>
            </div>
            <div style={styles.col}>
                <label style={styles.label}>Fecha</label>
                <input type="date" value={formData.fecha} onChange={e => { setIsDirty(true); setFormData({...formData, fecha: e.target.value})}} style={styles.input}/>
            </div>
        </div>

        <div>
            <label style={styles.label}>Nombre de Cotizaci√≥n / Oferta</label>
            <input 
                type="text" 
                placeholder="Ej: Cotizaci√≥n 1 - Octubre" 
                value={formData.nombre} 
                onChange={e => { setIsDirty(true); setFormData({...formData, nombre: e.target.value})}} 
                style={styles.input}
            />
            <small style={{color:'#6b7280', fontSize:'0.75rem'}}>√ötil para diferenciar si el cliente env√≠a una segunda oferta mejorada.</small>
        </div>

        <div style={{maxHeight:'300px', overflowY:'auto'}}>
            <table style={styles.table}>
                <thead>
                    <tr>
                        <th style={{...styles.th, width:'50%'}}>Calibre</th>
                        <th style={{...styles.th, width:'40%'}}>Precio ($/Kg)</th>
                        <th style={{...styles.th, width:'10%'}}></th>
                    </tr>
                </thead>
                <tbody>
                    {precios.map((p, i) => (
                        <tr key={i}>
                            <td style={styles.td}>
                                <input 
                                    type="text"
                                    value={p.calibre}
                                    onChange={e => handleChangeRow(i, 'calibre', e.target.value)}
                                    style={styles.inputCalibre}
                                    placeholder="Nombre Calibre"
                                />
                            </td>
                            <td style={styles.td}>
                                <input 
                                    ref={el => inputsRef.current[i] = el}
                                    type="number" 
                                    placeholder="0" 
                                    value={p.precio}
                                    onChange={e => handleChangeRow(i, 'precio', e.target.value)}
                                    onKeyDown={e => handleKeyDown(e, i)}
                                    style={styles.inputPrice}
                                />
                            </td>
                            <td style={styles.td}>
                                <button type="button" onClick={() => eliminarFila(i)} style={styles.btnIcon} tabIndex={-1}>
                                    <Trash2 size={16}/>
                                </button>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
            <button type="button" onClick={agregarFila} style={styles.btnAdd}>
                <Plus size={14}/> Agregar Calibre
            </button>
        </div>

        <div style={{display:'flex', alignItems:'center', gap:'10px', marginTop:'5px'}}>
             <input type="checkbox" checked={formData.activa} onChange={e => { setIsDirty(true); setFormData({...formData, activa: e.target.checked})}} />
             <label style={{fontSize:'0.9rem'}}>Oferta Activa</label>
        </div>

        <button type="submit" style={styles.btnSave} disabled={loading}>
            <Save size={18}/> Guardar Oferta
        </button>
    </form>
  )
}
export default NuevaOferta

==================================================
RUTA: src\pages\NuevaParcela.jsx
==================================================
import { useState, useEffect } from 'react'
import { supabase } from '../supabaseClient'
import { Save, X, MapPin } from 'lucide-react'

function NuevaParcela({ idParcela, cerrarModal, alGuardar }) {
  const [loading, setLoading] = useState(false)
  const [isDirty, setIsDirty] = useState(false)

  const [formData, setFormData] = useState({
    nombre: '',
    superficie_ha: ''
  })

  useEffect(() => {
    if (idParcela) {
      async function cargarParcela() {
        const { data } = await supabase.from('parcelas').select('*').eq('id', idParcela).single()
        if (data) {
          setFormData({
            nombre: data.nombre,
            superficie_ha: data.superficie_ha || ''
          })
        }
      }
      cargarParcela()
    }
  }, [idParcela])

  const handleChange = (e) => {
    setIsDirty(true)
    setFormData({ ...formData, [e.target.name]: e.target.value })
  }

  // Protecci√≥n de cierre seguro
  useEffect(() => {
    window.intentarCerrarModal = () => {
        if (isDirty && window.confirm("‚ö†Ô∏è Tienes cambios sin guardar. ¬øDeseas salir?")) {
            cerrarModal()
        } else if (!isDirty) {
            cerrarModal()
        }
    }
    return () => { window.intentarCerrarModal = null }
  }, [isDirty, cerrarModal])

  const handleSubmit = async (e) => {
    e.preventDefault()
    setLoading(true)

    const datosGuardar = {
      nombre: formData.nombre,
      superficie_ha: formData.superficie_ha
    }

    let error
    if (idParcela) {
      const { error: errUpdate } = await supabase.from('parcelas').update(datosGuardar).eq('id', idParcela)
      error = errUpdate
    } else {
      const { error: errInsert } = await supabase.from('parcelas').insert([datosGuardar])
      error = errInsert
    }

    setLoading(false)

    if (error) {
        alert('Error: ' + error.message)
    } else {
        setIsDirty(false)
        alGuardar()
    }
  }

  const styles = {
    container: { padding: '10px 20px', width: '100%', boxSizing: 'border-box' },
    formGroup: { marginBottom: '20px' },
    label: { display: 'block', marginBottom: '8px', color: '#4b5563', fontWeight: '500' },
    input: { width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '1rem', boxSizing:'border-box' },
    actions: { display: 'flex', gap: '10px', marginTop: '30px' },
    btnSave: { flex: 1, padding: '12px', backgroundColor: '#059669', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '1rem' },
    btnCancel: { flex: 1, padding: '12px', backgroundColor: '#f3f4f6', color: '#4b5563', border: '1px solid #d1d5db', borderRadius: '8px', cursor: 'pointer', display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '1rem' }
  }

  return (
    <div style={styles.container}>
        <form onSubmit={handleSubmit}>
          
          <div style={styles.formGroup}>
            <label style={styles.label}>Nombre de la Parcela <span style={{color:'red'}}>*</span></label>
            <input type="text" name="nombre" value={formData.nombre} onChange={handleChange} style={styles.input} placeholder="Ej: Fundo El Retiro" required />
          </div>

          <div style={styles.formGroup}>
            <label style={styles.label}>Superficie (Hect√°reas)</label>
            <input type="number" step="0.1" name="superficie_ha" value={formData.superficie_ha} onChange={handleChange} style={styles.input} placeholder="Ej: 15.5" />
          </div>

          <div style={styles.actions}>
            <button type="button" onClick={() => window.intentarCerrarModal ? window.intentarCerrarModal() : cerrarModal()} style={styles.btnCancel}>
              <X size={20} /> Cancelar
            </button>
            <button type="submit" style={styles.btnSave} disabled={loading}>
              <Save size={20} /> {idParcela ? 'Actualizar' : 'Guardar Parcela'}
            </button>
          </div>

        </form>
    </div>
  )
}

export default NuevaParcela


==================================================
RUTA: src\pages\NuevoCliente.jsx
==================================================
import { useState, useEffect } from 'react'
import { supabase } from '../supabaseClient'
// 1. YA NO IMPORTAMOS useParams NI useNavigate
// import { useNavigate, useParams } from 'react-router-dom' 
import { Save, X, Briefcase } from 'lucide-react'

// 2. RECIBIMOS "props" EN LUGAR DE USAR HOOKS DE NAVEGACI√ìN
// idCliente: El ID que nos pasa el Modal (o null si es nuevo)
// cerrarModal: Funci√≥n para cerrar la ventana
// alGuardar: Funci√≥n para refrescar la lista de atr√°s
function NuevoCliente({ idCliente, cerrarModal, alGuardar }) {
  
  const [loading, setLoading] = useState(false)
  const [isDirty, setIsDirty] = useState(false) // Para saber si escribi√≥ algo

  const [formData, setFormData] = useState({
    nombre: '',
    rut: '',
    telefono: '',
    email: '',
    tipo: 'Exportadora'
  })

  // 3. CARGAMOS DATOS USANDO LA PROP 'idCliente'
  useEffect(() => {
    if (idCliente) {
      async function cargarCliente() {
        const { data } = await supabase.from('clientes').select('*').eq('id', idCliente).single()
        if (data) {
          setFormData({
            nombre: data.nombre,
            rut: data.rut || '',
            telefono: data.telefono || '',
            email: data.email || '',
            tipo: data.tipo || 'Exportadora'
          })
        }
      }
      cargarCliente()
    }
  }, [idCliente])

  // 4. DETECTAR CAMBIOS PARA PROTECCI√ìN DE CIERRE
  const handleChange = (e) => {
    setIsDirty(true) // Marcamos que hubo cambios
    setFormData({ ...formData, [e.target.name]: e.target.value })
  }

  // 5. CONFIGURAR LA PROTECCI√ìN CONTRA CIERRE ACCIDENTAL (ESC o Click fuera)
  useEffect(() => {
    window.intentarCerrarModal = () => {
        if (isDirty) {
            if (window.confirm("‚ö†Ô∏è Tienes cambios sin guardar. ¬øDeseas salir?")) {
                cerrarModal()
            }
        } else {
            cerrarModal()
        }
    }
    return () => { window.intentarCerrarModal = null }
  }, [isDirty, cerrarModal])


  const handleSubmit = async (e) => {
    e.preventDefault()
    setLoading(true)

    const datosGuardar = { ...formData }

    let error
    // 6. USAMOS idCliente EN VEZ DE id
    if (idCliente) {
      const { error: errUpdate } = await supabase.from('clientes').update(datosGuardar).eq('id', idCliente)
      error = errUpdate
    } else {
      const { error: errInsert } = await supabase.from('clientes').insert([datosGuardar])
      error = errInsert
    }

    setLoading(false)

    if (error) {
        alert('Error: ' + error.message)
    } else {
        // 7. EN VEZ DE NAVIGATE, EJECUTAMOS ALGUARDAR
        setIsDirty(false) // Limpiamos la marca de cambios
        alGuardar() // Cerramos y refrescamos
    }
  }

  const styles = {
    // Ajust√© el container para que no tenga margen gigante, ya que ahora vive en una ventana peque√±a
    container: { padding: '10px 20px', width: '100%', boxSizing: 'border-box' },
    formGroup: { marginBottom: '20px' },
    label: { display: 'block', marginBottom: '8px', color: '#4b5563', fontWeight: '500' },
    input: { width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '1rem', boxSizing:'border-box' },
    select: { width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '1rem', backgroundColor: 'white', boxSizing:'border-box' },
    actions: { display: 'flex', gap: '10px', marginTop: '30px' },
    btnSave: { flex: 1, padding: '12px', backgroundColor: '#059669', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '1rem' },
    btnCancel: { flex: 1, padding: '12px', backgroundColor: '#f3f4f6', color: '#4b5563', border: '1px solid #d1d5db', borderRadius: '8px', cursor: 'pointer', display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '1rem' }
  }

  return (
    <div style={styles.container}>
        {/* Quitamos el T√≠tulo H2 y la Card blanca extra porque el Modal ya tiene t√≠tulo y fondo blanco */}
        
        <form onSubmit={handleSubmit}>
          
          <div style={styles.formGroup}>
            <label style={styles.label}>Nombre / Raz√≥n Social <span style={{color:'red'}}>*</span></label>
            <input type="text" name="nombre" value={formData.nombre} onChange={handleChange} style={styles.input} placeholder="Ej: Exportadora del Sur" required />
          </div>

          <div style={{display: 'flex', gap: '20px'}}>
             <div style={{...styles.formGroup, flex: 1}}>
                <label style={styles.label}>RUT</label>
                <input type="text" name="rut" value={formData.rut} onChange={handleChange} style={styles.input} placeholder="76.xxx.xxx-x" />
             </div>
             <div style={{...styles.formGroup, flex: 1}}>
                <label style={styles.label}>Tipo</label>
                <select name="tipo" value={formData.tipo} onChange={handleChange} style={styles.select}>
                   <option value="Exportadora">Exportadora</option>
                   <option value="Mercado Interno">Mercado Interno</option>
                   <option value="Intermediario">Intermediario</option>
                   <option value="Particular">Particular</option>
                </select>
             </div>
          </div>

          <div style={styles.formGroup}>
            <label style={styles.label}>Tel√©fono</label>
            <input type="text" name="telefono" value={formData.telefono} onChange={handleChange} style={styles.input} placeholder="+56 9 ..." />
          </div>

          <div style={styles.formGroup}>
            <label style={styles.label}>Email</label>
            <input type="email" name="email" value={formData.email} onChange={handleChange} style={styles.input} placeholder="contacto@empresa.com" />
          </div>

          <div style={styles.actions}>
            {/* 8. EL BOT√ìN CANCELAR USA LA L√ìGICA SEGURA */}
            <button type="button" onClick={() => window.intentarCerrarModal ? window.intentarCerrarModal() : cerrarModal()} style={styles.btnCancel}>
              <X size={20} /> Cancelar
            </button>
            <button type="submit" style={styles.btnSave} disabled={loading}>
              <Save size={20} /> {idCliente ? 'Actualizar' : 'Guardar Cliente'}
            </button>
          </div>

        </form>
    </div>
  )
}

export default NuevoCliente


==================================================
RUTA: src\pages\NuevoGasto.jsx
==================================================
import { useState, useEffect } from 'react'
import { supabase } from '../supabaseClient'
import { Save, Plus, Trash2, DollarSign, AlertCircle } from 'lucide-react'

function NuevoGasto({ idGasto, cerrarModal, alGuardar }) {
  const [loading, setLoading] = useState(false)
  const [isDirty, setIsDirty] = useState(false) 

  // Listas maestras
  const [listas, setListas] = useState({
    parcelas: [], proveedores: [], categorias: [], subcategorias: [], socios: []
  })
  const [subcategoriasFiltradas, setSubcategoriasFiltradas] = useState([])

  const [formData, setFormData] = useState({
    fecha: new Date().toISOString().split('T')[0],
    monto: '', 
    proveedor_id: '', 
    tipo_documento: 'Factura', // Valor por defecto
    nro_documento: '',
    categoria_id: '', 
    subcategoria_id: '', 
    parcela_id: '', 
    descripcion: ''
  })

  const [pagos, setPagos] = useState([{
    id: Date.now(), fecha_vencimiento: new Date().toISOString().split('T')[0],
    monto: '', forma_pago: 'Transferencia', estado: 'Pendiente'
  }])

  // Helpers
  const parseMoney = (val) => val.replace(/\./g, '')
  const formatMoney = (val) => val ? parseInt(val).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") : ''
  const formatCurrency = (val) => '$ ' + Math.round(val).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")

  // Carga inicial
  useEffect(() => {
    async function init() {
      const [par, prov, cat, sub, soc] = await Promise.all([
        supabase.from('parcelas').select('id, nombre').order('nombre'),
        supabase.from('proveedores').select('id, nombre').order('nombre'),
        supabase.from('categorias_gastos').select('id, nombre').order('nombre'),
        supabase.from('subcategorias_gastos').select('id, nombre, categoria_id').order('nombre'),
        supabase.from('socios').select('id, nombre').order('nombre')
      ])
      setListas({ 
        parcelas: par.data || [], proveedores: prov.data || [], 
        categorias: cat.data || [], subcategorias: sub.data || [], socios: soc.data || [] 
      })

      // Si es EDICI√ìN, cargar datos
      if (idGasto) {
        const { data: gasto } = await supabase.from('gastos').select('*').eq('id', idGasto).single()
        if (gasto) {
          setFormData({
            fecha: gasto.fecha, monto: gasto.monto,
            proveedor_id: gasto.proveedor_id || '', 
            tipo_documento: gasto.tipo_documento || 'Factura',
            nro_documento: gasto.nro_documento || '', 
            categoria_id: gasto.categoria_id || '',
            subcategoria_id: gasto.subcategoria_id || '', 
            parcela_id: gasto.parcela_id || '',
            descripcion: gasto.descripcion || ''
          })
          const { data: pagosBD } = await supabase.from('pagos_gastos').select('*').eq('gasto_id', idGasto)
          if (pagosBD?.length) setPagos(pagosBD)
        }
      }
    }
    init()
  }, [idGasto])

  // Filtrado de Subcategor√≠as
  useEffect(() => {
    if (formData.categoria_id) {
      setSubcategoriasFiltradas(listas.subcategorias.filter(s => s.categoria_id.toString() === formData.categoria_id.toString()))
    } else {
      setSubcategoriasFiltradas([])
    }
  }, [formData.categoria_id, listas.subcategorias])

  // Manejador General
  const handleChange = (e) => {
    setIsDirty(true)
    const { name, value } = e.target
    if (name === 'monto') {
        const raw = parseMoney(value)
        if (!isNaN(raw)) setFormData(prev => ({...prev, monto: raw}))
    } else if (name === 'categoria_id') {
        setFormData(prev => ({ ...prev, [name]: value, subcategoria_id: '' }))
    } else {
        setFormData(prev => ({ ...prev, [name]: value }))
    }
  }

  // L√≥gica de Pagos
  const updatePago = (id, field, val) => {
    setIsDirty(true)
    setPagos(prev => prev.map(p => {
        if (p.id === id) {
            if (field === 'monto') {
                const raw = parseMoney(val); return !isNaN(raw) ? { ...p, monto: raw } : p
            }
            return { ...p, [field]: val }
        }
        return p
    }))
  }
  const addPago = () => setPagos([...pagos, { id: Date.now(), fecha_vencimiento: formData.fecha, monto: '', forma_pago: 'Transferencia', estado: 'Pendiente' }])
  const removePago = (id) => pagos.length > 1 && setPagos(prev => prev.filter(p => p.id !== id))

  // C√°lculos
  const totalFactura = parseFloat(formData.monto) || 0
  const totalProgramado = pagos.reduce((acc, p) => acc + (parseFloat(p.monto) || 0), 0)
  const restante = totalFactura - totalProgramado
  const valido = Math.abs(restante) < 1

  // Interceptar el Cierre
  useEffect(() => {
    window.intentarCerrarModal = () => {
        if (isDirty) {
            if (confirm("‚ö†Ô∏è Tienes cambios sin guardar.\n¬øSeguro que quieres salir y perder los datos?")) {
                cerrarModal()
            }
        } else {
            cerrarModal()
        }
    }
    return () => { window.intentarCerrarModal = null }
  }, [isDirty, cerrarModal])


  const handleSubmit = async (e) => {
    e.preventDefault()
    if (!valido) return alert("Los pagos no suman el total de la factura.")
    
    setLoading(true)
    try {
      const todosPagados = pagos.every(p => p.estado === 'Pagado')
      const ninguno = pagos.every(p => p.estado === 'Pendiente')
      const estadoGlobal = todosPagados ? 'Pagado' : (ninguno ? 'Pendiente' : 'Parcial')

      const payload = { ...formData, estado_pago: estadoGlobal }
      
      let idFinal = idGasto
      if (idGasto) {
        await supabase.from('gastos').update(payload).eq('id', idGasto)
        await supabase.from('pagos_gastos').delete().eq('gasto_id', idGasto)
      } else {
        const { data } = await supabase.from('gastos').insert([payload]).select().single()
        idFinal = data.id
      }

      const pagosFormat = pagos.map(p => ({
        gasto_id: idFinal, fecha_vencimiento: p.fecha_vencimiento,
        monto: p.monto, forma_pago: p.forma_pago, estado: p.estado
      }))
      await supabase.from('pagos_gastos').insert(pagosFormat)

      alGuardar() 
    } catch (err) {
      alert(err.message)
    } finally {
      setLoading(false)
    }
  }

  const styles = {
    form: { display: 'flex', flexDirection: 'column', gap: '15px' },
    row: { display: 'flex', gap: '15px' },
    group: { flex: 1, display: 'flex', flexDirection: 'column', gap: '5px' },
    label: { fontSize: '0.85rem', fontWeight: '600', color: '#374151' },
    input: { padding: '10px', borderRadius: '6px', border: '1px solid #d1d5db', fontSize: '0.95rem' },
    sectionTitle: { fontSize: '1rem', fontWeight: 'bold', color: '#1f2937', marginTop: '20px', borderBottom: '1px solid #e5e7eb', paddingBottom: '5px' },
    table: { width: '100%', borderCollapse: 'collapse', marginTop: '10px' },
    th: { textAlign: 'left', padding: '8px', fontSize: '0.8rem', color: '#6b7280', borderBottom: '1px solid #e5e7eb' },
    td: { padding: '8px', borderBottom: '1px solid #f9fafb' },
    summary: { display: 'flex', justifyContent: 'flex-end', gap: '20px', backgroundColor: '#f9fafb', padding: '15px', borderRadius: '8px', marginTop: '10px' },
    btnPrimary: { padding: '12px', backgroundColor: '#1f2937', color: 'white', border: 'none', borderRadius: '8px', fontWeight: 'bold', cursor: 'pointer', marginTop: '20px', opacity: loading ? 0.7 : 1 }
  }

  return (
    <form onSubmit={handleSubmit} style={styles.form}>
      
      {/* SECCI√ìN 1: DATOS GENERALES */}
      <div style={styles.row}>
        <div style={styles.group}>
            <label style={styles.label}>Fecha *</label>
            <input type="date" name="fecha" value={formData.fecha} onChange={handleChange} style={styles.input} required />
        </div>
        <div style={styles.group}>
            <label style={styles.label}>Monto Total *</label>
            <div style={{position:'relative'}}>
                <DollarSign size={16} style={{position:'absolute', top:11, left:10, color:'#9ca3af'}}/>
                <input 
                    type="text" name="monto" value={formatMoney(formData.monto)} 
                    onChange={handleChange} style={{...styles.input, paddingLeft:30, fontWeight:'bold'}} 
                    placeholder="0" required 
                />
            </div>
        </div>
      </div>

      <div style={styles.row}>
        <div style={{...styles.group, flex: 2}}>
            <label style={styles.label}>Proveedor *</label>
            <select name="proveedor_id" value={formData.proveedor_id} onChange={handleChange} style={styles.input} required>
                <option value="">-- Seleccionar --</option>
                {listas.proveedores.map(p => <option key={p.id} value={p.id}>{p.nombre}</option>)}
            </select>
        </div>
        
        {/* --- AQU√ç EST√Å EL CAMBIO: TIPO DE DOCUMENTO --- */}
        <div style={{...styles.group, flex: 1}}>
            <label style={styles.label}>Tipo Doc.</label>
            <select name="tipo_documento" value={formData.tipo_documento} onChange={handleChange} style={styles.input}>
                <option value="Factura">Factura</option>
                <option value="Boleta">Boleta</option>
                <option value="Gu√≠a">Gu√≠a</option>
                <option value="Recibo">Recibo</option>
                <option value="Sin Doc">Sin Doc</option>
            </select>
        </div>

        <div style={{...styles.group, flex: 1}}>
            <label style={styles.label}>N¬∞ Documento</label>
            <input type="text" name="nro_documento" value={formData.nro_documento} onChange={handleChange} style={styles.input} placeholder="1234" />
        </div>
      </div>

      <div style={styles.row}>
        <div style={styles.group}>
            <label style={styles.label}>Categor√≠a</label>
            <select name="categoria_id" value={formData.categoria_id} onChange={handleChange} style={styles.input}>
                <option value="">-- Seleccionar --</option>
                {listas.categorias.map(c => <option key={c.id} value={c.id}>{c.nombre}</option>)}
            </select>
        </div>
        <div style={styles.group}>
            <label style={styles.label}>Subcategor√≠a</label>
            <select name="subcategoria_id" value={formData.subcategoria_id} onChange={handleChange} style={styles.input}>
                <option value="">-- Seleccionar --</option>
                {subcategoriasFiltradas.map(s => <option key={s.id} value={s.id}>{s.nombre}</option>)}
            </select>
        </div>
      </div>

      <div style={styles.group}>
          <label style={styles.label}>Descripci√≥n</label>
          <input type="text" name="descripcion" value={formData.descripcion} onChange={handleChange} style={styles.input} placeholder="Detalle del gasto..." />
      </div>

      {/* SECCI√ìN 2: PAGOS */}
      <h3 style={styles.sectionTitle}>Plan de Pagos</h3>
      <table style={styles.table}>
        <thead><tr><th>Vencimiento</th><th>Monto</th><th>Estado</th><th></th></tr></thead>
        <tbody>
            {pagos.map(p => (
                <tr key={p.id}>
                    <td style={styles.td}>
                        <input type="date" value={p.fecha_vencimiento} onChange={e => updatePago(p.id, 'fecha_vencimiento', e.target.value)} style={styles.input} />
                    </td>
                    <td style={styles.td}>
                        <input type="text" value={formatMoney(p.monto)} onChange={e => updatePago(p.id, 'monto', e.target.value)} style={styles.input} placeholder="$" />
                    </td>
                    <td style={styles.td}>
                        <select value={p.estado} onChange={e => updatePago(p.id, 'estado', e.target.value)} 
                            style={{...styles.input, backgroundColor: p.estado === 'Pagado' ? '#dcfce7' : '#fff'}}>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagado">Pagado</option>
                        </select>
                    </td>
                    <td style={styles.td}>
                        <button type="button" onClick={() => removePago(p.id)} style={{border:'none', background:'none', color:'#ef4444', cursor:'pointer'}}><Trash2 size={18}/></button>
                    </td>
                </tr>
            ))}
        </tbody>
      </table>
      
      <button type="button" onClick={addPago} style={{alignSelf:'flex-start', background:'none', border:'none', color:'#2563eb', fontWeight:'bold', cursor:'pointer', display:'flex', alignItems:'center', gap:5, marginTop:5}}>
        <Plus size={16}/> Agregar Cuota
      </button>

      <div style={styles.summary}>
         <div style={{textAlign:'right'}}>
            <small style={{color:'#6b7280'}}>Total Doc.</small>
            <div style={{fontWeight:'bold'}}>{formatCurrency(totalFactura)}</div>
         </div>
         <div style={{textAlign:'right'}}>
            <small style={{color:'#6b7280'}}>Asignado</small>
            <div style={{fontWeight:'bold', color: valido ? '#16a34a' : '#dc2626'}}>{formatCurrency(totalProgramado)}</div>
         </div>
         <div style={{textAlign:'right'}}>
            <small style={{color:'#6b7280'}}>Diferencia</small>
            <div style={{fontWeight:'bold', color: restante === 0 ? '#9ca3af' : '#d97706'}}>{formatCurrency(restante)}</div>
         </div>
      </div>

      <button type="submit" disabled={loading || !valido} style={styles.btnPrimary}>
        {loading ? 'Guardando...' : 'Guardar Gasto'}
      </button>

    </form>
  )
}

export default NuevoGasto


==================================================
RUTA: src\pages\NuevoMovimiento.jsx
==================================================
import { useState, useEffect } from 'react'
import { supabase } from '../supabaseClient'
import { useNavigate, useParams } from 'react-router-dom' // Importamos useParams
import { Save, X, ArrowRightLeft } from 'lucide-react'

function NuevoMovimiento() {
  const navigate = useNavigate()
  const { id } = useParams() // Capturamos ID si venimos a editar
  const [loading, setLoading] = useState(false)
  const [socios, setSocios] = useState([])

  const [formData, setFormData] = useState({
    fecha: new Date().toISOString().split('T')[0],
    socio_id: '',
    tipo_flujo: 'ingreso',
    concepto: 'Aporte de Capital',
    monto: '',
    descripcion: ''
  })

  // 1. Cargar Socios siempre
  useEffect(() => {
    async function cargarSocios() {
      const { data } = await supabase.from('socios').select('id, nombre').order('nombre')
      if (data) setSocios(data)
    }
    cargarSocios()
  }, [])

  // 2. Si hay ID, Cargar el Movimiento para Editar
  useEffect(() => {
    if (id) {
      async function cargarMovimiento() {
        const { data } = await supabase
          .from('movimientos_billetera')
          .select('*')
          .eq('id', id)
          .single()

        if (data) {
          // TRUCO: Si el monto es negativo, es 'egreso'. Lo pasamos a positivo para el input.
          const esEgreso = data.monto < 0;
          
          setFormData({
            fecha: data.fecha,
            socio_id: data.socio_id,
            tipo_flujo: esEgreso ? 'egreso' : 'ingreso',
            concepto: data.tipo, // En la BD la columna se llama 'tipo'
            monto: Math.abs(data.monto), // Quitamos el signo menos para mostrarlo en el input
            descripcion: data.descripcion || ''
          })
        }
      }
      cargarMovimiento()
    }
  }, [id])

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value })
  }

  const handleSubmit = async (e) => {
    e.preventDefault()
    setLoading(true)

    // L√≥gica del signo: Si es egreso, multiplicamos por -1
    let montoFinal = parseFloat(formData.monto)
    if (formData.tipo_flujo === 'egreso') {
      montoFinal = montoFinal * -1
    }

    let error;

    if (id) {
      // --- EDITAR ---
      const { error: errUpdate } = await supabase
        .from('movimientos_billetera')
        .update({
          fecha: formData.fecha,
          socio_id: formData.socio_id,
          tipo: formData.concepto,
          monto: montoFinal,
          descripcion: formData.descripcion
        })
        .eq('id', id)
      error = errUpdate
    } else {
      // --- CREAR ---
      const { error: errInsert } = await supabase
        .from('movimientos_billetera')
        .insert([{
          fecha: formData.fecha,
          socio_id: formData.socio_id,
          tipo: formData.concepto,
          monto: montoFinal,
          descripcion: formData.descripcion
        }])
      error = errInsert
    }

    setLoading(false)

    if (error) {
      alert('Error: ' + error.message)
    } else {
      navigate('/cuentas-socios')
    }
  }

  const styles = {
    container: { maxWidth: '600px', margin: '40px auto', padding: '20px' },
    card: { backgroundColor: 'white', padding: '30px', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)' },
    title: { display: 'flex', alignItems: 'center', gap: '10px', fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '20px', color: '#1f2937' },
    formGroup: { marginBottom: '20px' },
    label: { display: 'block', marginBottom: '8px', color: '#4b5563', fontWeight: '500' },
    input: { width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '1rem' },
    select: { width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '1rem', backgroundColor: 'white' },
    radioGroup: { display: 'flex', gap: '20px', marginBottom: '10px' },
    radioLabel: { display: 'flex', alignItems: 'center', gap: '5px', cursor: 'pointer', fontWeight: 'bold' },
    actions: { display: 'flex', gap: '10px', marginTop: '30px' },
    btnSave: { flex: 1, padding: '12px', backgroundColor: '#2563eb', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '1rem' },
    btnCancel: { flex: 1, padding: '12px', backgroundColor: '#f3f4f6', color: '#4b5563', border: '1px solid #d1d5db', borderRadius: '8px', cursor: 'pointer', display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '1rem' }
  }

  return (
    <div style={styles.container}>
      <div style={styles.card}>
        <h2 style={styles.title}>
          <ArrowRightLeft color="#2563eb" /> {id ? 'Editar Movimiento' : 'Registrar Movimiento'}
        </h2>

        <form onSubmit={handleSubmit}>
          
          <div style={styles.formGroup}>
            <label style={styles.label}>Socio</label>
            <select name="socio_id" value={formData.socio_id} onChange={handleChange} style={styles.select} required>
              <option value="">-- Selecciona Socio --</option>
              {socios.map(s => <option key={s.id} value={s.id}>{s.nombre}</option>)}
            </select>
          </div>

          <div style={styles.formGroup}>
            <label style={styles.label}>Tipo de Operaci√≥n</label>
            <div style={styles.radioGroup}>
              <label style={{...styles.radioLabel, color: '#16a34a'}}>
                <input 
                  type="radio" 
                  name="tipo_flujo" 
                  value="ingreso" 
                  checked={formData.tipo_flujo === 'ingreso'} 
                  onChange={handleChange} 
                /> 
                Ingresa Dinero (Aporte)
              </label>
              <label style={{...styles.radioLabel, color: '#dc2626'}}>
                <input 
                  type="radio" 
                  name="tipo_flujo" 
                  value="egreso" 
                  checked={formData.tipo_flujo === 'egreso'} 
                  onChange={handleChange} 
                /> 
                Sale Dinero (Retiro/Devoluci√≥n)
              </label>
            </div>
          </div>

          <div style={styles.formGroup}>
            <label style={styles.label}>Concepto</label>
            <select name="concepto" value={formData.concepto} onChange={handleChange} style={styles.select}>
              {formData.tipo_flujo === 'ingreso' ? (
                <>
                  <option value="Aporte de Capital">Aporte de Capital</option>
                  <option value="Pr√©stamo a la Empresa">Pr√©stamo a la Empresa</option>
                  <option value="Otro Ingreso">Otro Ingreso</option>
                </>
              ) : (
                <>
                  <option value="Devoluci√≥n Pr√©stamo">Devoluci√≥n de Pr√©stamo</option>
                  <option value="Retiro de Utilidades">Retiro de Utilidades</option>
                  <option value="Adelanto">Adelanto</option>
                  <option value="Otro Retiro">Otro Retiro</option>
                </>
              )}
            </select>
          </div>

          <div style={styles.formGroup}>
            <label style={styles.label}>Monto</label>
            <input type="number" name="monto" value={formData.monto} onChange={handleChange} style={styles.input} placeholder="$" required />
          </div>

          <div style={styles.formGroup}>
            <label style={styles.label}>Nota / Descripci√≥n</label>
            <input type="text" name="descripcion" value={formData.descripcion} onChange={handleChange} style={styles.input} />
          </div>

          <div style={styles.actions}>
            <button type="button" onClick={() => navigate('/cuentas-socios')} style={styles.btnCancel}>
              <X size={20} /> Cancelar
            </button>
            <button type="submit" style={styles.btnSave} disabled={loading}>
              <Save size={20} /> {id ? 'Actualizar Movimiento' : 'Guardar Movimiento'}
            </button>
          </div>

        </form>
      </div>
    </div>
  )
}

export default NuevoMovimiento


==================================================
RUTA: src\pages\NuevoMovimientoBodega.jsx
==================================================
import { useState } from 'react'
import { supabase } from '../supabaseClient'
import { ArrowUpCircle, ArrowDownCircle } from 'lucide-react'

function NuevoMovimientoBodega({ config, cerrar, alGuardar }) {
  // config trae: { tipo: 'Entrada' | 'Salida', producto: { id, nombre, unidad_medida } }
  const [loading, setLoading] = useState(false)
  const [formData, setFormData] = useState({
    cantidad: '',
    costo_unitario: '', // Solo para entrada
    referencia: '',
    fecha: new Date().toISOString().split('T')[0]
  })

  const esEntrada = config.tipo === 'Entrada'

  const handleSubmit = async (e) => {
    e.preventDefault()
    if (!formData.cantidad || parseFloat(formData.cantidad) <= 0) return alert("Cantidad inv√°lida")

    setLoading(true)
    try {
        const payload = {
            insumo_id: config.producto.id,
            tipo_movimiento: config.tipo,
            cantidad: parseFloat(formData.cantidad),
            fecha: formData.fecha,
            referencia: formData.referencia,
            costo_unitario: esEntrada ? (parseFloat(formData.costo_unitario) || 0) : null
        }

        await supabase.from('bodega_movimientos').insert([payload])
        
        // El trigger SQL se encargar√° de actualizar el stock en bodega_insumos
        alGuardar()
    } catch (error) {
        alert(error.message)
    } finally {
        setLoading(false)
    }
  }

  const styles = {
    form: { display:'flex', flexDirection:'column', gap:'15px' },
    label: { fontWeight:'bold', fontSize:'0.9rem', color:'#374151', marginBottom:'5px', display:'block' },
    input: { padding:'10px', borderRadius:'6px', border:'1px solid #d1d5db', width:'100%', boxSizing:'border-box' },
    infoBox: { backgroundColor: esEntrada ? '#dcfce7' : '#fee2e2', padding:'15px', borderRadius:'8px', color: esEntrada ? '#166534' : '#991b1b', display:'flex', alignItems:'center', gap:'10px', fontWeight:'bold' },
    btn: { backgroundColor: esEntrada ? '#166534' : '#991b1b', color:'white', padding:'12px', border:'none', borderRadius:'8px', cursor:'pointer', fontWeight:'bold', marginTop:'10px' }
  }

  return (
    <form onSubmit={handleSubmit} style={styles.form}>
        <div style={styles.infoBox}>
            {esEntrada ? <ArrowUpCircle/> : <ArrowDownCircle/>}
            <span>{config.tipo} de: {config.producto.nombre}</span>
        </div>

        <div style={{display:'flex', gap:'15px'}}>
            <div style={{flex:1}}>
                <label style={styles.label}>Cantidad ({config.producto.unidad_medida})</label>
                <input type="number" step="0.01" value={formData.cantidad} onChange={e => setFormData({...formData, cantidad: e.target.value})} style={styles.input} autoFocus required/>
            </div>
            
            {esEntrada && (
                <div style={{flex:1}}>
                    <label style={styles.label}>Costo Unitario ($)</label>
                    <input type="number" value={formData.costo_unitario} onChange={e => setFormData({...formData, costo_unitario: e.target.value})} style={styles.input} placeholder="Opcional"/>
                </div>
            )}
        </div>

        <div>
            <label style={styles.label}>Fecha</label>
            <input type="date" value={formData.fecha} onChange={e => setFormData({...formData, fecha: e.target.value})} style={styles.input} />
        </div>

        <div>
            <label style={styles.label}>Referencia / Nota</label>
            <input type="text" value={formData.referencia} onChange={e => setFormData({...formData, referencia: e.target.value})} style={styles.input} placeholder={esEntrada ? "N¬∞ Factura" : "Riego Sector 1..."} />
        </div>

        <button type="submit" style={styles.btn} disabled={loading}>
            {loading ? 'Registrando...' : `Confirmar ${config.tipo}`}
        </button>
    </form>
  )
}
export default NuevoMovimientoBodega


==================================================
RUTA: src\pages\NuevoProducto.jsx
==================================================
import { useState } from 'react'
import { supabase } from '../supabaseClient'
import { Save } from 'lucide-react'

function NuevoProducto({ producto, cerrar, alGuardar }) {
  const [loading, setLoading] = useState(false)
  const [formData, setFormData] = useState({
    nombre: producto?.nombre || '',
    unidad_medida: producto?.unidad_medida || 'Litros',
    categoria: producto?.categoria || 'Fertilizante',
    stock_minimo: producto?.stock_minimo || 0
  })

  const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value})

  const handleSubmit = async (e) => {
    e.preventDefault()
    setLoading(true)
    
    try {
        if (producto) {
            await supabase.from('bodega_insumos').update(formData).eq('id', producto.id)
        } else {
            await supabase.from('bodega_insumos').insert([formData])
        }
        alGuardar()
    } catch (error) {
        alert(error.message)
    } finally {
        setLoading(false)
    }
  }

  const styles = {
    form: { display:'flex', flexDirection:'column', gap:'15px' },
    label: { fontWeight:'bold', fontSize:'0.9rem', color:'#374151', marginBottom:'5px', display:'block' },
    input: { padding:'10px', borderRadius:'6px', border:'1px solid #d1d5db', width:'100%', boxSizing:'border-box' },
    btn: { backgroundColor:'#1f2937', color:'white', padding:'12px', border:'none', borderRadius:'8px', cursor:'pointer', fontWeight:'bold', display:'flex', justifyContent:'center', gap:'10px' }
  }

  return (
    <form onSubmit={handleSubmit} style={styles.form}>
        <div>
            <label style={styles.label}>Nombre Insumo</label>
            <input name="nombre" value={formData.nombre} onChange={handleChange} style={styles.input} placeholder="Ej: Urea 46%" required/>
        </div>
        
        <div style={{display:'flex', gap:'15px'}}>
            <div style={{flex:1}}>
                <label style={styles.label}>Unidad Medida</label>
                <select name="unidad_medida" value={formData.unidad_medida} onChange={handleChange} style={styles.input}>
                    <option value="Litros">Litros</option>
                    <option value="Kilos">Kilos</option>
                    <option value="Sacos">Sacos</option>
                    <option value="Unidades">Unidades</option>
                    <option value="Metros">Metros</option>
                </select>
            </div>
            <div style={{flex:1}}>
            <label style={styles.label}>Categor√≠a <span style={{color:'red'}}>*</span></label>
                <select name="categoria" value={formData.categoria} onChange={handleChange} style={styles.input}>
                    <option value="Fertilizante">Fertilizante</option>
                    <option value="Fitosanitario">Fitosanitario</option>
                    <option value="Riego">Riego (Mangueras, Aspersores, Fittings)</option> {/* <--- NUEVO */}
                    <option value="Mantenci√≥n">Mantenci√≥n / Limpieza</option> {/* <--- NUEVO */}
                    <option value="Herramienta">Herramienta</option>
                    <option value="Combustible">Combustible</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
        </div>

        <div>
            <label style={styles.label}>Alerta Stock M√≠nimo</label>
            <input type="number" name="stock_minimo" value={formData.stock_minimo} onChange={handleChange} style={styles.input} />
        </div>

        <button type="submit" style={styles.btn} disabled={loading}>
            <Save size={18}/> {loading ? 'Guardando...' : 'Guardar Producto'}
        </button>
    </form>
  )
}
export default NuevoProducto


==================================================
RUTA: src\pages\NuevoPrograma.jsx
==================================================
import { useState, useEffect } from 'react'
import { supabase } from '../supabaseClient'
import { Save, Clock, Trash2, CalendarDays, Droplets, CheckSquare, Square, MapPin } from 'lucide-react'

const DIAS_SEMANA = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo']

function NuevoPrograma({ idPrograma, cerrarModal, alGuardar }) {
  const [loading, setLoading] = useState(false)
  const [sectoresAgrupados, setSectoresAgrupados] = useState({}) // { 'Parcela A': [s1, s2], 'Parcela B': [s3] }
  const [todosLosSectores, setTodosLosSectores] = useState([]) // Lista plana para c√°lculos
  const [isDirty, setIsDirty] = useState(false)

  const [sectoresSeleccionados, setSectoresSeleccionados] = useState([])

  const [formData, setFormData] = useState({
    fecha_inicio: new Date().toISOString().split('T')[0],
    comentarios: ''
  })
  
  const [diasSeleccionados, setDiasSeleccionados] = useState([])
  const [turnos, setTurnos] = useState([{ id: 1, hora: '08:00', minutos: 30 }])

  // 1. CARGAR Y AGRUPAR SECTORES
  useEffect(() => {
    async function fetchSectores() {
      try {
        const { data, error } = await supabase
          .from('sectores')
          .select('id, nombre, parcelas ( nombre ), cantidad_arboles, aspersores_por_planta, caudal_lph')
          .order('nombre')

        if (!error && data) {
            setTodosLosSectores(data)
            
            // Agrupamos por nombre de Parcela
            const grupos = data.reduce((acc, sector) => {
                const nombreParcela = sector.parcelas?.nombre || 'Sin Parcela'
                if (!acc[nombreParcela]) acc[nombreParcela] = []
                acc[nombreParcela].push(sector)
                return acc
            }, {})
            setSectoresAgrupados(grupos)
        }
      } catch (err) {
        console.error(err)
      }
    }
    fetchSectores()
  }, [])

  // 2. CARGAR SI ES EDICI√ìN
  useEffect(() => {
    if (idPrograma) {
        async function cargarDatos() {
            const { data } = await supabase.from('programas_riego').select('*').eq('id', idPrograma).single()
            if (data) {
                setSectoresSeleccionados([data.sector_id])
                setFormData({
                    fecha_inicio: data.fecha_inicio,
                    comentarios: data.comentarios || ''
                })
                if (data.dias_semana && Array.isArray(data.dias_semana)) setDiasSeleccionados(data.dias_semana)
                if (data.turnos && Array.isArray(data.turnos)) setTurnos(data.turnos)
                else if (data.duracion_minutos > 0) setTurnos([{ id: 1, hora: '08:00', minutos: data.duracion_minutos }])
            }
        }
        cargarDatos()
    }
  }, [idPrograma])

  // --- MANEJADORES ---
  const toggleSector = (id) => {
    if (idPrograma) return 
    setIsDirty(true)
    if (sectoresSeleccionados.includes(id)) {
        setSectoresSeleccionados(sectoresSeleccionados.filter(s => s !== id))
    } else {
        setSectoresSeleccionados([...sectoresSeleccionados, id])
    }
  }

  const toggleDia = (dia) => {
    setIsDirty(true)
    setDiasSeleccionados(prev => prev.includes(dia) ? prev.filter(d => d !== dia) : [...prev, dia])
  }

  const agregarTurno = () => setTurnos([...turnos, { id: Date.now(), hora: '18:00', minutos: 30 }])
  const eliminarTurno = (id) => turnos.length > 1 && setTurnos(turnos.filter(t => t.id !== id))
  const actualizarTurno = (id, campo, valor) => {
    setIsDirty(true)
    setTurnos(turnos.map(t => t.id === id ? { ...t, [campo]: valor } : t))
  }

  // --- C√ÅLCULOS ---
  const sectoresInfo = todosLosSectores.filter(s => sectoresSeleccionados.includes(s.id))
  
  const minutosDiarios = turnos.reduce((acc, t) => acc + (parseInt(t.minutos) || 0), 0)
  const diasCount = diasSeleccionados.length
  const minutosSemanales = minutosDiarios * diasCount
  const horasSemanales = minutosSemanales / 60

  const caudalTotalHora = sectoresInfo.reduce((sum, s) => {
      return sum + ((s.cantidad_arboles || 0) * (s.aspersores_por_planta || 1) * (s.caudal_lph || 0))
  }, 0)
  
  const m3Semanales = (caudalTotalHora * horasSemanales) / 1000
  const fmtNum = (n) => n.toLocaleString('es-CL', { maximumFractionDigits: 1 })
  const esValido = sectoresSeleccionados.length > 0 && diasCount > 0 && minutosDiarios > 0

  useEffect(() => {
    window.intentarCerrarModal = () => {
        if (isDirty && confirm("‚ö†Ô∏è ¬øSalir sin guardar los cambios?")) cerrarModal()
        else if (!isDirty) cerrarModal()
    }
    return () => { window.intentarCerrarModal = null }
  }, [isDirty, cerrarModal])

  const handleSubmit = async (e) => {
    e.preventDefault()
    if (!esValido) return alert("Selecciona sectores, d√≠as y turnos.")
    setLoading(true)
    try {
      const resumenFrec = diasSeleccionados.map(d => d.substring(0,2)).join(', ')
      const basePayload = {
        fecha_inicio: formData.fecha_inicio,
        comentarios: formData.comentarios,
        dias_semana: diasSeleccionados,
        turnos: turnos,
        frecuencia: resumenFrec,
        duracion_minutos: minutosDiarios
      }

      if (idPrograma) {
          const { error } = await supabase.from('programas_riego').update(basePayload).eq('id', idPrograma)
          if(error) throw error
      } else {
          // Validar conflictos
          const { data: conflictos } = await supabase.from('programas_riego')
            .select('sector_id, sectores(nombre)').is('fecha_fin', null).in('sector_id', sectoresSeleccionados)

          if (conflictos && conflictos.length > 0) {
              const nombresConflictivos = conflictos.map(c => c.sectores?.nombre).join(', ')
              alert(`‚õî Conflictos detectados en: ${nombresConflictivos}. Termina sus programas actuales primero.`)
              setLoading(false); return
          }

          const registros = sectoresSeleccionados.map(secId => ({ ...basePayload, sector_id: secId }))
          const { error } = await supabase.from('programas_riego').insert(registros)
          if(error) throw error
      }
      alGuardar()
    } catch (error) { alert(error.message) } finally { setLoading(false) }
  }

  const styles = {
    form: { display: 'flex', flexDirection: 'column', gap: '20px' },
    label: { fontSize: '0.9rem', fontWeight: 'bold', color: '#374151', marginBottom: '5px', display: 'block' },
    input: { padding: '10px', borderRadius: '6px', border: '1px solid #d1d5db', width: '100%', boxSizing: 'border-box' },
    section: { backgroundColor: '#f9fafb', padding: '15px', borderRadius: '8px', border: '1px solid #e5e7eb' },
    daysGrid: { display: 'flex', gap: '8px', flexWrap: 'wrap', marginTop: '5px' },
    dayChip: (selected) => ({
        padding: '8px 12px', borderRadius: '20px', fontSize: '0.85rem', cursor: 'pointer', border: '1px solid', transition: '0.2s',
        backgroundColor: selected ? '#1f2937' : 'white', color: selected ? 'white' : '#4b5563', borderColor: selected ? '#1f2937' : '#d1d5db'
    }),
    turnoRow: { display: 'flex', gap: '10px', alignItems: 'center', marginBottom: '10px' },
    btnSmall: { border: 'none', background: 'none', cursor: 'pointer', color: '#ef4444' },
    
    // Grid Agrupado
    scrollArea: { maxHeight: '250px', overflowY: 'auto', border: '1px solid #e5e7eb', borderRadius: '8px', padding: '10px', backgroundColor:'white' },
    parcelaHeader: { fontSize: '0.85rem', fontWeight: 'bold', color: '#059669', margin: '15px 0 8px 0', display:'flex', alignItems:'center', gap:'5px', textTransform:'uppercase' },
    sectorGrid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(180px, 1fr))', gap: '10px' },
    sectorItem: (selected) => ({
        display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', borderRadius: '6px', cursor: idPrograma ? 'not-allowed' : 'pointer', transition: '0.2s',
        backgroundColor: selected ? '#f0fdf4' : 'white', border: selected ? '1px solid #16a34a' : '1px solid #e5e7eb', color: selected ? '#15803d' : '#374151'
    }),
    summaryCard: { backgroundColor: '#eff6ff', border: '1px solid #bfdbfe', padding: '15px', borderRadius: '8px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' },
    dataBlock: { textAlign:'right' },
    bigNum: { fontSize: '1.4rem', fontWeight: 'bold', color: '#1d4ed8' },
    subText: { fontSize: '0.75rem', color: '#1e40af' },
    btnSave: { padding: '12px', backgroundColor: '#0ea5e9', color: 'white', border: 'none', borderRadius: '8px', fontWeight: 'bold', cursor: 'pointer', opacity: loading ? 0.7 : 1 }
  }

  return (
    <form onSubmit={handleSubmit} style={styles.form}>
      
      {/* SELECCI√ìN AGRUPADA */}
      <div>
        <label style={styles.label}>Sectores a Regar ({sectoresSeleccionados.length}) *</label>
        <div style={styles.scrollArea}>
            {Object.keys(sectoresAgrupados).length === 0 && <div style={{padding:'20px', textAlign:'center', color:'#9ca3af'}}>Cargando sectores...</div>}
            
            {Object.keys(sectoresAgrupados).sort().map(parcela => (
                <div key={parcela}>
                    <div style={styles.parcelaHeader}><MapPin size={14}/> {parcela}</div>
                    <div style={styles.sectorGrid}>
                        {sectoresAgrupados[parcela].map(s => {
                            const isSelected = sectoresSeleccionados.includes(s.id)
                            return (
                                <div key={s.id} onClick={() => toggleSector(s.id)} style={styles.sectorItem(isSelected)}>
                                    {isSelected ? <CheckSquare size={18} /> : <Square size={18} color="#d1d5db"/>}
                                    <div style={{fontWeight:'bold', fontSize:'0.85rem'}}>{s.nombre}</div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            ))}
        </div>
        {idPrograma && <small style={{color:'#d97706'}}>Edici√≥n restringida a un solo sector.</small>}
      </div>

      {/* RESTO DEL FORMULARIO (FECHA, MOTIVO, D√çAS, TURNOS) IGUAL QUE ANTES */}
      <div style={{display:'flex', gap:'20px'}}>
         <div style={{flex: 1}}>
            <label style={styles.label}>Fecha Inicio</label>
            <input type="date" name="fecha_inicio" value={formData.fecha_inicio} onChange={e => setFormData({...formData, fecha_inicio: e.target.value})} style={styles.input} />
         </div>
         <div style={{flex: 2}}>
            <label style={styles.label}>Motivo / Observaci√≥n</label>
            <input type="text" name="comentarios" value={formData.comentarios} onChange={e => setFormData({...formData, comentarios: e.target.value})} style={styles.input} placeholder="Ej: Temporada Alta" />
         </div>
      </div>

      <div style={styles.section}>
         <label style={styles.label}><CalendarDays size={16} style={{marginBottom:-2}}/> D√≠as de Riego</label>
         <div style={styles.daysGrid}>
             {DIAS_SEMANA.map(dia => (
                 <div key={dia} onClick={() => toggleDia(dia)} style={styles.dayChip(diasSeleccionados.includes(dia))}>
                     {dia.substring(0, 3)}
                 </div>
             ))}
         </div>
      </div>

      <div style={styles.section}>
         <div style={{display:'flex', justifyContent:'space-between', marginBottom:'10px'}}>
            <label style={styles.label}><Clock size={16} style={{marginBottom:-2}}/> Turnos</label>
            <button type="button" onClick={agregarTurno} style={{background:'none', border:'none', color:'#0ea5e9', fontWeight:'bold', cursor:'pointer', fontSize:'0.85rem'}}>+ Agregar Horario</button>
         </div>
         {turnos.map((t, index) => (
             <div key={t.id} style={styles.turnoRow}>
                 <span style={{fontSize:'0.9rem', color:'#6b7280', width:'20px'}}>{index + 1}.</span>
                 <input type="time" value={t.hora} onChange={e => actualizarTurno(t.id, 'hora', e.target.value)} style={{...styles.input, width:'100px'}} />
                 <span style={{fontSize:'0.9rem'}}>x</span>
                 <div style={{position:'relative', width:'80px'}}>
                    <input type="number" value={t.minutos} onChange={e => actualizarTurno(t.id, 'minutos', e.target.value)} style={{...styles.input, paddingRight:'5px'}} />
                    <span style={{position:'absolute', right:'5px', top:'10px', fontSize:'0.7rem', color:'#9ca3af'}}>min</span>
                 </div>
                 {turnos.length > 1 && <button type="button" onClick={() => eliminarTurno(t.id)} style={styles.btnSmall}><Trash2 size={18}/></button>}
             </div>
         ))}
      </div>

      <div style={styles.summaryCard}>
          <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
              <Droplets size={32} color="#3b82f6" />
              <div>
                  <div style={{fontSize:'0.8rem', color:'#1e40af', fontWeight:'bold', textTransform:'uppercase'}}>Consumo Total Estimado</div>
                  <div style={{fontSize:'0.8rem', color:'#60a5fa'}}>Para {sectoresSeleccionados.length} sector(es)</div>
              </div>
          </div>
          
          <div style={{display:'flex', gap:'20px'}}>
              <div style={styles.dataBlock}>
                  <div style={styles.bigNum}>{horasSemanales.toFixed(1)} h</div>
                  <div style={styles.subText}>Riego / sem</div>
              </div>
              <div style={styles.dataBlock}>
                  <div style={styles.bigNum}>{fmtNum(m3Semanales)} m¬≥</div>
                  <div style={styles.subText}>Agua Total / sem</div>
              </div>
          </div>
      </div>

      <button type="submit" style={styles.btnSave} disabled={loading || !esValido}>
         {loading ? 'Guardando...' : (idPrograma ? 'Actualizar Programa' : 'Activar Programas')}
      </button>

    </form>
  )
}
export default NuevoPrograma


==================================================
RUTA: src\pages\NuevoProveedor.jsx
==================================================
import { useState, useEffect } from 'react'
import { supabase } from '../supabaseClient'
// Quitamos hooks de navegaci√≥n
import { Save, X } from 'lucide-react'

function NuevoProveedor({ idProveedor, cerrarModal, alGuardar }) {
  const [loading, setLoading] = useState(false)
  const [isDirty, setIsDirty] = useState(false)

  const [formData, setFormData] = useState({
    nombre: '',
    rut: '',
    telefono: '',
    email: ''
  })

  // 1. Cargar Datos si es Edici√≥n
  useEffect(() => {
    if (idProveedor) {
      async function cargar() {
        const { data } = await supabase.from('proveedores').select('*').eq('id', idProveedor).single()
        if (data) setFormData({ 
            nombre: data.nombre, 
            rut: data.rut || '', 
            telefono: data.telefono || '', 
            email: data.email || '' 
        })
      }
      cargar()
    }
  }, [idProveedor])

  // 2. Manejo de cambios y estado "Sucio"
  const handleChange = (e) => {
      setIsDirty(true)
      setFormData({ ...formData, [e.target.name]: e.target.value })
  }

  // 3. Protecci√≥n de cierre seguro
  useEffect(() => {
    window.intentarCerrarModal = () => {
        if (isDirty) {
            if (window.confirm("‚ö†Ô∏è Tienes cambios sin guardar. ¬øDeseas salir?")) {
                cerrarModal()
            }
        } else {
            cerrarModal()
        }
    }
    return () => { window.intentarCerrarModal = null }
  }, [isDirty, cerrarModal])

  const handleSubmit = async (e) => {
    e.preventDefault()
    setLoading(true)
    const payload = { ...formData }
    
    let error
    if (idProveedor) {
      const { error: err } = await supabase.from('proveedores').update(payload).eq('id', idProveedor)
      error = err
    } else {
      const { error: err } = await supabase.from('proveedores').insert([payload])
      error = err
    }
    
    setLoading(false)
    
    if (error) {
        alert('Error: ' + error.message)
    } else {
        setIsDirty(false)
        alGuardar()
    }
  }

  const styles = {
    container: { padding: '10px 20px', width: '100%', boxSizing: 'border-box' },
    formGroup: { marginBottom: '20px' },
    label: { display: 'block', marginBottom: '8px', color: '#4b5563', fontWeight: '500' },
    input: { width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '1rem', boxSizing:'border-box' },
    actions: { display: 'flex', gap: '10px', marginTop: '30px' },
    btnSave: { flex: 1, padding: '12px', backgroundColor: '#059669', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '1rem' },
    btnCancel: { flex: 1, padding: '12px', backgroundColor: '#f3f4f6', color: '#4b5563', border: '1px solid #d1d5db', borderRadius: '8px', cursor: 'pointer', display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '1rem' }
  }

  return (
    <div style={styles.container}>
        <form onSubmit={handleSubmit}>
          
          <div style={styles.formGroup}>
            <label style={styles.label}>Nombre Fantas√≠a / Raz√≥n Social <span style={{color:'red'}}>*</span></label>
            <input type="text" name="nombre" value={formData.nombre} onChange={handleChange} style={styles.input} placeholder="Ej: Ferreter√≠a El Agro" required />
          </div>
          
          <div style={styles.formGroup}>
            <label style={styles.label}>RUT</label>
            <input type="text" name="rut" value={formData.rut} onChange={handleChange} style={styles.input} placeholder="76.xxx.xxx-x" />
          </div>
          
          <div style={{display:'flex', gap:'20px'}}>
             <div style={{...styles.formGroup, flex:1}}>
                <label style={styles.label}>Tel√©fono</label>
                <input type="text" name="telefono" value={formData.telefono} onChange={handleChange} style={styles.input} />
             </div>
             <div style={{...styles.formGroup, flex:1}}>
                <label style={styles.label}>Email</label>
                <input type="email" name="email" value={formData.email} onChange={handleChange} style={styles.input} />
             </div>
          </div>
          
          <div style={styles.actions}>
            <button type="button" onClick={() => window.intentarCerrarModal ? window.intentarCerrarModal() : cerrarModal()} style={styles.btnCancel}>
                <X size={20} /> Cancelar
            </button>
            <button type="submit" style={styles.btnSave} disabled={loading}>
                <Save size={20} /> {idProveedor ? 'Actualizar' : 'Guardar'}
            </button>
          </div>
        </form>
    </div>
  )
}
export default NuevoProveedor


==================================================
RUTA: src\pages\NuevoSector.jsx
==================================================
import { useState, useEffect } from 'react'
import { supabase } from '../supabaseClient'
import { Save, X, Maximize } from 'lucide-react'

function NuevoSector({ idSector, cerrarModal, alGuardar }) {
  const [loading, setLoading] = useState(false)
  const [isDirty, setIsDirty] = useState(false)
  const [parcelas, setParcelas] = useState([])

  const [formData, setFormData] = useState({
    nombre: '',
    parcela_id: '',
    variedad: 'Hass',
    cantidad_arboles: '', 
    superficie_ha: '', // <--- NUEVO CAMPO
    aspersores_por_planta: 1,
    caudal_lph: '',
    ano_plantacion: '',
    marco_plantacion: ''
  })

  // 1. Cargar Parcelas
  useEffect(() => {
    async function cargarParcelas() {
      const { data } = await supabase.from('parcelas').select('id, nombre').order('nombre')
      if (data) setParcelas(data)
    }
    cargarParcelas()
  }, [])

  // 2. Cargar Datos del Sector
  useEffect(() => {
    if (idSector) {
      async function cargarSector() {
        const { data } = await supabase.from('sectores').select('*').eq('id', idSector).single()
        if (data) {
          setFormData({
            nombre: data.nombre,
            parcela_id: data.parcela_id || '',
            variedad: data.variedad || 'Hass',
            cantidad_arboles: data.cantidad_arboles || '',
            superficie_ha: data.superficie_ha || '', // <--- CARGA
            aspersores_por_planta: data.aspersores_por_planta || 1,
            caudal_lph: data.caudal_lph || '',
            ano_plantacion: data.anio_plantacion || '',
            marco_plantacion: data.marco_plantacion || ''
          })
        }
      }
      cargarSector()
    }
  }, [idSector])

  const handleChange = (e) => {
    setIsDirty(true)
    setFormData({ ...formData, [e.target.name]: e.target.value })
  }

  // Protecci√≥n de cierre
  useEffect(() => {
    window.intentarCerrarModal = () => {
        if (isDirty && window.confirm("‚ö†Ô∏è Tienes cambios sin guardar. ¬øDeseas salir?")) {
            cerrarModal()
        } else if (!isDirty) {
            cerrarModal()
        }
    }
    return () => { window.intentarCerrarModal = null }
  }, [isDirty, cerrarModal])

  const handleSubmit = async (e) => {
    e.preventDefault()
    setLoading(true)

    const datosGuardar = {
      ...formData,
      cantidad_arboles: parseInt(formData.cantidad_arboles) || 0,
      superficie_ha: parseFloat(formData.superficie_ha) || 0, // <--- GUARDADO
      aspersores_por_planta: parseInt(formData.aspersores_por_planta) || 1,
      caudal_lph: parseFloat(formData.caudal_lph) || 0,
      anio_plantacion: parseInt(formData.ano_plantacion) || null
    }

    let error
    if (idSector) {
      const { error: err } = await supabase.from('sectores').update(datosGuardar).eq('id', idSector)
      error = err
    } else {
      const { error: err } = await supabase.from('sectores').insert([datosGuardar])
      error = err
    }

    setLoading(false)
    if (error) {
        alert('Error: ' + error.message)
    } else {
        setIsDirty(false)
        alGuardar()
    }
  }

  const styles = {
    container: { padding: '10px 20px', width: '100%', boxSizing:'border-box' },
    formGroup: { marginBottom: '15px' },
    label: { display: 'block', marginBottom: '5px', color: '#4b5563', fontWeight: '500', fontSize:'0.9rem' },
    input: { width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '1rem', boxSizing:'border-box' },
    select: { width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', backgroundColor: 'white', fontSize: '1rem', boxSizing:'border-box' },
    actions: { display: 'flex', gap: '10px', marginTop: '30px' },
    btnSave: { flex: 1, padding: '12px', backgroundColor: '#1f2937', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '1rem' },
    btnCancel: { flex: 1, padding: '12px', backgroundColor: '#f3f4f6', color: '#4b5563', border: '1px solid #d1d5db', borderRadius: '8px', cursor: 'pointer', display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '1rem' }
  }

  return (
    <div style={styles.container}>
        <form onSubmit={handleSubmit}>
          
          <div style={{display:'flex', gap:'20px'}}>
             <div style={{...styles.formGroup, flex:1}}>
                <label style={styles.label}>Nombre Sector <span style={{color:'red'}}>*</span></label>
                <input type="text" name="nombre" value={formData.nombre} onChange={handleChange} style={styles.input} required />
             </div>
             <div style={{...styles.formGroup, flex:1}}>
                <label style={styles.label}>Parcela <span style={{color:'red'}}>*</span></label>
                <select name="parcela_id" value={formData.parcela_id} onChange={handleChange} style={styles.select} required>
                   <option value="">-- Seleccionar --</option>
                   {parcelas.map(p => <option key={p.id} value={p.id}>{p.nombre}</option>)}
                </select>
             </div>
          </div>

          <div style={{display:'flex', gap:'20px'}}>
             {/* CAMPO DE SUPERFICIE (NUEVO) */}
             <div style={{...styles.formGroup, flex:1}}>
                <label style={styles.label}>Superficie (Ha) <span style={{color:'red'}}>*</span></label>
                <div style={{position:'relative', display:'flex', alignItems:'center'}}>
                    <Maximize size={16} style={{position:'absolute', left:10, color:'#9ca3af'}}/>
                    <input 
                        type="number" step="0.01" 
                        name="superficie_ha" 
                        value={formData.superficie_ha} 
                        onChange={handleChange} 
                        style={{...styles.input, paddingLeft:'35px'}} 
                        placeholder="Ej: 2.5"
                        required 
                    />
                </div>
             </div>

             <div style={{...styles.formGroup, flex:1}}>
                <label style={styles.label}>Cantidad √Årboles</label>
                <input type="number" name="cantidad_arboles" value={formData.cantidad_arboles} onChange={handleChange} style={styles.input} placeholder="Ej: 400" />
             </div>
          </div>

          <div style={styles.formGroup}>
             <label style={styles.label}>Variedad</label>
             <input type="text" name="variedad" value={formData.variedad} onChange={handleChange} style={styles.input} />
          </div>

          {/* DATOS DE RIEGO */}
          <div style={{backgroundColor:'#f0f9ff', padding:'15px', borderRadius:'8px', marginBottom:'20px', border:'1px solid #bae6fd'}}>
             <h4 style={{marginTop:0, color:'#0369a1', marginBottom:'10px', fontSize:'0.95rem'}}>Configuraci√≥n Hidr√°ulica</h4>
             <div style={{display:'flex', gap:'20px'}}>
                <div style={{...styles.formGroup, flex:1}}>
                    <label style={styles.label}>Aspersores / √Årbol</label>
                    <input type="number" name="aspersores_por_planta" value={formData.aspersores_por_planta} onChange={handleChange} style={styles.input} placeholder="1" />
                </div>
                <div style={{...styles.formGroup, flex:1}}>
                    <label style={styles.label}>Caudal Aspersor (L/h)</label>
                    <input type="number" step="0.1" name="caudal_lph" value={formData.caudal_lph} onChange={handleChange} style={styles.input} placeholder="Ej: 35" />
                    <small style={{color:'#0284c7'}}>Litros por hora de cada emisor</small>
                </div>
             </div>
          </div>

          <div style={{display:'flex', gap:'20px'}}>
             <div style={{...styles.formGroup, flex:1}}>
                <label style={styles.label}>A√±o Plantaci√≥n</label>
                <input type="number" name="ano_plantacion" value={formData.ano_plantacion} onChange={handleChange} style={styles.input} />
             </div>
             <div style={{...styles.formGroup, flex:1}}>
                <label style={styles.label}>Marco (ej: 6x4)</label>
                <input type="text" name="marco_plantacion" value={formData.marco_plantacion} onChange={handleChange} style={styles.input} />
             </div>
          </div>

          <div style={styles.actions}>
            <button type="button" onClick={() => window.intentarCerrarModal ? window.intentarCerrarModal() : cerrarModal()} style={styles.btnCancel}>
              <X size={20} /> Cancelar
            </button>
            <button type="submit" style={styles.btnSave} disabled={loading}>
              <Save size={20} /> {idSector ? 'Actualizar' : 'Guardar Sector'}
            </button>
          </div>

        </form>
    </div>
  )
}
export default NuevoSector


==================================================
RUTA: src\pages\OfertasComerciales.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { FileText, Plus, Pencil, Trash2, CheckCircle, XCircle } from 'lucide-react'
import Modal from '../components/Modal'
import NuevaOferta from '../pages/NuevaOferta'

function OfertasComerciales() {
  const [ofertas, setOfertas] = useState([])
  const [loading, setLoading] = useState(true)
  const [modalOpen, setModalOpen] = useState(false)
  const [editId, setEditId] = useState(null)

  useEffect(() => { cargarOfertas() }, [])

  async function cargarOfertas() {
    setLoading(true)
    // Leemos la tabla 'ofertas_comerciales' que usa la columna JSON para precios
    const { data, error } = await supabase
      .from('ofertas_comerciales')
      .select('*, clientes(nombre)')
      .order('created_at', { ascending: false })
    
    if (error) console.error("Error cargando ofertas:", error)
    else setOfertas(data || [])
    setLoading(false)
  }

  const handleClose = () => {
     // Intenta usar la protecci√≥n de cierre del modal hijo si existe
     if (window.intentarCerrarModal) window.intentarCerrarModal()
     else setModalOpen(false)
  }

  const eliminarOferta = async (id) => {
      if(!confirm("¬øEst√°s seguro de eliminar esta oferta comercial?")) return
      
      const { error } = await supabase.from('ofertas_comerciales').delete().eq('id', id)
      if (error) alert("Error al eliminar: " + error.message)
      else cargarOfertas()
  }

  const toggleActiva = async (oferta) => {
      // Cambia el estado de activa/inactiva
      const { error } = await supabase
        .from('ofertas_comerciales')
        .update({ activa: !oferta.activa })
        .eq('id', oferta.id)

      if (error) alert("Error al actualizar: " + error.message)
      else cargarOfertas()
  }

  const formatearFecha = (f) => f ? f.split('-').reverse().join('/') : '-'

  const styles = {
    container: { padding: '20px', width: '100%', maxWidth: '1200px', margin: '0 auto' },
    header: { display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'30px', flexWrap: 'wrap', gap: '15px' },
    title: { display:'flex', alignItems:'center', gap:'10px', fontSize:'1.8rem', fontWeight:'bold', color:'#1f2937', margin: 0 },
    
    btnNew: { 
        backgroundColor:'#1f2937', color:'white', border:'none', padding:'10px 20px', 
        borderRadius:'8px', cursor:'pointer', fontWeight:'bold', display:'flex', 
        alignItems:'center', gap:'8px', fontSize: '0.95rem' 
    },
    
    grid: { display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(320px, 1fr))', gap:'20px' },
    
    // Estilo Tarjeta
    card: { 
        backgroundColor:'white', padding:'20px', borderRadius:'12px', 
        boxShadow:'0 2px 4px rgba(0,0,0,0.05)', border:'1px solid #e5e7eb', 
        display: 'flex', flexDirection: 'column', justifyContent: 'space-between'
    },
    cardHeader: { display:'flex', justifyContent:'space-between', alignItems:'flex-start', marginBottom:'15px' },
    cardTitle: { fontWeight:'bold', fontSize:'1.1rem', color:'#1f2937', margin:'0 0 5px 0' },
    clientName: { fontSize:'0.9rem', color:'#4b5563', fontWeight: '500', margin: 0, display: 'flex', alignItems: 'center', gap: '5px' },
    
    // Badge de estado
    statusBadge: (active) => ({ 
        padding:'4px 10px', borderRadius:'20px', fontSize:'0.75rem', fontWeight:'bold', 
        backgroundColor: active ? '#dcfce7' : '#f3f4f6', 
        color: active ? '#166534' : '#9ca3af', 
        display:'flex', alignItems:'center', gap:'5px', cursor:'pointer', border: '1px solid transparent',
        borderColor: active ? '#bbf7d0' : '#e5e7eb'
    }),

    infoBlock: { marginTop: 'auto', paddingTop: '15px', borderTop: '1px dashed #f3f4f6' },
    metaText: { fontSize:'0.85rem', color:'#6b7280', marginBottom: '5px' },

    actions: { display:'flex', justifyContent:'flex-end', gap:'10px', marginTop: '10px' },
    btnIcon: { border:'none', background:'none', cursor:'pointer', padding:'5px', borderRadius: '4px', transition: 'background 0.2s' }
  }

  return (
    <div style={styles.container}>
        <div style={styles.header}>
            <h1 style={styles.title}><FileText color="#2563eb" size={32}/> Ofertas Comerciales</h1>
            <button onClick={() => { setEditId(null); setModalOpen(true) }} style={styles.btnNew}>
                <Plus size={18}/> Nueva Oferta / Cotizaci√≥n
            </button>
        </div>

        {loading && <div style={{padding:'20px', color:'#9ca3af', textAlign:'center'}}>Cargando ofertas...</div>}

        <div style={styles.grid}>
            {!loading && ofertas.length === 0 && (
                <div style={{gridColumn: '1 / -1', padding:'40px', textAlign:'center', border:'2px dashed #e5e7eb', borderRadius:'12px', color:'#9ca3af'}}>
                    No hay cotizaciones registradas a√∫n.
                </div>
            )}
            
            {ofertas.map(of => (
                <div key={of.id} style={styles.card}>
                    <div style={styles.cardHeader}>
                        <div>
                            <h3 style={styles.cardTitle}>{of.nombre}</h3>
                            <p style={styles.clientName}>{of.clientes?.nombre || 'Sin Cliente'}</p>
                        </div>
                        
                        <div 
                            onClick={() => toggleActiva(of)} 
                            style={styles.statusBadge(of.activa)} 
                            title="Clic para activar/desactivar"
                        >
                            {of.activa ? <CheckCircle size={14}/> : <XCircle size={14}/>}
                            {of.activa ? 'ACTIVA' : 'INACTIVA'}
                        </div>
                    </div>
                    
                    <div style={styles.infoBlock}>
                        <div style={styles.metaText}>
                            üìÖ Fecha: <strong>{formatearFecha(of.fecha)}</strong>
                        </div>
                        <div style={styles.metaText}>
                            ü•ë Calibres definidos: <strong>{of.precios_json?.length || 0}</strong>
                        </div>

                        <div style={styles.actions}>
                            <button 
                                onClick={() => { setEditId(of.id); setModalOpen(true) }} 
                                style={{...styles.btnIcon, color:'#2563eb'}} 
                                title="Editar"
                            >
                                <Pencil size={18}/>
                            </button>
                            <button 
                                onClick={() => eliminarOferta(of.id)} 
                                style={{...styles.btnIcon, color:'#ef4444'}} 
                                title="Eliminar"
                            >
                                <Trash2 size={18}/>
                            </button>
                        </div>
                    </div>
                </div>
            ))}
        </div>

        <Modal 
            isOpen={modalOpen} 
            onClose={handleClose} 
            title={editId ? "Editar Cotizaci√≥n" : "Nueva Cotizaci√≥n"}
        >
            {modalOpen && (
                <NuevaOferta 
                    idOferta={editId}
                    cerrarModal={() => setModalOpen(false)}
                    alGuardar={() => { setModalOpen(false); cargarOfertas(); }}
                />
            )}
        </Modal>
    </div>
  )
}

export default OfertasComerciales

==================================================
RUTA: src\pages\Proveedores.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Truck, Plus, Pencil, Trash2 } from 'lucide-react'
import Modal from '../components/Modal'
import NuevoProveedor from './NuevoProveedor'

function Proveedores() {
  const [list, setList] = useState([])
  const [modalOpen, setModalOpen] = useState(false)
  const [editId, setEditId] = useState(null)

  useEffect(() => {
    leerDatos()
  }, [])

  function leerDatos() {
    supabase.from('proveedores').select('*').order('nombre').then(({ data }) => setList(data || []))
  }

  const abrirCrear = () => { setEditId(null); setModalOpen(true); }
  const abrirEditar = (id) => { setEditId(id); setModalOpen(true); }
  
  const cerrarModal = () => {
    if (window.intentarCerrarModal) window.intentarCerrarModal()
    else setModalOpen(false)
  }

  const eliminar = async (id) => {
    if (!confirm("¬øEliminar proveedor?")) return
    const { error } = await supabase.from('proveedores').delete().eq('id', id)
    if (error) alert('No se puede eliminar: tiene gastos asociados.')
    else setList(prev => prev.filter(x => x.id !== id))
  }

  const styles = {
    container: { padding: '20px', width: '100%' },
    header: { display: 'flex', justifyContent: 'flex-start', gap: '20px', alignItems: 'center', marginBottom: '30px' },
    title: { display: 'flex', alignItems: 'center', gap: '10px', fontSize: '1.5rem', fontWeight: 'bold', color: '#1f2937' },
    btnNew: { border:'none', cursor:'pointer', backgroundColor: '#059669', color: 'white', padding: '10px 20px', borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '0.9rem' },
    grid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '20px' },
    card: { backgroundColor: 'white', padding: '20px', borderRadius: '12px', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', border: '1px solid #f3f4f6', position: 'relative' },
    actions: { position: 'absolute', top: '20px', right: '20px', display: 'flex', gap: '10px' }
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><Truck color="#059669" /> Proveedores</h1>
        <button onClick={abrirCrear} style={styles.btnNew}><Plus size={18} /> Nuevo</button>
      </div>
      <div style={styles.grid}>
        {list.map((p) => (
          <div key={p.id} style={styles.card}>
            <h3 style={{ margin: '0 0 5px 0', color: '#1f2937' }}>{p.nombre}</h3>
            {p.rut && <p style={{ margin: 0, color: '#6b7280', fontSize:'0.9rem' }}>{p.rut}</p>}
            <div style={styles.actions}>
              <button onClick={() => abrirEditar(p.id)} style={{ border:'none', background:'none', color: '#2563eb', cursor:'pointer' }}><Pencil size={20} /></button>
              <button onClick={() => eliminar(p.id)} style={{ border: 'none', background: 'none', color: '#ef4444', cursor: 'pointer' }}><Trash2 size={20} /></button>
            </div>
          </div>
        ))}
      </div>

      <Modal isOpen={modalOpen} onClose={cerrarModal} title={editId ? "Editar Proveedor" : "Nuevo Proveedor"}>
          {modalOpen && (
             <NuevoProveedor 
                idProveedor={editId} 
                cerrarModal={() => setModalOpen(false)} 
                alGuardar={() => { setModalOpen(false); leerDatos(); }} 
             />
          )}
      </Modal>
    </div>
  )
}
export default Proveedores


==================================================
RUTA: src\pages\ResumenCosechas.jsx
==================================================
import { useEffect, useState, useMemo } from 'react'
import { supabase } from '../supabaseClient'
import { Sprout, DollarSign, Scale, TrendingUp, PieChart, Users, Calendar, Filter } from 'lucide-react'

function ResumenCosechas() {
  const [loading, setLoading] = useState(true)
  const [rawCosechas, setRawCosechas] = useState([]) // Guardamos toda la data cruda
  const [anioSeleccionado, setAnioSeleccionado] = useState('Todos')
  
  // Stats calculadas
  const [stats, setStats] = useState({
    totalKilos: 0,
    ingresoTotal: 0,
    precioPromedio: 0,
    porCalibre: {},
    porCliente: {}
  })

  useEffect(() => {
    cargarDatos()
  }, [])

  // Recalcular estad√≠sticas cuando cambia el a√±o o la data
  useEffect(() => {
    calcularEstadisticas()
  }, [rawCosechas, anioSeleccionado])

  async function cargarDatos() {
    setLoading(true)
    const { data, error } = await supabase
      .from('cosechas')
      .select(`
        id, fecha, destino,
        clientes ( nombre ),
        detalle_cosechas ( calibre, kilos, precio_kilo )
      `)
      .eq('destino', 'Venta')

    if (error) {
      console.error(error)
    } else {
      setRawCosechas(data || [])
    }
    setLoading(false)
  }

  function calcularEstadisticas() {
    // 1. Filtrar por A√±o
    const filtradas = rawCosechas.filter(c => {
        if (!c.fecha) return false
        if (anioSeleccionado === 'Todos') return true
        return c.fecha.startsWith(anioSeleccionado)
    })

    let sumaKilos = 0
    let sumaDinero = 0
    const distCalibre = {}
    const distCliente = {}

    filtradas.forEach(c => {
      const nombreCliente = c.clientes?.nombre || 'Cliente Desconocido'
      
      if (c.detalle_cosechas?.length > 0) {
        c.detalle_cosechas.forEach(det => {
          const k = Number(det.kilos) || 0
          const p = Number(det.precio_kilo) || 0
          
          sumaKilos += k
          sumaDinero += (k * p)

          const cal = det.calibre || 'Sin Calibre'
          distCalibre[cal] = (distCalibre[cal] || 0) + k
          distCliente[nombreCliente] = (distCliente[nombreCliente] || 0) + k
        })
      }
    })

    setStats({
      totalKilos: sumaKilos,
      ingresoTotal: sumaDinero,
      precioPromedio: sumaKilos > 0 ? (sumaDinero / sumaKilos) : 0,
      porCalibre: distCalibre,
      porCliente: distCliente
    })
  }

  // Extraer lista de a√±os √∫nicos disponibles
  const aniosDisponibles = useMemo(() => {
    const anios = rawCosechas.map(c => c.fecha.substring(0, 4))
    return [...new Set(anios)].sort().reverse()
  }, [rawCosechas])

  const fmtDinero = (n) => '$ ' + Math.round(n).toLocaleString('es-CL')
  const fmtKilos = (n) => Math.round(n).toLocaleString('es-CL') + ' Kg'
  const ordenCalibres = ["Extra", "Primera", "Segunda", "Tercera", "Cuarta", "Quinta", "Descarte", "Barrido"]

  const styles = {
    container: { padding: '20px', width: '100%', maxWidth:'1200px', margin:'0 auto' },
    header: { marginBottom: '30px', display:'flex', justifyContent:'space-between', alignItems:'center', flexWrap:'wrap', gap:'15px' },
    titleGroup: { display:'flex', alignItems:'center', gap:'10px' },
    title: { fontSize: '1.8rem', fontWeight: 'bold', color: '#1f2937', margin:0 },
    
    // Selector
    filterBox: { display:'flex', alignItems:'center', gap:'10px', backgroundColor:'white', padding:'8px 15px', borderRadius:'8px', border:'1px solid #d1d5db', boxShadow:'0 1px 2px rgba(0,0,0,0.05)' },
    select: { border:'none', fontSize:'1rem', fontWeight:'bold', color:'#374151', outline:'none', cursor:'pointer', backgroundColor:'transparent' },

    gridKPI: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '20px', marginBottom: '40px' },
    card: { backgroundColor: 'white', padding: '25px', borderRadius: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.05)', border: '1px solid #e5e7eb', display:'flex', alignItems:'center', gap:'20px' },
    iconBox: (color, bg) => ({ width:'60px', height:'60px', borderRadius:'12px', backgroundColor: bg, color: color, display:'flex', alignItems:'center', justifyContent:'center' }),

    gridCharts: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '20px' },
    chartCard: { backgroundColor: 'white', padding: '25px', borderRadius: '16px', border: '1px solid #e5e7eb', boxShadow: '0 2px 4px rgba(0,0,0,0.02)' },
    chartTitle: { fontSize: '1.1rem', fontWeight: 'bold', color: '#374151', marginBottom: '20px', display:'flex', alignItems:'center', gap:'10px' },
    
    barRow: { marginBottom: '15px' },
    barLabelRow: { display: 'flex', justifyContent: 'space-between', fontSize: '0.9rem', marginBottom: '5px', color: '#4b5563' },
    track: { width: '100%', height: '8px', backgroundColor: '#f3f4f6', borderRadius: '4px', overflow: 'hidden' },
    fill: (pct, color) => ({ width: `${pct}%`, height: '100%', backgroundColor: color, borderRadius: '4px' }),
    
    clientRow: { display:'flex', justifyContent:'space-between', padding:'10px 0', borderBottom:'1px dashed #f3f4f6', fontSize:'0.95rem' }
  }

  if (loading) return <div style={{padding:'40px', textAlign:'center', color:'#9ca3af'}}>Cargando datos...</div>

  return (
    <div style={styles.container}>
      <div style={styles.header}>
         <div style={styles.titleGroup}>
            <TrendingUp size={32} color="#16a34a"/>
            <h1 style={styles.title}>Dashboard de Cosechas</h1>
         </div>

         {/* SELECTOR DE A√ëO */}
         <div style={styles.filterBox}>
             <Calendar size={18} color="#6b7280"/>
             <span style={{color:'#9ca3af', fontSize:'0.9rem'}}>Periodo:</span>
             <select 
                value={anioSeleccionado} 
                onChange={(e) => setAnioSeleccionado(e.target.value)} 
                style={styles.select}
             >
                 {aniosDisponibles.map(a => <option key={a} value={a}>{a}</option>)}
                 <option value="Todos">Hist√≥rico Completo</option>
             </select>
         </div>
      </div>

      <div style={styles.gridKPI}>
         <div style={styles.card}>
             <div style={styles.iconBox('#16a34a', '#dcfce7')}><Scale size={32}/></div>
             <div>
                 <div style={{fontSize:'0.9rem', color:'#6b7280', fontWeight:'bold', textTransform:'uppercase'}}>Kilos Vendidos</div>
                 <div style={{fontSize:'1.8rem', fontWeight:'bold', color:'#1f2937'}}>{fmtKilos(stats.totalKilos)}</div>
             </div>
         </div>
         <div style={styles.card}>
             <div style={styles.iconBox('#16a34a', '#dcfce7')}><DollarSign size={32}/></div>
             <div>
                 <div style={{fontSize:'0.9rem', color:'#6b7280', fontWeight:'bold', textTransform:'uppercase'}}>Ventas {anioSeleccionado === 'Todos' ? 'Hist√≥ricas' : anioSeleccionado}</div>
                 <div style={{fontSize:'1.8rem', fontWeight:'bold', color:'#16a34a'}}>{fmtDinero(stats.ingresoTotal)}</div>
             </div>
         </div>
         <div style={styles.card}>
             <div style={styles.iconBox('#2563eb', '#dbeafe')}><Sprout size={32}/></div>
             <div>
                 <div style={{fontSize:'0.9rem', color:'#6b7280', fontWeight:'bold', textTransform:'uppercase'}}>Precio Promedio</div>
                 <div style={{fontSize:'1.8rem', fontWeight:'bold', color:'#2563eb'}}>{fmtDinero(stats.precioPromedio)} / Kg</div>
             </div>
         </div>
      </div>

      <div style={styles.gridCharts}>
          <div style={styles.chartCard}>
              <div style={styles.chartTitle}><PieChart size={20}/> Distribuci√≥n por Calibre</div>
              {Object.keys(stats.porCalibre).length === 0 && <div style={{fontStyle:'italic', color:'#9ca3af', padding:'20px'}}>No hay registros en este periodo.</div>}
              
              {ordenCalibres.map(cal => {
                  const val = stats.porCalibre[cal] || 0
                  if (val === 0) return null
                  const porcentaje = ((val / stats.totalKilos) * 100).toFixed(1)
                  const colorBarra = cal === 'Extra' || cal === 'Primera' ? '#16a34a' : (cal === 'Descarte' ? '#ef4444' : '#f59e0b')

                  return (
                      <div key={cal} style={styles.barRow}>
                          <div style={styles.barLabelRow}>
                              <span style={{fontWeight:'bold'}}>{cal}</span>
                              <span>{fmtKilos(val)} ({porcentaje}%)</span>
                          </div>
                          <div style={styles.track}>
                              <div style={styles.fill(porcentaje, colorBarra)}></div>
                          </div>
                      </div>
                  )
              })}
          </div>

          <div style={styles.chartCard}>
              <div style={styles.chartTitle}><Users size={20}/> Top Clientes ({anioSeleccionado})</div>
              {Object.keys(stats.porCliente).length === 0 && <div style={{fontStyle:'italic', color:'#9ca3af', padding:'20px'}}>No hay registros.</div>}

              {Object.entries(stats.porCliente)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8) // Mostrar solo top 8 para no saturar
                .map(([cliente, kilos]) => (
                  <div key={cliente} style={styles.clientRow}>
                      <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                          <div style={{width:'8px', height:'8px', borderRadius:'50%', backgroundColor:'#1f2937'}}></div>
                          <span style={{color:'#374151', fontWeight:'500'}}>{cliente}</span>
                      </div>
                      <div style={{fontWeight:'bold', color:'#1f2937'}}>{fmtKilos(kilos)}</div>
                  </div>
              ))}
          </div>
      </div>
    </div>
  )
}
export default ResumenCosechas


==================================================
RUTA: src\pages\ResumenFinanciero.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Wallet, TrendingUp, TrendingDown, Activity, ArrowUpCircle, ArrowDownCircle, AlertTriangle, Building, DollarSign } from 'lucide-react'

function ResumenFinanciero() {
  const [loading, setLoading] = useState(true)
  const [resumen, setResumen] = useState({
    ingresosVentas: 0,
    gastosOperacionales: 0,
    inversiones: 0,
    deudaPendiente: 0,
    gastosPagados: 0
  })
  
  const [listaMovimientos, setListaMovimientos] = useState([])

  useEffect(() => {
    cargarDatos()
  }, [])

  async function cargarDatos() {
    setLoading(true)
    
    // 1. TRAER GASTOS (Con su categor√≠a para saber si es Inversi√≥n)
    const { data: gastos } = await supabase
      .from('gastos')
      .select('*, categorias_gastos(tipo, nombre)')
      .order('fecha', { ascending: false })

    // 2. TRAER COSECHAS (Solo Ventas)
    const { data: cosechas } = await supabase
      .from('cosechas')
      .select('kilos, precio_kilo, fecha')
      .eq('destino', 'Venta')

    // --- C√ÅLCULOS ---

    // A) Ingresos por Venta de Fruta
    const totalVentas = (cosechas || []).reduce((acc, c) => acc + (Number(c.kilos) * Number(c.precio_kilo)), 0)

    // B) Clasificaci√≥n de Gastos
    let opex = 0 // Gasto Operacional
    let capex = 0 // Inversi√≥n
    let deuda = 0 
    let pagado = 0

    const movimientosCombinados = []

    if (gastos) {
        gastos.forEach(g => {
            const monto = Number(g.monto) || 0
            const esInversion = g.categorias_gastos?.tipo === 'Inversi√≥n'
            
            // Sumamos seg√∫n tipo
            if (esInversion) capex += monto
            else opex += monto

            // Estado de Pago
            if (g.estado_pago === 'Pendiente') deuda += monto
            else pagado += monto

            // Preparamos lista para el historial unificado (Gastos)
            movimientosCombinados.push({
                id: 'G-'+g.id,
                fecha: g.fecha,
                tipo: 'Egreso',
                categoria: g.categorias_gastos?.nombre || 'Gasto General',
                detalle: g.descripcion,
                monto: -monto, // Negativo para la tabla
                esInversion
            })
        })
    }

    // Agregamos las Ventas al historial visual
    if (cosechas) {
        cosechas.forEach((c, idx) => {
            const montoVenta = Number(c.kilos) * Number(c.precio_kilo)
            movimientosCombinados.push({
                id: 'C-'+idx,
                fecha: c.fecha,
                tipo: 'Ingreso',
                categoria: 'Venta Cosecha',
                detalle: `${c.kilos} Kg a $${parseInt(c.precio_kilo)}`,
                monto: montoVenta,
                esInversion: false
            })
        })
    }

    // Ordenar historial por fecha reciente
    movimientosCombinados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))

    setResumen({
        ingresosVentas: totalVentas,
        gastosOperacionales: opex,
        inversiones: capex,
        deudaPendiente: deuda,
        gastosPagados: pagado
    })
    setListaMovimientos(movimientosCombinados)
    setLoading(false)
  }

  const formatear = (n) => '$ ' + Math.round(n).toLocaleString('es-CL')

  // Resultado Operacional (Ventas - Gastos de Funcionamiento)
  const resultadoOperacional = resumen.ingresosVentas - resumen.gastosOperacionales
  
  // Flujo Neto (Considerando tambi√©n las inversiones)
  const flujoNeto = resultadoOperacional - resumen.inversiones

  const styles = {
    container: { padding: '20px', width: '100%', maxWidth: '1200px', margin: '0 auto' },
    header: { marginBottom: '30px' },
    title: { fontSize: '1.8rem', fontWeight: 'bold', color: '#1f2937', display:'flex', alignItems:'center', gap:'10px' },
    
    // Grid Principal
    gridTop: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '20px', marginBottom: '30px' },
    
    // Tarjetas Grandes
    cardBig: { backgroundColor: 'white', padding: '25px', borderRadius: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.05)', border: '1px solid #e5e7eb', display:'flex', flexDirection:'column', justifyContent:'space-between' },
    cardLabel: { fontSize: '0.9rem', color: '#6b7280', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px' },
    cardValue: (color) => ({ fontSize: '2rem', fontWeight: 'bold', color: color, marginTop: '5px' }),
    cardSub: { fontSize: '0.85rem', color: '#9ca3af', marginTop: '5px' },

    // Secci√≥n Indicadores
    sectionTitle: { fontSize: '1.2rem', fontWeight: 'bold', color: '#374151', marginBottom: '15px', marginTop: '10px' },
    indicatorsGrid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(240px, 1fr))', gap: '15px', marginBottom: '40px' },
    miniCard: { backgroundColor: 'white', padding: '20px', borderRadius: '12px', border: '1px solid #f3f4f6', display:'flex', alignItems:'center', gap:'15px' },
    
    // Tabla
    tableContainer: { backgroundColor: 'white', borderRadius: '12px', boxShadow: '0 2px 10px rgba(0,0,0,0.03)', overflow: 'hidden' },
    table: { width: '100%', borderCollapse: 'collapse', fontSize:'0.95rem' },
    th: { textAlign: 'left', padding: '15px', backgroundColor: '#f9fafb', color: '#6b7280', fontSize: '0.8rem', textTransform:'uppercase' },
    td: { padding: '15px', borderBottom: '1px solid #f3f4f6', color: '#374151' },
    
    // Badges
    badgeInv: { backgroundColor: '#dbeafe', color: '#1e40af', padding: '2px 8px', borderRadius: '4px', fontSize: '0.7rem', fontWeight: 'bold' },
    badgeOp: { backgroundColor: '#f3f4f6', color: '#4b5563', padding: '2px 8px', borderRadius: '4px', fontSize: '0.7rem', fontWeight: 'bold' },
  }

  if (loading) return <div style={{padding:'40px', textAlign:'center', color:'#9ca3af'}}>Calculando finanzas...</div>

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><Activity color="#16a34a"/> Resumen Financiero</h1>
      </div>

      {/* --- TARJETAS PRINCIPALES --- */}
      <div style={styles.gridTop}>
          
          {/* RESULTADO OPERACIONAL */}
          <div style={styles.cardBig}>
              <div>
                  <div style={styles.cardLabel}>Resultado Operacional</div>
                  <div style={styles.cardValue(resultadoOperacional >= 0 ? '#16a34a' : '#ef4444')}>
                      {formatear(resultadoOperacional)}
                  </div>
                  <div style={styles.cardSub}>Ingresos Ventas - Gastos Operaci√≥n</div>
              </div>
              <div style={{marginTop:'20px', height:'4px', width:'100%', backgroundColor:'#f3f4f6', borderRadius:'2px', overflow:'hidden'}}>
                  <div style={{height:'100%', width: `${Math.min(100, (resumen.ingresosVentas / (resumen.ingresosVentas + resumen.gastosOperacionales)) * 100)}%`, backgroundColor: resultadoOperacional>=0?'#16a34a':'#ef4444'}}></div>
              </div>
          </div>

          {/* FLUJO NETO (CAJA REAL) */}
          <div style={styles.cardBig}>
              <div>
                  <div style={{...styles.cardLabel, display:'flex', justifyContent:'space-between'}}>
                      <span>Flujo Neto (Inc. Inversi√≥n)</span>
                      {resumen.inversiones > 0 && <span style={styles.badgeInv}>CAPEX ACTIVO</span>}
                  </div>
                  <div style={styles.cardValue(flujoNeto >= 0 ? '#059669' : '#d97706')}>
                      {formatear(flujoNeto)}
                  </div>
                  <div style={styles.cardSub}>Resultado Final tras Inversiones</div>
              </div>
          </div>

          {/* DEUDA */}
          <div style={{...styles.cardBig, borderLeft:'5px solid #ef4444'}}>
              <div>
                  <div style={styles.cardLabel}>Cuentas por Pagar</div>
                  <div style={styles.cardValue('#ef4444')}>
                      {formatear(resumen.deudaPendiente)}
                  </div>
                  <div style={{display:'flex', alignItems:'center', gap:'5px', marginTop:'5px', color:'#ef4444', fontSize:'0.85rem'}}>
                      <AlertTriangle size={14}/> Facturas Pendientes
                  </div>
              </div>
          </div>
      </div>

      <h3 style={styles.sectionTitle}>Desglose de Movimientos</h3>
      <div style={styles.indicatorsGrid}>
          {/* INGRESOS */}
          <div style={styles.miniCard}>
              <div style={{padding:'10px', backgroundColor:'#dcfce7', borderRadius:'50%', color:'#166534'}}><TrendingUp size={24}/></div>
              <div>
                  <div style={{fontSize:'0.8rem', color:'#6b7280'}}>Ventas Totales</div>
                  <div style={{fontSize:'1.1rem', fontWeight:'bold', color:'#166534'}}>{formatear(resumen.ingresosVentas)}</div>
              </div>
          </div>

          {/* OPEX */}
          <div style={styles.miniCard}>
              <div style={{padding:'10px', backgroundColor:'#fee2e2', borderRadius:'50%', color:'#991b1b'}}><TrendingDown size={24}/></div>
              <div>
                  <div style={{fontSize:'0.8rem', color:'#6b7280'}}>Gastos Operacionales</div>
                  <div style={{fontSize:'1.1rem', fontWeight:'bold', color:'#991b1b'}}>{formatear(resumen.gastosOperacionales)}</div>
              </div>
          </div>

          {/* CAPEX */}
          <div style={styles.miniCard}>
              <div style={{padding:'10px', backgroundColor:'#dbeafe', borderRadius:'50%', color:'#1e40af'}}><Building size={24}/></div>
              <div>
                  <div style={{fontSize:'0.8rem', color:'#6b7280'}}>Inversiones (CAPEX)</div>
                  <div style={{fontSize:'1.1rem', fontWeight:'bold', color:'#1e40af'}}>{formatear(resumen.inversiones)}</div>
              </div>
          </div>

          {/* PAGADO */}
          <div style={styles.miniCard}>
              <div style={{padding:'10px', backgroundColor:'#f3f4f6', borderRadius:'50%', color:'#4b5563'}}><Wallet size={24}/></div>
              <div>
                  <div style={{fontSize:'0.8rem', color:'#6b7280'}}>Total Pagado</div>
                  <div style={{fontSize:'1.1rem', fontWeight:'bold', color:'#374151'}}>{formatear(resumen.gastosPagados)}</div>
              </div>
          </div>
      </div>

      {/* TABLA HIST√ìRICA */}
      <h3 style={styles.sectionTitle}>√öltimos Movimientos (Ingresos y Egresos)</h3>
      <div style={styles.tableContainer}>
          <table style={styles.table}>
              <thead>
                  <tr>
                      <th style={styles.th}>Fecha</th>
                      <th style={styles.th}>Concepto</th>
                      <th style={styles.th}>Detalle</th>
                      <th style={styles.th}>Tipo</th>
                      <th style={{...styles.th, textAlign:'right'}}>Monto</th>
                  </tr>
              </thead>
              <tbody>
                  {listaMovimientos.map((m) => (
                      <tr key={m.id}>
                          <td style={styles.td}>{m.fecha.split('-').reverse().join('/')}</td>
                          <td style={styles.td}>
                              <div style={{fontWeight:'bold'}}>{m.categoria}</div>
                          </td>
                          <td style={styles.td}>{m.detalle || '-'}</td>
                          <td style={styles.td}>
                              {m.tipo === 'Ingreso' ? (
                                  <span style={{color:'#166534', backgroundColor:'#dcfce7', padding:'2px 6px', borderRadius:'4px', fontSize:'0.75rem', fontWeight:'bold'}}>VENTA</span>
                              ) : (
                                  m.esInversion ? 
                                  <span style={styles.badgeInv}>INVERSI√ìN</span> : 
                                  <span style={styles.badgeOp}>GASTO</span>
                              )}
                          </td>
                          <td style={{...styles.td, textAlign:'right', fontWeight:'bold', color: m.monto>=0 ? '#166534' : '#ef4444'}}>
                              {formatear(m.monto)}
                          </td>
                      </tr>
                  ))}
                  {listaMovimientos.length === 0 && <tr><td colSpan="5" style={{padding:'30px', textAlign:'center', color:'#9ca3af'}}>No hay movimientos registrados.</td></tr>}
              </tbody>
          </table>
      </div>
    </div>
  )
}
export default ResumenFinanciero


==================================================
RUTA: src\pages\Riego.jsx
==================================================
import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Droplets, Calendar, Clock, Plus, Pencil, Trash2 } from 'lucide-react'
import Modal from '../components/Modal'
import NuevoPrograma from './NuevoPrograma'

function Riego() {
  const [gruposRiego, setGruposRiego] = useState({}) 
  const [historial, setHistorial] = useState([])
  
  // MODAL
  const [modalOpen, setModalOpen] = useState(false)
  const [programaEditarId, setProgramaEditarId] = useState(null) // Para manejar edici√≥n

  useEffect(() => {
    cargarDatos()
  }, [])

  // MODO CREAR
  const abrirModalNuevo = () => {
    setProgramaEditarId(null)
    setModalOpen(true)
  }

  // MODO EDITAR
  const abrirModalEditar = (id) => {
    setProgramaEditarId(id)
    setModalOpen(true)
  }

  const handleCloseRequest = () => {
    if (window.intentarCerrarModal) window.intentarCerrarModal()
    else setModalOpen(false)
  }

  const handleGuardar = () => {
    setModalOpen(false)
    cargarDatos()
  }

  // ELIMINAR (Finalizar programa o borrar si fue error)
  const eliminarPrograma = async (id) => {
      if(confirm("¬øEst√°s seguro de ELIMINAR este programa activo?")) {
          await supabase.from('programas_riego').delete().eq('id', id)
          cargarDatos()
      }
  }

  async function cargarDatos() {
    // 1. Programas Activos
    const { data: activos } = await supabase
      .from('programas_riego')
      .select('*, sectores(nombre, parcelas(nombre))') 
      .is('fecha_fin', null)
    
    if (activos) {
        const agrupado = activos.reduce((acc, prog) => {
            const nombreParcela = prog.sectores?.parcelas?.nombre || 'Sin Parcela'
            if (!acc[nombreParcela]) acc[nombreParcela] = []
            acc[nombreParcela].push(prog)
            return acc
        }, {})
        setGruposRiego(agrupado)
    }

    // 2. Historial (sin medidor)
    const { data: hist } = await supabase.from('programas_riego').select('*, sectores(nombre)').not('fecha_fin', 'is', null).order('fecha_fin', { ascending: false }).limit(5)
    setHistorial(hist || [])
  }

  const formatearFecha = (f) => f ? f.split('-').reverse().join('/') : '-'

  const renderDias = (diasArray) => {
      if (!Array.isArray(diasArray)) return null
      const diasCortos = ['Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa', 'Do']
      const diasNombres = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo']
      return (
          <div style={{display:'flex', gap:'4px', marginTop:'8px'}}>
              {diasNombres.map((dia, idx) => {
                  const activo = diasArray.includes(dia)
                  return (
                      <div key={dia} style={{
                          width:'20px', height:'20px', borderRadius:'50%', fontSize:'0.6rem',
                          display:'flex', alignItems:'center', justifyContent:'center',
                          backgroundColor: activo ? '#0ea5e9' : '#e5e7eb',
                          color: activo ? 'white' : '#9ca3af',
                          fontWeight: 'bold'
                      }}>
                          {diasCortos[idx]}
                      </div>
                  )
              })}
          </div>
      )
  }

  const styles = {
    container: { padding: '20px', width: '90%' },
    header: { display: 'flex', justifyContent: 'flex-start', gap:'20px', alignItems: 'center', marginBottom: '30px' },
    title: { display: 'flex', alignItems: 'center', gap: '10px', fontSize: '1.5rem', fontWeight: 'bold', color: '#1f2937' },
    btnNew: { textDecoration: 'none', backgroundColor: '#0ea5e9', color: 'white', padding: '10px 20px', borderRadius: '8px', fontWeight: 'bold', fontSize: '0.9rem', border:'none', cursor:'pointer', display:'flex', alignItems:'center', gap:'5px' },
    
    activeGrid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '20px' },
    activeCard: { backgroundColor: 'white', borderLeft: '5px solid #0ea5e9', padding: '20px', borderRadius: '12px', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', position: 'relative' },
    
    actions: { position: 'absolute', top: '15px', right: '15px', display: 'flex', gap: '8px' },
    btnIcon: { border: 'none', background: 'none', cursor: 'pointer', color: '#64748b' },

    table: { width: '100%', borderCollapse: 'collapse', backgroundColor: 'white', borderRadius: '8px', overflow: 'hidden', marginTop:'10px' },
    th: { textAlign: 'left', padding: '10px', backgroundColor: '#f9fafb', color: '#6b7280', fontSize: '0.8rem' },
    td: { padding: '10px', borderBottom: '1px solid #f3f4f6', fontSize: '0.9rem' },
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><Droplets color="#0ea5e9" /> Gesti√≥n de Riego</h1>
        <button onClick={abrirModalNuevo} style={styles.btnNew}><Plus size={18}/> Cambiar Programa</button>
      </div>

      {Object.keys(gruposRiego).length === 0 ? (
         <div style={{padding:'40px', textAlign:'center', backgroundColor:'white', borderRadius:'12px', color:'#9ca3af', border:'2px dashed #e5e7eb'}}>
            No hay programas de riego activos. Inicia uno nuevo.
         </div>
      ) : (
         Object.keys(gruposRiego).sort().map(parcela => (
             <div key={parcela} style={{marginBottom:'30px'}}>
                 <h3 style={{color:'#64748b', borderBottom:'1px solid #cbd5e1', paddingBottom:'5px', marginBottom:'15px'}}>{parcela}</h3>
                 <div style={styles.activeGrid}>
                     {gruposRiego[parcela].map(prog => (
                        <div key={prog.id} style={styles.activeCard}>
                            {/* BOTONES DE ACCI√ìN */}
                            <div style={styles.actions}>
                                <button onClick={() => abrirModalEditar(prog.id)} style={{...styles.btnIcon, color:'#2563eb'}} title="Editar"><Pencil size={18}/></button>
                                <button onClick={() => eliminarPrograma(prog.id)} style={{...styles.btnIcon, color:'#ef4444'}} title="Eliminar"><Trash2 size={18}/></button>
                            </div>

                            <div style={{fontSize:'1.1rem', fontWeight:'bold', color:'#1f2937'}}>{prog.sectores?.nombre}</div>
                            
                            {prog.dias_semana ? renderDias(prog.dias_semana) : <div style={{fontWeight:'bold', color:'#0ea5e9', margin:'10px 0'}}>{prog.frecuencia}</div>}

                            <div style={{marginTop:'15px', fontSize:'0.9rem'}}>
                                {prog.turnos && Array.isArray(prog.turnos) ? (
                                    prog.turnos.map((t, i) => (
                                        <div key={i} style={{display:'flex', alignItems:'center', gap:'5px', marginBottom:'4px', color:'#4b5563'}}>
                                            <Clock size={14} color="#9ca3af"/> 
                                            <strong>{t.hora}</strong> 
                                            <span style={{color:'#9ca3af'}}>({t.minutos} min)</span>
                                        </div>
                                    ))
                                ) : (
                                    <div style={{display:'flex', alignItems:'center', gap:'5px', color:'#4b5563'}}>
                                        <Clock size={14}/> {prog.duracion_minutos} min / d√≠a
                                    </div>
                                )}
                            </div>

                            <div style={{marginTop:'15px', borderTop:'1px solid #f3f4f6', paddingTop:'10px', fontSize:'0.8rem', color:'#9ca3af', display:'flex', gap:'5px'}}>
                                <Calendar size={14}/> Desde: {formatearFecha(prog.fecha_inicio)}
                            </div>
                        </div>
                     ))}
                 </div>
             </div>
         ))
      )}

      {/* SOLO HISTORIAL (Ya no hay medidor) */}
      <div style={{marginTop:'40px'}}>
          <h3 style={{color:'#6b7280'}}>Historial de Cambios</h3>
          <table style={styles.table}>
            <thead><tr><th style={styles.th}>Sector</th><th style={styles.th}>Fecha</th><th style={styles.th}>Duraci√≥n</th></tr></thead>
            <tbody>
              {historial.map(h => (
                <tr key={h.id}><td style={styles.td}>{h.sectores?.nombre}</td><td style={styles.td}>{formatearFecha(h.fecha_inicio)}</td><td style={styles.td}>{h.duracion_minutos}m / d√≠a</td></tr>
              ))}
            </tbody>
          </table>
      </div>

      <Modal 
        isOpen={modalOpen} 
        onClose={handleCloseRequest} 
        title={programaEditarId ? "Editar Programa Existente" : "Configurar Nuevo Programa"}
      >
        {modalOpen && (
            <NuevoPrograma 
                idPrograma={programaEditarId}
                cerrarModal={() => setModalOpen(false)} 
                alGuardar={handleGuardar}
            />
        )}
      </Modal>
    </div>
  )
}
export default Riego


==================================================
RUTA: src\pages\Sectores.jsx
==================================================
import React, { useState, useEffect } from 'react';
import Sidebar from '../components/Sidebar';
import { supabase } from '../supabaseClient';
import { Plus, MapPin, Droplets, Ruler, TreeDeciduous, ArrowRight } from 'lucide-react';
import Modal from '../components/Modal';
import NuevoSector from '../pages/NuevoSector';

// --- Componente de Tarjeta (Estilo Visual Completo) ---
const SectorCard = ({ sector, onClick }) => (
  <div 
    onClick={onClick}
    style={{
      background: 'white',
      borderRadius: '16px',
      boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
      padding: '24px',
      cursor: 'pointer',
      transition: 'transform 0.2s, box-shadow 0.2s',
      border: '1px solid #f3f4f6',
      display: 'flex',
      flexDirection: 'column',
      justifyContent: 'space-between',
      height: '100%'
    }}
    onMouseEnter={(e) => {
      e.currentTarget.style.transform = 'translateY(-5px)';
      e.currentTarget.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1)';
    }}
    onMouseLeave={(e) => {
      e.currentTarget.style.transform = 'translateY(0)';
      e.currentTarget.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)';
    }}
  >
    <div>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '15px' }}>
        <div style={{ background: '#ecfdf5', padding: '10px', borderRadius: '12px', color: '#059669' }}>
          <TreeDeciduous size={24} />
        </div>
        <span style={{ fontSize: '0.75rem', fontWeight: '600', color: '#9ca3af', textTransform: 'uppercase', letterSpacing: '0.05em' }}>
          Sector #{sector.id}
        </span>
      </div>
      
      <h3 style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#111827', margin: '0 0 10px 0' }}>
        {sector.nombre}
      </h3>
      
      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#6b7280', fontSize: '0.9rem' }}>
          <Ruler size={16} />
          <span>{sector.hectareas ? sector.hectareas : sector.superficie_ha || 0} Hect√°reas</span>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#6b7280', fontSize: '0.9rem' }}>
          <MapPin size={16} />
          <span>{sector.ubicacion || 'Ubicaci√≥n no definida'}</span>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#6b7280', fontSize: '0.9rem' }}>
          <Droplets size={16} />
          <span>{sector.metodo_riego || 'Riego no especificado'}</span>
        </div>
      </div>
    </div>

    <div style={{ marginTop: '20px', borderTop: '1px solid #f3f4f6', paddingTop: '15px', display: 'flex', alignItems: 'center', color: '#2563eb', fontWeight: '500', fontSize: '0.9rem' }}>
      Ver Detalles y Labores <ArrowRight size={16} style={{ marginLeft: 'auto' }} />
    </div>
  </div>
);

// --- Componente Principal ---
export default function Sectores() {
  const [sectores, setSectores] = useState([]);
  const [loading, setLoading] = useState(true);
  const [modalOpen, setModalOpen] = useState(false);

  const fetchSectores = async () => {
    setLoading(true);
    // Aseg√∫rate de que la tabla 'sectores' exista en Supabase
    const { data, error } = await supabase
      .from('sectores')
      .select('*')
      .order('nombre', { ascending: true });

    if (error) {
      console.error('Error cargando sectores:', error);
    } else {
      setSectores(data || []);
    }
    setLoading(false);
  };

  useEffect(() => {
    fetchSectores();
  }, []);

  return (
    <div style={{ display: 'flex', minHeight: '100vh', background: '#f9fafb' }}>
      <Sidebar />
      <div style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
        <Header title="Mis Sectores Productivos" />
        
        <div style={{ padding: '30px', maxWidth: '1400px', margin: '0 auto', width: '100%' }}>
          
          {/* Barra de Acciones */}
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px' }}>
            <div>
              <h2 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#111827', margin: 0 }}>Visi√≥n General</h2>
              <p style={{ color: '#6b7280', margin: '5px 0 0 0' }}>Administra tus lotes, superficies y variedades.</p>
            </div>
            <button 
              onClick={() => setModalOpen(true)}
              style={{ 
                display: 'flex', alignItems: 'center', gap: '8px',
                background: '#2563eb', color: 'white', padding: '12px 24px', 
                borderRadius: '10px', border: 'none', fontWeight: '600', cursor: 'pointer',
                boxShadow: '0 4px 6px rgba(37, 99, 235, 0.2)'
              }}
            >
              <Plus size={20} /> Nuevo Sector
            </button>
          </div>

          {/* GRID DE TARJETAS INTELIGENTES */}
          {loading ? (
            <p style={{ textAlign: 'center', color: '#6b7280' }}>Cargando sectores...</p>
          ) : (
            <div style={{ 
              display: 'grid', 
              gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', 
              gap: '25px' 
            }}>
              {sectores.map((sector) => (
                <SectorCard 
                  key={sector.id} 
                  sector={sector} 
                  onClick={() => alert(`Pr√≥ximamente: Detalle del sector ${sector.nombre}`)} 
                />
              ))}
              
              {sectores.length === 0 && (
                <div style={{ gridColumn: '1 / -1', textAlign: 'center', padding: '60px', color: '#9ca3af', border: '2px dashed #e5e7eb', borderRadius: '16px', backgroundColor: 'white' }}>
                  <TreeDeciduous size={48} style={{ marginBottom: '15px', opacity: 0.5 }} />
                  <p>No tienes sectores registrados.</p>
                  <button 
                    onClick={() => setModalOpen(true)}
                    style={{ marginTop: '10px', color: '#2563eb', background: 'none', border: 'none', cursor: 'pointer', textDecoration: 'underline' }}
                  >
                    Crea el primero ahora
                  </button>
                </div>
              )}
            </div>
          )}

        </div>
      </div>

      <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title="Registrar Nuevo Sector">
        <NuevoSector 
          cerrarModal={() => setModalOpen(false)} 
          onSectorGuardado={() => {
            setModalOpen(false);
            fetchSectores();
          }} 
        />
      </Modal>
    </div>
  );
}
