================================================================================
ARCHIVO: src/pages/Dashboard.jsx
================================================================================

import { useState } from 'react'
import { LayoutDashboard, Wallet, Sprout } from 'lucide-react'

import DashboardSectores from './DashboardSectores' 
import DashboardFinanzas from './DashboardFinanzas' 
import DashboardCosecha from './DashboardCosecha'

function Dashboard() {
  const [activeTab, setActiveTab] = useState('sectores')

  const tabs = [
    { id: 'sectores', label: 'Campo', icon: <LayoutDashboard size={18} /> },
    { id: 'finanzas', label: 'Finanzas', icon: <Wallet size={18} /> },
    { id: 'cosecha', label: 'Producci√≥n', icon: <Sprout size={18} /> }
  ]

  const renderContent = () => {
    switch (activeTab) {
      case 'sectores': return <DashboardSectores />
      case 'finanzas': return <DashboardFinanzas />
      case 'cosecha':  return <DashboardCosecha />
      default: return null
    }
  }

  const styles = {
    container: { padding: '20px', maxWidth: '1400px', margin: '0 auto' },
    
    // Header flex para alinear t√≠tulo izq y tabs der
    header: { 
        display: 'flex', 
        justifyContent: 'space-between', 
        alignItems: 'center', 
        marginBottom: '25px',
        flexWrap: 'wrap',
        gap: '15px'
    },
    titleGroup: { display: 'flex', flexDirection: 'column' },
    title: { fontSize: '1.8rem', fontWeight: 'bold', color: '#111827', margin: 0 },
    subtitle: { color: '#6b7280', marginTop: '5px', fontSize:'0.9rem' },
    
    tabsContainer: { 
        display: 'flex', gap: '5px', padding: '4px', backgroundColor: '#e5e7eb', 
        borderRadius: '10px', height: 'fit-content'
    },
    tab: (isActive) => ({
      display: 'flex', alignItems: 'center', gap: '8px',
      padding: '8px 16px', borderRadius: '8px', border: 'none', cursor: 'pointer',
      fontWeight: '600', fontSize: '0.9rem', transition: 'all 0.2s',
      backgroundColor: isActive ? 'white' : 'transparent',
      color: isActive ? '#1f2937' : '#6b7280',
      boxShadow: isActive ? '0 1px 3px rgba(0,0,0,0.1)' : 'none'
    }),
    contentArea: { animation: 'fadeIn 0.3s ease-in-out' }
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <div style={styles.titleGroup}>
            <h1 style={styles.title}>Dashboard</h1>
            <div style={styles.subtitle}>Visi√≥n general del negocio</div>
        </div>

        {/* Pesta√±as ahora a la derecha */}
        <div style={styles.tabsContainer}>
            {tabs.map(tab => (
            <button 
                key={tab.id} 
                onClick={() => setActiveTab(tab.id)}
                style={styles.tab(activeTab === tab.id)}
            >
                {tab.icon}
                {tab.label}
            </button>
            ))}
        </div>
      </div>

      <div style={styles.contentArea}>
        {renderContent()}
      </div>
    </div>
  )
}
export default Dashboard

================================================================================
ARCHIVO: src/pages/Cosechas.jsx
================================================================================

import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { 
  Sprout, Calendar, User, Plus, Trash2, Pencil, MapPin, 
  ChevronDown, ChevronUp, Scale, ArrowRight, Layers, List, 
  ArrowDown, ArrowUp, ArrowUpDown 
} from 'lucide-react'
import Modal from '../components/Modal'
import NuevaCosecha from './NuevaCosecha'

// Helpers
const formatearDinero = (monto) => '$ ' + Math.round(monto || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")

function Cosechas() {
  const [dataOriginal, setDataOriginal] = useState([]) 
  const [dataProcesada, setDataProcesada] = useState([]) 
  const [gruposCosechas, setGruposCosechas] = useState({}) 
  const [loading, setLoading] = useState(true)
  const [tarjetasExpandidas, setTarjetasExpandidas] = useState({})

  // Filtros y Controles
  const [anioSeleccionado, setAnioSeleccionado] = useState('')
  const [aniosDisponibles, setAniosDisponibles] = useState([])
  
  // ESTADOS DE VISTA
  const [vistaAgrupada, setVistaAgrupada] = useState(true) 
  const [orden, setOrden] = useState('fecha_desc') // fecha_desc | fecha_asc | sector

  const [modalOpen, setModalOpen] = useState(false)
  const [editarId, setEditarId] = useState(null)

  useEffect(() => { leerCosechas() }, [])
  
  useEffect(() => { 
      procesarDatos()
  }, [dataOriginal, anioSeleccionado, orden, vistaAgrupada])

  async function leerCosechas() {
    setLoading(true)
    try {
        const { data, error } = await supabase
          .from('cosechas')
          .select(`
            *,
            clientes:clientes!fk_cosechas_cliente ( nombre ),
            sectores:sectores!fk_cosechas_sector ( 
                nombre, 
                parcelas:parcelas!fk_sectores_parcela ( nombre ) 
            ),
            detalle_cosechas ( calibre, kilos, precio_kilo )
          `)
          .order('fecha', { ascending: false })
        
        if (error) throw error

        if (data) {
            const anios = [...new Set(data.map(item => item.fecha ? new Date(item.fecha).getFullYear() : null))].filter(a => a)
            const aniosOrdenados = anios.sort((a,b) => b - a)
            setAniosDisponibles(aniosOrdenados)
            setDataOriginal(data)
        }
    } catch (err) {
        console.error("Error al leer cosechas:", err.message)
    } finally {
        setLoading(false)
    }
  }

  // L√≥gica de Ordenamiento y Agrupaci√≥n
  const procesarDatos = () => {
      if (dataOriginal.length === 0) return

      // 1. Filtrar por A√±o
      let filtrados = [...dataOriginal]
      if (anioSeleccionado) {
          filtrados = filtrados.filter(c => c.fecha && new Date(c.fecha).getFullYear() === parseInt(anioSeleccionado))
      }

      // 2. Ordenar
      filtrados.sort((a, b) => {
          if (orden === 'fecha_desc') return new Date(b.fecha) - new Date(a.fecha)
          if (orden === 'fecha_asc') return new Date(a.fecha) - new Date(b.fecha)
          if (orden === 'sector') {
              const nombreA = a.sectores?.nombre || ''
              const nombreB = b.sectores?.nombre || ''
              return nombreA.localeCompare(nombreB)
          }
          return 0
      })

      // 3. Agrupar
      if (vistaAgrupada) {
          const agrupado = filtrados.reduce((acc, item) => {
              const nombreParcela = item.sectores?.parcelas?.nombre || 'Sin Parcela Asignada'
              if (!acc[nombreParcela]) acc[nombreParcela] = []
              acc[nombreParcela].push(item)
              return acc
          }, {})
          setGruposCosechas(agrupado)
      } else {
          setDataProcesada(filtrados)
      }
  }

  // Manejador inteligente del bot√≥n Fecha
  const toggleOrdenFecha = () => {
      if (orden === 'fecha_desc') setOrden('fecha_asc')
      else setOrden('fecha_desc')
  }

  const toggleExpansion = (id) => {
      setTarjetasExpandidas(prev => ({ ...prev, [id]: !prev[id] }))
  }

  const abrirCrear = () => { setEditarId(null); setModalOpen(true) }
  const abrirEditar = (id) => { setEditarId(id); setModalOpen(true) }
  const handleGuardado = () => { setModalOpen(false); leerCosechas() }

  const eliminar = async (id) => {
    if (confirm("¬øEliminar este registro de cosecha y sus detalles?")) {
      await supabase.from('cosechas').delete().eq('id', id)
      leerCosechas()
    }
  }

  const getFechaParts = (fechaString) => {
      if (!fechaString) return { dia: '-', mes: '-', ano: '-' }
      const date = new Date(fechaString)
      const userTimezoneOffset = date.getTimezoneOffset() * 60000
      const fechaCorrecta = new Date(date.getTime() + userTimezoneOffset)
      
      const dia = fechaCorrecta.getDate()
      const mes = fechaCorrecta.toLocaleString('es-ES', { month: 'short' }).toUpperCase().replace('.', '')
      const ano = fechaCorrecta.getFullYear()
      return { dia, mes, ano }
  }

  const renderBadge = (destino) => {
    const stylesBadge = {
        'Venta': { bg: '#dcfce7', color: '#166534', border: '#86efac' },
        'Consumo Interno': { bg: '#ffedd5', color: '#9a3412', border: '#fdba74' },
        'Mermas': { bg: '#fee2e2', color: '#991b1b', border: '#fca5a5' }
    }
    const config = stylesBadge[destino] || stylesBadge['Venta']
    return (
        <span style={{ 
            backgroundColor: config.bg, color: config.color, border: `1px solid ${config.border}`,
            padding: '2px 8px', borderRadius: '12px', fontSize: '0.7rem', fontWeight: 'bold', 
            textTransform: 'uppercase', letterSpacing: '0.5px'
        }}>
            {destino}
        </span>
    )
  }

  // Componente Tarjeta
  const CosechaCard = ({ c }) => {
      const totalDinero = (c.kilos || 0) * (c.precio_kilo || 0)
      const isExpanded = tarjetasExpandidas[c.id]
      const fechaObj = getFechaParts(c.fecha)

      return (
          <div style={styles.card}>
               <div style={styles.cardHeader}>
                  {/* CAJA FECHA AUMENTADA */}
                  <div style={styles.dateBox}>
                      <span style={styles.dayText}>{fechaObj.dia}</span>
                      <span style={styles.monthText}>{fechaObj.mes}</span>
                      <span style={styles.yearText}>{fechaObj.ano}</span>
                  </div>

                  <div style={styles.infoBox}>
                      <div style={styles.kilosRow}>
                          <Scale size={20} color="#374151"/>
                          <span style={styles.kilosBig}>{c.kilos ? c.kilos.toLocaleString('es-CL') : '0'}</span>
                          <span style={styles.unitText}>Kg</span>
                      </div>
                      <div style={styles.sectorRow}>
                          {c.sectores?.nombre || 'Sector Borrado'}
                          {!vistaAgrupada && <span style={{fontSize:'0.75rem', color:'#9ca3af', fontWeight:'normal', marginLeft:5}}>({c.sectores?.parcelas?.nombre})</span>}
                      </div>
                      {c.destino === 'Venta' && (
                          <div style={styles.clientRow}><User size={14}/> {c.clientes?.nombre || 'Sin Cliente'}</div>
                       )}
                  </div>

                  <div style={styles.actionBox}>
                      {renderBadge(c.destino)}
                      <div style={styles.actionButtons}>
                          <button onClick={() => abrirEditar(c.id)} style={styles.btnIcon} title="Editar"><Pencil size={18}/></button>
                          <button onClick={() => eliminar(c.id)} style={{...styles.btnIcon, color:'#ef4444'}} title="Eliminar"><Trash2 size={18}/></button>
                          <button onClick={() => toggleExpansion(c.id)} style={{...styles.btnIcon, color: isExpanded ? '#2563eb' : '#9ca3af', backgroundColor: isExpanded ? '#eff6ff' : 'transparent', borderRadius:'50%'}}>
                              {isExpanded ? <ChevronUp size={22}/> : <ChevronDown size={22}/>}
                          </button>
                      </div>
                  </div>
              </div>

              {isExpanded && (
                  <div style={styles.detailsContainer}>
                      {c.detalle_cosechas && c.detalle_cosechas.length > 0 ? (
                          <table style={styles.miniTable}>
                              <thead>
                                  <tr>
                                      <th style={styles.th}>Calibre</th>
                                      <th style={{...styles.th, textAlign:'right'}}>Cantidad</th>
                                      {c.destino === 'Venta' && <th style={{...styles.th, textAlign:'right'}}>Precio ($)</th>}
                                  </tr>
                              </thead>
                              <tbody>
                                  {c.detalle_cosechas.map((d, idx) => (
                                      <tr key={idx}>
                                          <td style={styles.td}>
                                              <div style={{display:'flex', alignItems:'center', gap:6}}>
                                                  <div style={{width:6, height:6, borderRadius:'50%', backgroundColor:'#16a34a'}}></div>
                                                  {d.calibre}
                                              </div>
                                          </td>
                                          <td style={{...styles.td, textAlign:'right', fontWeight:'500'}}>{d.kilos} Kg</td>
                                          {c.destino === 'Venta' && <td style={{...styles.td, textAlign:'right', color:'#16a34a'}}>{formatearDinero(d.precio_kilo)}</td>}
                                      </tr>
                                  ))}
                              </tbody>
                          </table>
                      ) : (
                          <div style={{fontSize:'0.8rem', fontStyle:'italic', color:'#9ca3af', padding:'15px 0', textAlign:'center'}}>
                              Sin detalle de calibres registrado.
                          </div>
                      )}
                      
                      {c.comentarios && (
                          <div style={{fontSize:'0.85rem', color:'#4b5563', marginTop:'15px', padding:'10px', backgroundColor:'#fff', borderRadius:'6px', border:'1px solid #e5e7eb', display:'flex', gap:8}}>
                              <span style={{fontWeight:'bold'}}>Nota:</span> {c.comentarios}
                          </div>
                      )}

                      {c.destino === 'Venta' && (
                          <div style={styles.moneyBlock}>
                                <span style={{fontSize:'0.9rem', color:'#6b7280', display:'flex', alignItems:'center', gap:5}}>
                                    Total Venta <ArrowRight size={14}/>
                                </span>
                              <span style={{fontWeight:'800', color:'#15803d', fontSize:'1.2rem'}}>{formatearDinero(totalDinero)}</span>
                          </div>
                      )}
                  </div>
              )}
          </div>
      )
  }

  const styles = {
    container: { width: '90%', maxWidth: '1400px', margin: '0 auto', padding: '10px 20px' },
    header: { display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom: '20px', flexWrap:'wrap', gap:15 },
    title: { fontSize: '1.5rem', fontWeight: 'bold', color: '#1f2937', display:'flex', alignItems:'center', gap:10, margin:0 },
    
    // BARRA DE CONTROLES
    controlsBar: { display: 'flex', gap: '15px', alignItems: 'center' },
    
    // Grupo de Botones (Toggle Group)
    controlGroup: { display:'flex', gap:1, backgroundColor:'white', border:'1px solid #d1d5db', borderRadius:8, overflow:'hidden' },
    
    // Estilo Bot√≥n Toggle
    btnToggle: (active) => ({
        padding:'8px 12px', border:'none', cursor:'pointer', display:'flex', alignItems:'center', gap:6, fontSize:'0.85rem',
        backgroundColor: active ? '#eff6ff' : 'white', color: active ? '#2563eb' : '#6b7280', fontWeight: active ? 'bold' : 'normal',
        transition: 'background-color 0.1s'
    }),

    // Etiqueta peque√±a para los grupos de botones
    groupLabel: { fontSize: '0.75rem', fontWeight:'bold', color:'#9ca3af', marginBottom:4, display:'block', textTransform:'uppercase' },

    selectControl: { padding: '8px', borderRadius: '8px', border: '1px solid #d1d5db', backgroundColor: 'white', color: '#374151', cursor: 'pointer', fontSize:'0.9rem' },
    btnNew: { border: 'none', cursor: 'pointer', backgroundColor: '#16a34a', color: 'white', padding: '8px 16px', borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '8px', fontWeight: 'bold', fontSize: '0.9rem' },
    
    parcelaSection: { marginBottom: '30px' },
    parcelaTitle: { fontSize: '1.1rem', fontWeight: 'bold', color: '#374151', borderBottom: '1px solid #e5e7eb', paddingBottom: '10px', marginBottom: '15px', display:'flex', alignItems:'center', gap:'8px' },
    
    grid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(380px, 1fr))', gap: '20px' },
    card: { backgroundColor: 'white', borderRadius: '12px', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', border: '1px solid #e5e7eb', overflow:'hidden', display:'flex', flexDirection:'column' },
    cardHeader: { padding: '0', backgroundColor: '#fff', display:'grid', gridTemplateColumns: '85px 1fr auto', minHeight: '90px' },
    
    // FECHA GRANDE
    dateBox: { 
        backgroundColor: '#f3f4f6', 
        borderRight: '1px solid #e5e7eb', 
        display: 'flex', 
        flexDirection: 'column', 
        justifyContent: 'center', 
        alignItems: 'center', 
        padding: '10px 5px',
        minWidth: '85px'
    },
    dayText: { fontSize: '1.8rem', fontWeight: '800', color: '#1f2937', lineHeight: 1 },
    monthText: { fontSize: '0.75rem', fontWeight: 'bold', color: '#6b7280', textTransform: 'uppercase', marginTop: 2 },
    yearText: { fontSize: '1.1rem', fontWeight: '800', color: '#9ca3af', marginTop: '4px' }, // A√ëO AUMENTADO

    infoBox: { padding: '15px', display: 'flex', flexDirection: 'column', justifyContent: 'center', gap: 4 },
    kilosRow: { display: 'flex', alignItems: 'baseline', gap: 8 },
    kilosBig: { fontSize: '1.6rem', fontWeight: '800', color: '#111827' },
    unitText: { fontSize: '0.9rem', color: '#6b7280', fontWeight: '500' },
    sectorRow: { display: 'flex', alignItems: 'center', gap: 6, fontSize: '0.95rem', fontWeight: '600', color: '#16a34a' },
    clientRow: { display: 'flex', alignItems: 'center', gap: 6, fontSize: '0.85rem', color: '#4b5563', marginTop: 4 },

    actionBox: { padding: '15px', display: 'flex', flexDirection: 'column', justifyContent: 'space-between', alignItems: 'flex-end' },
    actionButtons: { display: 'flex', gap: 8 },
    btnIcon: { background:'none', border:'none', cursor:'pointer', color:'#9ca3af', padding:'4px', display:'flex', alignItems:'center' },
    
    detailsContainer: { padding: '0 20px 20px 20px', backgroundColor: '#fafafa', borderTop:'1px dashed #e5e7eb' },
    miniTable: { width: '100%', fontSize: '0.85rem', borderCollapse: 'collapse', marginTop:15 },
    td: { padding: '8px 0', borderBottom: '1px solid #e5e7eb', color: '#374151' },
    th: { padding: '8px 0', textAlign: 'left', fontWeight: 'bold', color: '#9ca3af', borderBottom: '1px solid #d1d5db', fontSize:'0.75rem', textTransform:'uppercase' },
    moneyBlock: { marginTop: '15px', paddingTop: '10px', display:'flex', justifyContent:'space-between', alignItems:'center', borderTop: '2px solid #e5e7eb' },
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><Sprout color="#16a34a" size={28} /> Cosechas</h1>

        <div style={styles.controlsBar}>
            {/* GRUPO 1: VISTA */}
            <div>
                <span style={styles.groupLabel}>Vista</span>
                <div style={styles.controlGroup}>
                    <button onClick={() => setVistaAgrupada(true)} style={styles.btnToggle(vistaAgrupada)} title="Agrupar por Parcela">
                        <Layers size={16}/> Agrupado
                    </button>
                    <button onClick={() => setVistaAgrupada(false)} style={styles.btnToggle(!vistaAgrupada)} title="Lista Cronol√≥gica">
                        <List size={16}/> Lista
                    </button>
                </div>
            </div>

            {/* GRUPO 2: ORDENAMIENTO (NUEVO DISE√ëO CON BOTONES) */}
            <div>
                <span style={styles.groupLabel}>Ordenar por</span>
                <div style={styles.controlGroup}>
                    {/* BOT√ìN FECHA (ALTERNABLE) */}
                    <button 
                        onClick={toggleOrdenFecha} 
                        style={styles.btnToggle(orden.includes('fecha'))} 
                        title={orden === 'fecha_asc' ? "M√°s antiguos primero" : "M√°s recientes primero"}
                    >
                        <Calendar size={16}/> 
                        {orden === 'fecha_asc' ? <ArrowUp size={14}/> : <ArrowDown size={14}/>}
                        Fecha
                    </button>

                    {/* BOT√ìN SECTOR */}
                    <button 
                        onClick={() => setOrden('sector')} 
                        style={styles.btnToggle(orden === 'sector')} 
                        title="Ordenar alfab√©ticamente por Sector"
                    >
                        <ArrowUpDown size={16}/> Sector
                    </button>
                </div>
            </div>

            {/* FILTRO A√ëO */}
            <div>
                <span style={styles.groupLabel}>Filtro</span>
                <select 
                    style={styles.selectControl} 
                    value={anioSeleccionado} 
                    onChange={(e) => setAnioSeleccionado(e.target.value)}
                >
                    <option value="">A√±o: Todos</option>
                    {aniosDisponibles.map(a => <option key={a} value={a}>{a}</option>)}
                </select>
            </div>
            
            <div style={{marginTop: 15}}> {/* Alineaci√≥n con botones */}
                <button onClick={abrirCrear} style={styles.btnNew}>
                    <Plus size={18} /> Nueva
                </button>
            </div>
        </div>
      </div>

      {loading && <div style={{padding:'20px', color:'#9ca3af'}}>Cargando registros...</div>}

      {!loading && dataProcesada.length === 0 && Object.keys(gruposCosechas).length === 0 && (
          <div style={{textAlign:'center', padding:'40px', color:'#9ca3af', border:'2px dashed #e5e7eb', borderRadius:'12px', backgroundColor:'#f9fafb'}}>
              No hay cosechas registradas con estos filtros.
          </div>
      )}

      {/* VISTA 1: AGRUPADA POR PARCELA */}
      {!loading && vistaAgrupada && Object.keys(gruposCosechas).sort().map(parcela => (
          <div key={parcela} style={styles.parcelaSection}>
              <h3 style={styles.parcelaTitle}><MapPin size={18} color="#16a34a"/> {parcela}</h3>
              <div style={styles.grid}>
                 {gruposCosechas[parcela].map(c => <CosechaCard key={c.id} c={c} />)}
              </div>
          </div>
      ))}

      {/* VISTA 2: LISTA PLANA (CRONOL√ìGICA) */}
      {!loading && !vistaAgrupada && (
          <div style={styles.grid}>
              {dataProcesada.map(c => <CosechaCard key={c.id} c={c} />)}
          </div>
      )}

      <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title={editarId ? "Editar Cosecha" : "Registrar Nueva Cosecha"}>
        {modalOpen && <NuevaCosecha idCosecha={editarId} cerrarModal={() => setModalOpen(false)} alGuardar={handleGuardado} />}
      </Modal>
    </div>
  )
}
export default Cosechas

================================================================================
ARCHIVO: src/pages/Labores.jsx
================================================================================

import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { 
  Shovel, Plus, Trash2, Pencil, ArrowUpDown, Filter, Map, User,
  Droplets, TestTube, Scissors, Leaf, Hammer, ClipboardList, Package, CircleDot, LayoutGrid, Calendar
} from 'lucide-react'
import Modal from '../components/Modal'
import NuevaLabor from './NuevaLabor'

// Iconos visuales
const ICONOS_VISUALES = {
  'Riego': <Droplets size={18} color="#3b82f6"/>,
  'Fertilizaci√≥n': <TestTube size={18} color="#8b5cf6"/>,
  'Poda': <Scissors size={18} color="#f59e0b"/>,
  'Anillado': <CircleDot size={18} color="#d97706"/>,
  'Fitosanitario': <Leaf size={18} color="#ef4444"/>,
  'Mantenimiento': <Hammer size={18} color="#6b7280"/>,
  'Limpieza': <Leaf size={18} color="#10b981"/>,
  'Otros': <ClipboardList size={18} color="#9ca3af"/>
}

// Diccionario Texto
const EMOJIS_TIPO = {
  'Riego': 'üíß Riego',
  'Fertilizaci√≥n': 'üß™ Fertilizaci√≥n',
  'Poda': '‚úÇÔ∏è Poda',
  'Anillado': '‚≠ï Anillado',
  'Fitosanitario': 'üíä Fitosanitario',
  'Mantenimiento': 'üõ†Ô∏è Mantenimiento',
  'Limpieza': 'üßπ Limpieza',
  'Otros': 'üìã Otros'
}

function Labores() {
  const [labores, setLabores] = useState([])
  const [loading, setLoading] = useState(true)
  
  // Listas filtros y Maestros
  const [listaParcelas, setListaParcelas] = useState([])
  const [listaSectores, setListaSectores] = useState([]) 
  const [listaProveedores, setListaProveedores] = useState([])
  const [aniosDisponibles, setAniosDisponibles] = useState([])
  
  // Mapas
  const [mapaSectores, setMapaSectores] = useState({})
  const [mapaParcelas, setMapaParcelas] = useState({})

  // Estado Filtros
  const [filtros, setFiltros] = useState({
      anio: new Date().getFullYear().toString(),
      tipo: 'Todos',
      parcela: 'Todos',
      sector: 'Todos',
      proveedor: 'Todos',
      mes: 'Todos'
  })

  const [sortConfig, setSortConfig] = useState({ key: 'fecha', direction: 'desc' })
  const [modalOpen, setModalOpen] = useState(false)
  const [editId, setEditId] = useState(null)

  const fmtMoney = (m) => '$ ' + Math.round(m).toLocaleString('es-CL')
  const fmtFecha = (f) => f ? f.split('-').reverse().join('/') : ''

  useEffect(() => { cargarDatos() }, [])

  async function cargarDatos() {
    setLoading(true)
    
    // 1. Cargar Maestros
    const { data: parc } = await supabase.from('parcelas').select('id, nombre').eq('activo', true).order('nombre')
    const { data: sect } = await supabase.from('sectores').select('id, nombre, parcela_id').eq('activo', true).order('nombre')
    const { data: prov } = await supabase.from('proveedores').select('id, nombre').eq('activo', true).order('nombre')
    
    setListaParcelas(parc || [])
    setListaSectores(sect || [])
    setListaProveedores(prov || [])

    // Mapas
    const mapSec = {}; (sect || []).forEach(s => mapSec[s.id] = s)
    setMapaSectores(mapSec)
    const mapPar = {}; (parc || []).forEach(p => mapPar[p.id] = p.nombre)
    setMapaParcelas(mapPar)

    // 2. Cargar Labores
    const { data, error } = await supabase
        .from('labores')
        .select(`*, proveedores ( nombre )`)
        .order('fecha', { ascending: false })
    
    if (error) console.error("Error al cargar:", error)
    else {
        setLabores(data || [])
        // Extraer a√±os √∫nicos para el filtro
        const years = [...new Set((data || []).map(l => l.fecha.substring(0, 4)))].sort((a,b) => b - a)
        setAniosDisponibles(years)
    }

    setLoading(false)
  }

  const eliminar = async (id) => {
      if(confirm("¬øEliminar esta labor?")) {
          await supabase.from('labores').delete().eq('id', id)
          cargarDatos()
      }
  }

  const handleSort = (key) => {
      setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc' }))
  }

  const getDataProcesada = () => {
      let data = labores.filter(l => {
          if (filtros.anio !== 'Todos') {
              const anioLabor = l.fecha.substring(0, 4)
              if (anioLabor !== filtros.anio) return false
          }
          if (filtros.tipo !== 'Todos' && l.tipo_labor !== filtros.tipo) return false
          
          if (filtros.parcela !== 'Todos') {
              const ids = l.sectores_ids || []
              const pertenece = ids.some(id => mapaSectores[id]?.parcela_id.toString() === filtros.parcela)
              if (!pertenece) return false
          }

          if (filtros.sector !== 'Todos') {
               const ids = l.sectores_ids || []
               if (!ids.includes(parseInt(filtros.sector))) return false
          }

          if (filtros.proveedor !== 'Todos') {
              if (filtros.proveedor === 'Interno') {
                  if (l.proveedor_id) return false 
              } else {
                  if (!l.proveedor_id || l.proveedor_id.toString() !== filtros.proveedor) return false
              }
          }

          if (filtros.mes !== 'Todos') {
              const mesLabor = new Date(l.fecha).getMonth() + 1
              if (mesLabor.toString() !== filtros.mes) return false
          }
          return true
      })

      return data.sort((a, b) => {
          let valA = a[sortConfig.key]
          let valB = b[sortConfig.key]
          
          if (sortConfig.key === 'costo_total') {
             valA = Number(valA); valB = Number(valB);
          }

          if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1
          if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1
          return 0
      })
  }

  const dataFinal = getDataProcesada()

  const styles = {
    container: { width: '95%', maxWidth: '1600px', margin: '0 auto', padding: '20px 0' },
    header: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 },
    title: { fontSize: '1.5rem', fontWeight: 'bold', color: '#111827', display:'flex', alignItems:'center', gap:10 },
    
    filterBar: { display: 'flex', gap: 12, alignItems: 'center', marginBottom: 20, flexWrap:'wrap', backgroundColor: '#f9fafb', padding: '15px', borderRadius: '12px', border: '1px solid #e5e7eb' },
    labelFilter: { fontSize: '0.85rem', fontWeight: 'bold', color: '#4b5563', marginRight: 5, display:'flex', alignItems:'center', gap:5 },
    selectControl: { padding: '8px', borderRadius: 6, border: '1px solid #d1d5db', fontSize: '0.9rem', color: '#374151', minWidth: 120 },

    tableContainer: { backgroundColor: 'white', borderRadius: 10, border: '1px solid #e5e7eb', overflow: 'hidden' },
    table: { width: '100%', borderCollapse: 'collapse', fontSize: '0.9rem', tableLayout: 'fixed' }, 
    
    th: { textAlign: 'left', padding: '12px 15px', borderBottom: '1px solid #e5e7eb', color: '#6b7280', fontSize: '0.75rem', textTransform: 'uppercase', fontWeight: 600, cursor:'pointer' },
    thRight: { textAlign: 'right', padding: '12px 15px', borderBottom: '1px solid #e5e7eb', color: '#6b7280', fontSize: '0.75rem', textTransform: 'uppercase', fontWeight: 600, cursor:'pointer' },
    
    td: { padding: '10px 15px', borderBottom: '1px solid #f3f4f6', color: '#374151', verticalAlign:'middle', overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap' },
    tdRight: { padding: '10px 15px', borderBottom: '1px solid #f3f4f6', color: '#374151', verticalAlign:'middle', textAlign:'right', overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap' },
    
    insumoChip: { fontSize:'0.8rem', color:'#4b5563', display:'block', marginBottom: 2 }, 
    sectorsCell: { whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', maxWidth: '100%', display: 'block' }
  }

  const ThSort = ({ k, label, align = 'left', width }) => (
      <th style={{...(align === 'right' ? styles.thRight : styles.th), width}} onClick={() => handleSort(k)}>
          <div style={{display:'flex', alignItems:'center', justifyContent: align === 'right' ? 'flex-end' : 'flex-start', gap:5}}>
              {label} {sortConfig.key === k && <ArrowUpDown size={14}/>}
          </div>
      </th>
  )

  return (
    <div style={styles.container}>
      <div style={styles.header}>
         <h1 style={styles.title}><Shovel size={28}/> Registro de Labores</h1>
         <button onClick={() => { setEditId(null); setModalOpen(true) }} style={{ backgroundColor:'#1f2937', color:'white', border:'none', padding:'10px 20px', borderRadius:'8px', fontWeight:'bold', cursor:'pointer', display:'flex', alignItems:'center', gap:8 }}>
            <Plus size={18} /> Registrar Labor
         </button>
      </div>

      <div style={styles.filterBar}>
          <div>
              <span style={styles.labelFilter}><Calendar size={14}/> A√±o:</span>
              <select value={filtros.anio} onChange={e => setFiltros({...filtros, anio: e.target.value})} style={styles.selectControl}>
                  <option value="Todos">Todos</option>
                  {aniosDisponibles.map(a => <option key={a} value={a}>{a}</option>)}
              </select>
          </div>
          <div>
              <span style={styles.labelFilter}>Mes:</span>
              <select value={filtros.mes} onChange={e => setFiltros({...filtros, mes: e.target.value})} style={styles.selectControl}>
                  <option value="Todos">Todos</option>
                  {['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'].map((mes, i) => (
                      <option key={i} value={(i+1).toString()}>{i+1} - {mes}</option>
                  ))}
              </select>
          </div>
          <div>
              <span style={styles.labelFilter}><Filter size={14}/> Tipo:</span>
              <select value={filtros.tipo} onChange={e => setFiltros({...filtros, tipo: e.target.value})} style={styles.selectControl}>
                  <option value="Todos">Todos</option>
                  {Object.keys(EMOJIS_TIPO).map(key => <option key={key} value={key}>{EMOJIS_TIPO[key]}</option>)}
              </select>
          </div>
          <div>
              <span style={styles.labelFilter}><Map size={14}/> Parcela:</span>
              <select value={filtros.parcela} onChange={e => setFiltros({...filtros, parcela: e.target.value})} style={styles.selectControl}>
                  <option value="Todos">Todas</option>
                  {listaParcelas.map(p => <option key={p.id} value={p.id.toString()}>{p.nombre}</option>)}
              </select>
          </div>
          <div>
              <span style={styles.labelFilter}><LayoutGrid size={14}/> Sector:</span>
              <select value={filtros.sector} onChange={e => setFiltros({...filtros, sector: e.target.value})} style={styles.selectControl}>
                  <option value="Todos">Todos</option>
                  {listaSectores.filter(s => filtros.parcela === 'Todos' || s.parcela_id.toString() === filtros.parcela).map(s => (
                      <option key={s.id} value={s.id.toString()}>{s.nombre}</option>
                  ))}
              </select>
          </div>
          <div>
              <span style={styles.labelFilter}><User size={14}/> Proveedor:</span>
              <select value={filtros.proveedor} onChange={e => setFiltros({...filtros, proveedor: e.target.value})} style={styles.selectControl}>
                  <option value="Todos">Todos</option>
                  <option value="Interno">Interno</option>
                  {listaProveedores.map(p => <option key={p.id} value={p.id.toString()}>{p.nombre}</option>)}
              </select>
          </div>
          <div style={{marginLeft:'auto', fontSize:'0.85rem', color:'#6b7280'}}>
              Registros: <strong>{dataFinal.length}</strong>
          </div>
      </div>

      <div style={styles.tableContainer}>
          <table style={styles.table}>
              <colgroup>
                  <col style={{width: '110px'}} />
                  <col style={{width: '14%'}} />
                  <col style={{width: '14%'}} />
                  <col style={{width: '20%'}} />
                  <col style={{width: '130px'}} />
                  <col style={{width: '22%'}} />
                  <col style={{width: '140px'}} />
                  <col style={{width: '80px'}} />
              </colgroup>
              <thead>
                  <tr>
                      <ThSort label="Fecha" k="fecha"/>
                      <ThSort label="Labor" k="tipo_labor"/>
                      <th style={styles.th}>Parcela</th>
                      <th style={styles.th}>Sectores</th>
                      <ThSort label="Proveedor" k="proveedor"/>
                      <th style={styles.th}>Insumos Usados</th>
                      <ThSort label="Total" k="costo_total" align="right"/>
                      <th style={styles.th}></th>
                  </tr>
              </thead>
              <tbody>
                  {dataFinal.map(l => {
                      const ids = l.sectores_ids || []
                      const listaSectoresTxt = ids.map(id => mapaSectores[id]?.nombre || 'S?').join(', ')
                      const parcelasIds = [...new Set(ids.map(id => mapaSectores[id]?.parcela_id).filter(Boolean))]
                      let textoParcela = '-'
                      if (parcelasIds.length === 1) textoParcela = mapaParcelas[parcelasIds[0]] || '?'
                      else if (parcelasIds.length > 1) textoParcela = 'Varias / Mix'

                      return (
                          <tr key={l.id}>
                              <td style={styles.td}>{fmtFecha(l.fecha)}</td>
                              <td style={styles.td}>
                                  <div style={{display:'flex', alignItems:'center', gap:8, fontWeight:'600'}}>
                                      {ICONOS_VISUALES[l.tipo_labor]} {l.tipo_labor}
                                  </div>
                              </td>
                              <td style={styles.td}><span style={{fontWeight:'bold', color:'#4b5563'}}>{textoParcela}</span></td>
                              <td style={styles.td} title={listaSectoresTxt}><span style={styles.sectorsCell}>{listaSectoresTxt}</span></td>
                              <td style={styles.td}>
                                  {l.proveedores ? (
                                     <span style={{display:'flex', alignItems:'center', gap:5}}><User size={14} color="#6b7280"/> {l.proveedores.nombre}</span>
                                  ) : <span style={{color:'#9ca3af'}}>Interno</span>}
                              </td>
                              <td style={styles.td}>
                                  {l.detalles_insumos?.length > 0 ? (
                                      l.detalles_insumos.slice(0,3).map((i, idx) => (
                                          <span key={idx} style={styles.insumoChip}>
                                              <Package size={10} style={{display:'inline', marginRight:4}}/> 
                                              {i.nombre} <strong>({i.cantidad} {i.unidad})</strong>
                                          </span>
                                      ))
                                  ) : <span style={{color:'#d1d5db'}}>-</span>}
                              </td>
                              <td style={{...styles.tdRight, fontWeight:'bold', fontFamily:'monospace', fontSize:'1rem'}}>
                                  {fmtMoney(l.costo_total)}
                              </td>
                              <td style={styles.td}>
                                  <div style={{display:'flex', gap:5, justifyContent:'flex-end'}}>
                                      <button onClick={() => { setEditId(l.id); setModalOpen(true) }} style={{border:'none', background:'none', color:'#2563eb', cursor:'pointer'}}><Pencil size={16}/></button>
                                      <button onClick={() => eliminar(l.id)} style={{border:'none', background:'none', color:'#ef4444', cursor:'pointer'}}><Trash2 size={16}/></button>
                                  </div>
                              </td>
                          </tr>
                      )
                  })}
              </tbody>
          </table>
      </div>

      <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title={editId ? "Editar Labor" : "Registrar Labor"}>
         {modalOpen && <NuevaLabor idLabor={editId} cerrarModal={() => setModalOpen(false)} alGuardar={() => { setModalOpen(false); cargarDatos() }} />}
      </Modal>
    </div>
  )
}

export default Labores

================================================================================
ARCHIVO: src/pages/Riego.jsx
================================================================================

import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Droplets, Clock, Settings, PlayCircle, History, TreeDeciduous, ShowerHead } from 'lucide-react'
import Modal from '../components/Modal'
import NuevoPrograma from './NuevoPrograma'

// Helper para moneda (por si se usa en el futuro o en otras partes)
const formatMoney = (amount) => {
  return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(amount)
}

// Helper para n√∫meros con miles (Chile)
const formatNumber = (num) => {
    if (num === undefined || num === null) return '--'
    return new Intl.NumberFormat('es-CL').format(Math.round(num))
}

function Riego() {
  const [loading, setLoading] = useState(true)
  const [activeTab, setActiveTab] = useState('activos')

  // DATA
  const [sectoresAgrupados, setSectoresAgrupados] = useState({})
  const [historialProgramas, setHistorialProgramas] = useState([])
  
  // FILTROS HISTORIAL
  const [anioFiltro, setAnioFiltro] = useState('') 
  const [orden, setOrden] = useState({ campo: 'fecha_creacion', asc: false })

  // MODAL
  const [modalOpen, setModalOpen] = useState(false)
  const [sectorIdParaEditar, setSectorIdParaEditar] = useState(null)

  useEffect(() => { cargarDatos() }, [])
  useEffect(() => { if (activeTab === 'historial') cargarHistorial() }, [activeTab, anioFiltro])

  async function cargarDatos() {
    setLoading(true)
    try {
        const { data: sectoresBD } = await supabase
            .from('sectores')
            .select(`*, parcelas ( nombre )`)
            .order('nombre')
        
        const { data: programasActivos } = await supabase
            .from('programas_riego')
            .select('*')
            .neq('estado', 'Finalizado')

        const sectoresProcesados = sectoresBD.map(s => {
            const miPrograma = programasActivos?.find(p => {
                 if (p.sector_id && Number(p.sector_id) === Number(s.id)) return true;
                 if (p.sectores_ids && Array.isArray(p.sectores_ids) && p.sectores_ids.includes(s.id)) return true;
                 return false;
            })

            const caudalAspersor = s.caudal_lph || 0
            const numAspersores = s.cantidad_aspersores || 0
            const caudalTotalLph = caudalAspersor * numAspersores
            
            let litrosSemana = 0
            if (miPrograma && miPrograma.turnos && caudalTotalLph > 0) {
                let minutosSemana = 0
                const dias = miPrograma.dias?.length || 0
                const misTurnos = miPrograma.turnos.filter(t => !t.sector_id || Number(t.sector_id) === Number(s.id))
                misTurnos.forEach(t => { minutosSemana += (parseInt(t.duracion) || 0) * dias })
                litrosSemana = (caudalTotalLph / 60) * minutosSemana
            }

            return { ...s, programa: miPrograma, caudalTotalLph, litrosSemana }
        })

        const agrupados = sectoresProcesados.reduce((acc, sector) => {
            const nombreParcela = sector.parcelas?.nombre || 'Sin Parcela Asignada'
            if (!acc[nombreParcela]) acc[nombreParcela] = []
            acc[nombreParcela].push(sector)
            return acc
        }, {})

        setSectoresAgrupados(agrupados)
    } catch (err) { console.error(err) } finally { setLoading(false) }
  }

  async function cargarHistorial() {
      let query = supabase
          .from('programas_riego')
          .select(`*, sectores ( nombre, caudal_lph, cantidad_aspersores, parcelas (nombre) )`)
          .eq('estado', 'Finalizado')
      
      if (anioFiltro) {
          const inicioAnio = `${anioFiltro}-01-01`
          const finAnio = `${anioFiltro}-12-31`
          query = query.gte('fecha_creacion', inicioAnio).lte('fecha_creacion', finAnio)
      }

      const { data, error } = await query
      if (error) console.error(error)
      else setHistorialProgramas(data)
  }

  const handleSort = (campo) => {
      const isAsc = orden.campo === campo ? !orden.asc : true
      setOrden({ campo, asc: isAsc })
      const sorted = [...historialProgramas].sort((a, b) => {
          let valA = a[campo]; let valB = b[campo];
          if (campo === 'sector_id') { valA = a.sectores?.nombre; valB = b.sectores?.nombre }
          
          if (valA < valB) return isAsc ? -1 : 1
          if (valA > valB) return isAsc ? 1 : -1
          return 0
      })
      setHistorialProgramas(sorted)
  }

  const configurarSector = (idSector) => {
      setSectorIdParaEditar(idSector)
      setModalOpen(true)
  }

  const calcularVolumenTurno = (duracionMin, caudalTotalLph) => {
      if (!duracionMin || !caudalTotalLph) return '--'
      const m3 = (caudalTotalLph / 60 * duracionMin) / 1000
      return `${new Intl.NumberFormat('es-CL', { minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(m3)} m¬≥`
  }

  const styles = {
    container: { width: '90%', maxWidth: '1400px', margin: '0 auto', padding: '10px 20px' },
    
    header: { display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom: '20px', height: '50px' },
    title: { fontSize: '1.5rem', fontWeight: 'bold', color: '#1f2937', display:'flex', alignItems:'center', gap:10, margin:0 },
    
    tabsContainer: { display:'flex', gap:5, backgroundColor:'#f3f4f6', padding:4, borderRadius:8 },
    tab: (active) => ({
        padding:'6px 16px', cursor:'pointer', borderRadius:6,
        backgroundColor: active ? 'white' : 'transparent',
        color: active ? '#2563eb' : '#6b7280', 
        fontWeight: active ? 'bold' : 'normal', display:'flex', gap:6, alignItems:'center',
        boxShadow: active ? '0 1px 2px rgba(0,0,0,0.1)' : 'none',
        fontSize: '0.9rem', transition: 'all 0.2s'
    }),

    // CARDS
    parcelaSection: { marginBottom: 30 },
    parcelaTitle: { fontSize:'1.1rem', fontWeight:'bold', color:'#4b5563', marginBottom:10, borderLeft:'4px solid #10b981', paddingLeft:10 },
    grid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(340px, 1fr))', gap: '15px' },
    
    card: { backgroundColor: 'white', borderRadius: '12px', padding: '15px', border: '1px solid #e5e7eb', boxShadow: '0 2px 4px rgba(0,0,0,0.02)' },
    cardHeader: { display:'flex', justifyContent:'space-between', alignItems:'flex-start', marginBottom:10 },
    sectorName: { fontSize:'1.1rem', fontWeight:'bold', color:'#374151' },
    activeBadge: { backgroundColor:'#dcfce7', color:'#166534', padding:'2px 8px', borderRadius:'12px', fontSize:'0.7rem', fontWeight:'bold', display:'flex', alignItems:'center', gap:4 },
    inactiveBadge: { backgroundColor:'#f3f4f6', color:'#6b7280', padding:'2px 8px', borderRadius:'12px', fontSize:'0.7rem', fontWeight:'bold' },
    
    metaInfo: { display:'flex', gap:15, fontSize:'0.8rem', color:'#64748b', marginBottom:10 },
    metrics: { display:'grid', gridTemplateColumns:'1fr 1fr', gap:10, backgroundColor:'#f8fafc', padding:8, borderRadius:6, margin:'10px 0' },
    metricItem: { display:'flex', flexDirection:'column' },
    metricLabel: { fontSize:'0.7rem', color:'#64748b' },
    metricValue: { fontSize:'0.85rem', fontWeight:'bold', color:'#334155' },

    schedule: { marginTop:10, borderTop:'1px dashed #e2e8f0', paddingTop:8 },
    turnRow: { display:'flex', justifyContent:'space-between', alignItems:'center', fontSize:'0.85rem', marginBottom:6, color:'#475569', backgroundColor:'#f9fafb', padding:'4px 8px', borderRadius:4 },
    btnConfig: { width:'100%', marginTop:10, padding:'8px', backgroundColor:'#2563eb', color:'white', border:'none', borderRadius:'6px', cursor:'pointer', fontWeight:'500', display:'flex', alignItems:'center', justifyContent:'center', gap:6, fontSize:'0.9rem' },

    // HISTORIAL TABLE (Compacta y Reordenada)
    // Orden: Fecha | Parcela | Sector | D√≠as | Caudal Req | Riego Est. | Vigencia | Turnos
    tableContainer: { backgroundColor:'white', borderRadius:12, border:'1px solid #e5e7eb', overflow:'hidden', marginTop:10 },
    tableHeader: { backgroundColor:'#f9fafb', padding:'10px', fontWeight:'bold', display:'grid', gridTemplateColumns:'0.9fr 0.8fr 0.8fr 1.2fr 0.7fr 0.7fr 1.1fr 1fr', cursor:'pointer', fontSize:'0.8rem', color:'#4b5563', gap:'10px' },
    tableRow: { padding:'10px', display:'grid', gridTemplateColumns:'0.9fr 0.8fr 0.8fr 1.2fr 0.7fr 0.7fr 1.1fr 1fr', borderTop:'1px solid #f3f4f6', fontSize:'0.8rem', color:'#374151', alignItems:'center', gap:'10px' },
    filters: { display:'flex', gap:10, marginBottom:15, alignItems:'center', justifyContent:'flex-end' },
    select: { padding:'6px', borderRadius:6, border:'1px solid #d1d5db' }
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><Droplets color="#3b82f6" size={28}/> Control de Riego</h1>
        
        <div style={styles.tabsContainer}>
            <div style={styles.tab(activeTab === 'activos')} onClick={() => setActiveTab('activos')}>
                <PlayCircle size={16}/> Programaci√≥n Activa
            </div>
            <div style={styles.tab(activeTab === 'historial')} onClick={() => setActiveTab('historial')}>
                <History size={16}/> Historial
            </div>
        </div>
      </div>

      {activeTab === 'activos' && (
          loading ? <div>Cargando...</div> : (
            <div>
                {Object.keys(sectoresAgrupados).length === 0 && <div style={{color:'#6b7280'}}>No hay sectores configurados.</div>}
                
                {Object.entries(sectoresAgrupados).map(([parcela, sectoresParcela]) => (
                    <div key={parcela} style={styles.parcelaSection}>
                        <div style={styles.parcelaTitle}>{parcela}</div>
                        
                        <div style={styles.grid}>
                            {sectoresParcela.map(s => (
                                <div key={s.id} style={styles.card}>
                                    <div style={styles.cardHeader}>
                                        <div style={styles.sectorName}>{s.nombre}</div>
                                        {s.programa ? (
                                            <span style={styles.activeBadge}><PlayCircle size={10}/> ACTIVO</span>
                                        ) : (
                                            <span style={styles.inactiveBadge}>DETENIDO</span>
                                        )}
                                    </div>

                                    <div style={styles.metaInfo}>
                                        <span title="Cantidad de √Årboles"><TreeDeciduous size={14}/> {formatNumber(s.cantidad_arboles)}</span>
                                        <span title="Total Aspersores"><ShowerHead size={14}/> {formatNumber(s.cantidad_aspersores)}</span>
                                    </div>

                                    <div style={styles.metrics}>
                                        <div style={styles.metricItem}>
                                            <span style={styles.metricLabel}>Caudal Sector</span>
                                            <span style={styles.metricValue}>
                                                {s.caudalTotalLph > 0 ? `${formatNumber(s.caudalTotalLph/1000)} m¬≥/h` : '--'}
                                            </span>
                                        </div>
                                        <div style={styles.metricItem}>
                                            <span style={styles.metricLabel}>Semanal (Est.)</span>
                                            <span style={styles.metricValue}>
                                                {s.litrosSemana > 0 ? `${formatNumber(s.litrosSemana/1000)} m¬≥` : '--'}
                                            </span>
                                        </div>
                                    </div>

                                    <div style={styles.schedule}>
                                        {s.programa ? (
                                            <>
                                                <div style={{fontSize:'0.8rem', fontWeight:'bold', marginBottom:8, color:'#3b82f6'}}>
                                                    {s.programa.dias?.map(d => d.slice(0,3)).join(', ')}
                                                </div>
                                                {s.programa.turnos?.map((t, i) => (
                                                    <div key={i} style={styles.turnRow}>
                                                        <span style={{flex:1}}><Clock size={12} style={{marginRight:4}}/> Turno {i+1}</span>
                                                        <span style={{flex:1, textAlign:'center', fontWeight:'bold', color:'#059669', fontSize:'0.8rem'}}>
                                                            {calcularVolumenTurno(t.duracion, s.caudalTotalLph)}
                                                        </span>
                                                        <span style={{flex:1, textAlign:'right', fontWeight:'bold'}}>
                                                            {t.hora} ({t.duracion}')
                                                        </span>
                                                    </div>
                                                ))}
                                            </>
                                        ) : (
                                            <div style={{textAlign:'center', padding:5, color:'#9ca3af', fontSize:'0.8rem', fontStyle:'italic'}}>
                                                Sin programaci√≥n
                                            </div>
                                        )}
                                    </div>

                                    <button onClick={() => configurarSector(s.id)} style={styles.btnConfig}>
                                        <Settings size={14}/> Configurar
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                ))}
            </div>
          )
      )}

      {activeTab === 'historial' && (
          <div>
            <div style={styles.filters}>
                <label style={{fontSize:'0.85rem', color:'#4b5563'}}>Filtrar A√±o:</label>
                <select 
                    value={anioFiltro} 
                    onChange={(e) => setAnioFiltro(e.target.value)}
                    style={styles.select}
                >
                    <option value="">Todos</option>
                    {[2024, 2025, 2026, 2027].map(y => <option key={y} value={y}>{y}</option>)}
                </select>
            </div>

            <div style={styles.tableContainer}>
                <div style={styles.tableHeader}>
                    <div onClick={() => handleSort('fecha_creacion')}>Fecha</div>
                    <div onClick={() => handleSort('parcela_id')}>Parcela</div>
                    <div onClick={() => handleSort('sector_id')}>Sector</div>
                    <div>D√≠as</div>
                    <div>Caudal Req.</div>
                    <div>Riego Est.</div>
                    <div>Vigencia</div>
                    <div>Turnos</div>
                </div>
                {historialProgramas.length === 0 ? (
                     <div style={{padding:20, textAlign:'center', color:'#6b7280'}}>No hay registros hist√≥ricos.</div>
                ) : (
                    historialProgramas.map(prog => {
                        const caudalSectorLph = (prog.sectores?.caudal_lph || 0) * (prog.sectores?.cantidad_aspersores || 0);
                        const caudalSectorM3 = caudalSectorLph / 1000;
                        
                        // Calculo promedio de riego por turno (asumiendo duracion similar o promedio para la tabla)
                        const duracionPromedio = prog.turnos?.length > 0 
                            ? prog.turnos.reduce((acc, t) => acc + parseInt(t.duracion||0), 0) / prog.turnos.length 
                            : 0;
                        const riegoEstTurnoM3 = (caudalSectorLph / 60 * duracionPromedio) / 1000;

                        return (
                        <div key={prog.id} style={styles.tableRow}>
                            <div>
                                <strong>{new Date(prog.fecha_creacion).toLocaleDateString()}</strong>
                                <div style={{fontSize:'0.7rem', color:'#9ca3af'}}>
                                    {new Date(prog.fecha_creacion).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false})}
                                </div>
                            </div>
                            <div>{prog.sectores?.parcelas?.nombre}</div>
                            <div><strong>{prog.sectores?.nombre}</strong></div>
                            
                            {/* D√≠as al centro y compactos */}
                            <div style={{fontSize:'0.75rem', lineHeight:'1.2'}}>
                                {prog.dias?.map(d => d.slice(0,3)).join(', ')}
                            </div>

                            <div>{caudalSectorM3 > 0 ? `${formatNumber(caudalSectorM3)} m¬≥/h` : '-'}</div>
                            
                            {/* Nueva Columna Estimaci√≥n */}
                            <div style={{color:'#059669', fontWeight:'bold'}}>
                                {riegoEstTurnoM3 > 0 ? `~${formatNumber(riegoEstTurnoM3)} m¬≥` : '-'}
                            </div>

                            <div>
                                <span style={{fontSize:'0.75rem', display:'block'}}>In: {new Date(prog.fecha_inicio).toLocaleDateString()}</span>
                                <span style={{fontSize:'0.75rem', display:'block'}}>Out: {new Date(prog.fecha_fin).toLocaleDateString()}</span>
                            </div>
                            
                            <div>
                                {prog.turnos?.map((t, i) => (
                                    <div key={i} style={{fontSize:'0.75rem', whiteSpace:'nowrap'}}>
                                        {t.hora} ({t.duracion}')
                                    </div>
                                ))}
                            </div>
                        </div>
                    )})
                )}
            </div>
          </div>
      )}

      <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title="Configurar Programa de Riego">
        {modalOpen && (
            <NuevoPrograma 
                idSector={sectorIdParaEditar} 
                cerrarModal={() => setModalOpen(false)} 
                alGuardar={() => { setModalOpen(false); cargarDatos(); }} 
            />
        )}
      </Modal>

    </div>
  )
}

export default Riego

================================================================================
ARCHIVO: src/pages/Bodega.jsx
================================================================================

import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { 
    Package, Plus, ArrowUpCircle, ArrowDownCircle, Search, AlertTriangle, 
    History, Pencil, Trash2, Filter, Shovel, FileText 
} from 'lucide-react'
import Modal from '../components/Modal'
import NuevoProducto from './NuevoProducto'
import NuevoMovimientoBodega from './NuevoMovimientoBodega'
import NuevaLabor from './NuevaLabor'

function Bodega() {
  const [productos, setProductos] = useState([])
  const [movimientos, setMovimientos] = useState([])
  const [loading, setLoading] = useState(true)
  
  // TABS Y FILTROS
  const [activeTab, setActiveTab] = useState('inventario')
  const [filtroGlobal, setFiltroGlobal] = useState('')
  const [filtrosHistorial, setFiltrosHistorial] = useState({ tipo: 'Todos' })
  
  // MODALES
  const [modalProductoOpen, setModalProductoOpen] = useState(false)
  const [modalMovimientoOpen, setModalMovimientoOpen] = useState(false)
  const [modalLaborOpen, setModalLaborOpen] = useState(false)
  
  const [productoEditar, setProductoEditar] = useState(null) 
  const [movimientoConfig, setMovimientoConfig] = useState(null) // { tipo, producto }
  const [movimientoAEditar, setMovimientoAEditar] = useState(null) // El movimiento hist√≥rico a editar
  
  const [laborEditarId, setLaborEditarId] = useState(null)

  useEffect(() => {
    cargarDatos()
  }, [])

  async function cargarDatos() {
    setLoading(true)
    
    const [resProductos, resMovimientos] = await Promise.allSettled([
        supabase.from('bodega_insumos').select('*').eq('activo', true).order('nombre'),
        supabase.from('bodega_movimientos')
            .select(`
                *,
                bodega_insumos:bodega_insumos!fk_movimiento_insumo ( id, nombre, unidad_medida, stock_actual, costo_promedio ),
                labores:labores!fk_movimiento_labor ( id, tipo_labor, descripcion )
            `)
            .order('fecha', { ascending: false })
            .limit(200)
    ])

    if (resProductos.status === 'fulfilled' && resProductos.value.data) {
        const rawData = resProductos.value.data
        const unicos = [...new Map(rawData.map(item => [item['id'], item])).values()]
        setProductos(unicos)
    }

    if (resMovimientos.status === 'fulfilled' && resMovimientos.value.data) {
        setMovimientos(resMovimientos.value.data)
    }
    
    setLoading(false)
  }

  const parseOrigen = (mov) => {
      if (mov.labor_id && mov.labores) {
          return {
              esSistema: true,
              origenId: mov.labor_id,
              tipo: 'Labor',
              label: `Labor: ${mov.labores.tipo_labor}`,
              icono: <Shovel size={14} color="#d97706"/>,
              detalle: mov.labores.descripcion || 'Sin detalle'
          }
      }
      return {
          esSistema: false,
          origenId: null,
          tipo: 'Manual',
          label: 'Directo Bodega',
          icono: <Package size={14} color="#4b5563"/>,
          detalle: mov.referencia || '-'
      }
  }

  const abrirNuevoProducto = () => { setProductoEditar(null); setModalProductoOpen(true) }
  const abrirEditarProducto = (prod) => { setProductoEditar(prod); setModalProductoOpen(true) }
  
  // Nuevo movimiento (desde cero)
  const abrirMovimiento = (tipo, prod) => { 
      setMovimientoConfig({ tipo, producto: prod })
      setMovimientoAEditar(null) 
      setModalMovimientoOpen(true) 
  }

  const archivarProducto = async (id) => {
      if(confirm("¬øArchivar producto? Desaparecer√° de la lista pero se mantendr√° el historial.")) {
          await supabase.from('bodega_insumos').update({ activo: false }).eq('id', id)
          cargarDatos()
      }
  }

  // --- CORRECCI√ìN CLAVE: PERMITIR EDICI√ìN ---
  const handleEditarMovimiento = (mov) => {
      const info = parseOrigen(mov)
      if (info.esSistema) {
          setLaborEditarId(info.origenId)
          setModalLaborOpen(true)
      } else {
          // AHORA S√ç PERMITIMOS EDITAR
          // Preparamos la configuraci√≥n como si fuera uno nuevo, pero pasamos el objeto a editar
          setMovimientoConfig({ 
              tipo: mov.tipo_movimiento, 
              producto: mov.bodega_insumos // Pasamos el producto relacionado
          })
          setMovimientoAEditar(mov) // Guardamos el registro completo para llenar el form
          setModalMovimientoOpen(true)
      }
  }

  const handleEliminarMovimiento = async (mov) => {
      const info = parseOrigen(mov)
      if (info.esSistema) return alert("‚õî Movimiento protegido por Labor.")
      
      if(confirm("¬øEliminar este movimiento? Se revertir√° el stock.")) {
          const { error } = await supabase.from('bodega_movimientos').delete().eq('id', mov.id)
          if (error) alert("Error: " + error.message)
          else cargarDatos()
      }
  }

  const productosFiltrados = productos.filter(p => 
    p.nombre.toLowerCase().includes(filtroGlobal.toLowerCase()) || 
    p.categoria?.toLowerCase().includes(filtroGlobal.toLowerCase())
  )

  const movimientosFiltrados = movimientos.filter(m => {
      if (filtrosHistorial.tipo !== 'Todos' && m.tipo_movimiento !== filtrosHistorial.tipo) return false
      const nombreInsumo = m.bodega_insumos?.nombre || ''
      if (filtroGlobal && !nombreInsumo.toLowerCase().includes(filtroGlobal.toLowerCase())) return false
      return true
  })

  const fmtMoney = (n) => '$ ' + Math.round(n || 0).toLocaleString('es-CL')

  const styles = {
    container: { padding: '20px', maxWidth: '1400px', margin: '0 auto', width: '90%' },
    header: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap:'wrap', gap:'15px' },
    title: { fontSize: '1.8rem', fontWeight: 'bold', color: '#1f2937', display:'flex', alignItems:'center', gap:'10px' },
    tabs: { display: 'flex', gap: 5, backgroundColor: '#e5e7eb', padding: 4, borderRadius: 8, width: 'fit-content' },
    tab: (active) => ({
        padding: '8px 20px', borderRadius: 6, border: 'none', cursor: 'pointer', fontWeight: 600, fontSize: '0.9rem',
        backgroundColor: active ? 'white' : 'transparent', color: active ? '#111827' : '#6b7280',
        boxShadow: active ? '0 1px 2px rgba(0,0,0,0.1)' : 'none', display:'flex', alignItems:'center', gap:6
    }),
    searchBar: { display:'flex', alignItems:'center', backgroundColor:'white', padding:'8px 15px', borderRadius:'8px', border:'1px solid #d1d5db', width:'300px' },
    searchInput: { border:'none', outline:'none', marginLeft:'10px', width:'100%', fontSize:'0.95rem' },
    btnNew: { backgroundColor: '#1f2937', color: 'white', padding: '10px 20px', borderRadius: '8px', border: 'none', cursor: 'pointer', fontWeight: 'bold', display:'flex', alignItems:'center', gap:'8px' },
    grid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '20px', marginTop: 20 },
    card: { backgroundColor: 'white', borderRadius: '12px', padding: '20px', border: '1px solid #e5e7eb', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', display:'flex', flexDirection:'column', justifyContent:'space-between' },
    cardHeader: { display:'flex', justifyContent:'space-between', alignItems:'flex-start', marginBottom:'10px' },
    prodName: { fontSize: '1.1rem', fontWeight: 'bold', color: '#1f2937' },
    prodCat: { fontSize: '0.75rem', color: '#6b7280', backgroundColor:'#f3f4f6', padding:'2px 8px', borderRadius:'12px', marginTop:'4px', display:'inline-block', fontWeight:'600' },
    stockBlock: { margin: '15px 0' },
    stockBig: { fontSize: '2rem', fontWeight: '800', color: '#1f2937' },
    stockUnit: { fontSize: '1rem', color: '#6b7280', fontWeight:'normal', marginLeft:'5px' },
    pmpLabel: { fontSize: '0.8rem', color: '#6b7280', marginTop: 2 },
    actionsRow: { display:'flex', gap:'10px', marginTop:'15px', borderTop:'1px solid #f3f4f6', paddingTop:'15px' },
    btnAction: (color, bg) => ({ flex:1, padding:'10px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.85rem', display:'flex', alignItems:'center', justifyContent:'center', gap:'6px', backgroundColor: bg, color: color }),
    tableContainer: { backgroundColor: 'white', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', border: '1px solid #e5e7eb', marginTop: 20 },
    table: { width: '100%', borderCollapse: 'collapse', fontSize: '0.9rem' },
    th: { backgroundColor: '#f9fafb', padding: '12px 15px', textAlign: 'left', fontSize: '0.75rem', color: '#6b7280', fontWeight: '700', textTransform: 'uppercase', borderBottom:'1px solid #e5e7eb' },
    td: { padding: '12px 15px', borderBottom: '1px solid #f3f4f6', color: '#374151' },
    badge: (tipo) => ({
        padding: '2px 8px', borderRadius: '12px', fontSize: '0.75rem', fontWeight: 'bold', display:'inline-flex', alignItems:'center', gap:4,
        backgroundColor: tipo === 'Entrada' ? '#dcfce7' : '#fee2e2', color: tipo === 'Entrada' ? '#166534' : '#991b1b'
    }),
    origenBadge: { display: 'inline-flex', alignItems: 'center', gap: 6, padding: '4px 8px', backgroundColor: '#f3f4f6', borderRadius: '6px', fontSize: '0.75rem', color: '#4b5563', border: '1px solid #e5e7eb' },
    btnIcon: { border: 'none', background: 'none', cursor: 'pointer', padding: 4 }
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <div style={{display:'flex', flexDirection:'column', gap:10}}>
            <h1 style={styles.title}><Package color="#2563eb"/> Bodega</h1>
            <div style={styles.tabs}>
                <button onClick={() => setActiveTab('inventario')} style={styles.tab(activeTab === 'inventario')}>
                    <Package size={16}/> Inventario
                </button>
                <button onClick={() => setActiveTab('historial')} style={styles.tab(activeTab === 'historial')}>
                    <History size={16}/> Historial
                </button>
            </div>
        </div>
        
        <div style={{display:'flex', gap:10, alignItems:'center'}}>
            <div style={styles.searchBar}>
                <Search size={18} color="#9ca3af"/>
                <input 
                    type="text" 
                    placeholder={activeTab === 'inventario' ? "Buscar insumo..." : "Buscar movimiento..."}
                    style={styles.searchInput}
                    value={filtroGlobal}
                    onChange={e => setFiltroGlobal(e.target.value)}
                />
            </div>
            {activeTab === 'inventario' && (
                <button onClick={abrirNuevoProducto} style={styles.btnNew}><Plus size={18}/> Nuevo</button>
            )}
        </div>
      </div>

      {loading && <div style={{padding:20, color:'#6b7280'}}>Cargando datos...</div>}

      {!loading && activeTab === 'inventario' && (
          <div style={styles.grid}>
            {productosFiltrados.map(p => (
                <div key={p.id} style={styles.card}>
                    <div>
                        <div style={styles.cardHeader}>
                            <div>
                                <div style={styles.prodName}>{p.nombre}</div>
                                <span style={styles.prodCat}>{p.categoria}</span>
                            </div>
                            <div style={{display:'flex', gap:5}}>
                                <button onClick={() => abrirEditarProducto(p)} style={styles.btnIcon} title="Editar"><Pencil size={16} color="#9ca3af"/></button>
                                <button onClick={() => archivarProducto(p.id)} style={styles.btnIcon} title="Archivar"><Trash2 size={16} color="#ef4444"/></button>
                            </div>
                        </div>
                        <div style={styles.stockBlock}>
                            <div style={styles.stockBig}>
                                {parseFloat(p.stock_actual).toLocaleString('es-CL')} 
                                <span style={styles.stockUnit}>{p.unidad_medida}</span>
                            </div>
                            <div style={styles.pmpLabel}>
                                PMP: <strong>{fmtMoney(p.costo_promedio)}</strong> / {p.unidad_medida}
                            </div>
                            {p.stock_actual <= p.stock_minimo && (
                                <div style={{display:'flex', alignItems:'center', gap:5, color:'#ef4444', fontSize:'0.8rem', fontWeight:'bold', marginTop:8, backgroundColor:'#fef2f2', padding:6, borderRadius:6}}>
                                    <AlertTriangle size={14}/> Stock Cr√≠tico (Min: {p.stock_minimo})
                                </div>
                            )}
                        </div>
                    </div>
                    <div style={styles.actionsRow}>
                        <button onClick={() => abrirMovimiento('Entrada', p)} style={styles.btnAction('#166534', '#dcfce7')}>
                            <ArrowUpCircle size={18}/> Entrada
                        </button>
                        <button onClick={() => abrirMovimiento('Salida', p)} style={styles.btnAction('#991b1b', '#fee2e2')}>
                            <ArrowDownCircle size={18}/> Salida
                        </button>
                    </div>
                </div>
            ))}
          </div>
      )}

      {!loading && activeTab === 'historial' && (
          <div style={styles.tableContainer}>
              <table style={styles.table}>
                  <thead>
                      <tr>
                          <th style={styles.th}>Fecha</th>
                          <th style={styles.th}>Insumo</th>
                          <th style={styles.th}>Tipo</th>
                          <th style={styles.th}>Origen / Ref</th>
                          <th style={styles.th}>Detalle</th>
                          <th style={{...styles.th, textAlign:'right'}}>Cantidad</th>
                          <th style={{...styles.th, width:80}}>Acciones</th>
                      </tr>
                  </thead>
                  <tbody>
                      {movimientosFiltrados.map(mov => {
                          const info = parseOrigen(mov)
                          const colorCantidad = mov.tipo_movimiento === 'Entrada' ? '#166534' : '#991b1b'
                          return (
                              <tr key={mov.id}>
                                  <td style={styles.td}>{mov.fecha ? mov.fecha.split('-').reverse().join('/') : '-'}</td>
                                  <td style={{...styles.td, fontWeight:'bold'}}>{mov.bodega_insumos?.nombre || 'Desconocido'}</td>
                                  <td style={styles.td}>
                                      <span style={styles.badge(mov.tipo_movimiento)}>
                                          {mov.tipo_movimiento === 'Entrada' ? <ArrowUpCircle size={12}/> : <ArrowDownCircle size={12}/>}
                                          {mov.tipo_movimiento}
                                      </span>
                                  </td>
                                  <td style={styles.td}>
                                      <div style={styles.origenBadge}>{info.icono} {info.label}</div>
                                  </td>
                                  <td style={{...styles.td, fontSize:'0.8rem', color:'#6b7280'}}>{info.detalle}</td>
                                  <td style={{...styles.td, textAlign:'right', fontFamily:'monospace', fontWeight:'bold', color: colorCantidad}}>
                                      {mov.tipo_movimiento === 'Entrada' ? '+' : '-'}{parseFloat(mov.cantidad).toLocaleString('es-CL')} {mov.bodega_insumos?.unidad_medida}
                                  </td>
                                  <td style={styles.td}>
                                      <div style={{display:'flex', justifyContent:'flex-end', gap:5}}>
                                          <button 
                                              onClick={() => handleEditarMovimiento(mov)}
                                              title="Editar Movimiento"
                                              style={{...styles.btnIcon, color: info.esSistema ? '#2563eb' : '#4b5563', backgroundColor: info.esSistema ? '#eff6ff' : 'transparent', borderRadius:4}}
                                          >
                                              {info.esSistema ? <FileText size={16}/> : <Pencil size={16}/>}
                                          </button>
                                          <button 
                                              onClick={() => handleEliminarMovimiento(mov)}
                                              style={{...styles.btnIcon, color: info.esSistema ? '#d1d5db' : '#ef4444', cursor: info.esSistema ? 'not-allowed' : 'pointer'}}
                                          >
                                              <Trash2 size={16}/>
                                          </button>
                                      </div>
                                  </td>
                              </tr>
                          )
                      })}
                  </tbody>
              </table>
          </div>
      )}
      
      {/* MODAL REGISTRO / EDICI√ìN MOVIMIENTO */}
      <Modal isOpen={modalMovimientoOpen} onClose={() => setModalMovimientoOpen(false)} title={`${movimientoAEditar ? 'Editar' : 'Registrar'} ${movimientoConfig?.tipo || 'Movimiento'}`}>
          {modalMovimientoOpen && (
            <NuevoMovimientoBodega 
                config={movimientoConfig}
                movimientoEditar={movimientoAEditar} // PASAMOS EL OBJETO DE EDICION
                cerrar={() => setModalMovimientoOpen(false)}
                alGuardar={() => { setModalMovimientoOpen(false); cargarDatos() }}
            />
          )}
      </Modal>

      <Modal isOpen={modalLaborOpen} onClose={() => setModalLaborOpen(false)} title="Editar Labor (Origen)">
          {modalLaborOpen && <NuevaLabor idLabor={laborEditarId} cerrarModal={() => setModalLaborOpen(false)} alGuardar={() => { setModalLaborOpen(false); cargarDatos() }} />}
      </Modal>
      <Modal isOpen={modalProductoOpen} onClose={() => setModalProductoOpen(false)} title={productoEditar ? "Editar Producto" : "Nuevo Producto"}>
          {modalProductoOpen && <NuevoProducto producto={productoEditar} cerrar={() => setModalProductoOpen(false)} alGuardar={() => { setModalProductoOpen(false); cargarDatos() }} />}
      </Modal>
    </div>
  )
}

export default Bodega

================================================================================
ARCHIVO: src/pages/OfertasComerciales.jsx
================================================================================

import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { FileText, Plus, Pencil, Trash2, CheckCircle, XCircle, ChevronDown, ChevronUp } from 'lucide-react'
import Modal from '../components/Modal'
import NuevaOferta from '../pages/NuevaOferta'

function OfertasComerciales() {
  const [ofertas, setOfertas] = useState([])
  const [loading, setLoading] = useState(true)
  const [modalOpen, setModalOpen] = useState(false)
  const [editId, setEditId] = useState(null)
  
  // Estado para manejar expansiones de acorde√≥n (Set de IDs expandidos)
  const [expandedIds, setExpandedIds] = useState(new Set())

  useEffect(() => { cargarOfertas() }, [])

  async function cargarOfertas() {
    setLoading(true)
    const { data, error } = await supabase
      .from('ofertas_comerciales')
      .select('*, clientes(nombre)')
      .order('activa', { ascending: false }) // Activas primero
      .order('created_at', { ascending: false })
    
    if (error) {
        console.error(error)
    } else {
        setOfertas(data || [])
        
        // --- CAMBIO: Expandir todos por defecto ---
        const allIds = new Set((data || []).map(offer => offer.id))
        setExpandedIds(allIds)
    }
    setLoading(false)
  }

  const toggleExpand = (id) => {
    const newSet = new Set(expandedIds)
    if (newSet.has(id)) newSet.delete(id)
    else newSet.add(id)
    setExpandedIds(newSet)
  }

  const eliminarOferta = async (id, e) => {
      e.stopPropagation() // Evitar abrir acorde√≥n
      if(confirm("¬øEliminar esta cotizaci√≥n?")) {
          await supabase.from('ofertas_comerciales').delete().eq('id', id)
          cargarOfertas()
      }
  }

  const handleEdit = (id, e) => {
      e.stopPropagation()
      setEditId(id)
      setModalOpen(true)
  }

  const styles = {
    // REGLA: Contenedor 90% ancho max 1400px
    container: { width: '90%', maxWidth: '1400px', margin: '0 auto', padding: '20px 0' },
    
    // REGLA: Encabezado Compacto
    header: { display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:20, borderBottom:'1px solid #e5e7eb', paddingBottom:15 },
    titleSection: { display: 'flex', alignItems: 'center', gap: 12 },
    title: { fontSize:'1.5rem', fontWeight:'bold', color:'#111827', margin: 0 },
    subtitle: { fontSize:'0.9rem', color:'#6b7280' },
    
    btnNew: { padding:'8px 16px', backgroundColor:'#111827', color:'white', borderRadius:'6px', border:'none', fontWeight:'600', display:'flex', alignItems:'center', gap:6, cursor:'pointer', fontSize:'0.9rem' },
    
    // Grid de Tarjetas
    grid: { display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(350px, 1fr))', gap:20 },
    
    // Tarjeta
    card: { backgroundColor:'white', borderRadius:10, border:'1px solid #e5e7eb', boxShadow:'0 1px 3px rgba(0,0,0,0.05)', overflow:'hidden', transition: 'box-shadow 0.2s' },
    
    // Cabecera Tarjeta (Siempre visible)
    cardHeader: { padding: '15px', display:'flex', justifyContent:'space-between', alignItems:'center', cursor: 'pointer', backgroundColor: '#fff' },
    cardTitleInfo: { display: 'flex', flexDirection: 'column' },
    clientName: { fontSize:'1rem', fontWeight:'bold', color:'#111827' },
    offerMeta: { fontSize:'0.8rem', color:'#6b7280', display: 'flex', gap: '8px', alignItems:'center', marginTop: '4px' },
    
    statusBadge: (active) => ({
        padding:'2px 8px', borderRadius:12, fontSize:'0.7rem', fontWeight:'bold', textTransform:'uppercase',
        backgroundColor: active ? '#dcfce7' : '#f3f4f6',
        color: active ? '#166534' : '#6b7280', border: active ? '1px solid #bbf7d0' : '1px solid #e5e7eb'
    }),

    // Contenido Expandible (Acorde√≥n)
    expandableContent: { borderTop: '1px solid #f3f4f6', backgroundColor: '#f9fafb', padding: '15px' },
    
    // Tabla interna compacta
    table: { width: '100%', borderCollapse: 'collapse', fontSize: '0.85rem' },
    th: { textAlign: 'left', padding: '8px', borderBottom: '1px solid #e5e7eb', color: '#6b7280' },
    td: { padding: '8px', borderBottom: '1px solid #e5e7eb', fontWeight: '500', color: '#374151' },
    tdPrice: { textAlign: 'right', fontWeight: 'bold', fontFamily: 'monospace' },

    actions: { display:'flex', gap:8, alignItems:'center' }
  }

  return (
    <div style={styles.container}>
        <div style={styles.header}>
            <div style={styles.titleSection}>
                <h1 style={styles.title}>Ofertas & Precios</h1>
                <span style={styles.subtitle}>| Gesti√≥n Comercial</span>
            </div>
            <button onClick={() => { setEditId(null); setModalOpen(true) }} style={styles.btnNew}>
                <Plus size={16}/> Nueva Oferta
            </button>
        </div>

        {loading ? <div style={{textAlign:'center', padding:40, color:'#6b7280'}}>Cargando ofertas...</div> : (
            <div style={styles.grid}>
                {ofertas.map(of => {
                    const isOpen = expandedIds.has(of.id)
                    const precios = of.precios_json || []

                    return (
                        <div key={of.id} style={styles.card}>
                            {/* Cabecera Clickeable */}
                            <div style={styles.cardHeader} onClick={() => toggleExpand(of.id)}>
                                <div style={styles.cardTitleInfo}>
                                    <div style={{display:'flex', alignItems:'center', gap:10}}>
                                        <span style={styles.clientName}>{of.clientes?.nombre || 'Sin Cliente'}</span>
                                        <span style={styles.statusBadge(of.activa)}>{of.activa ? 'Activa' : 'Inactiva'}</span>
                                    </div>
                                    <div style={styles.offerMeta}>
                                        <FileText size={12}/> {of.nombre || 'Cotizaci√≥n est√°ndar'} 
                                        <span>‚Ä¢</span> 
                                        {new Date(of.fecha).toLocaleDateString('es-CL')}
                                    </div>
                                </div>
                                <div style={styles.actions}>
                                    <button onClick={(e) => handleEdit(of.id, e)} style={{border:'none', background:'none', cursor:'pointer', color:'#2563eb'}}>
                                        <Pencil size={16}/>
                                    </button>
                                    <button onClick={(e) => eliminarOferta(of.id, e)} style={{border:'none', background:'none', cursor:'pointer', color:'#ef4444'}}>
                                        <Trash2 size={16}/>
                                    </button>
                                    <div style={{color:'#9ca3af', marginLeft:5}}>
                                        {isOpen ? <ChevronUp size={20}/> : <ChevronDown size={20}/>}
                                    </div>
                                </div>
                            </div>

                            {/* Detalle Acorde√≥n */}
                            {isOpen && (
                                <div style={styles.expandableContent}>
                                    {precios.length > 0 ? (
                                        <table style={styles.table}>
                                            <thead>
                                                <tr>
                                                    <th style={styles.th}>Calibre</th>
                                                    <th style={{...styles.th, textAlign:'right'}}>Precio Kilo</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {precios.map((p, idx) => (
                                                    <tr key={idx}>
                                                        <td style={styles.td}>{p.calibre}</td>
                                                        <td style={{...styles.td, ...styles.tdPrice}}>
                                                            $ {p.precio.toLocaleString('es-CL')}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    ) : (
                                        <p style={{fontStyle:'italic', color:'#9ca3af', fontSize:'0.85rem', textAlign:'center'}}>
                                            Sin precios definidos.
                                        </p>
                                    )}
                                </div>
                            )}
                        </div>
                    )
                })}
            </div>
        )}

        <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title={editId ? "Editar Cotizaci√≥n" : "Nueva Cotizaci√≥n"}>
            {modalOpen && (
                <NuevaOferta 
                    idOferta={editId}
                    cerrarModal={() => setModalOpen(false)}
                    alGuardar={() => { setModalOpen(false); cargarOfertas(); }}
                />
            )}
        </Modal>
    </div>
  )
}

export default OfertasComerciales

================================================================================
ARCHIVO: src/pages/Gastos.jsx
================================================================================

import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { 
  DollarSign, Plus, Calendar, Filter, Search, 
  Tag, User, FileText, Trash2, TrendingUp, TrendingDown,
  LayoutGrid, List, MapPin, Globe, CreditCard, ArrowUpDown
} from 'lucide-react'
import Modal from '../components/Modal'
import NuevoGasto from './NuevoGasto'

const formatMoney = (amount) => '$ ' + Math.round(amount || 0).toLocaleString('es-CL')
const formatDate = (dateStr) => {
    if(!dateStr) return '-'
    const [y, m, d] = dateStr.split('-')
    return `${d}/${m}/${y}`
}

function Gastos() {
  const [gastos, setGastos] = useState([])
  const [loading, setLoading] = useState(true)
  
  // Maestros para filtros
  const [categorias, setCategorias] = useState([])
  const [proveedores, setProveedores] = useState([])
  
  // Vista Activa
  const [activeTab, setActiveTab] = useState('resumen') // 'resumen' (Tarjetas) | 'historial' (Tabla)

  // Filtros
  const [filtroMes, setFiltroMes] = useState('')
  const [filtroAnio, setFiltroAnio] = useState(new Date().getFullYear().toString())
  const [filtroCategoria, setFiltroCategoria] = useState('')
  const [filtroProveedor, setFiltroProveedor] = useState('')
  const [busqueda, setBusqueda] = useState('')
  
  // Ordenamiento (NUEVO)
  const [orden, setOrden] = useState('fecha_desc') // fecha_desc | fecha_asc | monto_desc | monto_asc

  const [modalOpen, setModalOpen] = useState(false)
  const [editarId, setEditarId] = useState(null)

  useEffect(() => { cargarMaestros() }, [])
  useEffect(() => { cargarGastos() }, [filtroMes, filtroAnio])

  async function cargarMaestros() {
    const [cat, prov] = await Promise.all([
        supabase.from('categorias_gastos').select('id, nombre').order('nombre'),
        supabase.from('proveedores').select('id, nombre').order('nombre')
    ])
    setCategorias(cat.data || [])
    setProveedores(prov.data || [])
  }

  async function cargarGastos() {
    setLoading(true)
    let query = supabase
      .from('gastos')
      .select(`
        *,
        categorias_gastos!gastos_categoria_id_fkey ( nombre ),
        proveedores ( nombre ),
        socios:pagado_por_socio_id ( nombre )
      `)
      .order('fecha', { ascending: false })

    if (filtroAnio && filtroAnio !== 'Todos') {
        const anio = parseInt(filtroAnio)
        if (filtroMes && filtroMes !== 'Todos') {
            const mes = parseInt(filtroMes)
            const fechaInicio = new Date(anio, mes - 1, 1).toISOString().split('T')[0]
            const fechaFin = new Date(anio, mes, 0).toISOString().split('T')[0]
            query = query.gte('fecha', fechaInicio).lte('fecha', fechaFin)
        } else {
            const fechaInicio = `${anio}-01-01`
            const fechaFin = `${anio}-12-31`
            query = query.gte('fecha', fechaInicio).lte('fecha', fechaFin)
        }
    }

    const { data, error } = await query
    if (error) console.error("Error cargando gastos:", error)
    else setGastos(data || [])
    
    setLoading(false)
  }

  const eliminarGasto = async (id) => {
    if (confirm("¬øEliminar este registro de gasto?")) {
      const { error } = await supabase.from('gastos').delete().eq('id', id)
      if (!error) cargarGastos()
    }
  }

  // 1. Filtrado
  const gastosFiltrados = gastos.filter(g => {
    if (filtroCategoria && filtroCategoria !== 'Todos' && g.categoria_id?.toString() !== filtroCategoria) return false
    if (filtroProveedor && filtroProveedor !== 'Todos' && g.proveedor_id?.toString() !== filtroProveedor) return false
    
    const texto = busqueda.toLowerCase()
    return !busqueda || 
           g.descripcion?.toLowerCase().includes(texto) || 
           g.proveedores?.nombre?.toLowerCase().includes(texto) ||
           g.nro_documento?.toLowerCase().includes(texto) ||
           g.monto?.toString().includes(texto)
  })

  // 2. Ordenamiento (NUEVO)
  const gastosOrdenados = [...gastosFiltrados].sort((a, b) => {
      if (orden === 'fecha_desc') return new Date(b.fecha) - new Date(a.fecha)
      if (orden === 'fecha_asc') return new Date(a.fecha) - new Date(b.fecha)
      if (orden === 'monto_desc') return (b.monto || 0) - (a.monto || 0)
      if (orden === 'monto_asc') return (a.monto || 0) - (b.monto || 0)
      return 0
  })

  // C√°lculos KPIs
  const totalPeriodo = gastosFiltrados.reduce((acc, g) => acc + (g.monto || 0), 0)
  const totalPagado = gastosFiltrados.filter(g => g.estado_pago === 'Pagado').reduce((acc, g) => acc + (g.monto || 0), 0)
  const totalPendiente = totalPeriodo - totalPagado

  const StatusBadge = ({ status }) => {
      const isPaid = status === 'Pagado'
      return (
          <span style={{
              padding:'4px 10px', borderRadius:12, fontSize:'0.75rem', fontWeight:'bold',
              backgroundColor: isPaid ? '#dcfce7' : '#fee2e2', color: isPaid ? '#166534' : '#991b1b',
              border: isPaid ? '1px solid #86efac' : '1px solid #fca5a5', display:'inline-block'
          }}>
              {status?.toUpperCase()}
          </span>
      )
  }

  const styles = {
    container: { width: '95%', maxWidth: '1400px', margin: '0 auto', padding: '20px 0' },
    header: { display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom: 20 },
    title: { fontSize: '1.5rem', fontWeight: 'bold', color: '#1f2937', display: 'flex', alignItems: 'center', gap: 10 },
    
    tabsContainer: { display:'flex', gap:5, backgroundColor:'#e5e7eb', padding:4, borderRadius:8 },
    tabBtn: (active) => ({
        padding:'8px 16px', borderRadius:6, border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.9rem',
        backgroundColor: active ? 'white' : 'transparent', color: active ? '#111827' : '#6b7280', display:'flex', gap:8, alignItems:'center',
        boxShadow: active ? '0 1px 3px rgba(0,0,0,0.1)' : 'none'
    }),

    // KPIs
    kpiBar: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))', gap: 20, marginBottom: 20 },
    kpiCard: (bg, border) => ({ backgroundColor: bg, padding: 20, borderRadius: 16, border: `1px solid ${border}`, display: 'flex', flexDirection: 'column', gap: 5 }),
    kpiLabel: { fontSize: '0.8rem', fontWeight: 'bold', color: '#6b7280', textTransform: 'uppercase' },
    kpiValue: { fontSize: '2rem', fontWeight: '800', color: '#111827' },

    // Filtros
    controls: { display: 'flex', gap: 10, flexWrap: 'wrap', alignItems: 'center', backgroundColor: '#fff', padding: 15, borderRadius: 12, border: '1px solid #e5e7eb', marginBottom: 20 },
    filterGroup: { display:'flex', alignItems:'center', gap:5 },
    labelFilter: { fontSize:'0.85rem', fontWeight:'bold', color:'#6b7280' },
    select: { padding: '8px 12px', borderRadius: 8, border: '1px solid #d1d5db', fontSize: '0.9rem', minWidth: 140, cursor:'pointer' },
    inputSearch: { padding: '8px 12px', borderRadius: 8, border: '1px solid #d1d5db', fontSize: '0.9rem', width: 200, paddingLeft:32 },
    btnNew: { backgroundColor: '#1f2937', color: 'white', border: 'none', padding: '10px 20px', borderRadius: 8, fontWeight: 'bold', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 8 },

    // VISTA TARJETAS
    gridCards: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: 20 },
    card: { backgroundColor: 'white', borderRadius: 12, padding: 0, border: '1px solid #e5e7eb', display: 'flex', flexDirection: 'column', overflow:'hidden', boxShadow: '0 2px 4px rgba(0,0,0,0.05)' },
    cardHeader: { padding:15, display:'flex', gap:15, alignItems:'center', borderBottom:'1px solid #f3f4f6' },
    dateBox: { display: 'flex', flexDirection: 'column', alignItems: 'center', minWidth: 60, paddingRight: 15, borderRight: '1px solid #f3f4f6' },
    day: { fontSize: '1.5rem', fontWeight: 'bold', color: '#374151', lineHeight: 1 },
    month: { fontSize: '0.75rem', textTransform: 'uppercase', color: '#9ca3af', fontWeight: 'bold' },
    year: { fontSize: '0.7rem', color: '#9ca3af' },
    cardBody: { padding:15, flex:1 },
    cardFooter: { padding: '10px 15px', backgroundColor:'#f9fafb', borderTop:'1px solid #f3f4f6', display:'flex', justifyContent:'space-between', alignItems:'center' },
    
    // VISTA TABLA
    tableContainer: { backgroundColor: 'white', borderRadius: 12, border: '1px solid #e5e7eb', overflow: 'hidden' },
    table: { width: '100%', borderCollapse: 'collapse', fontSize: '0.9rem' },
    th: { textAlign: 'left', padding: '12px 15px', backgroundColor: '#f9fafb', color: '#6b7280', fontWeight: 'bold', fontSize: '0.75rem', textTransform: 'uppercase', borderBottom: '1px solid #e5e7eb' },
    td: { padding: '12px 15px', borderBottom: '1px solid #f3f4f6', color: '#374151', verticalAlign:'middle' },
    badge: { display:'inline-flex', alignItems:'center', gap:4, backgroundColor:'#f3f4f6', padding:'2px 8px', borderRadius:6, border:'1px solid #e5e7eb', fontSize:'0.75rem', color:'#4b5563' },
    
    btnIcon: { border:'none', background:'transparent', cursor:'pointer', padding:5, borderRadius:4, color:'#6b7280' }
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><DollarSign size={28} /> Gesti√≥n de Gastos</h1>
        <div style={styles.tabsContainer}>
            <button onClick={() => setActiveTab('resumen')} style={styles.tabBtn(activeTab === 'resumen')}>
                <LayoutGrid size={16}/> Resumen
            </button>
            <button onClick={() => setActiveTab('historial')} style={styles.tabBtn(activeTab === 'historial')}>
                <List size={16}/> Historial
            </button>
        </div>
      </div>

      <div style={styles.kpiBar}>
            <div style={styles.kpiCard('white', '#d1d5db')}>
                <span style={styles.kpiLabel}>Gasto Total (Periodo)</span>
                <span style={styles.kpiValue}>{formatMoney(totalPeriodo)}</span>
            </div>
            <div style={styles.kpiCard('#f0fdf4', '#bbf7d0')}>
                <div style={{display:'flex', justifyContent:'space-between'}}><span style={{...styles.kpiLabel, color:'#166534'}}>Pagado</span><TrendingUp size={20} color="#16a34a"/></div>
                <span style={{...styles.kpiValue, color:'#166534'}}>{formatMoney(totalPagado)}</span>
            </div>
            <div style={styles.kpiCard('#fef2f2', '#fecaca')}>
                <div style={{display:'flex', justifyContent:'space-between'}}><span style={{...styles.kpiLabel, color:'#991b1b'}}>Deuda Pendiente</span><TrendingDown size={20} color="#ef4444"/></div>
                <span style={{...styles.kpiValue, color:'#991b1b'}}>{formatMoney(totalPendiente)}</span>
            </div>
      </div>

      <div style={styles.controls}>
        {/* Filtros Izquierda */}
        <div style={styles.filterGroup}>
            <span style={styles.labelFilter}>A√±o:</span>
            <select value={filtroAnio} onChange={e => setFiltroAnio(e.target.value)} style={styles.select}>
                <option value="Todos">Todos</option>
                {[2024, 2025, 2026, 2027].map(a => <option key={a} value={a}>{a}</option>)}
            </select>
        </div>

        <div style={styles.filterGroup}>
            <span style={styles.labelFilter}>Mes:</span>
            <select value={filtroMes} onChange={e => setFiltroMes(e.target.value)} style={styles.select}>
                <option value="Todos">Todos</option>
                {['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'].map((m,i) => (
                    <option key={i} value={i+1}>{m}</option>
                ))}
            </select>
        </div>

        <div style={styles.filterGroup}>
            <span style={styles.labelFilter}>Categor√≠a:</span>
            <select value={filtroCategoria} onChange={e => setFiltroCategoria(e.target.value)} style={styles.select}>
                <option value="Todos">Todas</option>
                {categorias.map(c => <option key={c.id} value={c.id}>{c.nombre}</option>)}
            </select>
        </div>

        <div style={styles.filterGroup}>
            <span style={styles.labelFilter}>Proveedor:</span>
            <select value={filtroProveedor} onChange={e => setFiltroProveedor(e.target.value)} style={styles.select}>
                <option value="Todos">Todos</option>
                {proveedores.map(p => <option key={p.id} value={p.id}>{p.nombre}</option>)}
            </select>
        </div>

        {/* Grupo Derecha: Ordenar, Buscar, Nuevo */}
        <div style={{display:'flex', alignItems:'center', gap:10, marginLeft:'auto'}}>
            
            {/* CONTROL ORDENAR */}
            <div style={styles.filterGroup}>
                <ArrowUpDown size={16} color="#6b7280"/>
                <select value={orden} onChange={e => setOrden(e.target.value)} style={styles.select}>
                    <option value="fecha_desc">M√°s Recientes</option>
                    <option value="fecha_asc">M√°s Antiguos</option>
                    <option value="monto_desc">Mayor Monto</option>
                    <option value="monto_asc">Menor Monto</option>
                </select>
            </div>

            <div style={{position:'relative'}}>
                <Search size={16} color="#9ca3af" style={{position:'absolute', left:10, top:10}}/>
                <input 
                    type="text" placeholder="Buscar..." value={busqueda} onChange={e => setBusqueda(e.target.value)}
                    style={styles.inputSearch}
                />
            </div>

            <button onClick={() => { setEditarId(null); setModalOpen(true) }} style={styles.btnNew}>
                <Plus size={18}/> Nuevo
            </button>
        </div>
      </div>

      {loading && <div style={{padding:40, textAlign:'center', color:'#9ca3af'}}>Cargando registros...</div>}

      {/* VISTA 1: RESUMEN (TARJETAS) */}
      {!loading && activeTab === 'resumen' && (
          <div style={styles.gridCards}>
              {gastosOrdenados.map(g => {
                  const fecha = new Date(g.fecha)
                  const dia = fecha.getDate()
                  const mes = fecha.toLocaleString('es-ES', { month: 'short' }).toUpperCase()
                  const anio = fecha.getFullYear()
                  const isGlobal = !g.sectores_ids || g.sectores_ids.length === 0

                  return (
                      <div key={g.id} style={styles.card}>
                          <div style={styles.cardHeader}>
                              <div style={styles.dateBox}>
                                  <span style={styles.day}>{dia}</span>
                                  <span style={styles.month}>{mes}</span>
                                  <span style={styles.year}>{anio}</span>
                              </div>
                              <div style={{flex:1}}>
                                  <div style={{fontSize:'1rem', fontWeight:'bold', color:'#1f2937', marginBottom:5}}>{g.descripcion}</div>
                                  <div style={{display:'flex', gap:5, flexWrap:'wrap'}}>
                                      <span style={styles.badge}><Tag size={12}/> {g.categorias_gastos?.nombre || 'General'}</span>
                                      {g.proveedores && <span style={styles.badge}><User size={12}/> {g.proveedores.nombre}</span>}
                                  </div>
                              </div>
                          </div>
                          
                          <div style={styles.cardBody}>
                              <div style={{display:'flex', justifyContent:'space-between', alignItems:'flex-end', marginBottom:10}}>
                                  <div>
                                      <div style={{fontSize:'0.75rem', color:'#6b7280', marginBottom:2}}>Monto Total</div>
                                      <div style={{fontSize:'1.5rem', fontWeight:'800', color:'#111827'}}>{formatMoney(g.monto)}</div>
                                  </div>
                                  <StatusBadge status={g.estado_pago} />
                              </div>
                              
                              <div style={{fontSize:'0.8rem', color:'#6b7280', display:'flex', flexDirection:'column', gap:4}}>
                                  {g.nro_documento && <div style={{display:'flex', gap:6}}><FileText size={14}/> Doc: {g.nro_documento}</div>}
                                  <div style={{display:'flex', gap:6, alignItems:'center'}}>
                                      {isGlobal ? <Globe size={14}/> : <MapPin size={14}/>}
                                      {isGlobal ? 'Gasto Global (Todo el campo)' : `Asignado a ${g.sectores_ids.length} sectores`}
                                  </div>
                                  {g.estado_pago === 'Pagado' && g.socios && (
                                      <div style={{display:'flex', gap:6, color:'#166534'}}>
                                          <CreditCard size={14}/> Pagado por: {g.socios.nombre}
                                      </div>
                                  )}
                              </div>
                          </div>

                          <div style={styles.cardFooter}>
                              <span style={{fontSize:'0.75rem', color:'#9ca3af'}}>ID: {g.id}</span>
                              <div style={{display:'flex', gap:10}}>
                                  <button onClick={() => { setEditarId(g.id); setModalOpen(true) }} style={{...styles.btnIcon, color:'#4b5563', fontWeight:'bold'}}>Editar</button>
                                  <button onClick={() => eliminarGasto(g.id)} style={{...styles.btnIcon, color:'#ef4444'}}>Eliminar</button>
                              </div>
                          </div>
                      </div>
                  )
              })}
          </div>
      )}

      {/* VISTA 2: HISTORIAL (TABLA) */}
      {!loading && activeTab === 'historial' && (
          <div style={styles.tableContainer}>
              <table style={styles.table}>
                  <thead>
                      <tr>
                          <th style={styles.th}>Fecha</th>
                          <th style={styles.th}>Categor√≠a</th>
                          <th style={styles.th}>Proveedor</th>
                          <th style={styles.th}>Descripci√≥n</th>
                          <th style={styles.th}>Sectores</th>
                          <th style={styles.th}>Estado</th>
                          <th style={{...styles.th, textAlign:'right'}}>Monto</th>
                          <th style={{...styles.th, textAlign:'center'}}>Acciones</th>
                      </tr>
                  </thead>
                  <tbody>
                      {gastosOrdenados.map(g => {
                          const isGlobal = !g.sectores_ids || g.sectores_ids.length === 0
                          return (
                              <tr key={g.id}>
                                  <td style={styles.td}>{formatDate(g.fecha)}</td>
                                  <td style={{...styles.td, fontWeight:'bold'}}>{g.categorias_gastos?.nombre}</td>
                                  <td style={styles.td}>{g.proveedores?.nombre || '-'}</td>
                                  <td style={styles.td}>
                                      <div>{g.descripcion}</div>
                                      {g.nro_documento && <div style={{fontSize:'0.75rem', color:'#9ca3af'}}>#{g.nro_documento}</div>}
                                  </td>
                                  <td style={styles.td}>
                                       {isGlobal ? (
                                           <span style={styles.badge}><Globe size={10}/> Global</span>
                                       ) : (
                                           <span style={{...styles.badge, backgroundColor:'#eff6ff', color:'#1e40af', border:'1px solid #bfdbfe'}}>
                                               <MapPin size={10}/> {g.sectores_ids.length}
                                           </span>
                                       )}
                                  </td>
                                  <td style={styles.td}><StatusBadge status={g.estado_pago}/></td>
                                  <td style={{...styles.td, textAlign:'right', fontWeight:'bold', fontFamily:'monospace', fontSize:'1rem'}}>
                                      {formatMoney(g.monto)}
                                  </td>
                                  <td style={styles.td}>
                                      <div style={{display:'flex', justifyContent:'center', gap:5}}>
                                          <button onClick={() => { setEditarId(g.id); setModalOpen(true) }} style={{...styles.btnIcon, backgroundColor:'#f3f4f6'}}>
                                              <FileText size={16}/>
                                          </button>
                                          <button onClick={() => eliminarGasto(g.id)} style={{...styles.btnIcon, color:'#ef4444', backgroundColor:'#fef2f2'}}>
                                              <Trash2 size={16}/>
                                          </button>
                                      </div>
                                  </td>
                              </tr>
                          )
                      })}
                  </tbody>
              </table>
          </div>
      )}

      <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title={editarId ? "Editar Gasto" : "Registrar Nuevo Gasto"}>
         {modalOpen && (
            <NuevoGasto 
                idGasto={editarId}
                cerrarModal={() => setModalOpen(false)}
                alGuardar={() => { setModalOpen(false); cargarGastos() }}
            />
         )}
      </Modal>
    </div>
  )
}

export default Gastos

================================================================================
ARCHIVO: src/pages/CuentasSocios.jsx
================================================================================

import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { 
    Users, TrendingUp, TrendingDown, Plus, Minus, Wallet, 
    ArrowUpDown, Filter, ShoppingBag, User, 
    Pencil, Trash2, Lock, FileText, Calendar, Search, LayoutGrid, List
} from 'lucide-react'
import Modal from '../components/Modal'
import NuevoGasto from './NuevoGasto'

// --- COMPONENTES INTERNOS ---

const SmartMoneyInput = ({ value, onChange, placeholder, autoFocus }) => {
    const [display, setDisplay] = useState('')
    useEffect(() => {
        if(value) setDisplay('$ ' + parseInt(value).toLocaleString('es-CL'))
        else setDisplay('')
    }, [value])
    const handleChange = (e) => {
        const raw = e.target.value.replace(/\D/g, '')
        setDisplay(raw)
        onChange(raw)
    }
    return (
        <input 
            type="text" value={display} onChange={handleChange} placeholder={placeholder || "$ 0"} autoFocus={autoFocus}
            style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '1.2rem', fontWeight: 'bold', color: '#111827', textAlign: 'center', boxSizing: 'border-box' }}
        />
    )
}

function FormularioMovimiento({ socioId, tipoInicial, initialData, cerrar, alGuardar }) {
    const [loading, setLoading] = useState(false)
    const [formData, setFormData] = useState({
        socio_id: socioId || '', 
        tipo: tipoInicial || 'Aporte', 
        monto: '',
        fecha: new Date().toISOString().split('T')[0], 
        descripcion: ''
    })
    const [socios, setSocios] = useState([])

    useEffect(() => {
        supabase.from('socios').select('id, nombre').order('nombre').then(({ data }) => setSocios(data || []))
        if (initialData) {
            setFormData({
                socio_id: initialData.socio_id || '',
                tipo: initialData.tipo || 'Aporte',
                monto: initialData.monto || '',
                fecha: initialData.fecha || '',
                descripcion: initialData.descripcion || ''
            })
        }
    }, [initialData])

    const handleSubmit = async (e) => {
        e.preventDefault()
        if(!formData.monto || parseInt(formData.monto) <= 0) return alert("Ingresa un monto v√°lido")
        setLoading(true)
        
        let error = null
        if (initialData) {
            const { error: err } = await supabase.from('movimientos_billetera').update(formData).eq('id', initialData.id)
            error = err
        } else {
            const { error: err } = await supabase.from('movimientos_billetera').insert([formData])
            error = err
        }

        setLoading(false)
        if(error) alert("Error: " + error.message)
        else alGuardar()
    }

    const estilos = {
        form: { display: 'flex', flexDirection: 'column', gap: 20, width: '100%', boxSizing: 'border-box' },
        selectorTipo: { display: 'flex', gap: 10, marginBottom: 10 },
        btnTipo: (activo, esAporte) => ({
            flex: 1, padding: '10px', borderRadius: '8px', border: '1px solid', cursor: 'pointer', fontWeight: 'bold', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8,
            backgroundColor: activo ? (esAporte ? '#dcfce7' : '#fee2e2') : 'white',
            borderColor: activo ? (esAporte ? '#166534' : '#991b1b') : '#e5e7eb',
            color: activo ? (esAporte ? '#166534' : '#991b1b') : '#6b7280'
        }),
        input: { padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', width: '100%', boxSizing: 'border-box' },
        btnSave: { padding: '12px', backgroundColor: '#111827', color: 'white', borderRadius: '8px', border: 'none', fontWeight: 'bold', cursor: 'pointer' }
    }

    return (
        <form onSubmit={handleSubmit} style={estilos.form}>
            <div style={estilos.selectorTipo}>
                <div onClick={() => setFormData({...formData, tipo: 'Aporte'})} style={estilos.btnTipo(formData.tipo === 'Aporte', true)}>
                    <TrendingUp size={18}/> Aporte
                </div>
                <div onClick={() => setFormData({...formData, tipo: 'Retiro'})} style={estilos.btnTipo(formData.tipo === 'Retiro', false)}>
                    <TrendingDown size={18}/> Retiro
                </div>
            </div>
            <div>
                <label style={{display:'block', marginBottom:5, fontWeight:'bold', fontSize:'0.9rem'}}>Socio</label>
                <select value={formData.socio_id} onChange={e => setFormData({...formData, socio_id: e.target.value})} style={estilos.input} disabled={!!socioId || !!initialData} required>
                    <option value="">-- Seleccionar Socio --</option>
                    {socios.map(s => <option key={s.id} value={s.id}>{s.nombre}</option>)}
                </select>
            </div>
            <div>
                 <label style={{display:'block', marginBottom:5, fontWeight:'bold', fontSize:'0.9rem'}}>Monto</label>
                 <SmartMoneyInput value={formData.monto} onChange={v => setFormData({...formData, monto: v})} autoFocus/>
            </div>
            <div>
                <label style={{display:'block', marginBottom:5, fontWeight:'bold', fontSize:'0.9rem'}}>Fecha</label>
                <input type="date" value={formData.fecha} onChange={e => setFormData({...formData, fecha: e.target.value})} style={estilos.input} required/>
            </div>
            <div>
                <label style={{display:'block', marginBottom:5, fontWeight:'bold', fontSize:'0.9rem'}}>Descripci√≥n (Opcional)</label>
                <input type="text" value={formData.descripcion} onChange={e => setFormData({...formData, descripcion: e.target.value})} style={estilos.input} placeholder="Ej: Aporte inicial..." />
            </div>
            <button type="submit" style={estilos.btnSave} disabled={loading}>
                {loading ? 'Guardando...' : (initialData ? 'Actualizar Movimiento' : 'Confirmar Movimiento')}
            </button>
        </form>
    )
}

// --- VISTA PRINCIPAL ---

function CuentasSocios() {
  const [socios, setSocios] = useState([])
  const [movimientos, setMovimientos] = useState([])
  const [loading, setLoading] = useState(true)
  
  // ESTADOS DE UI
  const [activeTab, setActiveTab] = useState('resumen')
  
  // Modales
  const [modalOpen, setModalOpen] = useState(false)
  const [modalConfig, setModalConfig] = useState({ socioId: null, tipo: 'Aporte', data: null })
  const [modalGastoOpen, setModalGastoOpen] = useState(false)
  const [gastoEditarId, setGastoEditarId] = useState(null)

  // --- FILTROS Y ORDENAMIENTO ---
  const [sortSocios, setSortSocios] = useState('nombre') 
  
  // Filtros de Historial
  const [filtros, setFiltros] = useState({
      tipo: 'Todos',    
      socio: 'Todos',   
      year: 'Todos',    
      month: 'Todos'    
  })
  
  const [sortConfig, setSortConfig] = useState({ key: 'fecha', direction: 'desc' })

  const formatMoney = (val) => '$ ' + Math.round(val).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")
  const formatDate = (f) => f ? f.split('-').reverse().join('/') : '-'

  useEffect(() => { cargarDatos() }, [])

  async function cargarDatos() {
    setLoading(true)
    try {
        // 1. Cargar Socios (Vista de saldos)
        const { data: dataSocios, error: errSocios } = await supabase.from('vista_saldo_socios').select('*')
        if (errSocios) throw errSocios

        // 2. Cargar Movimientos
        const { data: dataMovs, error: errMovs } = await supabase
            .from('movimientos_billetera')
            .select('*')
            .order('fecha', { ascending: false })
            .limit(500)
        
        if (errMovs) throw errMovs

        // 3. Cruzar datos manualmente
        const movimientosEnriquecidos = (dataMovs || []).map(m => {
            const socioInfo = (dataSocios || []).find(s => s.socio_id === m.socio_id)
            return {
                ...m,
                socios: { nombre: socioInfo ? socioInfo.socio_nombre : 'Socio Desconocido' }
            }
        })

        setSocios(dataSocios || [])
        setMovimientos(movimientosEnriquecidos)

    } catch (error) {
        console.error("Error al cargar datos:", error)
        alert("Error cargando datos: " + error.message)
    } finally {
        setLoading(false)
    }
  }

  // Detectar Origen
  const parseOrigen = (descripcion) => {
      const desc = descripcion || ''
      const matchGasto = desc.match(/\[GID:(\d+)\]/)
      const gastoId = matchGasto ? matchGasto[1] : null

      if (gastoId || desc.includes('Pago Gasto')) {
          return { 
              esSistema: true,
              gastoId: gastoId,
              tipo: 'Gasto', 
              label: 'Pago Gasto', 
              icono: <ShoppingBag size={14} color="#4b5563"/>,
              detalle: desc.replace(/\[GID:.*?\]/, '').replace('Pago Gasto:', '').trim() 
          }
      }
      return { 
          esSistema: false,
          gastoId: null,
          tipo: 'Manual', 
          label: 'Directo', 
          icono: <User size={14} color="#4b5563"/>,
          detalle: desc || 'Sin descripci√≥n'
      }
  }

  const handleEditar = (mov) => {
      const info = parseOrigen(mov.descripcion)
      if (info.esSistema && info.gastoId) {
          setGastoEditarId(info.gastoId)
          setModalGastoOpen(true)
      } else if (info.esSistema && !info.gastoId) {
          alert("Este movimiento es de sistema pero no encuentro el ID del gasto original para editarlo.")
      } else {
          setModalConfig({ socioId: null, tipo: mov.tipo, data: mov })
          setModalOpen(true)
      }
  }

  const handleEliminar = async (mov) => {
      const info = parseOrigen(mov.descripcion)
      
      // LOGICA DE BORRADO SEGURA PERO PERMISIVA
      if (info.esSistema) {
           // Permitimos borrar pero con advertencia fuerte para limpiar registros hu√©rfanos
           if(!confirm("‚ö†Ô∏è ADVERTENCIA: Este registro est√° vinculado a un Gasto.\n\nSi el gasto original ya no existe, este registro es un residuo y puedes borrarlo.\n\n¬øEst√°s seguro de que deseas FORZAR el borrado?")) {
               return;
           }
      } else {
           if (!confirm("¬øEliminar movimiento permanentemente?")) return;
      }

      const { error } = await supabase.from('movimientos_billetera').delete().eq('id', mov.id)
      if (error) alert("Error al eliminar: " + error.message)
      else cargarDatos()
  }

  // --- L√ìGICA DE DATOS ---

  const getSociosOrdenados = () => {
      const lista = [...socios]
      if (sortSocios === 'nombre') return lista.sort((a, b) => a.socio_nombre.localeCompare(b.socio_nombre))
      if (sortSocios === 'saldo_desc') return lista.sort((a, b) => b.saldo_actual - a.saldo_actual)
      if (sortSocios === 'saldo_asc') return lista.sort((a, b) => a.saldo_actual - b.saldo_actual)
      return lista
  }

  const handleSort = (key) => {
      setSortConfig(prev => ({
          key,
          direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
      }))
  }

  const getMovimientosProcesados = () => {
      let data = movimientos.filter(m => {
          if (filtros.tipo !== 'Todos' && m.tipo !== filtros.tipo) return false
          if (filtros.socio !== 'Todos' && m.socio_id.toString() !== filtros.socio) return false
          const [anio, mes] = m.fecha.split('-') 
          if (filtros.year !== 'Todos' && anio !== filtros.year) return false
          if (filtros.month !== 'Todos' && parseInt(mes).toString() !== filtros.month) return false
          return true
      })

      data.sort((a, b) => {
          let valA = a[sortConfig.key]
          let valB = b[sortConfig.key]
          if (sortConfig.key === 'socio') {
              valA = a.socios?.nombre || ''
              valB = b.socios?.nombre || ''
          }
          if (sortConfig.key === 'monto') {
              valA = parseFloat(valA)
              valB = parseFloat(valB)
          }
          if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1
          if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1
          return 0
      })
      return data
  }

  const styles = {
    container: { width: '90%', maxWidth: '1400px', margin: '0 auto', padding: '20px 0' },
    
    headerRow: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 },
    title: { fontSize: '1.5rem', fontWeight: 'bold', color: '#111827', display:'flex', alignItems:'center', gap:10 },
    
    tabsContainer: { display:'flex', gap:5, backgroundColor:'#e5e7eb', padding:4, borderRadius:8 },
    tabBtn: (active) => ({
        padding:'8px 16px', borderRadius:6, border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.9rem',
        backgroundColor: active ? 'white' : 'transparent', color: active ? '#111827' : '#6b7280', display:'flex', gap:8, alignItems:'center',
        boxShadow: active ? '0 1px 3px rgba(0,0,0,0.1)' : 'none'
    }),
    
    filterBar: { 
        display: 'flex', gap: 12, alignItems: 'center', marginBottom: 20, flexWrap:'wrap', 
        backgroundColor: '#f9fafb', padding: '15px', borderRadius: '12px', border: '1px solid #e5e7eb'
    },
    labelFilter: { fontSize: '0.85rem', fontWeight: 'bold', color: '#4b5563', marginRight: 5 },
    selectControl: { padding: '8px', borderRadius: 6, border: '1px solid #d1d5db', fontSize: '0.9rem', color: '#374151', minWidth: 120 },
    
    btnNew: { backgroundColor: '#1f2937', color: 'white', border: 'none', padding: '10px 20px', borderRadius: 8, fontWeight: 'bold', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 8, marginLeft:'auto' },

    gridSocios: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(320px, 1fr))', gap: '20px' },
    cardSocio: { backgroundColor: 'white', borderRadius: '16px', border: '1px solid #e5e7eb', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', overflow: 'hidden' },
    cardHeader: { padding: '15px 20px', borderBottom: '1px solid #f9fafb', display: 'flex', justifyContent: 'space-between', alignItems: 'center', backgroundColor: '#fff' },
    socioName: { fontSize: '1.1rem', fontWeight: 'bold', color: '#1f2937' },
    cardBody: { padding: '20px', textAlign: 'center' },
    saldoMain: { fontSize: '2.2rem', fontWeight: '800', color: '#111827', margin: '10px 0' },
    statsRow: { display: 'flex', justifyContent: 'space-around', marginTop: 15, padding: '10px', backgroundColor: '#f9fafb', borderRadius: 8 },
    statVal: { fontWeight: 'bold', fontSize: '0.9rem', color: '#374151' },
    statLabel: { fontSize: '0.7rem', color: '#9ca3af', textTransform: 'uppercase' },
    cardActions: { padding: '15px', display: 'flex', gap: '10px', borderTop: '1px solid #f3f4f6' },
    btnAction: (tipo) => ({
        flex: 1, padding: '8px', borderRadius: '6px', border: 'none', cursor: 'pointer', fontWeight: 'bold', fontSize: '0.85rem', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 5,
        backgroundColor: tipo === 'Aporte' ? '#f0fdf4' : '#fef2f2',
        color: tipo === 'Aporte' ? '#166534' : '#991b1b',
        border: `1px solid ${tipo === 'Aporte' ? '#bbf7d0' : '#fecaca'}`
    }),

    tableContainer: { backgroundColor: 'white', borderRadius: '10px', border: '1px solid #e5e7eb', overflow: 'hidden' },
    table: { width: '100%', borderCollapse: 'collapse', fontSize: '0.9rem' },
    th: { textAlign: 'left', padding: '12px 15px', backgroundColor: '#f9fafb', color: '#6b7280', fontSize: '0.75rem', fontWeight: 'bold', textTransform: 'uppercase', borderBottom: '1px solid #e5e7eb', cursor: 'pointer', userSelect: 'none' },
    td: { padding: '12px 15px', borderBottom: '1px solid #f3f4f6', color: '#374151', verticalAlign:'middle' },
    badge: (tipo) => ({
        padding: '2px 8px', borderRadius: '12px', fontSize: '0.75rem', fontWeight: 'bold',
        backgroundColor: tipo === 'Aporte' ? '#dcfce7' : '#fee2e2', color: tipo === 'Aporte' ? '#166534' : '#991b1b'
    }),
    origenBadge: { display: 'inline-flex', alignItems: 'center', gap: 6, padding: '4px 8px', backgroundColor: '#f3f4f6', borderRadius: '6px', fontSize: '0.75rem', color: '#4b5563', border: '1px solid #e5e7eb' },
    btnIcon: { border: 'none', background: 'none', cursor: 'pointer', padding: 4 }
  }

  // --- MODIFICADO: ACEPTA ALIGN Y CENTRADO POR DEFECTO PARA MONTO ---
  const ThSort = ({ k, label, align = 'left' }) => (
      <th style={{...styles.th, textAlign: align}} onClick={() => handleSort(k)}>
          <div style={{display:'flex', alignItems:'center', gap:5, justifyContent: align === 'right' ? 'flex-end' : (align === 'center' ? 'center' : 'flex-start')}}>
              {label}
              {sortConfig.key === k && (
                  <ArrowUpDown size={14} color={sortConfig.direction === 'asc' ? '#2563eb' : '#9ca3af'} />
              )}
          </div>
      </th>
  )

  const movsFiltrados = getMovimientosProcesados()

  return (
    <div style={styles.container}>
        <div style={styles.headerRow}>
            <h1 style={styles.title}><Users size={28}/> Socios & Capital</h1>
            
            <div style={styles.tabsContainer}>
                <button onClick={() => setActiveTab('resumen')} style={styles.tabBtn(activeTab === 'resumen')}>
                    <LayoutGrid size={16}/> Resumen
                </button>
                <button onClick={() => setActiveTab('historial')} style={styles.tabBtn(activeTab === 'historial')}>
                    <List size={16}/> Historial
                </button>
            </div>
        </div>

        {activeTab === 'resumen' && (
            <div>
                <div style={{...styles.filterBar, justifyContent:'flex-end'}}>
                    <div style={{display:'flex', alignItems:'center', gap:8, fontSize:'0.9rem', color:'#6b7280'}}>
                        <ArrowUpDown size={16}/> Ordenar por:
                    </div>
                    <select value={sortSocios} onChange={e => setSortSocios(e.target.value)} style={styles.selectControl}>
                        <option value="nombre">Alfab√©tico (A-Z)</option>
                        <option value="saldo_desc">Mayor Saldo</option>
                        <option value="saldo_asc">Menor Saldo</option>
                    </select>
                    
                    <button 
                        onClick={() => { setModalConfig({ socioId: null, tipo: 'Aporte', data: null }); setModalOpen(true) }}
                        style={styles.btnNew}
                    >
                        <Wallet size={18}/> Registrar Movimiento
                    </button>
                </div>

                <div style={styles.gridSocios}>
                    {getSociosOrdenados().map(socio => (
                        <div key={socio.socio_id || socio.id} style={styles.cardSocio}>
                            <div style={styles.cardHeader}>
                                <span style={styles.socioName}>{socio.socio_nombre}</span>
                                <div style={{backgroundColor:(socio.saldo_actual||0)>=0?'#d1fae5':'#fee2e2', borderRadius:'50%', padding:5}}>
                                    {(socio.saldo_actual||0)>=0 ? <TrendingUp size={16} color="#059669"/> : <TrendingDown size={16} color="#dc2626"/>}
                                </div>
                            </div>
                            <div style={styles.cardBody}>
                                <div style={{fontSize:'0.8rem', color:'#6b7280'}}>Saldo Disponible</div>
                                <div style={{...styles.saldoMain, color: (socio.saldo_actual || 0) >= 0 ? '#111827' : '#dc2626'}}>
                                    {formatMoney(socio.saldo_actual || 0)}
                                </div>
                                <div style={styles.statsRow}>
                                    <div>
                                        <div style={{...styles.statVal, color:'#059669'}}>+ {formatMoney(socio.total_invertido || 0)}</div>
                                        <div style={styles.statLabel}>Aportado</div>
                                    </div>
                                    <div style={{width:1, backgroundColor:'#e5e7eb'}}></div>
                                    <div>
                                        <div style={{...styles.statVal, color:'#d97706'}}>- {formatMoney(socio.total_recuperado || 0)}</div>
                                        <div style={styles.statLabel}>Retirado</div>
                                    </div>
                                </div>
                            </div>
                            <div style={styles.cardActions}>
                                <button style={styles.btnAction('Aporte')} onClick={() => { setModalConfig({ socioId: socio.socio_id, tipo: 'Aporte', data: null }); setModalOpen(true) }}>
                                    <Plus size={14}/> Aportar
                                </button>
                                <button style={styles.btnAction('Retiro')} onClick={() => { setModalConfig({ socioId: socio.socio_id, tipo: 'Retiro', data: null }); setModalOpen(true) }}>
                                    <Minus size={14}/> Retirar
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        )}

        {activeTab === 'historial' && (
            <div>
                <div style={styles.filterBar}>
                    <div style={{display:'flex', alignItems:'center'}}>
                        <span style={styles.labelFilter}>A√±o:</span>
                        <select value={filtros.year} onChange={e => setFiltros({...filtros, year: e.target.value})} style={styles.selectControl}>
                            <option value="Todos">Todos</option>
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                        </select>
                    </div>

                    <div style={{display:'flex', alignItems:'center'}}>
                        <span style={styles.labelFilter}>Mes:</span>
                        <select value={filtros.month} onChange={e => setFiltros({...filtros, month: e.target.value})} style={styles.selectControl}>
                            <option value="Todos">Todos</option>
                            {['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'].map((m, i) => (
                                <option key={i} value={(i+1).toString()}>{m}</option>
                            ))}
                        </select>
                    </div>

                    <div style={{display:'flex', alignItems:'center'}}>
                        <span style={styles.labelFilter}>Socio:</span>
                        <select value={filtros.socio} onChange={e => setFiltros({...filtros, socio: e.target.value})} style={styles.selectControl}>
                            <option value="Todos">Todos</option>
                            {socios.map(s => (
                                <option key={s.socio_id} value={s.socio_id.toString()}>{s.socio_nombre}</option>
                            ))}
                        </select>
                    </div>

                    <div style={{display:'flex', alignItems:'center'}}>
                        <span style={styles.labelFilter}>Tipo:</span>
                        <select value={filtros.tipo} onChange={e => setFiltros({...filtros, tipo: e.target.value})} style={styles.selectControl}>
                            <option value="Todos">Todos</option>
                            <option value="Aporte">Aportes</option>
                            <option value="Retiro">Retiros</option>
                        </select>
                    </div>
                    
                    <button 
                        onClick={() => { setModalConfig({ socioId: null, tipo: 'Aporte', data: null }); setModalOpen(true) }}
                        style={styles.btnNew}
                    >
                        <Wallet size={18}/> Registrar
                    </button>
                </div>
                
                <div style={{marginBottom:10, textAlign:'right', fontSize:'0.85rem', color:'#6b7280'}}>
                    <strong>{movsFiltrados.length}</strong> movimientos encontrados
                </div>

                <div style={styles.tableContainer}>
                    <table style={styles.table}>
                        <thead>
                            <tr>
                                <ThSort k="fecha" label="Fecha" />
                                <ThSort k="socio" label="Socio" />
                                <ThSort k="tipo" label="Tipo" />
                                <th style={styles.th}>Origen</th>
                                <th style={styles.th}>Detalle</th>
                                {/* CENTRADO */}
                                <ThSort k="monto" label="Monto" align="center"/>
                                <th style={{...styles.th, width: 80}}>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {movsFiltrados.length === 0 ? (
                                <tr><td colSpan="7" style={{padding:40, textAlign:'center', color:'#9ca3af', fontStyle:'italic'}}>No hay movimientos con estos filtros.</td></tr>
                            ) : movsFiltrados.map(mov => {
                                const infoOrigen = parseOrigen(mov.descripcion)
                                return (
                                    <tr key={mov.id}>
                                        <td style={styles.td}>{formatDate(mov.fecha)}</td>
                                        <td style={{...styles.td, fontWeight:'bold'}}>{mov.socios?.nombre || 'Desconocido'}</td>
                                        <td style={styles.td}>
                                            <span style={styles.badge(mov.tipo)}>{mov.tipo}</span>
                                        </td>
                                        <td style={styles.td}>
                                            <div style={styles.origenBadge}>
                                                {infoOrigen.icono} 
                                                <span>{infoOrigen.label}</span>
                                            </div>
                                        </td>
                                        <td style={styles.td}>{infoOrigen.detalle}</td>
                                        {/* CENTRADO */}
                                        <td style={{...styles.td, textAlign:'center', fontWeight:'bold', fontFamily:'monospace'}}>
                                            {formatMoney(mov.monto)}
                                        </td>
                                        <td style={styles.td}>
                                            <div style={{display:'flex', justifyContent:'flex-end', gap:5}}>
                                                <button 
                                                    onClick={() => handleEditar(mov)} 
                                                    title={infoOrigen.esSistema ? "Editar Documento Original" : "Editar Movimiento"}
                                                    style={{...styles.btnIcon, color: infoOrigen.esSistema ? '#2563eb' : '#4b5563', backgroundColor: infoOrigen.esSistema ? '#eff6ff' : 'transparent', borderRadius:'4px'}}
                                                >
                                                    {infoOrigen.esSistema ? <FileText size={16}/> : <Pencil size={16}/>}
                                                </button>

                                                <button 
                                                    onClick={() => handleEliminar(mov)} 
                                                    style={{...styles.btnIcon, color: infoOrigen.esSistema ? '#d1d5db' : '#ef4444', cursor: 'pointer'}} 
                                                    title="Eliminar registro"
                                                >
                                                    <Trash2 size={16}/>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                )
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        )}

        <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title={modalConfig.data ? "Editar Movimiento" : "Registrar Movimiento"}>
            {modalOpen && (
                <FormularioMovimiento 
                    socioId={modalConfig.socioId}
                    tipoInicial={modalConfig.tipo}
                    initialData={modalConfig.data}
                    cerrar={() => setModalOpen(false)}
                    alGuardar={() => { setModalOpen(false); cargarDatos(); }}
                />
            )}
        </Modal>

        <Modal isOpen={modalGastoOpen} onClose={() => setModalGastoOpen(false)} title="Editar Documento / Gasto">
            {modalGastoOpen && (
                <NuevoGasto 
                    idGasto={gastoEditarId} 
                    cerrarModal={() => setModalGastoOpen(false)} 
                    alGuardar={() => { setModalGastoOpen(false); cargarDatos(); }} 
                />
            )}
        </Modal>

    </div>
  )
}

export default CuentasSocios

================================================================================
ARCHIVO: src/pages/Bitacora.jsx
================================================================================

import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { 
    StickyNote, Plus, Trash2, Calendar, Pencil, AlertTriangle, 
    Paperclip, CheckCircle2, Clock, ChevronDown, ChevronUp, 
    CheckSquare, Square, Save 
} from 'lucide-react'
import Modal from '../components/Modal'
import NuevaNota from './NuevaNota'

function Bitacora() {
  const [notas, setNotas] = useState([])
  const [loading, setLoading] = useState(true)
  
  // Control de acorde√≥n
  const [expandedIds, setExpandedIds] = useState(new Set())

  // Estado para inputs de "Nueva Tarea R√°pida" (Mapa: ID Nota -> Texto Input)
  const [inputStates, setInputStates] = useState({})

  // Filtros
  const [filtroTipo, setFiltroTipo] = useState('Todos') 

  // Modal
  const [modalOpen, setModalOpen] = useState(false)
  const [notaEditar, setNotaEditar] = useState(null)

  useEffect(() => { cargarNotas() }, [])

  async function cargarNotas() {
    setLoading(true)
    const { data } = await supabase.from('bitacora').select('*').order('created_at', { ascending: false })
    setNotas(data || [])
    setLoading(false)
  }

  const borrarNota = async (id, e) => {
      e.stopPropagation()
      if(confirm("¬øEliminar esta nota permanentemente?")) {
          await supabase.from('bitacora').delete().eq('id', id)
          cargarNotas()
      }
  }

  const toggleExpand = (id, e) => {
      e.stopPropagation()
      const newSet = new Set(expandedIds)
      if (newSet.has(id)) newSet.delete(id)
      else newSet.add(id)
      setExpandedIds(newSet)
  }

  // --- L√ìGICA TAREAS ---

  // 1. Marcar completado
  const toggleTarea = async (nota, tareaId, e) => {
      e.stopPropagation() 

      const nuevoChecklist = nota.checklist.map(item => 
          item.id === tareaId ? { ...item, hecho: !item.hecho } : item
      )

      // Optimista
      setNotas(prev => prev.map(n => n.id === nota.id ? { ...n, checklist: nuevoChecklist } : n))

      await supabase.from('bitacora').update({ checklist: nuevoChecklist }).eq('id', nota.id)
  }

  // 2. Manejar Input de Nueva Tarea
  const handleInputChange = (id, valor) => {
      setInputStates(prev => ({ ...prev, [id]: valor }))
  }

  // 3. Agregar Tarea Directamente
  const addTareaDirecta = async (nota, e) => {
      e.preventDefault()
      e.stopPropagation()

      const texto = inputStates[nota.id]
      if (!texto || !texto.trim()) return

      const nuevaTarea = {
          id: Date.now(),
          texto: texto,
          hecho: false
      }

      const nuevoChecklist = [...(nota.checklist || []), nuevaTarea]

      // Optimista
      setNotas(prev => prev.map(n => n.id === nota.id ? { ...n, checklist: nuevoChecklist } : n))
      
      // Limpiar input
      setInputStates(prev => ({ ...prev, [nota.id]: '' }))

      // Guardar BD
      const { error } = await supabase.from('bitacora').update({ checklist: nuevoChecklist }).eq('id', nota.id)
      
      if (error) {
          console.error(error)
          cargarNotas() // Revertir si falla
      }
  }

  // --- FILTROS Y UI ---

  const getNotasFiltradas = () => {
      if (filtroTipo === 'Todos') return notas
      if (filtroTipo === 'Importante') return notas.filter(n => n.importante)
      return notas.filter(n => n.tipo === filtroTipo)
  }

  const formatDate = (dateString) => {
      if (!dateString) return ''
      const date = new Date(dateString)
      return date.toLocaleDateString('es-CL', { day: 'numeric', month: 'short' })
  }

  const styles = {
    container: { width: '90%', maxWidth: '1000px', margin: '0 auto', padding: '20px 0' },
    header: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 30 },
    title: { fontSize: '1.5rem', fontWeight: 'bold', color: '#111827', display:'flex', alignItems:'center', gap:10 },
    tabs: { display: 'flex', gap: 8, marginBottom: 30, flexWrap:'wrap' },
    tab: (active, isAlert) => ({
        padding: '6px 14px', borderRadius: '20px', border: active ? '1px solid transparent' : '1px solid #e5e7eb',
        cursor: 'pointer', fontWeight: 'bold', fontSize: '0.85rem',
        backgroundColor: active ? (isAlert ? '#fee2e2' : '#1f2937') : 'white',
        color: active ? (isAlert ? '#991b1b' : 'white') : '#4b5563',
        transition: 'all 0.2s', display:'flex', alignItems:'center', gap:6
    }),
    timeline: { position: 'relative', borderLeft: '2px solid #e5e7eb', marginLeft: '20px', paddingLeft: '30px' },
    itemWrapper: { marginBottom: '30px', position: 'relative' },
    dot: (tipo) => ({
        position: 'absolute', left: '-39px', top: '15px', width: '16px', height: '16px', borderRadius: '50%',
        backgroundColor: tipo === 'Incidente' ? '#ef4444' : (tipo === 'Hito' ? '#3b82f6' : '#10b981'),
        border: '4px solid #f3f4f6'
    }),
    card: (importante) => ({
        backgroundColor: 'white', borderRadius: '12px', 
        border: importante ? '1px solid #fecaca' : '1px solid #e5e7eb',
        boxShadow: importante ? '0 4px 6px -1px rgba(220, 38, 38, 0.1)' : '0 2px 4px rgba(0,0,0,0.05)',
        overflow: 'hidden', cursor: 'pointer', transition: 'all 0.2s'
    }),
    cardHeader: { padding: '15px', borderBottom: '1px solid #f9fafb', display:'flex', justifyContent:'space-between', alignItems:'start' },
    cardBody: { padding: '15px', color: '#374151', fontSize: '0.95rem', whiteSpace: 'pre-line' },
    badge: { fontSize:'0.7rem', textTransform:'uppercase', fontWeight:'bold', padding:'2px 8px', borderRadius:'10px', backgroundColor:'#f3f4f6', color:'#4b5563' },
    dateTag: { fontSize:'0.8rem', color:'#6b7280', display:'flex', alignItems:'center', gap:5 },
    cardFooter: { 
        padding: '10px 15px', backgroundColor: '#f9fafb', display:'flex', justifyContent:'space-between', alignItems:'center', 
        fontSize:'0.8rem', color:'#6b7280', borderTop: '1px solid #f3f4f6' 
    },
    expandedArea: { padding: '15px', backgroundColor: '#fff', borderTop: '1px solid #f3f4f6' },
    
    checkRow: { 
        display: 'flex', alignItems: 'flex-start', gap: 10, marginBottom: 8, fontSize: '0.9rem',
        cursor: 'pointer', padding: '4px', borderRadius: '4px', transition: 'background 0.1s'
    },
    adjuntoLink: { display: 'inline-flex', alignItems: 'center', gap: 6, padding: '4px 10px', backgroundColor: '#f3f4f6', borderRadius: '4px', fontSize: '0.8rem', color: '#2563eb', textDecoration: 'none', marginRight: 10, marginBottom: 5 },
    
    // Input r√°pido
    quickAddRow: { display: 'flex', gap: 8, marginTop: 15, paddingTop: 10, borderTop: '1px dashed #e5e7eb' },
    quickInput: { flex: 1, padding: '6px 10px', borderRadius: '6px', border: '1px solid #d1d5db', fontSize: '0.85rem' },
    quickBtn: { padding: '6px 12px', backgroundColor: '#f3f4f6', border: '1px solid #e5e7eb', borderRadius: '6px', cursor: 'pointer', display: 'flex', alignItems: 'center' }
  }

  const notasFiltradas = getNotasFiltradas()

  return (
    <div style={styles.container}>
        <div style={styles.header}>
            <h1 style={styles.title}><StickyNote size={28}/> Bit√°cora de Campo</h1>
            <button 
                onClick={() => { setNotaEditar(null); setModalOpen(true) }}
                style={{ backgroundColor:'#1f2937', color:'white', border:'none', padding:'10px 20px', borderRadius:'8px', fontWeight:'bold', cursor:'pointer', display:'flex', alignItems:'center', gap:8 }}
            >
                <Plus size={18}/> Nueva Nota
            </button>
        </div>

        <div style={styles.tabs}>
            <button onClick={() => setFiltroTipo('Todos')} style={styles.tab(filtroTipo === 'Todos')}>Todas</button>
            <button onClick={() => setFiltroTipo('Importante')} style={styles.tab(filtroTipo === 'Importante', true)}>
                <AlertTriangle size={14}/> Importantes
            </button>
            <button onClick={() => setFiltroTipo('Incidente')} style={styles.tab(filtroTipo === 'Incidente')}>Incidentes</button>
            <button onClick={() => setFiltroTipo('Tarea')} style={styles.tab(filtroTipo === 'Tarea')}>Tareas</button>
        </div>

        <div style={styles.timeline}>
            {loading ? <div style={{color:'#6b7280'}}>Cargando bit√°cora...</div> : notasFiltradas.map(nota => {
                const isExpanded = expandedIds.has(nota.id)
                const totalCheck = nota.checklist ? nota.checklist.length : 0
                const doneCheck = nota.checklist ? nota.checklist.filter(c => c.hecho).length : 0
                const totalAdjuntos = nota.adjuntos ? nota.adjuntos.length : 0
                const tieneExtras = totalCheck > 0 || totalAdjuntos > 0

                return (
                    <div key={nota.id} style={styles.itemWrapper}>
                        <div style={styles.dot(nota.tipo)}></div>
                        
                        <div style={styles.card(nota.importante)} onClick={() => { setNotaEditar(nota); setModalOpen(true) }}>
                            {/* HEADER */}
                            <div style={styles.cardHeader}>
                                <div>
                                    <div style={{display:'flex', alignItems:'center', gap:8, marginBottom:5}}>
                                        {nota.importante && <AlertTriangle size={16} color="#dc2626"/>}
                                        <h3 style={{margin:0, fontSize:'1.1rem', color:'#111827'}}>{nota.titulo}</h3>
                                    </div>
                                    <div style={{display:'flex', gap:8}}>
                                        <span style={styles.badge}>{nota.tipo}</span>
                                        <span style={styles.dateTag}><Calendar size={12}/> {formatDate(nota.fecha || nota.created_at)}</span>
                                        {nota.fecha_alerta && (
                                            <span style={{...styles.dateTag, color:'#d97706'}}><Clock size={12}/> Vence: {formatDate(nota.fecha_alerta)}</span>
                                        )}
                                    </div>
                                </div>
                                <div style={{display:'flex', gap:5}}>
                                    <button onClick={(e) => { e.stopPropagation(); setNotaEditar(nota); setModalOpen(true) }} style={{border:'none', background:'none', color:'#2563eb', cursor:'pointer'}}><Pencil size={16}/></button>
                                    <button onClick={(e) => borrarNota(nota.id, e)} style={{border:'none', background:'none', color:'#ef4444', cursor:'pointer'}}><Trash2 size={16}/></button>
                                </div>
                            </div>
                            
                            {/* BODY */}
                            {nota.contenido && (
                                <div style={styles.cardBody}>
                                    {nota.contenido.length > 150 && !isExpanded ? nota.contenido.substring(0, 150) + '...' : nota.contenido}
                                </div>
                            )}

                            {/* EXPANDED AREA */}
                            {isExpanded && (
                                <div style={styles.expandedArea} onClick={(e) => e.stopPropagation()}>
                                    
                                    {/* LISTA DE TAREAS */}
                                    {(totalCheck > 0 || true) && ( // Siempre visible para poder agregar tareas nuevas
                                        <div style={{marginBottom: 15}}>
                                            {totalCheck > 0 && (
                                                <div style={{fontSize:'0.75rem', fontWeight:'bold', color:'#9ca3af', marginBottom:8, textTransform:'uppercase'}}>Lista de Tareas</div>
                                            )}
                                            
                                            {nota.checklist && nota.checklist.map(item => (
                                                <div 
                                                    key={item.id} 
                                                    style={styles.checkRow}
                                                    onClick={(e) => toggleTarea(nota, item.id, e)}
                                                    onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#f3f4f6'}
                                                    onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                                                >
                                                    {item.hecho ? <CheckSquare size={18} color="#10b981"/> : <Square size={18} color="#d1d5db"/>}
                                                    <span style={{textDecoration: item.hecho ? 'line-through' : 'none', color: item.hecho ? '#9ca3af' : '#374151'}}>
                                                        {item.texto}
                                                    </span>
                                                </div>
                                            ))}

                                            {/* INPUT R√ÅPIDO PARA NUEVA TAREA */}
                                            <div style={styles.quickAddRow}>
                                                <input 
                                                    type="text" 
                                                    placeholder="Agregar tarea r√°pida..." 
                                                    value={inputStates[nota.id] || ''}
                                                    onChange={(e) => handleInputChange(nota.id, e.target.value)}
                                                    onKeyDown={(e) => e.key === 'Enter' && addTareaDirecta(nota, e)}
                                                    onClick={(e) => e.stopPropagation()} 
                                                    style={styles.quickInput}
                                                />
                                                <button onClick={(e) => addTareaDirecta(nota, e)} style={styles.quickBtn}>
                                                    <Plus size={16} color="#4b5563"/>
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    {/* LISTA ADJUNTOS */}
                                    {totalAdjuntos > 0 && (
                                        <div>
                                            <div style={{fontSize:'0.75rem', fontWeight:'bold', color:'#9ca3af', marginBottom:8, textTransform:'uppercase'}}>Archivos Adjuntos</div>
                                            <div style={{display:'flex', flexWrap:'wrap'}}>
                                                {nota.adjuntos.map((file, idx) => (
                                                    <a key={idx} href={file.url} target="_blank" rel="noopener noreferrer" style={styles.adjuntoLink}>
                                                        <Paperclip size={14}/> {file.nombre}
                                                    </a>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* FOOTER */}
                            <div style={styles.cardFooter} onClick={(e) => toggleExpand(nota.id, e)}>
                                <div style={{display:'flex', gap:15}}>
                                    {(totalCheck > 0) ? (
                                        <div style={{display:'flex', alignItems:'center', gap:5, color: doneCheck === totalCheck ? '#059669' : '#6b7280'}}>
                                            <CheckCircle2 size={14}/> {doneCheck}/{totalCheck} Tareas
                                        </div>
                                    ) : (
                                        <div style={{color:'#9ca3af'}}>Sin tareas</div>
                                    )}
                                    {totalAdjuntos > 0 && (
                                        <div style={{display:'flex', alignItems:'center', gap:5}}>
                                            <Paperclip size={14}/> {totalAdjuntos}
                                        </div>
                                    )}
                                </div>
                                
                                <div style={{display:'flex', alignItems:'center', gap:5, cursor:'pointer', fontWeight:'bold', color:'#374151'}}>
                                    {isExpanded ? 'Contraer' : 'Ver / A√±adir'}
                                    {isExpanded ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}
                                </div>
                            </div>

                        </div>
                    </div>
                )
            })}
            
            {notasFiltradas.length === 0 && !loading && (
                <div style={{padding:'20px', color:'#9ca3af', fontStyle:'italic'}}>No se encontraron registros.</div>
            )}
        </div>

        <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title={notaEditar ? "Editar Nota" : "Nueva Entrada"}>
            {modalOpen && (
                <NuevaNota 
                    notaEditar={notaEditar} 
                    cerrarModal={() => setModalOpen(false)} 
                    alGuardar={() => { setModalOpen(false); cargarNotas(); }}
                />
            )}
        </Modal>
    </div>
  )
}

export default Bitacora

================================================================================
ARCHIVO: src/pages/Clientes.jsx
================================================================================

import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Users, Plus, Pencil, Archive, Search, ArrowUpDown, Mail, Phone, MapPin, UserCheck } from 'lucide-react' // Usamos Archive en vez de Trash2
import Modal from '../components/Modal'
import NuevoCliente from './NuevoCliente'

function Clientes() {
  const [clientes, setClientes] = useState([])
  const [filtro, setFiltro] = useState('')
  const [sortConfig, setSortConfig] = useState({ key: 'nombre', direction: 'asc' })
  
  const [modalOpen, setModalOpen] = useState(false)
  const [editId, setEditId] = useState(null)

  useEffect(() => {
    cargarClientes()
  }, [])

  async function cargarClientes() {
    // FILTRO: Solo cargamos los activos
    const { data } = await supabase
        .from('clientes')
        .select('*')
        .eq('activo', true) 
        .order('nombre')
    setClientes(data || [])
  }

  const handleSort = (key) => {
    setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc' }))
  }

  const sortedData = [...clientes].sort((a, b) => {
    let valA = (a[sortConfig.key] || '').toString().toLowerCase()
    let valB = (b[sortConfig.key] || '').toString().toLowerCase()
    if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1
    if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1
    return 0
  }).filter(c => 
    c.nombre.toLowerCase().includes(filtro.toLowerCase()) || 
    (c.rut && c.rut.includes(filtro))
  )

  // CAMBIO: Borrado L√≥gico (Archivar)
  const archivar = async (id) => {
      if(confirm("¬øArchivar este cliente? Se mantendr√° el historial pero no aparecer√° en listas nuevas.")) {
          const { error } = await supabase.from('clientes').update({ activo: false }).eq('id', id)
          if(error) alert('Error al archivar: ' + error.message)
          else cargarClientes()
      }
  }

  // Helper para mostrar resumen de contactos
  const RenderContactos = ({ contactos }) => {
      if (!contactos || contactos.length === 0) return <span style={{color:'#9ca3af', fontStyle:'italic', fontSize:'0.8rem'}}>Sin contactos</span>
      
      const principal = contactos[0]
      const extra = contactos.length - 1

      return (
          <div style={{display:'flex', flexDirection:'column', gap:2}}>
              <div style={{display:'flex', alignItems:'center', gap:4, fontWeight:'500', fontSize:'0.85rem'}}>
                 <UserCheck size={13} color="#4b5563"/> {principal.nombre}
              </div>
              <div style={{fontSize:'0.75rem', color:'#6b7280', paddingLeft:18}}>
                  {principal.cargo || 'Contacto'} 
                  {extra > 0 && <span style={{marginLeft:5, backgroundColor:'#e5e7eb', padding:'0 4px', borderRadius:4, fontSize:'0.7rem'}}>+{extra} m√°s</span>}
              </div>
          </div>
      )
  }

  // Estilos
  const styles = {
    container: { padding: '20px', width: '90%', margin: '0 auto', maxWidth: '1200px' },
    header: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' },
    title: { display: 'flex', alignItems: 'center', gap: '10px', fontSize: '1.5rem', fontWeight: 'bold', color: '#1f2937' },
    search: { padding: '8px 12px', borderRadius: '6px', border: '1px solid #d1d5db', width: '250px' },
    btnNew: { backgroundColor: '#1f2937', color: 'white', padding: '10px 15px', borderRadius: '8px', border: 'none', cursor: 'pointer', display: 'flex', gap: 5, alignItems: 'center' },
    
    tableContainer: { backgroundColor: 'white', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', border: '1px solid #e5e7eb' },
    table: { width: '100%', borderCollapse: 'collapse' },
    th: { backgroundColor: '#f9fafb', padding: '12px', textAlign: 'left', fontSize: '0.85rem', color: '#6b7280', fontWeight: '600', cursor: 'pointer', borderBottom:'1px solid #e5e7eb' },
    td: { padding: '12px', borderBottom: '1px solid #f9fafb', fontSize: '0.9rem', color: '#374151' },
    
    chip: { display:'inline-flex', alignItems:'center', gap:5, padding:'2px 8px', borderRadius:'12px', backgroundColor:'#f3f4f6', color:'#4b5563', fontSize:'0.8rem', marginRight:5 }
  }

  const ThSort = ({ label, sortKey }) => (
    <th style={styles.th} onClick={() => handleSort(sortKey)}>
        <div style={{display:'flex', alignItems:'center', gap:5}}>
            {label} {sortConfig.key === sortKey && <ArrowUpDown size={14}/>}
        </div>
    </th>
  )

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><Users /> Clientes</h1>
        <div style={{display:'flex', gap:10}}>
            <div style={{position:'relative'}}>
                <Search size={16} style={{position:'absolute', left:10, top:10, color:'#9ca3af'}}/>
                <input type="text" placeholder="Buscar..." value={filtro} onChange={e => setFiltro(e.target.value)} style={{...styles.search, paddingLeft:35}} />
            </div>
            <button onClick={() => { setEditId(null); setModalOpen(true) }} style={styles.btnNew}><Plus size={18}/> Nuevo</button>
        </div>
      </div>

      <div style={styles.tableContainer}>
        <table style={styles.table}>
            <thead>
                <tr>
                    <ThSort label="Empresa / Raz√≥n Social" sortKey="nombre" />
                    <ThSort label="RUT" sortKey="rut" />
                    <th style={styles.th}>Contactos Clave</th>
                    <ThSort label="Ubicaci√≥n" sortKey="direccion" />
                    <th style={styles.th}></th>
                </tr>
            </thead>
            <tbody>
                {sortedData.map(c => (
                    <tr key={c.id}>
                        <td style={styles.td}>
                            <strong>{c.nombre}</strong>
                            <div style={{fontSize:'0.8rem', color:'#6b7280'}}>{c.tipo}</div>
                        </td>
                        <td style={styles.td}>{c.rut || '-'}</td>
                        <td style={styles.td}>
                           {/* Renderizamos los contactos guardados en JSON */}
                           <RenderContactos contactos={c.contactos} />
                           {/* Si hay contacto general (legacy), lo mostramos si no hay contactos espec√≠ficos */}
                           {(!c.contactos || c.contactos.length === 0) && c.email && 
                              <div style={{marginTop:4}}><span style={styles.chip}><Mail size={10}/> {c.email}</span></div>
                           }
                        </td>
                        <td style={styles.td}>
                            {c.direccion && <span style={{display:'flex', alignItems:'center', gap:4, color:'#6b7280'}}><MapPin size={14}/> {c.direccion}</span>}
                        </td>
                        <td style={styles.td}>
                            <div style={{display:'flex', gap:5, justifyContent:'flex-end'}}>
                                <button onClick={() => { setEditId(c.id); setModalOpen(true) }} style={{border:'none', background:'none', color:'#2563eb', cursor:'pointer'}}><Pencil size={16}/></button>
                                <button onClick={() => archivar(c.id)} style={{border:'none', background:'none', color:'#d97706', cursor:'pointer'}} title="Archivar"><Archive size={16}/></button>
                            </div>
                        </td>
                    </tr>
                ))}
                {sortedData.length === 0 && <tr><td colSpan="5" style={{textAlign:'center', padding:30, color:'#9ca3af'}}>No se encontraron clientes activos.</td></tr>}
            </tbody>
        </table>
      </div>

      <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title={editId ? "Editar Cliente" : "Nuevo Cliente"}>
        {modalOpen && <NuevoCliente idCliente={editId} cerrarModal={() => setModalOpen(false)} alGuardar={() => { setModalOpen(false); cargarClientes(); }} />}
      </Modal>
    </div>
  )
}

export default Clientes

================================================================================
ARCHIVO: src/pages/Proveedores.jsx
================================================================================

import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Truck, Plus, Pencil, Archive, Search, ArrowUpDown, Mail, Phone, UserCheck } from 'lucide-react'
import Modal from '../components/Modal'
import NuevoProveedor from './NuevoProveedor'

function Proveedores() {
  const [proveedores, setProveedores] = useState([])
  const [filtro, setFiltro] = useState('')
  const [sortConfig, setSortConfig] = useState({ key: 'nombre', direction: 'asc' })
  
  const [modalOpen, setModalOpen] = useState(false)
  const [editId, setEditId] = useState(null)

  useEffect(() => {
    cargarDatos()
  }, [])

  async function cargarDatos() {
    // FILTRO ACTIVO
    const { data } = await supabase
        .from('proveedores')
        .select('*')
        .eq('activo', true) 
        .order('nombre')
    setProveedores(data || [])
  }

  const handleSort = (key) => {
    setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc' }))
  }

  const sortedData = [...proveedores].sort((a, b) => {
    let valA = (a[sortConfig.key] || '').toString().toLowerCase()
    let valB = (b[sortConfig.key] || '').toString().toLowerCase()
    if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1
    if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1
    return 0
  }).filter(p => 
    p.nombre.toLowerCase().includes(filtro.toLowerCase()) || 
    (p.rut && p.rut.includes(filtro))
  )

  // SOFT DELETE
  const archivar = async (id) => {
      if(confirm("¬øArchivar este proveedor?")) {
          const { error } = await supabase.from('proveedores').update({ activo: false }).eq('id', id)
          if(error) alert('Error: ' + error.message)
          else cargarDatos()
      }
  }

  const RenderContactos = ({ contactos }) => {
    if (!contactos || contactos.length === 0) return <span style={{color:'#9ca3af', fontStyle:'italic', fontSize:'0.8rem'}}>Sin contactos</span>
    
    const principal = contactos[0]
    const extra = contactos.length - 1

    return (
        <div style={{display:'flex', flexDirection:'column', gap:2}}>
            <div style={{display:'flex', alignItems:'center', gap:4, fontWeight:'500', fontSize:'0.85rem'}}>
               <UserCheck size={13} color="#4b5563"/> {principal.nombre}
            </div>
            <div style={{fontSize:'0.75rem', color:'#6b7280', paddingLeft:18}}>
                {principal.cargo || 'Contacto'} 
                {extra > 0 && <span style={{marginLeft:5, backgroundColor:'#e5e7eb', padding:'0 4px', borderRadius:4, fontSize:'0.7rem'}}>+{extra} m√°s</span>}
            </div>
        </div>
    )
  }

  const styles = {
    container: { padding: '20px', width: '90%', margin: '0 auto', maxWidth: '1200px' },
    header: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' },
    title: { display: 'flex', alignItems: 'center', gap: '10px', fontSize: '1.5rem', fontWeight: 'bold', color: '#1f2937' },
    search: { padding: '8px 12px', borderRadius: '6px', border: '1px solid #d1d5db', width: '250px' },
    btnNew: { backgroundColor: '#1f2937', color: 'white', padding: '10px 15px', borderRadius: '8px', border: 'none', cursor: 'pointer', display: 'flex', gap: 5, alignItems: 'center' },
    tableContainer: { backgroundColor: 'white', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', border: '1px solid #e5e7eb' },
    table: { width: '100%', borderCollapse: 'collapse' },
    th: { backgroundColor: '#f9fafb', padding: '12px', textAlign: 'left', fontSize: '0.85rem', color: '#6b7280', fontWeight: '600', cursor: 'pointer', borderBottom:'1px solid #e5e7eb' },
    td: { padding: '12px', borderBottom: '1px solid #f9fafb', fontSize: '0.9rem', color: '#374151' },
    chip: { display:'inline-flex', alignItems:'center', gap:5, padding:'2px 8px', borderRadius:'12px', backgroundColor:'#f3f4f6', color:'#4b5563', fontSize:'0.8rem', marginRight:5 }
  }

  const ThSort = ({ label, sortKey }) => (
    <th style={styles.th} onClick={() => handleSort(sortKey)}>
        <div style={{display:'flex', alignItems:'center', gap:5}}>
            {label} {sortConfig.key === sortKey && <ArrowUpDown size={14}/>}
        </div>
    </th>
  )

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><Truck /> Proveedores</h1>
        <div style={{display:'flex', gap:10}}>
            <div style={{position:'relative'}}>
                <Search size={16} style={{position:'absolute', left:10, top:10, color:'#9ca3af'}}/>
                <input type="text" placeholder="Buscar..." value={filtro} onChange={e => setFiltro(e.target.value)} style={{...styles.search, paddingLeft:35}} />
            </div>
            <button onClick={() => { setEditId(null); setModalOpen(true) }} style={styles.btnNew}><Plus size={18}/> Nuevo</button>
        </div>
      </div>

      <div style={styles.tableContainer}>
        <table style={styles.table}>
            <thead>
                <tr>
                    <ThSort label="Nombre / Raz√≥n" sortKey="nombre" />
                    <ThSort label="RUT" sortKey="rut" />
                    <th style={styles.th}>Contactos / Vendedores</th>
                    <ThSort label="Email Central" sortKey="email" />
                    <th style={styles.th}></th>
                </tr>
            </thead>
            <tbody>
                {sortedData.map(p => (
                    <tr key={p.id}>
                        <td style={styles.td}><strong>{p.nombre}</strong></td>
                        <td style={styles.td}>{p.rut || '-'}</td>
                        <td style={styles.td}>
                            <RenderContactos contactos={p.contactos} />
                        </td>
                        <td style={styles.td}>
                            {p.email && <span style={styles.chip}><Mail size={12}/> {p.email}</span>}
                        </td>
                        <td style={styles.td}>
                            <div style={{display:'flex', gap:5, justifyContent:'flex-end'}}>
                                <button onClick={() => { setEditId(p.id); setModalOpen(true) }} style={{border:'none', background:'none', color:'#2563eb', cursor:'pointer'}}><Pencil size={16}/></button>
                                <button onClick={() => archivar(p.id)} style={{border:'none', background:'none', color:'#d97706', cursor:'pointer'}} title="Archivar"><Archive size={16}/></button>
                            </div>
                        </td>
                    </tr>
                ))}
                {sortedData.length === 0 && <tr><td colSpan="5" style={{textAlign:'center', padding:30, color:'#9ca3af'}}>No hay proveedores activos.</td></tr>}
            </tbody>
        </table>
      </div>

      <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title={editId ? "Editar Proveedor" : "Nuevo Proveedor"}>
        {modalOpen && <NuevoProveedor idProveedor={editId} cerrarModal={() => setModalOpen(false)} alGuardar={() => { setModalOpen(false); cargarDatos(); }} />}
      </Modal>
    </div>
  )
}

export default Proveedores

================================================================================
ARCHIVO: src/pages/Categorias.jsx
================================================================================

import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { Tags, Plus, Trash2, ChevronRight, FolderOpen } from 'lucide-react'

function Categorias() {
  const [categorias, setCategorias] = useState([])
  const [subcategorias, setSubcategorias] = useState([])
  const [catSeleccionada, setCatSeleccionada] = useState(null)
  
  // Inputs
  const [nuevaCat, setNuevaCat] = useState('')
  const [nuevaSub, setNuevaSub] = useState('')

  useEffect(() => {
    cargarDatos()
  }, [])

  async function cargarDatos() {
    const { data: cats } = await supabase.from('categorias_gastos').select('*').order('nombre')
    const { data: subs } = await supabase.from('subcategorias_gastos').select('*').order('nombre')
    setCategorias(cats || [])
    setSubcategorias(subs || [])
  }

  // --- ACCIONES CATEGORIAS ---
  const crearCategoria = async (e) => {
      e.preventDefault()
      if (!nuevaCat.trim()) return
      const { error } = await supabase.from('categorias_gastos').insert([{ nombre: nuevaCat }])
      if (!error) {
          setNuevaCat('')
          cargarDatos()
      }
  }

  const eliminarCategoria = async (id) => {
      if(confirm("¬øEliminar categor√≠a y sus subcategor√≠as?")) {
          await supabase.from('categorias_gastos').delete().eq('id', id)
          if(catSeleccionada?.id === id) setCatSeleccionada(null)
          cargarDatos()
      }
  }

  // --- ACCIONES SUBCATEGORIAS ---
  const crearSubcategoria = async (e) => {
      e.preventDefault()
      if (!nuevaSub.trim() || !catSeleccionada) return
      const { error } = await supabase.from('subcategorias_gastos').insert([{ 
          nombre: nuevaSub, 
          categoria_id: catSeleccionada.id 
      }])
      if (!error) {
          setNuevaSub('')
          cargarDatos()
      }
  }

  const eliminarSub = async (id) => {
      if(confirm("¬øEliminar subcategor√≠a?")) {
          await supabase.from('subcategorias_gastos').delete().eq('id', id)
          cargarDatos()
      }
  }

  // Filtrar subs para la vista
  const subsVisibles = catSeleccionada 
      ? subcategorias.filter(s => s.categoria_id === catSeleccionada.id)
      : []

  const styles = {
    container: { padding: '20px', width: '90%', margin: '0 auto', maxWidth: '1000px' },
    title: { fontSize: '1.5rem', fontWeight: 'bold', color: '#1f2937', display:'flex', alignItems:'center', gap:10, marginBottom:30 },
    
    layout: { display: 'flex', gap: '30px', alignItems: 'flex-start', flexWrap:'wrap' },
    
    // Panel Izq (Categorias)
    panel: { flex: 1, backgroundColor: 'white', borderRadius: '12px', padding: '20px', border: '1px solid #e5e7eb', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', minWidth:'300px' },
    panelHeader: { fontSize:'1rem', fontWeight:'bold', marginBottom:15, borderBottom:'1px solid #f3f4f6', paddingBottom:10, color:'#374151' },
    
    list: { listStyle: 'none', padding: 0, margin: 0 },
    itemCat: (active) => ({
        padding: '10px 12px', cursor: 'pointer', borderRadius: '8px', marginBottom: '5px', display: 'flex', justifyContent: 'space-between', alignItems: 'center',
        backgroundColor: active ? '#eff6ff' : 'transparent',
        color: active ? '#2563eb' : '#4b5563',
        fontWeight: active ? '600' : 'normal',
        border: active ? '1px solid #dbeafe' : '1px solid transparent'
    }),
    
    itemSub: { padding: '8px 12px', borderBottom: '1px dashed #f3f4f6', display: 'flex', justifyContent: 'space-between', color:'#4b5563', fontSize:'0.9rem' },

    inputGroup: { display: 'flex', gap: 5, marginTop: 15 },
    input: { flex: 1, padding: '8px', borderRadius: '6px', border: '1px solid #d1d5db' },
    btnAdd: { backgroundColor: '#1f2937', color: 'white', border: 'none', borderRadius: '6px', padding: '0 12px', cursor: 'pointer' },
    btnDel: { border: 'none', background: 'none', color: '#ef4444', cursor: 'pointer', opacity: 0.6 }
  }

  return (
    <div style={styles.container}>
      <h1 style={styles.title}><Tags /> Categor√≠as de Gastos</h1>

      <div style={styles.layout}>
          
          {/* PANEL CATEGOR√çAS */}
          <div style={styles.panel}>
              <div style={styles.panelHeader}>1. Categor√≠as Principales</div>
              <ul style={styles.list}>
                  {categorias.map(c => (
                      <li key={c.id} style={styles.itemCat(catSeleccionada?.id === c.id)} onClick={() => setCatSeleccionada(c)}>
                          <span>{c.nombre}</span>
                          <div style={{display:'flex', alignItems:'center', gap:5}}>
                              <button onClick={(e) => { e.stopPropagation(); eliminarCategoria(c.id); }} style={styles.btnDel}><Trash2 size={16}/></button>
                              <ChevronRight size={16} style={{opacity: catSeleccionada?.id===c.id ? 1 : 0.3}}/>
                          </div>
                      </li>
                  ))}
              </ul>
              <form onSubmit={crearCategoria} style={styles.inputGroup}>
                  <input type="text" placeholder="Nueva categor√≠a..." value={nuevaCat} onChange={e => setNuevaCat(e.target.value)} style={styles.input} />
                  <button type="submit" style={styles.btnAdd}><Plus size={18}/></button>
              </form>
          </div>

          {/* PANEL SUBCATEGOR√çAS */}
          <div style={{...styles.panel, backgroundColor: catSeleccionada ? 'white' : '#f9fafb'}}>
              <div style={styles.panelHeader}>
                  {catSeleccionada ? `2. Subcategor√≠as de "${catSeleccionada.nombre}"` : "2. Selecciona una categor√≠a"}
              </div>
              
              {catSeleccionada ? (
                  <>
                      <ul style={styles.list}>
                          {subsVisibles.map(s => (
                              <li key={s.id} style={styles.itemSub}>
                                  <span>{s.nombre}</span>
                                  <button onClick={() => eliminarSub(s.id)} style={styles.btnDel}><Trash2 size={16}/></button>
                              </li>
                          ))}
                          {subsVisibles.length === 0 && <div style={{fontStyle:'italic', color:'#9ca3af', padding:10}}>Sin subcategor√≠as.</div>}
                      </ul>
                      <form onSubmit={crearSubcategoria} style={styles.inputGroup}>
                          <input type="text" placeholder="Nueva subcategor√≠a..." value={nuevaSub} onChange={e => setNuevaSub(e.target.value)} style={styles.input} />
                          <button type="submit" style={styles.btnAdd}><Plus size={18}/></button>
                      </form>
                  </>
              ) : (
                  <div style={{textAlign:'center', padding:40, color:'#9ca3af'}}>
                      <FolderOpen size={40} style={{opacity:0.2, marginBottom:10}}/>
                      <div>Selecciona una categor√≠a de la izquierda para ver y editar sus subcategor√≠as.</div>
                  </div>
              )}
          </div>

      </div>
    </div>
  )
}

export default Categorias

================================================================================
ARCHIVO: src/pages/ConfiguracionCampo.jsx
================================================================================

import { useEffect, useState } from 'react'
import { supabase } from '../supabaseClient'
import { MapPin, Map, Plus, Pencil, Archive, TreeDeciduous, Ruler, Droplets, Activity, Clock } from 'lucide-react'
import Modal from '../components/Modal'
import NuevaParcela from './NuevaParcela'
import NuevoSector from './NuevoSector'

function ConfiguracionCampo() {
  const [arbol, setArbol] = useState([]) // Estructura completa (Parcelas -> Sectores)
  const [loading, setLoading] = useState(true)

  // ESTADOS MODALES
  const [modalParcelaOpen, setModalParcelaOpen] = useState(false)
  const [modalSectorOpen, setModalSectorOpen] = useState(false)
  
  const [editParcelaId, setEditParcelaId] = useState(null)
  const [editSectorId, setEditSectorId] = useState(null)

  useEffect(() => {
    cargarDatos()
  }, [])

  async function cargarDatos() {
    setLoading(true)
    try {
      // 1. CARGAMOS SOLO LOS ACTIVOS
      const { data: parcelas } = await supabase
        .from('parcelas')
        .select('*')
        .eq('activo', true)
        .order('nombre')

      const { data: sectores } = await supabase
        .from('sectores')
        .select('*')
        .eq('activo', true)
        .order('nombre')

      if (parcelas && sectores) {
        // Armamos la estructura y calculamos totales
        const estructura = parcelas.map(p => {
            const misSectores = sectores.filter(s => s.parcela_id === p.id)
            
            // C√°lculos acumulados
            const totalArboles = misSectores.reduce((acc, s) => acc + (s.cantidad_arboles || 0), 0)
            const totalHa = misSectores.reduce((acc, s) => acc + (s.superficie_ha || 0), 0)
            const totalAspersores = misSectores.reduce((acc, s) => acc + (s.cantidad_aspersores || 0), 0)
            
            // Calculamos caudal total en m3/h (L/h * cantidad / 1000)
            const totalCaudalLPH = misSectores.reduce((acc, s) => acc + ((s.cantidad_aspersores || 0) * (s.caudal_lph || 0)), 0)
            const totalCaudalM3 = totalCaudalLPH / 1000

            return {
                ...p,
                sectores: misSectores,
                stats: { 
                    arboles: totalArboles, 
                    has: totalHa,
                    aspersores: totalAspersores,
                    caudalM3: totalCaudalM3
                }
            }
        })
        setArbol(estructura)
      }
    } catch (error) {
      console.error(error)
    } finally {
      setLoading(false)
    }
  }

  const handleClose = (setModal) => setModal(false)

  const abrirEditarParcela = (id) => { setEditParcelaId(id); setModalParcelaOpen(true) }
  const abrirEditarSector = (id) => { setEditSectorId(id); setModalSectorOpen(true) }

  // SOFT DELETE
  const archivarParcela = async (id) => {
      if(confirm("¬øArchivar esta parcela? Desaparecer√° de la lista principal pero se mantendr√° en el historial.")) {
          const { error } = await supabase.from('parcelas').update({ activo: false }).eq('id', id)
          if (error) alert('Error al archivar: ' + error.message)
          else cargarDatos()
      }
  }

  const archivarSector = async (id) => {
      if(confirm("¬øArchivar este sector?")) {
          const { error } = await supabase.from('sectores').update({ activo: false }).eq('id', id)
          if (error) alert('Error al archivar: ' + error.message)
          else cargarDatos()
      }
  }

  // Helper para calcular estado/edad del huerto
  const getEstadoHuerto = (anoPlantacion) => {
      if (!anoPlantacion) return { label: 'Sin info', color: '#9ca3af' }
      const antiguedad = new Date().getFullYear() - anoPlantacion
      
      if (antiguedad < 2) return { label: 'üå± Nuevo', color: '#10b981' } // Verde esmeralda
      if (antiguedad < 5) return { label: 'üåø Crecimiento', color: '#84cc16' } // Verde lima
      return { label: 'üå≥ Adulto', color: '#15803d' } // Verde oscuro
  }

  const styles = {
    container: { padding: '20px', maxWidth: '1200px', margin: '0 auto' },
    header: { display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:30 },
    title: { fontSize:'1.5rem', fontWeight:'bold', color:'#1f2937', display:'flex', alignItems:'center', gap:10 },
    btnNew: { padding:'10px 20px', backgroundColor:'#1f2937', color:'white', borderRadius:'8px', border:'none', fontWeight:'bold', display:'flex', alignItems:'center', gap:8, cursor:'pointer' },
    
    parcelaContainer: { backgroundColor:'white', borderRadius:12, padding:20, marginBottom:30, border:'1px solid #e5e7eb', boxShadow:'0 2px 4px rgba(0,0,0,0.05)' },
    parcelaHeader: { display:'flex', justifyContent:'space-between', alignItems:'center', borderBottom:'2px solid #f3f4f6', paddingBottom:15, marginBottom:15, flexWrap: 'wrap', gap: 10 },
    parcelaTitle: { fontSize:'1.2rem', fontWeight:'bold', color:'#374151', display:'flex', alignItems:'center', gap:10, minWidth: '200px' },
    
    // Stats mejorados
    statsContainer: { display:'flex', gap:10, flexWrap:'wrap', flex: 1, justifyContent: 'flex-end', marginRight: 15 },
    statBadge: { display:'flex', alignItems:'center', gap:6, backgroundColor:'#f8fafc', padding:'6px 12px', borderRadius:8, border:'1px solid #e2e8f0', fontSize:'0.85rem', color:'#475569', fontWeight:500 },
    
    gridSectores: { display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(280px, 1fr))', gap:15 },
    sectorCard: { backgroundColor:'#f9fafb', padding:15, borderRadius:8, border:'1px solid #e5e7eb', position:'relative', display:'flex', flexDirection:'column', gap:8 },
    sectorHeader: { display:'flex', justifyContent:'space-between', alignItems:'flex-start' },
    sectorName: { fontWeight:'bold', color:'#111827', fontSize:'1rem' },
    
    // Detalles del sector densos
    detailRow: { display:'flex', justifyContent:'space-between', fontSize:'0.85rem', color:'#4b5563', borderBottom:'1px dashed #e5e7eb', paddingBottom:4 },
    
    actions: { display:'flex', justifyContent:'flex-end', gap:8, marginTop:'auto', paddingTop:10 },
    btnIcon: { background:'none', border:'none', cursor:'pointer', color:'#6b7280' }
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}><MapPin size={28}/> Configuraci√≥n de Campo</h1>
        <div style={{display:'flex', gap:10}}>
             <button onClick={() => { setEditParcelaId(null); setModalParcelaOpen(true) }} style={{...styles.btnNew, backgroundColor:'white', color:'#374151', border:'1px solid #d1d5db'}}>
                <Map size={18}/> Nueva Parcela
             </button>
             <button onClick={() => { setEditSectorId(null); setModalSectorOpen(true) }} style={styles.btnNew}>
                <Plus size={18}/> Nuevo Sector
             </button>
        </div>
      </div>

      {arbol.map(p => (
        <div key={p.id} style={styles.parcelaContainer}>
            <div style={styles.parcelaHeader}>
                <div style={styles.parcelaTitle}>
                    <Map size={20} color="#4b5563"/> {p.nombre}
                </div>
                
                <div style={styles.statsContainer}>
                    <div style={styles.statBadge} title="Superficie Total">
                        <Ruler size={14}/> {p.stats.has.toFixed(1)} Ha
                    </div>
                    <div style={styles.statBadge} title="Total √Årboles">
                        <TreeDeciduous size={14}/> {p.stats.arboles}
                    </div>
                    <div style={styles.statBadge} title="Total Aspersores">
                        <Droplets size={14}/> {p.stats.aspersores} asp
                    </div>
                    <div style={{...styles.statBadge, backgroundColor:'#eff6ff', borderColor:'#bfdbfe', color:'#1e40af'}} title="Capacidad de Riego Total">
                        <Activity size={14}/> {p.stats.caudalM3.toFixed(1)} m¬≥/h
                    </div>
                </div>

                <div style={{display:'flex', gap:5}}>
                    <button onClick={() => abrirEditarParcela(p.id)} style={styles.btnIcon}><Pencil size={18}/></button>
                    <button onClick={() => archivarParcela(p.id)} style={{...styles.btnIcon, color:'#d97706'}} title="Archivar Parcela">
                        <Archive size={18}/>
                    </button>
                </div>
            </div>

            <div style={styles.gridSectores}>
                {p.sectores.length === 0 ? (
                    <div style={{color:'#9ca3af', fontStyle:'italic', padding:10}}>Sin sectores registrados.</div>
                ) : (
                    p.sectores.map(s => {
                        const ratio = s.cantidad_arboles > 0 ? (s.cantidad_aspersores / s.cantidad_arboles).toFixed(1) : '0'
                        const estado = getEstadoHuerto(s.ano_plantacion)

                        return (
                            <div key={s.id} style={styles.sectorCard}>
                                <div style={styles.sectorHeader}>
                                    <div>
                                        <div style={styles.sectorName}>{s.nombre}</div>
                                        <span style={{fontSize:'0.75rem', fontWeight:'bold', color: estado.color, backgroundColor:'#f0fdf4', padding:'2px 6px', borderRadius:4}}>
                                            {estado.label}
                                        </span>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style={styles.detailRow}>
                                        <span><Ruler size={12} style={{marginRight:4, verticalAlign:'text-bottom'}}/> Superficie:</span>
                                        <strong>{s.superficie_ha} Ha</strong>
                                    </div>
                                    <div style={styles.detailRow}>
                                        <span><TreeDeciduous size={12} style={{marginRight:4, verticalAlign:'text-bottom'}}/> Plantas:</span>
                                        <strong>{s.cantidad_arboles} ({s.variedad})</strong>
                                    </div>
                                    <div style={styles.detailRow}>
                                        <span><Droplets size={12} style={{marginRight:4, verticalAlign:'text-bottom'}}/> Riego:</span>
                                        <strong>{ratio} asp/planta</strong>
                                    </div>
                                    <div style={{...styles.detailRow, borderBottom:'none', color:'#2563eb'}}>
                                        <span><Activity size={12} style={{marginRight:4, verticalAlign:'text-bottom'}}/> Caudal:</span>
                                        <strong>{s.caudal_lph} L/h</strong>
                                    </div>
                                </div>

                                <div style={styles.actions}>
                                    <button onClick={() => abrirEditarSector(s.id)} style={styles.btnIcon}><Pencil size={16}/></button>
                                    <button onClick={() => archivarSector(s.id)} style={{...styles.btnIcon, color:'#d97706'}} title="Archivar Sector">
                                        <Archive size={16}/>
                                    </button>
                                </div>
                            </div>
                        )
                    })
                )}
            </div>
        </div>
      ))}
      
      {arbol.length === 0 && !loading && <div style={{textAlign:'center', padding:'40px', color:'#6b7280'}}>No hay parcelas activas. Comienza creando una.</div>}

      <Modal isOpen={modalParcelaOpen} onClose={() => handleClose(setModalParcelaOpen)} title={editParcelaId ? "Editar Parcela" : "Nueva Parcela"}>
          {modalParcelaOpen && <NuevaParcela idParcela={editParcelaId} cerrarModal={() => setModalParcelaOpen(false)} alGuardar={() => { setModalParcelaOpen(false); cargarDatos(); }} />}
      </Modal>

      <Modal isOpen={modalSectorOpen} onClose={() => handleClose(setModalSectorOpen)} title={editSectorId ? "Editar Sector" : "Nuevo Sector"}>
          {modalSectorOpen && <NuevoSector idSector={editSectorId} cerrarModal={() => setModalSectorOpen(false)} alGuardar={() => { setModalSectorOpen(false); cargarDatos(); }} />}
      </Modal>

    </div>
  )
}
export default ConfiguracionCampo

